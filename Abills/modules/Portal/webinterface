#!perl

=head1 NAME

 User portal

=cut

use Portal;

my $Portal = Portal->new($db, $admin, \%conf);


#***********************************************************
#  Portal manage menu
#***********************************************************
sub portal_manage_menu {
  if ($FORM{message}) {
    $html->message('info', $lang{INFO}, "$FORM{message}");
  }

  $Portal->{ACTION}     = 'add';
  $Portal->{ACTION_LNG} = $lang{ADD};
  $Portal->{TITLE_NAME} = $lang{ADD_MENU};

  #$Portal->{debug}=1;
  if (!$FORM{STATUS} or $FORM{STATUS} == 0) {

    $Portal->{SHOWED} = '';
    $Portal->{HIDDEN} = 'checked=\'checked\'';
  }
  else {
    $Portal->{SHOWED} = 'checked=\'checked\'';
    $Portal->{HIDDEN} = '';
  }

  if ($FORM{add}) {
    if ($FORM{NAME} ne '') {
      $Portal->portal_menu_add({%FORM});
      if (!$Portal->{errno}) {

        #$html->message('info', $lang{INFO}, "$lang{ADDED}");
        $html->tpl_show(
          _include('portal_redirect', 'Portal'),
          {
            SECTION => '',
            MESSAGE => "$lang{ADDED}",
          }
        );
      }
    }
    else {
      $html->message('info', $lang{INFO}, "$lang{FIELDS_FOR_NAME_ARE_REQUIRED}");
      $html->tpl_show(_include('portal_menu_add', 'Portal'), { %$Portal, %FORM });
    }
  }
  elsif ($FORM{del}) {

    $list = $Portal->portal_articles_list({ ARTICLE_ID => $FORM{del}, COLS_NAME => 1 });

    if (defined($list->[0]->{id})) {

      $html->message('info', $lang{INFO}, "$lang{CANT_DELETE_ERROR}");
    }
    else {

      #$Portal->{debug}=1;
      $Portal->portal_menu_del({ ID => $FORM{del} });
      if (!$Portal->{errno}) {
        $html->message('info', $lang{INFO}, "$lang{DELETED}");
      }
    }
  }
  elsif ($FORM{change}) {
    if ($FORM{NAME} ne '') {
      $Portal->portal_menu_change({%FORM});
      if (!$Portal->{errno}) {
        $html->tpl_show(
          _include('portal_redirect', 'Portal'),
          {
            SECTION => '',
            MESSAGE => "$lang{CHANGED}",
          }
        );
      }
    }
    else {
      $Portal->{ACTION}     = 'change';
      $Portal->{ACTION_LNG} = $lang{CHANGE};
      $Portal->{TITLE_NAME} = $lang{CHANGE_MENU};
      $html->message('info', $lang{INFO}, "$lang{FIELDS_FOR_NAME_ARE_REQUIRED}");
      $html->tpl_show(_include('portal_menu_add', 'Portal'), { %$Portal, %FORM });
    }
  }
  elsif ($FORM{chg}) {
    $Portal->{ACTION}     = 'change';
    $Portal->{ACTION_LNG} = $lang{CHANGE};
    $Portal->{TITLE_NAME} = $lang{CHANGE_MENU};

    $Portal->portal_menu_info({ ID => $FORM{chg}, });

    if ($Portal->{STATUS} == 0) {
      $Portal->{SHOWED} = '';
      $Portal->{HIDDEN} = 'checked=\'checked\'';
    }
    else {
      $Portal->{SHOWED} = 'checked=\'checked\'';
      $Portal->{HIDDEN} = '';
    }

  }

  if (!$FORM{add} and !$FORM{change}) {
    $html->tpl_show(_include('portal_menu_add', 'Portal'), $Portal);
  }

  my ($table, $list) = result_former({
     INPUT_DATA      => $Portal,
     FUNCTION        => 'portal_menu_list',
     BASE_FIELDS     => 5,
     FUNCTION_FIELDS => 'change,del',
     SKIP_USER_TITLE => 1,
     EXT_TITLES      => {
       name   => $lang{NAME},
       url    => 'URL',
       date   => $lang{ADDED},
       status => $lang{STATUS}
     },
     TABLE           => {
       width      => '100%',
       caption    => "$lang{MENU}",
       qs         => $pages_qs,
       ID         => 'PORTAL_TYPES',
       EXPORT     => 1,
       MENU       => "$lang{ADD}:index=$index&add_form=1&$pages_qs:add",
     },
     SELECT_VALUE    => {
       status => { 0 => "$lang{HIDDEN}:text-danger",
                   1 => "$lang{SHOWED}:text-primary"
                 },
     },
     MAKE_ROWS    => 1,
     SEARCH_FORMER=> 1,
     TOTAL        => 1
  });

  return 1;
}

#***********************************************************
#  Portal articles
#***********************************************************
sub portal_articles {
  my $users = Users->new($db, $admin, \%conf);

  if ($FORM{message}) {
    $html->message('info', $lang{INFO}, "$FORM{message}");
  }

  $Portal->{ACTION}     = 'add';
  $Portal->{ACTION_LNG} = $lang{ADD};
  $Portal->{TITLE_NAME} = $lang{ADD_ARTICLE};

  my @IMPORTANCE_STATUS = ("$lang{NORMAL}","$lang{CRITICAL}");

  my $importance_select =  $html->form_select(
  'IMPORTANCE',
  {
    SELECTED       => $FORM{IMPORTANCE},
    SEL_ARRAY      => \@IMPORTANCE_STATUS,
    ARRAY_NUM_ID   => 1,
    SEL_VALUE      => 'name',
    NO_ID          => 1
  });

  my $tags_list;
  if(in_array('Tags', \@MODULES)){
    use Tags;
    our $Tags = Tags->new($db, $admin, \%conf);
    $tags_list = $Tags->list({COLS_NAME => 1, NAME => '_SHOW'});
  }

  $Portal->{TAGS} = $html->form_select(
      'TAGS',
      {
        SELECTED       => $Portal->{TAGS},
        SEL_LIST       => $tags_list,
        SEL_KEY        => 'id',
        SEL_VALUE      => 'name',
        NO_ID          => 1,
        SEL_OPTIONS    => {"" => ""}
      });

  my $group_select = sel_groups();

  $Portal->{GROUPS} = $group_select;
  $Portal->{IMPORTANCE_STATUS} = $importance_select;
  $Portal->{ADRESS_FORM} = $html->tpl_show(templates('form_address_search'),
                                            $user_pi,
                                            { OUTPUT2RETURN => 1 });

  my $PORTAL_MENU_ID = $Portal->{PORTAL_MENU_ID} = $html->form_select(
    "PORTAL_MENU_ID",
    {
      SELECTED   => $FORM{PORTAL_MENU_ID},
      SEL_LIST   => $Portal->portal_menu_list({ NOT_URL => 1, COLS_NAME => 1 }),
      SEL_OPTIONS=> { '' => $lang{CHOOSE_MENU} },
      NO_ID      => 1
    }
  );

  #$Portal->{debug}=1;
  if (!$FORM{STATUS} or $FORM{STATUS} == 0) {
    $Portal->{SHOWED} = '';
    $Portal->{HIDDEN} = 'checked=\'checked\'';
  }
  else {
    $Portal->{SHOWED} = 'checked=\'checked\'';
    $Portal->{HIDDEN} = '';
  }

  if ($FORM{ON_MAIN_PAGE}) {
    $Portal->{ON_MAIN_PAGE_CHECKED} = 'checked=\'checked\'';
  }

  if ($FORM{add}) {

    if ($FORM{TITLE} ne '' and $FORM{CONTENT} ne '' and $FORM{PORTAL_MENU_ID} ne '') {
      $Portal->portal_article_add({%FORM});
      if (!$Portal->{errno}) {

        $html->tpl_show(
          _include('portal_redirect', 'Portal'),
          {
            SECTION => '',
            MESSAGE => "$lang{ADDED}",
          }
        );
      }
    }
    else {
      $html->message('info', $lang{INFO}, "$lang{FIELDS_FOR_TITLE_TEXT_MENU_ARE_REQUIRED}");
      $html->tpl_show(
        _include('portal_article_add', 'Portal'),
        {
          %$Portal,
          %FORM,
          ALIGN          => 'right',
          PORTAL_MENU_ID => $PORTAL_MENU_ID,
        }
      );
    }
  }
  elsif ($FORM{del}) {
    $Portal->portal_article_del({ ID => $FORM{del} });
    if (!$Portal->{errno}) {
      $html->message('info', $lang{INFO}, "$lang{DELETED}");
    }

  }
  elsif ($FORM{change}) {
    if ($FORM{TITLE} ne '' and $FORM{CONTENT} ne '' and $FORM{PORTAL_MENU_ID} ne '') {

      if($FORM{RESET} == 1){
        $FORM{DISTRICT_ID} = 0;
        $FORM{STREET_ID} = 0;
      }

      $Portal->portal_article_change({%FORM});
      if (!$Portal->{errno}) {
        $html->tpl_show(
          _include('portal_redirect', 'Portal'),
          {
            SECTION => '',
            MESSAGE => "$lang{CHANGED}",
          }
        );
      }
    }
    else {
      $Portal->{ACTION}     = 'change';
      $Portal->{ACTION_LNG} = $lang{CHANGE};
      $Portal->{TITLE_NAME} = $lang{CHANGE_MENU};
      $html->message('info', $lang{INFO}, "$lang{FIELDS_FOR_TITLE_TEXT_MENU_ARE_REQUIRED}");
      $html->tpl_show(
        _include('portal_article_add', 'Portal'),
        {
          %$Portal,
          %FORM,
          ALIGN          => 'right',
          PORTAL_MENU_ID => $PORTAL_MENU_ID,

        }
      );
    }
  }
  elsif ($FORM{chg}) {
    $Portal->{ACTION}     = 'change';
    $Portal->{ACTION_LNG} = $lang{CHANGE};
    $Portal->{TITLE_NAME} = $lang{CHANGE_MENU};

    $Portal->portal_article_info({ ID => $FORM{chg}, });

    $PORTAL_MENU_ID = $Portal->{PORTAL_MENU_ID} = $html->form_select(
      "PORTAL_MENU_ID",
      {
        SELECTED          => $Portal->{PORTAL_MENU_ID},
        SEL_MULTI_ARRAY   => [ [ '', $lang{CHOOSE_MENU} ], @{ $Portal->portal_menu_list({ NOT_URL => 1 }) } ],
        MULTI_ARRAY_KEY   => 0,
        MULTI_ARRAY_VALUE => 1,
        NO_ID             => 1
      }
    );

    if ($Portal->{STATUS} == 0) {
      $Portal->{SHOWED} = '';
      $Portal->{HIDDEN} = 'checked=\'checked\'';
    }
    else {
      $Portal->{SHOWED} = 'checked=\'checked\'';
      $Portal->{HIDDEN} = '';
    }

    if ($Portal->{ON_MAIN_PAGE}) {
      $Portal->{ON_MAIN_PAGE_CHECKED} = 'checked=\'checked\'';
    }

    if($Portal->{ARCHIVE} == 0) {
      $Portal->{SHOWED_ARCHIVE} = '';
      $Portal->{HIDDEN_ARCHIVE} = 'checked=\'checked\'';
    }
    else {
      $Portal->{SHOWED_ARCHIVE} = 'checked=\'checked\'';
      $Portal->{HIDDEN_ARCHIVE} = '';
    }

    $Portal->{IMPORTANCE_STATUS} =  $html->form_select(
      'IMPORTANCE',
      {
        SELECTED       => $Portal->{IMPORTANCE},
        SEL_ARRAY      => \@IMPORTANCE_STATUS,
        ARRAY_NUM_ID   => 'id',
        SEL_VALUE      => 'name',
        NO_ID          => 1
      });

    $Portal->{TAGS} = $html->form_select(
      'TAGS',
      {
        SELECTED       => $Portal->{TAGS},
        SEL_LIST       => $tags_list,
        SEL_KEY        => 'id',
        SEL_VALUE      => 'name',
        NO_ID          => 1,
        SEL_OPTIONS    => {"" => ""}
      });

    $Portal->{GROUPS} = sel_groups({ GID => $Portal->{GID}});

    if($Portal->{DISTRICT_ID}){
      $user_pi->{ADDRESS_DISTRICT} = ($users->district_info({ID => $Portal->{DISTRICT_ID}}))->{NAME};
    }

    if($Portal->{STREET_ID}){
      $user_pi->{ADDRESS_STREET} = ($users->street_info({ID => $Portal->{STREET_ID}}))->{NAME};
    }

    $Portal->{ADRESS_FORM} = $html->tpl_show(templates('form_address_search'),
                                            { %$user_pi,
                                              DISTRICT_ID       => $Portal->{DISTRICT_ID},
                                              STREET_ID         => $Portal->{STREET_ID},
                                            }, { OUTPUT2RETURN     => 1 });
  }

  if (!$FORM{add} and !$FORM{change}) {

    $html->tpl_show(
      _include('portal_article_add', 'Portal'),
      {
        %$Portal,
        ALIGN          => 'right',
        PORTAL_MENU_ID => $PORTAL_MENU_ID,
      }
    );
  }

  $table = $html->table(
    {
      width      => '100%',
      caption    => $lang{MENU},
      title      => [ $lang{MENU},
                      $lang{TITLE},
                      $lang{DATE_PUBLICATE},
                      $lang{DATE_END},
                      $lang{STATUS},
                      $lang{ON_MAIN_PAGE},
                      $lang{USER_PORTAL},
                      $lang{IMPORTANCE},
                      $lang{GROUPS},
                      $lang{TAGS},
                      $lang{DISTRICT},
                      $lang{STREET},
                      '-', '-' ],
      cols_align => [ 'left', 'left', 'left', 'left', 'right','right', 'center', 'center' ],
      ID         => 'PORTAL_TYPES',
    }
  );

  my @STATUS     = ('<strong style=\'color:red\'>' . $lang{HIDDEN} . '</strong>',
                '<strong style=\'color:#090\'>' . $lang{SHOWED} . '</strong>');
  my @ARCHIVE    = ("<span class='label label-danger label-sm'>$lang{TO_ARCHIVE}</span>",
                "<span class='label label-success label-sm'>$lang{SHOW}</span>");
  my @IMPORTANCE = ("<span class='label label-success label-sm'>$lang{NORMAL}</span>",
                "<span class='label label-danger label-sm'>$lang{CRITICAL}</span>");
  #$Portal->{debug}=1;

  $list = $Portal->portal_articles_list({ COLS_NAME => 1 });

  foreach my $line (@$list) {
    my $tag_name;
    if(in_array('Tags', \@MODULES)){
      my $tag_info = $Tags->info($line->{tags});
      if($Tags->{TOTAL}){
        $tag_name   = $tag_info->{NAME};
      }
    }

    $table->addrow(
      $line->{name},
      $line->{title},    # (length($line->[1]) > 30 ) ? substr ($line->[1], 0, 21) . '...' : $line->[1],
      $line->{date},
      $line->{end_date},
      @STATUS[ $line->{status} ],
      ($line->{on_main_page} == 1) ? $lang{YES} : $lang{NO},
      @ARCHIVE[ $line->{archive} ],
      @IMPORTANCE[ $line->{importance} ],
      $line->{gp_name},
      $tag_name,
      $line->{dis_name},
      $line->{st_name},
      $html->button($lang{INFO}, "index=$index&chg=$line->{id}", { class => 'change' }),
      (defined($permissions{0}{5})) ? $html->button($lang{DEL}, "index=$index&del=$line->{id}", { MESSAGE => "$lang{DEL} $line->{title}?", class => 'del' }) : ''
    );
  }

   print $table->show();

  return 1;
}

#***********************************************************
#  User cabinet news
#***********************************************************
sub portal_user_cabinet {
  my ($attr) = @_;

  my $list = $Portal->portal_articles_list({ ARCHIVE => 0, COLS_NAME  => 1 });

  my %USER_NEWS;        # данные в шаблон user_news
  my @NORMAL;           # массив новостей с уровнем важности "Нормальный"
  my @IMPORTANT;        # массив новостей с уровнем важности "Важный"
  my $indicators = 0;   # количество индикаторов
  my $active = 0;       # активный слайд
  my $not_show = 0;

  foreach $item (@$list){
    # если дата окончания новости больше меньше чем сегодняшняя дата, то показываем новости
    # или если новость не в архиве
    if($item->{etimestamp} > time && $item->{utimestamp} < time){
      # если група подходит или не обьявлена в новости
      if($item->{gid} == $users->{GID} || $item->{gid} == ''){
        # проверка на адресс
        if($item->{dis_name} eq $users->{ADDRESS_DISTRICT} &&  $item->{st_name} eq '' ||
           $item->{st_name} eq $users->{ADDRESS_STREET} && $item->{dis_name} eq ''    ||
           $item->{dis_name} eq $users->{ADDRESS_DISTRICT} && $item->{st_name} eq $users->{ADDRESS_STREET} ||
           $item->{dis_name} eq '' && $item->{st_name} == '') {
          my $tag_check;
          if(in_array('Tags', \@MODULES)){
            use Tags;
            our $Tags = Tags->new($db, $admin, \%conf);
            $tag_check = $Tags->tags_user({COLS_NAME => 1, UID => $users->{UID}, TAG_ID=>$item->{tags} });
          }
          if(defined $tag_check->[0]->{date} || $item->{tags} == ''){
          # если новость срочная
          if($item->{importance} == 1){
            my $short_description = $item->{short_description};
            if((length $short_description) > 600){

              $short_description = substr($short_description, 0, 600);
            }

            my $important = $html->tpl_show(_include('portal_user_content', 'Portal'),
                                        {
                                          TITLE              => $item->{title},
                                          SHORT_DESCRIPTION  => $short_description,
                                          COLOR              => "#FFFFCC",
                                          ACTIVE             => ($active == 0) ? 'active' : '',
                                          HREF               => "$SELF_URL?article=" . $item->{id}
                                        },
                                        { OUTPUT2RETURN      => 1 });

            unshift(@IMPORTANT, $important);
            $indicators++;
            $active++;
          }
          else {
            my $short_description = $item->{short_description};
            if((length $short_description) > 600){
              $short_description = substr($short_description, 0, 600);
            }

            my $normal = $html->tpl_show(_include('portal_user_content', 'Portal'),
                                        {
                                          TITLE              => $item->{title},
                                          SHORT_DESCRIPTION  => $short_description,
                                          ACTIVE             => ((((scalar @$list) - 1 - $not_show) == $indicators) && $active == 0) ? 'active' : '',
                                          HREF               => "$SELF_URL?article=" . $item->{id}
                                        },
                                        { OUTPUT2RETURN      => 1 });

            unshift(@NORMAL, $normal);
            $indicators++;
          }
        } else { $not_show ++};
        } else { $not_show ++};
      } else { $not_show ++};
    } else { $not_show ++};
  }

  # список всех новостей по порядку важности
  foreach $item (@IMPORTANT){
    $USER_NEWS{CONTENT} .= $item;
  }

  foreach $item (@NORMAL){
    $USER_NEWS{CONTENT} .= $item;
  }

  # индикаторы для карусели
  for(my $i = 0; $i < $indicators; $i++){
    if($i==0){
        $USER_NEWS{INDICATORS} .= "<li data-target='#myCarousel' data-slide-to='$i' class='active'></li>";
    }else{
      $USER_NEWS{INDICATORS} .= "<li data-target='#myCarousel' data-slide-to='$i' ></li>";
    }
  }

  my $news_body = '';
  if ($USER_NEWS{CONTENT} ne '' ){
    $news_body = $html->tpl_show(_include('portal_user_news', 'Portal'),
                                              { %USER_NEWS },
                                              { OUTPUT2RETURN     => 1 });
  }

  return $news_body;
}

#**********************************************************
=head2 portal_start_page() -

  Arguments:
    $attr -
  Returns:

  Examples:

=cut
#**********************************************************
sub portal_s_page {
  my ($wrong_passwd, $attr) = @_;
  # my $lang = $conf{PORTAL_LANGUAGE};

  do "../Abills/modules/Portal/lng_$lang.pl";
  do "../language/$lang.pl";

  %OUTPUT;
  $OUTPUT{HTML_STYLE} = 'default_adm';
  $OUTPUT{SEL_LANGUAGE} = $html->form_select(
    'language',
    {
      EX_PARAMS  => 'onChange="selectLanguage()"',
      SELECTED   => $html->{language},
      SEL_HASH   => \%LANG,
      NO_ID      => 1,
      EXT_PARAMS => { qt_locale => \%QT_LANG }
    }
  );

  my $url = '';

  # $Portal->{debug}=1;

  my $list = $Portal->portal_menu_list({ MENU_SHOW => 1, COLS_NAME => 1 });

  if ($list->[0]->{id}) {

    foreach my $line (@$list) {

      # Если поле url пустое, формируем меню
      if ($line->{url} eq '') {
        $url = "$SELF_URL?menu_category=" . $line->{id};
      }

      # Если поле url не пустое формируем внешнюю ссылку
      else {

        # Если строка содержит http:// выводим как есть
        if ($line->{url} =~ m|http://*|) {
          $url = $line->{url};
        }

        # Если строка не содержит http://  - добавляем
        else {
          $url = 'http://' . $line->{url};
        }
      }

      # Если нажатое меню не совпадает с активным меню то выводим меню без выделения
      if ($FORM{menu_category} != $line->{id}) {
        $OUTPUT{MENU} .= $html->tpl_show(
          _include('portal_menu', 'Portal'),
          {
            HREF      => $url,
            MENU_NAME => $line->{name},
          },
          { OUTPUT2RETURN => 1 }
        );
      }
      else {
        #  Выделение активного меню
        $OUTPUT{MENU} .= $html->tpl_show(_include('portal_menu_hovered', 'Portal'), { MENU_NAME => $line->{name}, }, { OUTPUT2RETURN => 1 });
      }
    }
  }
  else {
    # Выводит  сообшение "В системе не созданы разделы"
    $OUTPUT{MENU} = $lang{NO_MENU};
  }

  if ($FORM{menu_category}) {

    # Собираем статьи в категории меню
    $list = $Portal->portal_articles_list({ ARTICLE_ID => $FORM{menu_category}, COLS_NAME => 1 });
    if ($list->[0]->{id}) {
      my $total_articles = 0;
      foreach my $line (@$list) {

        # Проверка времени публикации статьи
        if ($line->{utimestamp} <= time()) {
          $OUTPUT{CONTENT} .= $html->tpl_show(
            _include('portal_content', 'Portal'),
            {
              HREF              => "$SELF_URL?article=" . $line->{id},
              TITLE             => $line->{title},
              SHORT_DESCRIPTION => $line->{short_description}
            },
            { OUTPUT2RETURN => 1 }
          );
          $total_articles++;

        }
      }

      # Если количество статей - ноль
      if ($total_articles <= 0) {

        $OUTPUT{CONTENT} .= $html->tpl_show(
          _include('portal_article', 'Portal'),
          {
            TITLE   => '',
            ARTICLE => $lang{NO_DATA}
          },
          { OUTPUT2RETURN => 1 }
        );

      }

    }
    else {
      # Если в данной категории меню нет статтей выводим сообщение - "В этой категории пока нет данных"
      $OUTPUT{CONTENT} .= $html->tpl_show(
        _include('portal_article', 'Portal'),
        {
          TITLE   => '',
          ARTICLE => $lang{NO_DATA}
        },
        { OUTPUT2RETURN => 1 }
      );
    }
  }
  else {
    # Отображает статьи на главной
    $list = $Portal->portal_articles_list({ MAIN_PAGE => 1, COLS_NAME => 1 });
    if ($list->[0]->{id}) {

      # Если дата статьи меньше или такая же как текущая - выводим статью
      foreach my $line (@$list) {
        if ($line->{utimestamp} <= time()) {
          $OUTPUT{CONTENT} .= $html->tpl_show(
            _include('portal_content', 'Portal'),
            {
              HREF              => "$SELF_URL?article=" . $line->{id},
              TITLE             => $line->{title},
              SHORT_DESCRIPTION => $line->{short_description}
            },
            { OUTPUT2RETURN => 1 }
          );
        }
      }
    }
    else {
      # Выводит сообщение - "В этой категории пока нет данных"
      $OUTPUT{CONTENT} .= $html->tpl_show(
        _include('portal_article', 'Portal'),
        {
          TITLE   => '',
          ARTICLE => $lang{NO_DATA}
        },
        { OUTPUT2RETURN => 1 }
      );
    }

  }

  if ($FORM{article}) {

    # Отображение статьи польностю
    $list = $Portal->portal_articles_list({ ID => $FORM{article}, COLS_NAME => 1 });
    if ($list->[0]->{id}) {
      my $text_article = convert($list->[0]->{content}, { text2html => 1 });
      my (@links) = $text_article =~ /\[(.+?)]/gm;

      my @reworked_links;
      my $link_num = 0;
      foreach my $link (@links){
        my ($site, $text) = $link =~ /(.+)\|(.+)/i;
        $reworked_links[$link_num] = "<a href=" . $site . ">" . $text . "</a>";
        $text_article =~ s/\[$site\|$text]/ $reworked_links[$link_num]/;
        $link_num++;
      }

      $OUTPUT{CONTENT} = $html->tpl_show(
        _include('portal_article', 'Portal'),
        {
          TITLE   => $list->[0]->{title},
          ARTICLE => $text_article
        },
        { OUTPUT2RETURN => 1 }
      );
    }

  }

  if(@REGISTRATION){
    $OUTPUT{REGISTRATION} = "<a class='btn btn-primary btn-lg' href='registration.cgi?module=$REGISTRATION[0]' target='_blank'>$lang{REGISTRATION}</a>";
  }

  if($wrong_passwd == 1){
    $OUTPUT{WRONG_PASSWD}       = $html->message('err', $lang{ERR_WRONG_PASSWD}, '');
    $OUTPUT{WRONG_PASSWD_CHECK} = 1;
  }

  if ($conf{AUTH_VK_ID}) {
    $OUTPUT{SOCIAL_AUTH_BLOCK}=$html->element('li',
      $html->button('', "external_auth=Vk", { class => 'icon-vk', ICON => 'fa fa-vk'} ),
      { OUTPUT2RETURN => 1 }
    )
  }

  if ($conf{AUTH_FACEBOOK_ID}) {
    $OUTPUT{SOCIAL_AUTH_BLOCK}.=$html->element('li',
      $html->button('', "external_auth=Facebook", { class => 'icon-facebook', ICON => 'fa fa-facebook'}),
      { OUTPUT2RETURN => 1 }
    );
  }

  if ($conf{AUTH_GOOGLE_ID}) {
    $OUTPUT{SOCIAL_AUTH_BLOCK}.=$html->element('li',
      $html->button('', "external_auth=Google", { class => 'icon-google', ICON => 'fa fa-google'}),
      { OUTPUT2RETURN => 1 }
    );
  }

  if ($conf{AUTH_INSTAGRAM_ID}) {
    $OUTPUT{SOCIAL_AUTH_BLOCK}.=$html->element('li',
      $html->button('', "external_auth=Instagram", { class => 'icon-instagram', ICON => 'fa fa-instagram'}),
      { OUTPUT2RETURN => 1 }
    );
  }

  print $html->tpl_show(_include('portal_body', 'Portal'), { %OUTPUT });

  return 1;
}
