#!perl

=head2
  
  Modinfo module

  Show module and other information

=cut

use strict;
use warnings;

our ($db, %lang);
our Abills::HTML $html;

#**********************************************************
=head2 modinfo_start_page_show($attr)

  Arguments:

  Results:
    $card_info

=cut
#**********************************************************
sub modinfo_start_page_show {
  require Abills::Fetcher;
  Abills::Fetcher->import(qw(web_request));

  my $base_site = 'http://abills.net.ua';
  my $base_docu_link = "$base_site/wiki";
  my $doc_id = "1277971";

  my $output = web_request("$base_docu_link/rest/api/content/$doc_id?expand=body.view",
    {
      CURL        => 1,
      JSON_RETURN => 1
    }
  );

  if (!$output && !$output->{body} && !$output->{body}{view}{value}) {
    return 0;
  }
  my $page_body = $output->{body}{view}{value} // '';
  my @modules_list = ($page_body =~ /<th[^>]*><a[^>]*>(.+?)<\/a><\/th>/gm);
  my @modules_links = ($page_body =~ /<th[^>]*><a href=\"(.*?)\"[^>]*>.+?<\/a><\/th>/gm);
  my @modules_descriptions = ($page_body =~ /<td[^>]*>(.+?)<\/td>/gm);

  my $random_module_index = rand(scalar @modules_list);
  my $name = $modules_list[$random_module_index];
  my $url = $modules_links[$random_module_index];
  my $desc = $modules_descriptions[$random_module_index];

  $url = $base_site . $url;
  my $info = modinfo_show($name, $url, $desc);
  
  print $info if ($index);
  
  return $info;
}


#**********************************************************
=head2 modinfo_show($module_name, $url, $desc) - info about module

  Arguments:
    $module_name
    $url
    $desc

  Results:
    $result

=cut
#**********************************************************
sub modinfo_show {
  my ($module_name, $url, $desc) = @_;

  my $result = $html->tpl_show(_include('modinfo_about_module', 'Modinfo'),
    {
      MODULE_NAME => $module_name,
      DESCRIBE    => $desc,
      WIKI_LINK   => $url
    },
    { OUTPUT2RETURN => 1 }
  );

  return $result;
}


#**********************************************************
=head2 modinfo_tips() - Get random tip from db

  Arguments:

  Results:
    $card_info

=cut
#**********************************************************
sub modinfo_tips {

  my $output = web_request('https://api.adviceslip.com/advice', { CURL => 1, JSON_RETURN => 1 });
  if (!$output && !$output->{slip} && !$output->{slip}{advice}) {
    return '';
  }
  my $tip = $output->{slip}{advice};
  my $card_info = $html->tpl_show(_include('modinfo_tip', 'Modinfo'), { TIP => $tip }, { OUTPUT2RETURN => 1 });

  return $card_info;
}


#**********************************************************
=head2 modinfo_start_page() - returns module dashboard

  Arguments:

  Results:
    \%START_PAGE_F

=cut
#**********************************************************
sub modinfo_start_page {
  my %START_PAGE_F = (
    'modinfo_start_page_show' => $lang{MOD_INFO},
    'modinfo_tips'            => $lang{TIPS}
  );

  return \%START_PAGE_F;
}

1;
