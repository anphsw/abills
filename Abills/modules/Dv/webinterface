#!perl
=head1 NAME

  Dv module

  Internet Dialup/VPN/IPoE functions

  Error ID: 9xx

=cut


use strict;
use warnings FATAL => 'all';
use Abills::Defs;
use Abills::Base qw(int2byte time2sec ip2int int2ip days_in_month
  date_diff in_array sendmail sec2time show_log mk_unique_value
  convert clearquotes next_month);
use Abills::Filters qw(_mac_former);
use Dv;
use Finance;
use Fees;
use Dv_Sessions;
use Shedule;
use Tariffs;
use Nas;
use Log;

our $db;
our %conf;
our $admin;
our $html;
our %permissions;
our $ui;
our @MONTHES_LIT;
our @WEEKDAYS;
our @MONTHES;
our %err_strs;
our @bool_vals;
our @state_colors;
our %lang;
our $PG;
our $users;
our $base_dir;
our @PERIODS; # ???
our %ADMIN_REPORT;

my $Dv       = Dv->new($db, $admin, \%conf);
my $Fees     = Fees->new($db, $admin, \%conf);
my $Payments = Finance->payments($db, $admin, \%conf);
my $Tariffs  = Tariffs->new($db, \%conf, $admin);
my $Sessions = Dv_Sessions->new($db, $admin, \%conf);
my $Nas      = Nas->new($db, \%conf);
our $Log     = Log->new($db, \%conf);

my %FORM_BASE      = ();
my %TRAFFIC_NAMES  = ();

my $chart_height           = 350;
my $chart_new_window_width = 400;
my $chart_embedded_width   = 740;

my $new_window_size = "$chart_new_window_width:" . ($chart_height * 1.2);

#my @service_status = ("$lang{ENABLE}", "$lang{DISABLE}", "$lang{NOT_ACTIVE}", "$lang{HOLD_UP}",
#  "$lang{DISABLE}: $lang{NON_PAYMENT}", "$lang{ERR_SMALL_DEPOSIT}",
#  "$lang{VIRUS_ALERT}", "$lang{REPAIR}" );

#**********************************************************
=head2 dv_user_del($uid, $attr) Delete user from module

=cut
#**********************************************************
sub dv_user_del {
  my ($uid, $attr) = @_;

  $Dv->{UID} = $uid;
  $Dv->del({ UID => $uid });
  $Log->log_del({ LOGIN => $attr->{LOGIN} });

  return 0;
}

#**********************************************************
=head2 dv_chg_tp($attr) - Change user tariff plan from admin interface

=cut
#**********************************************************
sub dv_chg_tp {
  my ($attr) = @_;

  my $user;
  if (defined($attr->{USER_INFO})) {
    $user = $attr->{USER_INFO};
    $Dv   = $Dv->info($user->{UID}, { DOMAIN_ID => $user->{DOMAIN_ID} });
    if ($Dv->{TOTAL} < 1) {
      $html->message('info', $lang{INFO}, "$lang{NOT_ACTIVE}");
      return 0;
    }
  }
  else {
    $html->message('err', $lang{ERROR}, "$lang{USER_NOT_EXIST}");
    return 0;
  }

  if (!$permissions{0}{10}) {
    $html->message('err', $lang{ERROR}, "$lang{ERR_ACCESS_DENY}");
    return 1;
  }

  #my $TARIF_PLAN = $FORM{tarif_plan} || $lang{DEFAULT_TARIF_PLAN};
  my $period     = $FORM{period}     || 0;
  my $Shedule = Shedule->new($db, $admin, \%conf);

  #Get next period
  if (
       ($Dv->{MONTH_ABON} && $Dv->{MONTH_ABON} > 0)
    && !$Dv->{STATUS}
    && !$users->{DISABLE}
    && ( $users->{DEPOSIT} + $users->{CREDIT} > 0
       || $Dv->{POSTPAID_ABON}
       || ($Dv->{PAYMENT_TYPE} && $Dv->{PAYMENT_TYPE} == 1))
  )
  {
    if ($users->{ACTIVATE} ne '0000-00-00') {
      my ($Y, $M, $D) = split(/-/, $users->{ACTIVATE}, 3);
      $M--;
      $Dv->{ABON_DATE} = POSIX::strftime("%Y-%m-%d", localtime((POSIX::mktime(0, 0, 0, $D, $M, ($Y - 1900), 0, 0, 0) + 31 * 86400 + (($conf{START_PERIOD_DAY}) ? $conf{START_PERIOD_DAY} * 86400 : 0))));
    }
    else {
      my ($Y, $M, $D) = split(/-/, $DATE, 3);
      $M++;
      if ($M == 13) {
        $M = 1;
        $Y++;
      }

      if ($conf{START_PERIOD_DAY}) {
        $D = $conf{START_PERIOD_DAY};
      }
      else {
        $D = '01';
      }
      $Dv->{ABON_DATE} = sprintf("%d-%02d-%02d", $Y, $M, $D);
    }
  }

  my $message='';
  if ($FORM{set}) {
    if (!$permissions{0}{4}) {
      $html->message('err', $lang{ERROR}, "$lang{ERR_ACCESS_DENY}");
      return 0;
    }

    my ($year, $month, $day) = split(/-/, $DATE, 3);
    if ($period > 0) {
      if ($period == 1) {
        ($year, $month, $day) = split(/-/, $Dv->{ABON_DATE}, 3);
      }
      else {
        ($year, $month, $day) = split(/-/, $FORM{DATE}, 3);
      }

      my $seltime = POSIX::mktime(0, 0, 0, $day, ($month - 1), ($year - 1900));

      if ($seltime <= time()) {
        $html->message('info', $lang{INFO}, "$lang{ERR_WRONG_DATA} " . $html->color_mark("$lang{DATE}: $year-$month-$day", $_COLORS[6]));
        return 0;
      }
      elsif ($FORM{date_D} && $FORM{date_D} > ($month != 2 ? (($month % 2) ^ ($month > 7)) + 30 : (!($year % 400) || !($year % 4) && ($year % 25) ? 29 : 28))) {
        $html->message('info', $lang{INFO}, "$lang{ERR_WRONG_DATA} " . $html->color_mark("$lang{DATE}: $year-$month-$day", $_COLORS[6]));
        return 0;
      }

      $Shedule->add(
        {
          UID          => $Dv->{UID},
          TYPE         => 'tp',
          ACTION       => $FORM{TP_ID},
          D            => $day,
          M            => $month,
          Y            => $year,
          MODULE       => 'Dv',
          COMMENTS     => "$lang{FROM}: $Dv->{TP_ID}:".
            (($Dv->{TP_NAME}) ? "$Dv->{TP_NAME}" : q{})  . ((! $FORM{GET_ABON}) ? "\nGET_ABON=-1" : '' ) . ((! $FORM{RECALCULATE}) ? "\nRECALCULATE=-1" : ''),
          ADMIN_ACTION => 1
        }
      );

      if (! _error_show($Shedule) ) {
        $html->message('info', $lang{CHANGED}, "$lang{TARIF_PLAN} $lang{CHANGED}");
        $Dv->info($Dv->{UID});
      }
    }
    else {
      $Dv->change({%FORM});

      if (! _error_show($Dv) ) {
        #Take fees
        #Message
        if (!$Dv->{STATUS} && $FORM{GET_ABON}) {
          $Dv->{ACCOUNT_ACTIVATE} = $users->{ACTIVATE};
          service_get_month_fee($Dv);
        }

        $html->message('info', $lang{CHANGED}, "$lang{TARIF_PLAN} $message");
        $Dv->info($Dv->{UID});
      }
    }
  }
  elsif ($FORM{del}) {
    $Shedule->del(
      {
        UID => $Dv->{UID},
        ID  => $FORM{SHEDULE_ID}
      }
    );

    $html->message('info', $lang{DELETED}, "$lang{DELETED} [$FORM{SHEDULE_ID}]");
  }

  $Shedule->info(
    {
      UID      => $Dv->{UID},
      TYPE     => 'tp',
      MODULE   => 'Dv'
    }
  );

  if ($Shedule->{TOTAL} > 0 && !$conf{DV_TP_MULTISHEDULE}) {
    my $table = $html->table(
      {
        width      => '100%',
        caption    => "$lang{SHEDULE}",
        cols_align => [ 'left', 'left' ],
        rows       => [ [ "$lang{TARIF_PLAN}:", "$Shedule->{ACTION}" ], [ "$lang{DATE}:", "$Shedule->{D}-$Shedule->{M}-$Shedule->{Y}" ], [ "$lang{ADMIN}:", "$Shedule->{ADMIN_NAME}" ], [ "$lang{ADDED}:", "$Shedule->{DATE}" ], [ "ID:", "$Shedule->{SHEDULE_ID}" ] ]
      }
    );
    $Tariffs->{TARIF_PLAN_SEL} = $table->show() . $html->form_input('SHEDULE_ID', "$Shedule->{SHEDULE_ID}", { TYPE => 'HIDDEN' });
    $Tariffs->{ACTION}         = 'del';
    $Tariffs->{LNG_ACTION}     = $lang{DEL};
  }
  else {
    my $tp_list = $Tariffs->list({
                          MODULE        => 'Dv',
                          DOMAIN_ID     => $users->{DOMAIN_ID} || $admin->{DOMAIN_ID},
                          COMMENTS      => '_SHOW',
                          TP_GROUP_NAME => '_SHOW',
                          COLS_NAME     => 1
                          });
    my $table;
    #Sheduler fot TP change
    if ($conf{DV_TP_MULTISHEDULE}) {
      if ($FORM{del_Shedule} && $FORM{COMMENTS}) {
        $Shedule->del({ ID => $FORM{del_Shedule} });
        if (! _error_show($Shedule)) {
          $html->message('info', $lang{INFO}, "$lang{SHEDULE} $lang{DELETED} $FORM{del_Shedule}");
        }
        $Shedule->{TOTAL} = 1;
      }

      $table = $html->table(
        {
          width      => '100%',
          caption    => "$lang{SHEDULE}",
          cols_align => [ 'right', 'left', 'left' ],
          title      => [ $lang{DATE}, $lang{TARIF_PLAN}, '-' ],
        }
      );

      if ($Shedule->{TOTAL} > 0) {
        my $list = $Shedule->list(
          {
            UID      => $Dv->{UID},
            TYPE     => 'tp',
            DESCRIBE => '_SHOW',
            MODULE   => 'Dv'
          }
        );

        my %TP_HASH = ();
        foreach my $line (@$tp_list) {
          $TP_HASH{ $line->{id} } = $line->{name};
        }

        foreach my $line (@$list) {
          $table->addrow("$line->[3]-$line->[2]-$line->[1]", "$line->[7] : $TP_HASH{$line->[7]}", $html->button($lang{DEL}, "index=$index&del_Shedule=$line->[14]&UID=$FORM{UID}", { MESSAGE => "$lang{DEL} $line->[3]-$line->[2]-$line->[1]?", class => 'del' }));
        }

        $Tariffs->{SHEDULE_LIST} .= $table->show();
      }
    }

    # GID:ID=>NAME
    my %TPS_HASH = ();
    foreach my $line (@$tp_list) {
      $TPS_HASH{($line->{tp_group_name} || '')}{ $line->{id} } = "$line->{id} $line->{name}";
    }

    $Tariffs->{TARIF_PLAN_SEL} = $html->form_select(
      'TP_ID',
      {
        SELECTED          => $Dv->{TP_ID},
        SEL_HASH          => \%TPS_HASH,
        GROUP_COLOR       => 1,
        MAIN_MENU         => ($permissions{0}{10}) ? get_function_index('dv_tp') : undef,
        MAIN_MENU_AGRV    => "TP_ID=". ($Dv->{TP_NUM} || '')
      }
    );

    $Tariffs->{PARAMS} .= form_period($period, { ABON_DATE => $Dv->{ABON_DATE} });

    if ($permissions{0}{4}) {
      $Tariffs->{ACTION} = 'set';
    }

    $Tariffs->{LNG_ACTION} = $lang{CHANGE};
  }

  $Tariffs->{UID}   = $attr->{USER_INFO}->{UID};
  #$tariffs->{m}     = $m;
  $Tariffs->{TP_ID} = $Dv->{TP_NUM};

  $Tariffs->{TP_NAME} = $Dv->{TP_ID}.':'. ($Dv->{TP_NAME} || '');

  $html->tpl_show(templates('form_chg_tp'), $Tariffs);

  return 1;
}


#**********************************************************
=head2 dv_users_search($Dv)

=cut
#**********************************************************
sub dv_users_search {
  my ($Dv_) = @_;

  $index=get_function_index('dv_users_list') if ( $functions{$index} && $functions{$index} ne 'dv_users_list' );
  $Dv->{GROUP_SEL}  = sel_groups();
  $Dv->{STATUS_SEL} = sel_status({ STATUS => $FORM{DV_STATUS} || '',
                                   ALL    => 1,
                                   NAME   => 'DV_STATUS'
                                  });

  if ($conf{DV_LOGIN}) {
    $Dv_->{DV_LOGIN_FORM} .= $html->tpl_show(templates('form_row'), { ID => 'DV_LOGIN',
         NAME  => "Internet $lang{LOGIN}",
         VALUE => $html->form_input('DV_LOGIN', $FORM{DV_LOGIN} || '%DV_LOGIN%', { ID => 'DV_LOGIN' })
         }, { OUTPUT2RETURN => 1 });
  }

  $Dv_->{TP_SEL} = $html->form_select(
      'TP_NUM',
      {
        SELECTED    => $FORM{TP_NUM},
        SEL_LIST    => $Tariffs->list({ MODULE => 'Dv', NEW_MODEL_TP => 1, DOMAIN_ID => $users->{DOMAIN_ID}, COLS_NAME => 1 }),
        SEL_OPTIONS => { '' => "$lang{ALL}" },
        EX_PARAMS   => 'multiple="multiple"'
      }
  );

  form_search({
        SEARCH_FORM  => $html->tpl_show(_include('dv_users_search', 'Dv'),
           { %$Dv_, %FORM },
           { OUTPUT2RETURN => 1 }),
        ADDRESS_FORM  => 1,
        CONTROL_FORM  => 1
  });

  return 1;
}

#**********************************************************
=head2 dv_users_list($attr)

=cut
#**********************************************************
sub dv_users_list {
  my ($attr) = @_;

  if (!$permissions{0}{2}) {
    return 0;
  }

  if ($attr->{TP}) {
    if ($FORM{TP_NUM}) {
      $FORM{TP_ID} = $FORM{TP_NUM};
      $FORM{TP_ID} =~ s/,/;/g;
    }
    $LIST_PARAMS{TP_ID} = $FORM{TP_NUM} || $FORM{TP_ID};
  }
  elsif ($FORM{TP_ID} || $FORM{TP_NUM}) {
    $FORM{TP_ID} = $FORM{TP_NUM} if ($FORM{TP_NUM});
    $FORM{subf} = $index;
    dv_tp();
    return 0;
  }

  dv_users_search($Dv);

  my $service_status = sel_status({ HASH_RESULT => 1 });
  my $active         = '';
  my $status_bar     = $html->button($lang{ALL}, "index=$index$pages_qs", { class => 'btn btn-default active'  });

  foreach my $i (sort keys %$service_status) {
    my ($name, $color) = split(/:/, $service_status->{$i});
    my $qs   = $pages_qs || q{};

    if (defined($FORM{DV_STATUS}) && $FORM{DV_STATUS} ne '' && $FORM{DV_STATUS} == $i) {
      $LIST_PARAMS{DV_STATUS} = $FORM{DV_STATUS};
      $pages_qs .= "&DV_STATUS=$i";
      $qs       .= "&DV_STATUS=$i";
      $active    = 'active';
    }
    else {
      if ($i > 3) {
        $active = $color || q{};
      }
      else {
        $active = $color || q{};
      }

      $qs =~ s/\&DV_STATUS=\d//;
    }

    $status_bar .= $html->button($name, "index=$index&DV_STATUS=$i$qs",
        { class => "btn btn-default $active"  });
  }

  print $html->letters_list({ pages_qs => $pages_qs });

  if ($FORM{letter}) {
    $LIST_PARAMS{LOGIN} = "$FORM{letter}*";
    $pages_qs .= "&letter=$FORM{letter}";
  }

  my (undef, $list) = result_former({
     INPUT_DATA      => $Dv,
     FUNCTION        => 'list',
     BASE_FIELDS     => 0,
     DEFAULT_FIELDS  => 'LOGIN,FIO,DEPOSIT,CREDIT,TP_NAME,DV_STATUS',
     FUNCTION_FIELDS => 'form_payments,dv_stats',
     MAP             => 1,
     MAP_FIELDS      => 'ADDRESS_FLAT,LOGIN,DEPOSIT,FIO,TP_NAME,ONLINE',
     MAP_FILTERS     => { id => 'search_link:form_users:UID'
                          #online => ''
                        },
     #MULTISELECT     => ($permissions{0}{7}) ? 'UID:uid' : '',
     EXT_TITLES      => {
       'ip'          => 'IP',
       'netmask'     => 'NETMASK',
       'speed'       => $lang{SPEED},
       'port'        => $lang{PORT},
       'cid'         => 'CID',
       'filter_id'   => 'Filter ID',
       'tp_name'     => "$lang{TARIF_PLAN}",
       'dv_status'   => "Internet $lang{STATUS}",
       'dv_status_date' => "$lang{STATUS} $lang{DATE}",
       'online'      => 'Online',
       'online_ip'   => 'Online IP',
       'online_cid'  => 'Online CID',
       'online_duration'=> 'Online '. $lang{DURATION},
       'month_fee'   => $lang{MONTH_FEE},
       'day_fee'     => $lang{DAY_FEE},
       'dv_expire'   => "Internet $lang{EXPIRE}",
       'dv_login'    => "$lang{SERVICE} $lang{LOGIN}",
       'dv_password' => "$lang{SERVICE} $lang{PASSWD}",
       'month_traffic_in'  => "$lang{MONTH} $lang{RECV}",
       'month_traffic_out' => "$lang{MONTH} $lang{SENT}",
     },
     SELECT_VALUE    => {
       dv_status    => $service_status,
       login_status => $service_status
     },
     TABLE           => {
       width      => '100%',
       caption    => "Internet - $lang{USERS}",
       qs         => $pages_qs,
       ID         => 'INTERNET_USERS_LIST',
       header     => $status_bar,
       #SELECT_ALL => ($permissions{0}{7}) ? "internet_users_list:UID:$lang{SELECT_ALL}" : undef,
       EXPORT     => 1,
       MENU       => "$lang{ADD}:index=" . get_function_index('dv_wizard_user') . ':add' . ";$lang{SEARCH}:index=$index&search_form=1:search",
     },
     MAKE_ROWS    => 1,
     SEARCH_FORMER=> 1,
     MODULE       => 'Dv',
     TOTAL        => 1,
     SHOW_MORE_THEN=>1
  });

  if ( _error_show($Dv, { MODULE_NAME => $lang{DV} }) ) {
    return 0;
  }
  elsif ($Dv->{TOTAL} == 1) {
    delete $FORM{LOGIN};
    $ui = user_info($list->[0]->{uid});
    print $ui->{TABLE_SHOW};
    form_users({ USER_INFO => $ui });
    return 1;
  }

  return 1;
}

#**********************************************************
=head1 user_dv($attr) - Show user information

=cut
#**********************************************************
sub dv_user {
  my ($attr) = @_;

  $Dv->{UID} = $FORM{UID} || $LIST_PARAMS{UID};
  delete($Dv->{errno});

  if ($FORM{CID} && $FORM{CID} !~ /ANY/i) {
    my $list = $Dv->list({ LOGIN     => '_SHOW',
                           CID       => $FORM{CID},
                           COLS_NAME => 1 });

    if ($Dv->{TOTAL} > 0 && $list->[0]{uid} != $FORM{UID}) {
      $html->message('err', $lang{ERROR}, "CID/MAC: $FORM{CID} $lang{EXIST}. $lang{LOGIN}: " . $html->button("$list->[0]{login}", "index=15&UID=" . $list->[0]{uid} ));
    }
  }

  $Dv->account_check();
  if(_error_show($Dv)) {
    return 1;
  }

  if ($FORM{REGISTRATION_INFO}) {
    # Info
    load_module('Docs', $html);
    $users = Users->new($db, $admin, \%conf);
    $Dv       = $Dv->info($Dv->{UID});
    my $pi    = $users->pi({ UID => $Dv->{UID} });
    my $user  = $users->info($Dv->{UID}, { SHOW_PASSWORD => $permissions{0}{3} });
    $pi->{ADDRESS_FULL} = "$pi->{ADDRESS_STREET} $pi->{ADDRESS_BUILD}, $pi->{ADDRESS_FLAT}";

    ($Dv->{Y}, $Dv->{M}, $Dv->{D}) = split(/-/, (($pi->{CONTRACT_DATE}) ? $pi->{CONTRACT_DATE} : $DATE), 3);
    $pi->{CONTRACT_DATE_LIT} = "$Dv->{D} " . $MONTHES_LIT[ int($Dv->{M}) - 1 ] . " $Dv->{Y} $lang{YEAR}";

    $Dv->{MONTH_LIT}         = $MONTHES_LIT[ int($Dv->{M}) - 1 ];
    if ($Dv->{Y}=~/(\d{2})$/) {
      $Dv->{YY}=$1;
    }

    if (! $FORM{pdf}) {
      if (in_array('Mail', \@MODULES)) {
        load_module('Mail', $html);
        my $Mail = Mail->new($db, $admin, \%conf);
        my $list = $Mail->mbox_list({ UID => $Dv->{UID} });
        foreach my $line (@$list) {
          $Mail->{EMAIL_ADDR} = $line->[0] . '@' . $line->[1];
          $user->{EMAIL_INFO}.=$html->tpl_show(_include('mail_user_info', 'Mail'), $Mail, { OUTPUT2RETURN => 1 });
        }
      }
    }

    #Show rest of prepaid traffic
    if ( $Sessions->prepaid_rest(
      {
        UID  => ($Dv->{JOIN_SERVICE} > 1) ? $Dv->{JOIN_SERVICE} : $Dv->{UID},
        UIDS => $Dv->{UID}
      }
     )
    ) {
      my $list  = $Sessions->{INFO_LIST};

      my $i = 0;
      foreach my $line (@$list) {
        #my $traffic_rest = ($conf{DV_INTERVAL_PREPAID}) ? $sessions->{REST}->{ $line->{interval_id} }->{ $line->{traffic_class} }  :  $sessions->{REST}->{ $line->{traffic_class} };
        $Dv->{'PREPAID_TRAFFIC_'. $i .'_NAME'} = (($TRAFFIC_NAMES{ $line->{traffic_class} }) ? $TRAFFIC_NAMES{ $line->{traffic_class} } : '');
        $Dv->{'PREPAID_TRAFFIC_'. $i}          = $line->{prepaid};
        $Dv->{'TRAFFIC_PRICE_IN_'. $i}         = $line->{in_price};
        $Dv->{'TRAFFIC_PRICE_OUT_'. $i}        = $line->{out_price};
        $Dv->{'TRAFFIC_SPEED_IN_'. $i}         = $line->{in_speed};
        $Dv->{'TRAFFIC_SPEED_OUT_'. $i}        = $line->{out_speed};
        $i++;
      }
    }
    print $html->header();
    $Dv->{PASSWORD} = $user->{PASSWORD} if (! $Dv->{PASSWORD}) ;

    return $html->tpl_show(
        _include('dv_user_memo', 'Dv', { pdf => $FORM{pdf} }),
        {
          %$user,
          %$pi,
          DATE => $DATE,
          TIME => $TIME,
          %$Dv,
        }
      );
    return 1;
  }
  elsif ($FORM{PASSWORD}) {
    my $password_form;
    $password_form->{PW_CHARS}   = $conf{PASSWD_SYMBOLS} || "abcdefhjmnpqrstuvwxyz23456789ABCDEFGHJKLMNPQRSTUVWYXZ";
    $password_form->{PW_LENGTH}  = $conf{PASSWD_LENGTH}  || 6;
    $password_form->{ACTION}     = 'change';
    $password_form->{LNG_ACTION} = "$lang{CHANGE}";
    $password_form->{ACTION}     = 'change';
    $password_form->{LNG_ACTION} = "$lang{CHANGE}";

    $password_form->{HIDDDEN_INPUT} = $html->form_input(
      'UID',
      $FORM{UID},
      {
        TYPE          => 'hidden',
        OUTPUT2RETURN => 1
      }
    );

    $Dv->info($FORM{UID});
    $password_form->{HIDDDEN_INPUT} .= "$lang{PASSWD}: $Dv->{PASSWORD}";
    $password_form->{RESET_INPUT_VISIBLE}   =  'block; ';
    $html->tpl_show(templates('form_password'), $password_form);

    return 1;
  }
  elsif ($FORM{Shedule}) {

  }
  elsif ($FORM{add}) {
    if (!$permissions{0}{1}) {
      $html->message('err', $lang{ERROR}, "$lang{ERR_ACCESS_DENY}");
      return 0;
    }

    if ((! $FORM{IP} || $FORM{IP} eq '0.0.0.0') && $FORM{STATIC_IP_POOL}) {
      $FORM{IP} = dv_get_static_ip($FORM{STATIC_IP_POOL});
    }
    elsif ($FORM{IP} && $FORM{IP} =~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/ && $FORM{IP} ne '0.0.0.0') {
      my $list = $Dv->list({ LOGIN     => '_SHOW',
                             IP        => $FORM{IP},
                             COLS_NAME => 1 });

      if ($Dv->{TOTAL} > 0 && $list->[0]{uid} != $FORM{UID}) {
        $html->message('err', $lang{ERROR}, "IP: $FORM{IP} $lang{EXIST}. $lang{LOGIN}: " . $html->button("$list->[0]{login}", "index=15&UID=" . $list->[0]{uid} ));
        return 0;
      }
    }
    $Dv->add(\%FORM);
    if (!$Dv->{errno}) {
      #Make month fee
      $Dv->{ACCOUNT_ACTIVATE} = $attr->{USER_INFO}->{ACTIVATE};
      $Dv->info($Dv->{UID});
      service_get_month_fee($Dv, { REGISTRATION => 1 }) if (!$FORM{STATUS});

      if($conf{MSG_REGREQUEST_STATUS} && ! $FORM{STATUS}) {
        msgs_unreg_requests_list({ UID => $FORM{UID}, NOTIFY_ID => -1 });
      }

      if ($attr->{REGISTRATION}) {
        my $service_status = sel_status({ HASH_RESULT => 1 });
        my ($status, $color) = split( /:/, $service_status->{ $Dv->{STATUS} } );
        $Dv->{STATUS} = $html->color_mark( $status, $color );
        $html->tpl_show(_include('dv_user_info', 'Dv'), $Dv);
        return 1;
      }
      else {
        $html->message('info', $lang{INFO}, "$lang{ADDED}");
      }
    }
  }
  elsif ($FORM{del}) {
    $Dv->del();
    if (!$Dv->{errno}) {
      $html->message('info', $lang{INFO}, "$lang{DELETED}");
    }
  }
  elsif ($FORM{change} || $FORM{RESET}) {
    if (!$permissions{0}{4}) {
      $html->message('err', $lang{ERROR}, "$lang{ERR_ACCESS_DENY}");
      return 0;
    }

    if ((! $FORM{IP} || $FORM{IP} eq '0.0.0.0') && $FORM{STATIC_IP_POOL}) {
      $FORM{IP} = dv_get_static_ip($FORM{STATIC_IP_POOL});
    }

    if ($FORM{IP} && $FORM{IP} =~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/ && $FORM{IP} ne '0.0.0.0') {
      my $list = $Dv->list({ IP => $FORM{IP}, LOGIN => '_SHOW', COLS_NAME => 1 });
      if ($Dv->{TOTAL} > 0 && $list->[0]->{uid} != $FORM{UID}) {
        $html->message('err', $lang{ERROR}, "IP: $FORM{IP} $lang{EXIST}. $lang{LOGIN}: " . $html->button("$list->[0]{login}", "index=15&UID=" . $list->[0]->{uid}));
        return 0;
      }
    }

    if ($FORM{RESET}) {
      $FORM{PASSWORD}='__RESET__';
      $html->message('info', $lang{INFO}, "$lang{PASSWD} $lang{RESETED}");
    }
    elsif ($FORM{newpassword}) {
      if (! $FORM{RESET_PASSWD} && length($FORM{newpassword}) < $conf{PASSWD_LENGTH}) {
        $html->message('err', $lang{ERROR}, "$lang{ERR_SHORT_PASSWD} $conf{PASSWD_LENGTH}");
      }
      elsif ($FORM{newpassword} eq $FORM{confirm}) {
        $FORM{PASSWORD} = $FORM{newpassword};
      }
      elsif ($FORM{newpassword} ne $FORM{confirm}) {
        $html->message('err', $lang{ERROR}, "$lang{ERR_WRONG_CONFIRM}");
      }
    }

    $Dv->change({%FORM, DETAIL_STATS => $FORM{DETAIL_STATS} || 0 });

    if (defined($FORM{STATUS}) && $FORM{STATUS} == 0) {
      my $Shedule = Shedule->new($db, $admin, \%conf);
      my $list = $Shedule->list(
        {
          UID       => $FORM{UID},
          MODULE    => 'Dv',
          TYPE      => 'status',
          ACTION    => '0',
          COLS_NAME => 1
        }
      );

      if ($Shedule->{TOTAL} == 1) {
        $Shedule->del(
          {
            UID => $FORM{UID},
            IDS => $list->[0]->{shedule_id}
          }
        );
      }

      #change reg request status to active
      if($conf{MSG_REGREQUEST_STATUS}) {
        msgs_unreg_requests_list({ UID => $FORM{UID}, NOTIFY_ID => -1 });
      }
    }

    if (!$Dv->{errno}) {
      $Dv->{ACCOUNT_ACTIVATE} = $attr->{USER_INFO}->{ACTIVATE};
      if (!$FORM{STATUS} && ($FORM{GET_ABON} || !$FORM{TP_ID})) {
        service_get_month_fee($Dv);
      }

      $html->message('info', "Internet", "$lang{CHANGED}");
      return 0 if ($attr->{REGISTRATION});
    }
  }

  if (_error_show($Dv, { MODULE_NAME => 'Internet', ID => 901 })) {
    return 1 if ($attr->{REGISTRATION});
  }
  elsif($Dv->{errno} && $attr->{REGISTRATION}) {
    return 1;
  }

  $Dv->info($Dv->{UID}, { DOMAIN_ID => $users->{DOMAIN_ID} });

  if ($Dv->{TOTAL} < 1) {
    $Dv->{TP_ADD} = $html->form_select(
      'TP_ID',
      {
        SELECTED  => $Dv->{TP_ID} || $FORM{TP_ID} || '',
        SEL_LIST  => $Tariffs->list({ MODULE => 'Dv', NEW_MODEL_TP => 1, DOMAIN_ID => $users->{DOMAIN_ID}, COLS_NAME => 1 }),
      }
    );

    if ($conf{DV_LOGIN}) {
      $Dv->{LOGIN_FORM} .= $html->tpl_show(templates('form_row'), { ID => "DV_LOGIN",
         NAME  => $lang{LOGIN},
         VALUE => $html->form_input('DV_LOGIN', $Dv->{DV_LOGIN} ) }, { OUTPUT2RETURN => 1 });
    }

    if ($attr->{ACTION}) {
      $Dv->{ACTION}     = $attr->{ACTION};
      $Dv->{LNG_ACTION} = $attr->{LNG_ACTION};
    }
    else {
      $Dv->{ACTION}     = 'add';
      $Dv->{LNG_ACTION} = $lang{ACTIVATE};
      $html->message('warn', $lang{INFO}, $lang{NOT_ACTIVE});
    }

    $Dv->{IP} = '0.0.0.0';
  }
  else {
    $Dv->{PASSWORD_BTN} = ($conf{DV_PASSWORD}) ?  $html->button($lang{PASSWD}, "UID=$Dv->{UID}&PASSWORD=1&index=". get_function_index('dv_user'),
        { ex_params => (($Dv->{PASSWORD}) ? 'class=\'btn btn-primary btn-xs\'' : 'class=\'btn btn-warning btn-xs\'')  }) : '';

    if ($FORM{pay_to}) {
      dv_pay_to({ Dv => $Dv });
      return 0;
    }

    if ($attr->{ACTION}) {
      $Dv->{ACTION}     = 'change';
      $Dv->{LNG_ACTION} = $attr->{LNG_ACTION};
    }
    else {
      $Dv->{ACTION}     = 'change';
      $Dv->{LNG_ACTION} = $lang{CHANGE};
    }

    if ($permissions{0}{10}) {
      $Dv->{CHANGE_TP_BUTTON} = $html->button($lang{CHANGE}, 'UID=' . $Dv->{UID} . '&index=' . get_function_index('dv_chg_tp'), { class => 'change' });
    }

    $Dv->{NEXT_FEES_WARNING} = dv_warning({ USER => $users,
                                            DV   => $Dv
                                          });

    $Dv->{NETMASK_COLOR} = ($Dv->{NETMASK} ne '255.255.255.255') ? 'bg-warning' : '';

    my $shedule_index    = get_function_index('dv_sheduler');

    $Dv->{SHEDULE}       = $html->button("", "UID=$FORM{UID}&Shedule=status&index=" . (($shedule_index) ? $shedule_index : $index + 4), { class => 'glyphicon glyphicon-calendar', TITLE => $lang{SHEDULE} });

    my $list = $Sessions->online(
      {
        UID            => $Dv->{UID},
        CLIENT_IP      => '_SHOW',
        DURATION_SEC2  => '_SHOW',
        ACCT_INPUT_OCTETS => '_SHOW',
        ACCT_OUTPUT_OCTETS=> '_SHOW',
        NAS_NAME       => '_SHOW',
        NAS_PORT_ID    => '_SHOW',
        ACCT_SESSION_ID=> '_SHOW',
        USER_NAME      => '_SHOW',
        GUEST          => '_SHOW'
      }
    );

    if ($Sessions->{TOTAL}) {
      my $online_index = get_function_index('dv_online');

      my $table = $html->table(
        {
          caption1 => 'Online',
          ID      => 'DV_ONLINE',
        }
      );

      foreach my $line (@$list) {
        my @row = (
          $line->{client_ip},
          sec2time_str($line->{duration_sec2}),
          int2byte($line->{acct_input_octets}),
          int2byte($line->{acct_output_octets}),
          ($line->{guest}==1) ? $html->color_mark($lang{GUEST}, 'bg-danger') : '',
          $html->button($line->{nas_name}, "index=$online_index&NAS_ID=$line->{nas_id}")
        );

        if ($conf{DV_EXTERNAL_DIAGNOSTIC}) {
          my @diagnostic_rules = split(/;/, $conf{DV_EXTERNAL_DIAGNOSTIC});
          for(my $diag_num=0; $diag_num<=$#diagnostic_rules; $diag_num++) {
            my ($name)=split(/:/, $diagnostic_rules[$diag_num]);

            if (! $name) {
              $name = 'Diagnostic '. $diag_num;
            }
            push @row,$html->button($name, "index=$online_index&diagnostic=$diag_num:$line->{client_ip}+$Dv->{UID}+$line->{nas_id}+$line->{nas_port_id}+$line->{acct_session_id}$pages_qs", { TITLE => "$name", BUTTON => 1 , NO_LINK_FORMER => 1 });
          }
        }

        push @row, $html->button('Z', "index=$online_index&zap=$Dv->{UID}+$line->{nas_id}+$line->{nas_port_id}+$line->{acct_session_id}$pages_qs", { TITLE => 'Zap',    class => 'del', NO_LINK_FORMER => 1 }),
        $html->button('H', "index=$online_index&FRAMED_IP_ADDRESS=$line->{client_ip}&hangup=$line->{nas_id}+$line->{nas_port_id}+$line->{acct_session_id}+$line->{user_name}&$pages_qs", { TITLE => 'Hangup', class => 'off', NO_LINK_FORMER => 1 });

        $table->addrow(@row);
      }

      $Dv->{ONLINE_TABLE} = $table->show();
    }
    else {
      $Dv->{LAST_LOGIN_MSG} = dv_user_error($Dv);
    }

    $list = $admin->action_list({ TYPE      => '4;8;9;14',
                                  UID       => $FORM{UID},
                                  MODULE    => 'Dv',
                                  DATETIME  => '_SHOW',
                                  PAGE_ROWS => 1,
                                  COLS_NAME => 1,
                                  SORT      => 'id',
                                  DESC      => 'desc' });

    if ($admin->{TOTAL}) {
      $list->[0]->{datetime} =~ /(\d{4}-\d{2}-\d{2})/;
      my $status_date = $1;

      my $days = ($status_date eq '0000-00-00') ? 0 : date_diff($status_date, $DATE);

      $Dv->{STATUS_INFO} = "$lang{FROM}: $status_date ($lang{DAYS}: $days)";
      if ($conf{DV_REACTIVE_PERIOD}) {
        my ($period, $sum) = split(/:/, $conf{DV_REACTIVE_PERIOD});
        $Dv->{STATUS_DAYS}  = $days if ($period < $days);
        $Dv->{REACTIVE_SUM} = $sum  if ($period < $days);
      }
    }

    $Dv->{CALLBACK}          = ($Dv->{CALLBACK} == 1) ? ' checked' : '';
    $Dv->{DETAIL_STATS}      = ($Dv->{DETAIL_STATS} && $Dv->{DETAIL_STATS} == 1) ? ' checked' : '';
    $Dv->{REGISTRATION_INFO} = $html->button("$lang{MEMO}", "qindex=$index&UID=$Dv->{UID}&REGISTRATION_INFO=1", { BUTTON => 1, ex_params => 'target=_new' });

    if ($permissions{0}{14}) {
      $Dv->{DEL_FORM}       = $html->tpl_show(templates('form_row'), { ID => "del",
         NAME  => $lang{DEL},
         VALUE => $html->form_input('del', 1, { TYPE => 'checkbox' }) }, { OUTPUT2RETURN => 1 });
    }

    if ($conf{DV_TURBO_MODE}) {
      $Dv->{TURBO_MODE_SEL} = $html->form_select('TURBO_MODE',
      {
         SELECTED     => $Dv->{TURBO_MODE} || $FORM{TURBO_MODE},
         SEL_ARRAY    => [ $lang{ENABLE}, $lang{DISABLE}, $lang{NOT_ACTIVE}, ],
         ARRAY_NUM_ID => 1
      }
      );

      $Dv->{TURBO_MODE_FORM} = $html->tpl_show(templates('form_row'), { ID => "TURBO_MODE",
         NAME  => 'TURBO',
         VALUE => $Dv->{TURBO_MODE_SEL} }, { OUTPUT2RETURN => 1 });

      $Dv->{TURBO_MODE_FORM} .= $html->tpl_show(templates('form_row'), { ID => "FREE_TURBO_MODE",
         NAME  => "TURBO $lang{COUNT}",
         VALUE => $html->form_input('FREE_TURBO_MODE', $Dv->{FREE_TURBO_MODE} ) }, { OUTPUT2RETURN => 1 });
    }

    if ($conf{DV_LOGIN}) {
      $Dv->{LOGIN_FORM} .= $html->tpl_show(templates('form_row'), { ID => 'DV_LOGIN',
         NAME  => $lang{LOGIN},
         VALUE => $html->form_input('DV_LOGIN', $Dv->{DV_LOGIN} ) }, { OUTPUT2RETURN => 1 });
    }

    if ($conf{DOCS_PDF_PRINT}) {
      $Dv->{REGISTRATION_INFO_PDF} = $html->button("$lang{MEMO} (PDF)", "qindex=$index&UID=$Dv->{UID}&REGISTRATION_INFO=1&pdf=1", { ex_params => 'target=_new', BUTTON => 1 });
    }
  }

  $Dv->{STATUS_SEL} = sel_status({ STATUS => $Dv->{STATUS} });
  my $service_status_colors=sel_status({ COLORS => 1 });

  if ($Dv->{STATUS} && $service_status_colors->[$Dv->{STATUS}]) {
    $Dv->{STATUS_COLOR} = $service_status_colors->[$Dv->{STATUS}];
    # Gradient start
    $Dv->{STATUS_COLOR_GR_S} = _darken_hex($service_status_colors->[$Dv->{STATUS}], 1.2);
    # Gradient finish
    $Dv->{STATUS_COLOR_GR_F} = _darken_hex($service_status_colors->[$Dv->{STATUS}], 0.9);
  }

  #Join Service
  if ($attr->{USER_INFO}->{COMPANY_ID}) {
    my $list = $Dv->list(
      {
        JOIN_SERVICE => 1,
        COMPANY_ID   => $attr->{USER_INFO}->{COMPANY_ID},
        COLS_NAME    => 1
      }
    );

    $Dv->{JOIN_SERVICES_SEL} = $html->form_select(
      'JOIN_SERVICE',
      {
        SELECTED   => $Dv->{JOIN_SERVICE},
        SEL_LIST   => $list,
        SEL_KEY    => 'uid',
        SEL_VALUE  => 'login',
        SEL_OPTIONS=> { 1 => $lang{MAIN} },
        NO_ID      => undef
      }
    );

    if ($Dv->{JOIN_SERVICE} && $Dv->{JOIN_SERVICE} == 1) {
      $list = $Dv->list(
        {
          JOIN_SERVICE => $Dv->{UID},
          LOGIN        => '_SHOW',
          COMPANY_ID   => $attr->{USER_INFO}->{COMPANY_ID},
          PAGE_ROWS    => 1000,
          COLS_NAME    => 1
        }
      );

      foreach my $line (@$list) {
        $Dv->{JOIN_SERVICES_USERS} .= $html->button("$line->{login}", "&index=15&UID=$line->{uid}", { BUTTON => 1 }). ' ';
      }
    }
    elsif ($Dv->{JOIN_SERVICE} && $Dv->{JOIN_SERVICE} > 1) {
      $Dv->{JOIN_SERVICES_USERS} = $html->button($lang{MAIN}, "index=15&UID=$Dv->{JOIN_SERVICE}", { BUTTON => 1 });
    }

    $Dv->{JOIN_SERVICE} = $html->tpl_show(_include('dv_user_join_service', 'Dv'), $Dv, { OUTPUT2RETURN => 1 });
  }
  else {
    $Dv->{JOIN_SERVICE} = '';
  }

  $Dv->{STATIC_IP_POOL} = $html->form_select(
    'STATIC_IP_POOL',
    {
      SELECTED       => $FORM{STATIC_POOL} || 0,
      SEL_LIST       => $Nas->ip_pools_list({ STATIC => 1, COLS_NAME => 1 }),
      SEL_OPTIONS    => { '' => '' },
      MAIN_MENU      => get_function_index('form_ip_pools'),
      #MAIN_MENU_AGRV => "chg=". ($tarif_info->{IPPOOL} || ''),
      NO_ID          => 1
    }
  );

  my $total_fee = ($Dv->{MONTH_ABON} || 0)+($Dv->{DAY_ABON} || 0);

  if ($users->{REDUCTION}) {
    $total_fee = $total_fee * (100 - $users->{REDUCTION}) / 100;
  }

  if ($Dv->{STATUS} && $total_fee > $users->{DEPOSIT}) {
    my $sum=0;
    if ($Dv->{ABON_DISTRIBUTION} && ! $conf{DV_FULL_MONTH}) {
      my $days_in_month = days_in_month({ DATE => $DATE });
      my $month_fee = ($total_fee / $days_in_month); # * ($days_in_month - $d);
      if ($month_fee > $users->{DEPOSIT}) {
        my $full_sum  = abs($month_fee - $users->{DEPOSIT});
        $sum = sprintf("%.2f", $full_sum);
        if($sum - $full_sum < 0) {
          $sum = sprintf("%.2f", int($sum + 1));
        }
      }
    }
    else {
      $sum =  sprintf("%.2f", abs($total_fee - $users->{DEPOSIT}));
      if ($sum < abs($total_fee - $users->{DEPOSIT})) {
        $sum = sprintf("%.2f", int($sum + 1));
      }
    }

    if ( $sum > 0 ) {
      $Dv->{PAYMENT_MESSAGE} = $html->message('warn', '', "$lang{ACTIVATION_PAYMENT} $sum " . $html->button("$lang{PAYMENTS}", "UID=$FORM{UID}&index=2&SUM=$sum", { class => 'payments'}), { OUTPUT2RETURN => 1 } );
    }
  }

  if ($Dv->{NEXT_FEES_WARNING}) {
    $Dv->{NEXT_FEES_WARNING}=$html->message('info', "", $Dv->{NEXT_FEES_WARNING}, { OUTPUT2RETURN => 1 }) ;
  }

  if ($Dv->{DV_EXPIRE} && $Dv->{DV_EXPIRE} ne '0000-00-00') {
    if (date_diff($Dv->{DV_EXPIRE}, $DATE) > 1) {
      $Dv->{EXPIRE_COLOR} = 'bg-danger';
      $Dv->{EXPIRE_COMMENTS}="$lang{EXPIRE}";
    }
  }

  if($Dv->{PERSONAL_TP} && $Dv->{PERSONAL_TP} != 0.00){
    $Dv->{PERSONAL_TP_MSG} = $html->message('info', "$lang{ACTIVE_PERSONAL} $lang{TARIF_PLAN}", '', {OUTPUT2RETURN=>1});
  }

  delete $FORM{pdf};
  $html->tpl_show(_include('dv_user', 'Dv'), { %$admin, %$attr, %$Dv }, { ID => 'dv_user' });

  return 1;
}

#**********************************************************
=head2 dv_user_error($Dv) last user suth

=cut
#**********************************************************
sub dv_user_error {
  my ($Dv_) = @_;

  if ($conf{DV_SKIP_SHOW_QUICK_ERRORS}) {
    return '';
  }

  my $message = '';

  my $error_logs = $Log->log_list({COLS_NAME => 1,
                                   LOGIN     => ($conf{DV_LOGIN} && $Dv_->{DV_LOGIN}) ? $Dv_->{DV_LOGIN} : $ui->{LOGIN},
                                   SORT      => 'date',
                                   DESC      => 'DESC',
                                   PAGE_ROWS => 1
                                  });

  if ($Log->{TOTAL}) {
    if($error_logs->[0]->{log_type} > 4){
      $message = $html->message('info', '', "$lang{LAST_AUTH} $lang{DATE} $error_logs->[0]->{date} $error_logs->[0]->{message}", {OUTPUT2RETURN => 1});
    }
    else{
      $message .= $html->message('err', "$lang{LAST_AUTH} $lang{DATE} $error_logs->[0]->{date} $error_logs->[0]->{message}", '', {OUTPUT2RETURN => 1});
      $error_logs = $Log->log_list({COLS_NAME => 1,
                                    LOGIN     => ($conf{DV_LOGIN} && $Dv_->{DV_LOGIN}) ? $Dv_->{DV_LOGIN} : $ui->{LOGIN},
                                    LOG_TYPE  => 6,
                                    SORT      => 'date',
                                    DESC      => 'DESC',
                                    PAGE_ROWS => 1
                                    });
      if($Log->{TOTAL}) {
        $message .= $html->message('info', '', "$lang{LAST_SUCCES_AUTH} $error_logs->[0]->{date} $error_logs->[0]->{message}", {OUTPUT2RETURN => 1});
      }
    }
  }

  return $message;
}


#**********************************************************
=head2 dv_get_static_ip($pool_id) - Get static ip from pool

  Arguments:
    $pool_id   - IP pool ID

  Returns:
    IP address

=cut
#**********************************************************
sub dv_get_static_ip {
  my ($pool_id) = @_;
  my $ip = '0.0.0.0';

  $Nas->ip_pools_info($pool_id);

  if($Nas->{errno}) {
    $html->message('err', $lang{ERROR}, "[$Nas->{errno}] $err_strs{$Nas->{errno}} $Nas->{errstr}");
    return '0.0.0.0';
  }

  my $start_ip = ip2int($Nas->{IP});
  my $end_ip   = $start_ip + $Nas->{COUNTS};

  my %users_ips = ();

  my $list = $Dv->list(
    {
      PAGE_ROWS => 100000,
      IP        => ">=$Nas->{IP}",
      SKIP_GID  => 1,
      COLS_NAME => 1
    }
  );

  foreach my $line (@$list) {
    $users_ips{ $line->{ip} } = 1;
  }

  for (my $ip_cur = $start_ip ; $ip_cur <= $end_ip ; $ip_cur++) {
    if (! $users_ips{ int2ip($ip_cur) }) {
      return int2ip($ip_cur);
    }
  }

  $html->message('err', $lang{ERROR}, "$lang{ERR_NO_FREE_IP_IN_POOL}");

  return $ip;
}

#**********************************************************
=head2 dv_tp()  -Tarif plans

=cut
#**********************************************************
sub dv_tp {

  my $tarif_info;
  my @Octets_Direction = ("$lang{RECV} + $lang{SEND}", $lang{RECV}, $lang{SEND});

  my %payment_types = ( 0 => $lang{PREPAID},
                        1 => $lang{POSTPAID},
                        2 => $lang{GUEST}
                      );

  my %bool_hash     = (0 => $lang{NO},
                       1 => $lang{YES}
                      );

  $tarif_info               = $Tariffs->defaults();
  $tarif_info->{LNG_ACTION} = $lang{ADD};
  $tarif_info->{ACTION}     = 'ADD_TP';

  if (! $FORM{TP_ID} && $FORM{chg}) {
    $FORM{TP_ID} = $FORM{chg};
  }

  if ($FORM{ADD_TP}) {
    $FORM{TP_ID} = $FORM{CHG_TP_ID};
    $Tariffs->add({ %FORM, MODULE => 'Dv' });
    if (!$Tariffs->{errno}) {
      $html->message('info', $lang{ADDED}, "$lang{NAME}: $FORM{NAME}\n".
      $html->button($lang{INTERVALS}, 'index='. get_function_index('form_intervals')."&TP_ID=$Tariffs->{INSERT_ID}", { BUTTON => 1 }));
    }
  }
  elsif (defined($FORM{TP_ID})) {
    $Dv->account_check();
    if(_error_show($Dv)) {
      return 1;
    }

    $tarif_info = $Tariffs->info($FORM{TP_ID}, { ID => $FORM{TP_NUM} });

    if (_error_show($Tariffs, { ID => 950, MESSAGE => " TP ID: $FORM{TP_ID} " })) {
      return 0;
    }
    elsif(! $index ) {
      return 0;
    }

    $pages_qs   .= "&TP_ID=$tarif_info->{TP_ID}". (($FORM{subf}) ? "&subf=$FORM{subf}" : '');
    $FORM{TP_NUM}= $tarif_info->{ID};
    my %F_ARGS   = (TP => $tarif_info);

    $Tariffs->{NAME_SEL} = $html->form_main(
      {
        CONTENT => $html->form_select(
          'TP_ID',
          {
            SELECTED  => $tarif_info->{TP_ID},
            SEL_LIST  => $Tariffs->list({%LIST_PARAMS, MODULE => 'Dv', NEW_MODEL_TP => 1, COLS_NAME => 1 }),
            SEL_KEY   => 'tp_id',
            SEL_VALUE => 'id,name',
            NO_ID     => 1
          }
        ),
        HIDDEN => { index => $index },
        SUBMIT => { show  => $lang{SHOW} },
        class  => 'navbar-form navbar-right',
      }
    );

    $index = get_function_index('dv_tp');
    $LIST_PARAMS{TP_ID} = $FORM{TP_ID};
    func_menu(
      {
        $lang{NAME} => $Tariffs->{NAME_SEL}
      },
      [
        $lang{INFO}     . "::TP_ID=$FORM{TP_ID}",
        $lang{INTERVALS}. ':'. get_function_index('form_intervals').":TP_ID=$FORM{TP_ID}",
        $lang{NAS}      . ':'. get_function_index('form_nas_allow').":TP_ID=$FORM{TP_ID}",
        $lang{USERS}    . ':'. get_function_index('dv_users_list').":TP_ID=$FORM{TP_ID}"
       ],
      { f_args => \%F_ARGS }
    );

    if ($FORM{subf}) {
      return 0;
    }
    elsif ($FORM{change}) {
      $Tariffs->change($FORM{TP_ID}, {%FORM});
      if (!$Tariffs->{errno}) {
        $html->message('info', $lang{CHANGED}, "$lang{CHANGED} $Tariffs->{ID}");
      }
    }

    $tarif_info->{LNG_ACTION} = $lang{CHANGE};
    $tarif_info->{ACTION}     = 'change';
    $FORM{add_form}=1;
  }
  elsif (defined($FORM{del}) && $FORM{COMMENTS}) {
    $Tariffs->del($FORM{del});

    if (!$Tariffs->{errno}) {
      $html->message('info', $lang{DELETED}, "$lang{DELETED} $FORM{del}");
    }
  }

  if (_error_show($Tariffs, { MESSAGE => "$lang{TARIF_PLAN}" })) {
    $FORM{add_form}=1;
  }

  if ($FORM{add_form} || $FORM{chg}) {
    $tarif_info->{SEL_OCTETS_DIRECTION} = $html->form_select(
      'OCTETS_DIRECTION',
      {
        SELECTED     => $tarif_info->{OCTETS_DIRECTION},
        SEL_ARRAY    => \@Octets_Direction,
        ARRAY_NUM_ID => 1
      }
    );

    $tarif_info->{PAYMENT_TYPE_SEL} = $html->form_select(
      'PAYMENT_TYPE',
      {
        SELECTED   => $tarif_info->{PAYMENT_TYPE},
        SEL_HASH   => \%payment_types,
        #ARRAY_NUM_ID => 1
      }
    );

    $tarif_info->{GROUPS_SEL} = $html->form_select(
      'TP_GID',
      {
        SELECTED       => $tarif_info->{TP_GID},
        SEL_LIST       => $Tariffs->tp_group_list({ COLS_NAME => 1 }),
        MAIN_MENU      => get_function_index('form_tp_groups'),
        MAIN_MENU_AGRV => "chg=$tarif_info->{TP_GID}",
        SEL_OPTIONS    => { '' => '' },
      }
    );

    my $nas_ip_pools_list = $Nas->ip_pools_list({ STATIC => 0, COLS_NAME => 1 });

    $tarif_info->{IP_POOLS_SEL} = $html->form_select(
      'IPPOOL',
      {
        SELECTED       => $tarif_info->{IPPOOL},
        SEL_LIST       => $nas_ip_pools_list,
        SEL_KEY        => 'id',
        SEL_VALUE      => 'name',
        SEL_OPTIONS    => { '' => '' },
        MAIN_MENU      => get_function_index('form_ip_pools'),
        MAIN_MENU_AGRV => "chg=$tarif_info->{IPPOOL}",
      }
    );

    $tarif_info->{NEG_DEPOSIT_IPPOOL_SEL} = $html->form_select(
      'NEG_DEPOSIT_IPPOOL',
      {
        SELECTED   => $tarif_info->{NEG_DEPOSIT_IPPOOL},
        SEL_LIST   => $nas_ip_pools_list,
        SEL_KEY    => 'id',
        SEL_VALUE  => 'name',
        SEL_OPTIONS=> { '' => '' },
        MAIN_MENU      => get_function_index('form_ip_pools'),
        MAIN_MENU_AGRV => "chg=$tarif_info->{NEG_DEPOSIT_IPPOOL}",
      }
    );

    $tarif_info->{REDUCTION_FEE}      = ($tarif_info->{REDUCTION_FEE})      ? 'checked' : '';
    $tarif_info->{POSTPAID_DAY_FEE}   = ($tarif_info->{POSTPAID_DAY_FEE})   ? 'checked' : '';
    $tarif_info->{POSTPAID_MONTH_FEE} = ($tarif_info->{POSTPAID_MONTH_FEE}) ? 'checked' : '';
    $tarif_info->{PERIOD_ALIGNMENT}   = ($tarif_info->{PERIOD_ALIGNMENT})   ? 'checked' : '';
    $tarif_info->{ABON_DISTRIBUTION}  = ($tarif_info->{ABON_DISTRIBUTION})  ? 'checked' : '';
    $tarif_info->{ACTIVE_DAY_FEE}     = ($tarif_info->{ACTIVE_DAY_FEE})     ? 'checked' : '';
    $tarif_info->{FIXED_FEES_DAY}     = ($tarif_info->{FIXED_FEES_DAY})     ? 'checked' : '';

    my %FEES_METHODS = %{ get_fees_types() };
    $FEES_METHODS{0} = '';

    $tarif_info->{SEL_METHOD} = $html->form_select(
      'FEES_METHOD',
      {
        SELECTED => $tarif_info->{FEES_METHOD} || 1,
        SEL_HASH => \%FEES_METHODS,
        NO_ID    => 1,
        SORT_KEY => 1,
        MAIN_MENU => get_function_index('form_fees_types'),
      }
    );

    my $tp_list = $Tariffs->list({ MODULE       => 'Dv',
                                   DOMAIN_ID    => $admin->{DOMAIN_ID},
                                   NEW_MODEL_TP => 1,
                                   COLS_NAME    => 1
                                 });

    $tarif_info->{SMALL_DEPOSIT_ACTION_SEL} = $html->form_select(
      'SMALL_DEPOSIT_ACTION',
      {
        SELECTED    => $tarif_info->{SMALL_DEPOSIT_ACTION} || 0,
        SEL_LIST    => $tp_list,
        SEL_OPTIONS => { 0 => '--', '-1' => "$lang{HOLD_UP}" },
      }
    );

    $tarif_info->{NEXT_TARIF_PLAN_SEL} = $html->form_select(
      'NEXT_TARIF_PLAN',
      {
        SELECTED     => $tarif_info->{NEXT_TARIF_PLAN},
        SEL_LIST     => $tp_list,
        SEL_OPTIONS  => { '' => '', '-1' => "$lang{HOLD_UP}" },
      }
    );

    if ($conf{BONUS_EXT_FUNCTIONS}) {
      my @BILL_ACCOUNT_PRIORITY = (
        "$lang{PRIMARY} $lang{BILL_ACCOUNT}",
        "$lang{EXTRA} $lang{BILL_ACCOUNT}, $lang{PRIMARY} $lang{BILL_ACCOUNT}",
        "$lang{EXTRA} $lang{BILL_ACCOUNT}"
      );

      $tarif_info->{BILLS_PRIORITY_SEL} = $html->form_select(
        'BILLS_PRIORITY',
        {
          SELECTED     => $tarif_info->{BILLS_PRIORITY},
          SEL_ARRAY    => \@BILL_ACCOUNT_PRIORITY,
          ARRAY_NUM_ID => 1
        }
      );

      $tarif_info->{BONUS} = $html->tpl_show(_include('bonus_tp_row', 'Bonus'), $tarif_info, { OUTPUT2RETURN => 1 });
    }

    if ($conf{EXT_BILL_ACCOUNT}) {
      my $checked = ($tarif_info->{EXT_BILL_ACCOUNT}) ? ' checked' : '';
      $tarif_info->{EXT_BILL_ACCOUNT} = "<tr><td>$lang{EXTRA} $lang{BILL}:</td><td><input type='checkbox' name='EXT_BILL_ACCOUNT' value='1' $checked></td></tr>\n";
    }
    else {
      $tarif_info->{EXT_BILL_ACCOUNT} = '';
    }

    $html->tpl_show(_include('dv_tp', 'Dv'), $tarif_info, { SKIP_VARS => 'IP' });
  }

  $LIST_PARAMS{NEW_MODEL_TP}=1;
  $LIST_PARAMS{MODULE}='Dv';
  $Tariffs->{COL_NAMES_ARR} = undef;
  delete($LIST_PARAMS{TP_ID});

  my Abills::HTML $table;
  my $list;
  ($table, $list) = result_former({
     INPUT_DATA      => $Tariffs,
     FUNCTION        => 'list',
     BASE_FIELDS     => 2,
     DEFAULT_FIELDS  => 'ID,NAME,TIME_TARIFS,TRAF_TARIFS,PAYMENT_TYPE,DAY_FEE,MONTH_FEE',
     FUNCTION_FIELDS => 'intervals,change,del',
     EXT_TITLES      => {
       id                      => $lang{NUM},
       name                    => $lang{NAME},
       time_tarifs             => $lang{HOUR_TARIF},
       traf_tarifs             => $lang{TRAFIC_TARIFS},
       tp_gid                  => $lang{GROUP},
       uplimit                 => $lang{UPLIMIT},
       logins                  => $lang{SIMULTANEOUSLY},
       day_fee                 => $lang{DAY_FEE},
       active_day_fee          => $lang{ACTIVE_DAY_FEE},
       postpaid_day_fee        => "$lang{DAY_FEE} $lang{POSTPAID}",
       month_fee               => $lang{MONTH_FEE},
       postpaid_month_fee      => "$lang{MONTH_FEE} $lang{POSTPAID}",
       period_alignment        => $lang{MONTH_ALIGNMENT},
       abon_distribution       => $lang{ABON_DISTRIBUTION},
       fixed_fees_day          => $lang{FIXED_FEES_DAY},
       small_deposit_action    => $lang{SMALL_DEPOSIT_ACTION},
       reduction_fee           => $lang{REDUCTION},
       fees_method             => "$lang{FEES} $lang{TYPE}",
       day_time_limit          => "$lang{TIME_LIMIT} $lang{DAY}",
       week_time_limit         => "$lang{TIME_LIMIT} $lang{WEEK}",
       month_time_limit        => "$lang{TIME_LIMIT} $lang{MONTH}",
       total_time_limit        => "$lang{TIME_LIMIT} $lang{TOTAL}",
       day_traf_limit          => "$lang{TRAF_LIMIT} $lang{DAY}",
       week_traf_limit         => "$lang{TRAF_LIMIT} $lang{WEEK}",
       month_traf_limit        => "$lang{TRAF_LIMIT} $lang{MONTH}",
       total_traf_limit        => "$lang{TRAF_LIMIT} $lang{TOTAL}",
       octets_direction        => $lang{OCTETS_DIRECTION},
       activ_price             => $lang{ACTIVATE},
       change_price            => $lang{CHANGE},
       credit_tresshold        => $lang{CREDIT_TRESSHOLD},
       credit                  => $lang{CREDIT},
       user_credit_limit       => "$lang{USER_PORTAL} $lang{CREDIT}",
       max_session_duration    => "$lang{MAX_SESSION_DURATION} (sec.)",
       filter_id               => $lang{FILTERS},
       age                     => "$lang{AGE} ($lang{DAYS})",
       payment_type            => $lang{PAYMENT_TYPE},
       min_session_cost        => $lang{MIN_SESSION_COST},
       min_use                 => $lang{MIN_USE},
       traffic_transfer_period => $lang{TRAFFIC_TRANSFER_PERIOD},
       neg_deposit_filter_id   => $lang{NEG_DEPOSIT_FILTER_ID},
       neg_deposit_ippool      => $lang{NEG_DEPOSIT_IP_POOL},
       priority                => $lang{PRIORITY},
       fine                    => $lang{FINE},
       next_tarif_plan         => "$lang{TARIF_PLAN} $lang{NEXT_PERIOD}",
       rad_pairs               => "RADIUS Parameters (,)",
       comments                => "$lang{DESCRIBE}",
       inner_tp_id             => 'ID',

       in_speed                =>  "$lang{SPEED} $lang{RECV}",
       out_speed               =>  "$lang{SPEED} $lang{SENT}",
       prepaid                 =>  "$lang{PREPAID}",
       in_price                =>  "$lang{PRICE} $lang{RECV}",
       out_price               =>  "$lang{PRICE} $lang{SENT}",
       intervals               =>  $lang{INTERVALS}
     },
     SKIP_USER_TITLE => 1,
     SELECT_VALUE    => {
        time_tarifs  => \%bool_hash,
        traf_tarifs  => \%bool_hash,
        payment_type => \%payment_types,
     },
     TABLE           => {
       width      => '100%',
       caption    => "$lang{TARIF_PLAN}",
       border     => 1,
       qs         => $pages_qs,
       ID         => 'DV_TARIF_PLANS',
       MENU       => "$lang{ADD}:index=$index&add_form=1:add",
       EXPORT     => 1,
     },
     #MAKE_ROWS    => 1,
     MODULE       => 'Dv',
     #TOTAL        => 1
  });


  foreach my $line (@$list) {
    my $delete;
    my $change;
    if ($permissions{4}{1}) {
      $delete = $html->button($lang{DEL}, "index=$index&del=$line->{tp_id}", { MESSAGE => "$lang{DEL} $line->{id} $line->{name}?", class => 'del' });
      $change = $html->button($lang{CHANGE}, "index=$index&TP_ID=$line->{tp_id}", { class => 'change' });
    }

    if ($FORM{TP_ID} && $FORM{TP_ID} eq $line->{tp_id}) {
      $table->{rowcolor} = 'success';
    }
    else {
      undef($table->{rowcolor});
    }

    my @fields_array = ();
    for (my $i = 0; $i < 2+$Tariffs->{SEARCH_FIELDS_COUNT}; $i++) {
      if ($Tariffs->{COL_NAMES_ARR}->[$i] =~ /time_tarifs|traf_tarifs|abon_distribution|period_alignment|fixed_fees_day/) {
        $line->{$Tariffs->{COL_NAMES_ARR}->[$i]} = $bool_hash{$line->{$Tariffs->{COL_NAMES_ARR}->[$i]}};
      }
      elsif ($Tariffs->{COL_NAMES_ARR}->[$i] =~ /small_deposit_action/) {
        $line->{$Tariffs->{COL_NAMES_ARR}->[$i]} = ($line->{$Tariffs->{COL_NAMES_ARR}->[$i]} == -1) ? $lang{HOLD_UP} : $payment_types{$line->{$Tariffs->{COL_NAMES_ARR}->[$i]}};
      }
      elsif($Tariffs->{COL_NAMES_ARR}->[$i] =~ /name/) {
        $line->{name} = $html->button($line->{name}, "index=$index&TP_ID=$line->{tp_id}");
      }
      elsif ($Tariffs->{COL_NAMES_ARR}->[$i] =~ /payment_type/) {
        $line->{$Tariffs->{COL_NAMES_ARR}->[$i]} = $payment_types{$line->{$Tariffs->{COL_NAMES_ARR}->[$i]}};
      }

      push @fields_array, $line->{$Tariffs->{COL_NAMES_ARR}->[$i]};
    }

    $table->addrow(
      @fields_array,
      $html->button($lang{INTERVALS}, "index=". get_function_index('form_intervals') ."&TP_ID=$line->{tp_id}", { class => 'interval' }),
      $change,
      $delete
    );
  }

  print $table->show();

  $table = $html->table(
    {
      width      => '100%',
      cols_align => [ 'right', 'right' ],
      rows       => [ [ "$lang{TOTAL}:", $html->b($Tariffs->{TOTAL}) ] ]
    }
  );

  print $table->show();
  system_info();
  return 1;
}

#**********************************************************
=head2 dv_rating_tp($attr)

=cut
#**********************************************************
sub dv_rating_tp {
  my ($attr) = @_;

  eval { require Bonus_rating; };
  if (!$@) {
    Bonus_rating->import();
  }
  else {
    $html->message('err', $lang{ERROR}, "Can't load 'Bonus_rating'. Purchase this module http://abills.net.ua");
    return 0;
  }

  my $Bonus_rating = Bonus_rating->new($db, $admin, \%conf);

  if (defined($attr->{TP})) {
    if ($FORM{change}) {
      $Bonus_rating->change({%FORM});

      if (!$Bonus_rating->{errno}) {
        $html->message('info', $lang{INFO}, "$lang{CHANGED}");
      }
    }
  }
  elsif (defined($FORM{TP_ID})) {
    $FORM{subf} = $index;
    dv_tp();
    return 0;
  }

  _error_show($Bonus_rating);

  $Bonus_rating->info($FORM{TP_ID});

  my $tp_list = $Tariffs->list({ MODULE       => 'Dv',
                                 DOMAIN_ID    => $admin->{DOMAIN_ID},
                                 NEW_MODEL_TP => 1,
                                 COLS_NAME    => 1
                               });

  $Bonus_rating->{RATING_ACTION_SEL} = $html->form_select(
    'RATING_ACTION',
    {
      SELECTED    => $Bonus_rating->{RATING_ACTION},
      SEL_LIST    => $tp_list,
      SEL_KEY     => 'tp_id',
      SEL_VALUE   => 'id,name',
      SEL_OPTIONS => { '' => "", '-1' => "$lang{HOLD_UP}" },
      NO_ID       => 1
    }
  );

  $Bonus_rating->{ACTION}           = 'change';
  $Bonus_rating->{LNG_ACTION}       = "$lang{CHANGE}";
  $Bonus_rating->{EXT_BILL_ACCOUNT} = "checked" if ($Bonus_rating->{EXT_BILL_ACCOUNT});

  $html->tpl_show(_include('dv_rating_tp', 'Dv'), $Bonus_rating);

  return 1;
}

#**********************************************************
=head2 dv_rating_periodic($attr)

=cut
#**********************************************************
sub dv_rating_periodic {
  my ($attr) = @_;

  my $debug = $attr->{DEBUG} || 0;
  my $debug_output = '';
  $debug_output .= "DV: Make ratings\n" if ($debug > 1);

  eval { require Bonus_rating; };
  if (!$@) {
    Bonus_rating->import();
  }
  else {
    print "Can't load 'Bonus_rating'. Purchase this module http://abills.net.ua";
    return 0;
  }

  my %LIST_PARAMS = (PAGE_ROWS => 1000000);
  $LIST_PARAMS{LOGIN} = $attr->{LOGIN} if ($attr->{LOGIN});
  $LIST_PARAMS{TP_ID} = $attr->{TP_ID} if ($attr->{TP_ID});

  my $Bonus_rating = Bonus_rating->new($db, $admin, \%conf);

  $Bonus_rating->change_users_rating({%LIST_PARAMS});

  #Change Tps
  my $list = $Bonus_rating->change_users_tps_list({%LIST_PARAMS, COLS_NAME => 1 });

  foreach my $line (@$list) {
    $debug_output .= "UID: $line->{uid} TP: $line->{old_tp_id} -> $line->{tp_id}\n" if ($debug > 0);
    $Dv->change(
      {
        UID            => $line->{uid},
        TP_ID          => $line->{tp_id},
        NO_CHANGE_FEES => 1,
      }
    );

  }

  $DEBUG .= $debug_output;
  return $debug_output;
}

#**********************************************************
#
#**********************************************************
sub dv_rating_user {

  eval { require Bonus_rating; };
  if (!$@) {
    Bonus_rating->import();
  }
  else {
    print "Can't load 'Bonus_rating'. Purchase this module http://abills.net.ua";
    return 0;
  }

  my $Bonus_rating = Bonus_rating->new($db, $admin, \%conf);
  $users = $user if (!$users);

  $Bonus_rating->users_rating_info({ UID => $LIST_PARAMS{UID} });

  if ($Bonus_rating->{TOTAL} == 0) {
    $html->message('info', $lang{INFO}, "$lang{BONUS} $lang{NOT_ACTIVE}");
    return 0;
  }

  if ($FORM{UP_RATING_PRE}) {
    my $need_percents = int(($FORM{UP_RATING} - $Bonus_rating->{RATING_PER}));
    $FORM{NEED_SUM} = sprintf("%.2f", $need_percents * ($Bonus_rating->{ONE_PERCENT_SUM} * $Bonus_rating->{ONE_PERCENT_COUNT}));

    $html->tpl_show(_include('dv_user_rating_pre', 'Dv'), { %$Bonus_rating, %FORM });
    return 0;
  }
  elsif ($FORM{UP_RATING}) {
    my $need_percents = int(($FORM{UP_RATING} - $Bonus_rating->{RATING_PER}));
    my $need_sum = $need_percents * ($Bonus_rating->{ONE_PERCENT_SUM} * $Bonus_rating->{ONE_PERCENT_COUNT});

    if ($users->{CREDIT} + $users->{DEPOSIT} < $need_sum) {
      $html->message('err', $lang{ERROR}, "$lang{ERR_SMALL_DEPOSIT}", {  });
    }
    else {
      for (my $i = 0 ; $i < int($need_percents * $Bonus_rating->{ONE_PERCENT_COUNT}) ; $i++) {
        $Fees->take($users, $Bonus_rating->{ONE_PERCENT_SUM}, { DESCRIBE => "$lang{RATING_UP}" });
        $users->{DEPOSIT} -= $Bonus_rating->{ONE_PERCENT_SUM};
      }
      $Bonus_rating->{RATING_PER} = $FORM{UP_RATING};
      $html->message('info', $lang{INFO}, "$lang{UP_RATING} $FORM{UP_RATING}");

      $users->pi_change({ _rating => $Bonus_rating->{RATING_PER}, UID => $LIST_PARAMS{UID} });
    }
  }

  $Bonus_rating->{UP_RATING} = int(($users->{CREDIT} + $users->{DEPOSIT}) / ($Bonus_rating->{ONE_PERCENT_SUM} * $Bonus_rating->{ONE_PERCENT_COUNT})) + $Bonus_rating->{RATING_PER};

  if ($Bonus_rating->{UP_RATING} > 100) {
    $Bonus_rating->{UP_RATING} = 100;
  }
  elsif ($Bonus_rating->{UP_RATING} < 0) {
    $Bonus_rating->{UP_RATING} = 0;
  }

  $Bonus_rating->{ONE_PERCENT_SUM} = sprintf("%.2f", $Bonus_rating->{ONE_PERCENT_SUM} * $Bonus_rating->{ONE_PERCENT_COUNT});

  $html->tpl_show(_include('dv_user_rating', 'Dv'), $Bonus_rating);

  return 1;
}


#**********************************************************
=head2 dv_online() - Show online sessions

=cut
#**********************************************************
sub dv_online {

  my $message;
  if ($FORM{ping}) {
    if ($FORM{ping} eq '0.0.0.0' && $FORM{SESSION_ID}) {
      $Sessions->online_info( { ACCT_SESSION_ID  => $FORM{SESSION_ID}, NAS_ID => $FORM{NAS_ID} });
      $FORM{ping} = $Sessions->{FRAMED_IP_ADDRESS};
    }

    host_diagnostic($FORM{ping});
  }
  elsif($FORM{mac_info}) {
    my $result = get_oui_info($FORM{mac_info});
    $html->message('info', $lang{INFO}, "MAC: $FORM{mac_info}\n $result");
  }
  elsif ($FORM{hangup}) {
    my ($nas_id, $nas_port_id, $acct_session_id, $user_name) = split(/ |\+/, $FORM{hangup}, 4);

    $Nas->info({ NAS_ID => $nas_id });

    if (_error_show($Nas)) {
      return 0;
    }

    $Sessions->online_info( { ACCT_SESSION_ID  => $acct_session_id, NAS_ID => $nas_id });

    require Abills::Nas::Control;
    Abills::Nas::Control->import();

    my $Nas_cmd = Abills::Nas::Control->new($db, \%conf);
    my $ret = $Nas_cmd->hangup(
      $Nas,
      $nas_port_id || 0,
      $user_name || '',
      {
        DEBUG                => $FORM{DEBUG} || undef,
        ACCT_TERMINATE_CAUSE => 6,
        %$Sessions
      }
    );

    if ($ret == 0) {
      $message = "$lang{NAS} ID:  $nas_id\n $lang{NAS} IP: $Nas->{NAS_IP}\n $lang{PORT}: $nas_port_id\n SESSION_ID: $acct_session_id\n\n  $ret";
      sleep 3;
      $admin->action_add($FORM{UID}, "$user_name", { MODULE => 'Dv', TYPE => 15 });
    }
    elsif ($ret == 1) {
      $message = "$Nas->{NAS_TYPE}  -NAS NOT supported yet ";
    }

    $html->message('info', $lang{INFO}, "$message $ret");
  }
  elsif ($FORM{diagnostic}) {
    my ($diag_num,$diag_params) = split(/:/, $FORM{diagnostic}, 2);
    my ($ip, $uid, $nas_id, undef, $acct_session_id) = split(/ /, $diag_params);

    my ($name, $cmd);
    my @diagnostic_rules = split(/;/, $conf{DV_EXTERNAL_DIAGNOSTIC});
    for(my $i=0; $i<=$#diagnostic_rules; $i++) {
      ($name, $cmd)=split(/:/, $diagnostic_rules[$i]);
      if ($i == $diag_num) {
        last;
      }
    }

    my $ACCT_INFO = $Sessions->online_info(
        {
          NAS_ID            => $nas_id,
          ACCT_SESSION_ID   => $acct_session_id,
          UID               => $uid,
          FRAMED_IP_ADDRESS => $ip
        }
    );

    my $res = cmd($cmd,
                  { PARAMS => $ACCT_INFO,
                    SET_ENV=> 1
                   });

    print $html->message('info', $lang{DIAGNOSTIC} .' '. ($name || q{}), $res);
  }

  if ($FORM{zapall}) {
    $Sessions->zap(0, 0, 0, { ALL => 1, %FORM });
    $html->message('info', $lang{INFO}, "Zapped all sessions");
  }
  elsif ($FORM{zap}) {
    my ($uid, $nas_id, $nas_port_id, $acct_session_id) = split(/ /, $FORM{zap}, 4);
    $Sessions->zap($nas_id, $nas_port_id, $acct_session_id, {%FORM});

    if (_error_show($Sessions)) {
      return 0;
    }

    $Nas->info({ NAS_ID => $nas_id });
    $message = "\n$lang{NAS} ID:   $nas_id\n $lang{NAS} IP: $Nas->{NAS_IP}\n $lang{PORT}: $nas_port_id\n SESSION_ID: $acct_session_id\n\n";
    my ($Y, $M, undef) = split(/-/, $DATE, 3);
    $Sessions->list(
      {
        UID             => $uid,
        DATE            => ">=$Y-$M-01",
        ACCT_SESSION_ID => $acct_session_id,
        NAS_PORT        => $nas_port_id,
        NAS_ID          => $Nas->{NAS_ID},
        PAGE_ROWS       => 1
      }
    );

    if ($Sessions->{TOTAL} < 1) {
      $message .= $html->button('Add To log', "index=$index&tolog=$acct_session_id&nas_id=$nas_id&nas_port_id=$nas_port_id&ZAPED=1", { BUTTON => 1 }) . ' ' . $html->button($lang{DEL}, "index=$index&del=$acct_session_id&nas_id=$nas_id&nas_port_id=$nas_port_id&ZAPED=1", { BUTTON => 1 });
    }
    else {
      $message .= "$lang{EXIST}";
      $Sessions->online_del(
        {
          NAS_ID          => $nas_id,
          NAS_PORT        => $nas_port_id,
          ACCT_SESSION_ID => $acct_session_id
        }
      );
    }

    $html->message('info', $lang{INFO}, $message);
  }
  elsif ($FORM{tolog}) {
    $FORM{IDS}=~s/\s+//g if ($FORM{IDS});
    require Acct;
    Acct->import();
    my $Acct = Acct->new($db, \%conf);

    $Sessions->online(
      {
        ACCT_SESSION_ID   => '_SHOW',
        ACCT_SESSION_ID   => $FORM{IDS} || $FORM{tolog},
        ZAPED             => 1,
        ACCT_INPUT_OCTETS => '_SHOW',
        ACCT_OUTPUT_OCTETS=> '_SHOW',
        EX_INPUT_OCTETS   => '_SHOW',
        EX_OUTPUT_OCTETS  => '_SHOW',
        ACCT_SESSION_TIME => '_SHOW',
        NAS_PORT_ID       => $FORM{nas_port_id} || '_SHOW',
        NAS_IP            => '_SHOW',
        CLIENT_IP         => '_SHOW',
        CONNECT_INFO      => '_SHOW',
        CID               => '_SHOW',
        USER_NAME         => '_SHOW',
        SESSION_START     => '_SHOW',
        NAS_ID            => $FORM{nas_id},
      }
    );

    my $online_list = $Sessions->{nas_sorted};
    my $nas_list    = $Nas->list({ COLS_NAME => 1, COLS_UPPER => 1 });
    my @results     = ();
    my @added       = ();
    my $ACCT_INFO;

    foreach my $nas_row (@$nas_list) {
      next if (!defined($online_list->{ $nas_row->{NAS_ID} }));
      foreach my $line (@{ $online_list->{ $nas_row->{NAS_ID} } }) {
        push @added, $line->{acct_session_id};

        $ACCT_INFO->{INBYTE}               = $line->{acct_input_octets};
        $ACCT_INFO->{OUTBYTE}              = $line->{acct_output_octets};
        $ACCT_INFO->{INBYTE2}              = $line->{ex_input_octets};
        $ACCT_INFO->{OUTBYTE2}             = $line->{ex_output_octets};
        $ACCT_INFO->{'Acct-Session-Time'}  = $line->{acct_session_time};
        $ACCT_INFO->{'Acct-Session-Id'}    = $line->{acct_session_id};
        $ACCT_INFO->{'NAS-Port'}           = $line->{nas_port_id};
        $ACCT_INFO->{'Nas-IP-Address'}     = $nas_row->{nas_ip};
        $ACCT_INFO->{'Framed-IP-Address'}  = $line->{client_ip};
        $ACCT_INFO->{'Connect-Info'}       = $line->{connect_info};
        $ACCT_INFO->{'Calling-Station-Id'} = $line->{calling_station_id};
        $ACCT_INFO->{'User-Name'}          = $line->{user_name};
        $ACCT_INFO->{SESSION_START}        = $line->{session_start};
        $ACCT_INFO->{'Acct-Terminate-Cause'} = 3;
        $ACCT_INFO->{'Acct-Status-Type'}     = 'Stop';

        $Acct->accounting($ACCT_INFO, $nas_row);

        push @results, "$ACCT_INFO->{'User-Name'} ($line->{acct_session_id}) ". (($Acct->{errno}) ? $lang{ERROR} : $lang{ADDED});
      }
    }

    $html->message('info', $lang{REPORTS}, join($html->br(), @results));
    $Sessions->online_del({ SESSIONS_LIST => \@added });
  }
  elsif ($FORM{del}) {
    if ($FORM{IDS}) {
      my @sessions_list = split(/, /, $FORM{IDS});
      $Sessions->online_del({ SESSIONS_LIST => \@sessions_list });
      $FORM{del} = $FORM{IDS};
    }
    else {
      $Sessions->online_del(
        {
          NAS_ID          => $FORM{nas_id},
          NAS_PORT        => $FORM{nas_port_id},
          ACCT_SESSION_ID => $FORM{del}
        }
      );
    }

    if (!_error_show($Sessions)) {
      my $table = $html->table(
        {
          width => '100%',
          rows  => [ [ "NAS_ID", $FORM{nas_id} ], [ "NAS_PORT", $FORM{nas_port_id} ], [ "ACCT_SESSION_ID", $FORM{del} ] ]
        }
      );

      #my $MODULE      = (defined($self->{MODULE})) ? $self->{MODULE} : '';
      #my $action_type = ($attr->{TYPE})            ? $attr->{TYPE}   : '';
      $html->message('info', $lang{DELETED}, $table->show());
    }
  }

  my $service_status = sel_status({ HASH_RESULT => 1 });

  # online count
  my $list     = $Sessions->online_count({ %LIST_PARAMS, COLS_NAME => 1 });

  my $nas_list = $Nas->list({ COLS_NAME => 1, PAGE_ROWS => 50000 });

  my $cure = '';
  if ($FORM{ZAPED}) {
    $LIST_PARAMS{ZAPED} = 1;
    $LIST_PARAMS{ACCT_SESSION_ID} = '_SHOW' if (! $LIST_PARAMS{ACCT_SESSION_ID});
    $cure = 'Zap';
    $pages_qs .= "&ZAPED=1";
  }
  else {
    $Sessions->{ZAPED} = 0 if (!$Sessions->{ZAPED});
    $cure = 'Online';
  }

  $html->short_info_panels_row(
    [
     {
       ID     => mk_unique_value(10),
       NUMBER => $Sessions->{ONLINE} || ' 0',
       NUMBER_SIZE => '40px',
       ICON   => 'plane',
       TEXT   => $html->button("Online", "index=$index"),
       COLOR  => 'green',
       SIZE   => 3
     },
     {
       ID          => mk_unique_value( 10 ),
       NUMBER      => $Sessions->{ZAPED} || ' 0',
       NUMBER_SIZE => '40px',
       ICON        => 'remove',
       TEXT        => $html->button( "$lang{ZAPED}", "index=$index&ZAPED=1" ),
       COLOR       => 'orange',
       SIZE        => 3
     }
    ]
  );

  if ($Sessions->{TOTAL} && $Sessions->{TOTAL} > 500 && ! $FORM{show_columns}) {
    my $table = $html->table(
      {
        width      => '100%',
        caption    => "Online $lang{TOTAL}",
        title      => [ "NAS ID", "NAS $lang{NAME}", "NAS IP", "$lang{TYPE}", "$lang{SESSIONS}", "$lang{USERS}", "ZAPPED", "$lang{ERROR}", "$lang{GUEST}", "-" ],
        cols_align => [ 'right', 'left', 'right', 'right', 'right', 'right', 'right', 'right', 'right', 'center:noprint' ],
        qs         => $pages_qs,
        ID         => 'ONLINE'
      }
    );

    foreach my $line (@$list) {
      $table->{rowcolor} = ($FORM{NAS_ID} && $line->{nas_id} == $FORM{NAS_ID}) ? 'row_active' : undef;
      $table->addrow($line->{nas_id}, $line->{nas_name}, $line->{nas_ip}, $line->{nas_type}, $line->{nas_total_sessions}, $line->{nas_total_users}, ($line->{nas_zaped} > 0) ? $html->button("$line->{nas_zaped}", "index=$index&NAS_ID=$line->{nas_id}&ZAPED=1") : 0,
      $html->button($line->{nas_error_sessions}, "index=$index&NAS_ID=$line->{nas_id}&NAS_ERROR_SESSIONS=1"),
      $html->button($line->{guest}, "index=$index&NAS_ID=$line->{nas_id}&FILTER=1&FILTER_FIELD=GUEST"),
      $html->button("$lang{SHOW}", "index=$index&NAS_ID=$line->{nas_id}", { class => 'show' }));
    }
    print $table->show();

    if (!$FORM{NAS_ID} && !$FORM{ZAPED} && !$FORM{FILTER}) {
      print dv_online_search();
      return 0;
    }
    elsif($FORM{NAS_ID}) {
      $pages_qs .= "&NAS_ID=$FORM{NAS_ID}";
      $LIST_PARAMS{NAS_ID} = $FORM{NAS_ID};
    }
  }

  if ($FORM{FILTER}) {
    $LIST_PARAMS{FILTER_FIELD}=$FORM{FILTER_FIELD};
    $LIST_PARAMS{FILTER}=$FORM{FILTER};
  }

  if($FORM{NAS_ERROR_SESSIONS}) {
    $LIST_PARAMS{NAS_ERROR_SESSIONS} = $FORM{NAS_ERROR_SESSIONS};
  }

  $Sessions->{debug}=1 if ($FORM{DEBUG} && $FORM{DEBUG} == 5);
  my %online_status = (
   0 => "(1) $lang{START}",
   1 => "(1) $lang{START}",
   2 => '(2) Zapped',
   3 => '(3) Alive',
   5 => '(5) Error 5',
   6 => '(6) Error 6',
   9 => '(9) Renew Session',
   10=> '(10) IPN without accounting',
   11=> '(11) IP reserved'
  );

  my Abills::HTML $table;
  ($table, $list) = result_former({
     INPUT_DATA      => $Sessions,
     FUNCTION        => 'online',
     DEFAULT_FIELDS  => 'LOGIN,FIO,NAS_PORT_ID,DURATION_SEC2,CLIENT_IP_NUM,ACCT_INPUT_OCTETS,ACCT_OUTPUT_OCTETS',
     BASE_FIELDS     => 0,
     FUNCTION_FIELDS => 'ping, zap, hangup, graphics',
     EXT_TITLES      => {
       'fio'         => $lang{FIO},
       'user_name'   => "RAD User-Name",
       'login'       => $lang{LOGIN},
       'nas_port_id' => $lang{PORT},
       'client_ip_num'=> 'IP',
       #'duration'    => $lang{DURATION},
       'duration_sec2'=> $lang{DURATION},
       'acct_input_octets'    => "$lang{SENT}",
       'acct_output_octets'   => "$lang{RECV}",
       'ex_input_octets'      => "Ex_IN",
       'ex_output_octets'     => "Ex_OUT",
       'nas_name'             => $lang{NAS},
       'acct_session_id'      => "SESSION_ID",
       'CONNECT_INFO'=> "CONNECT_INFO",
       'guest'       => $lang{GUEST},
       'turbo'       => 'TURBO',
       'ip'          => "$lang{STATIC} IP",
       'netmask'     => 'NETMASK',
       'speed'       => $lang{SPEED},
       'calls_tp_id' => 'Online TP_ID',
       'tp_id',      => 'TP_ID',
       #'port'        => "$lang{USER_PORT}",
       'CID'         => 'CID',
       'filter_id'   => 'Filter ID',
       'tp_name'     => $lang{TARIF_PLAN},
       'last_alive'  => $lang{LAST_UPDATE},
       'dv_status'   => "Internet $lang{STATUS}",
       'dv_expire'   => "Internet $lang{EXPIRE}",
       'session_sum' => "$lang{SESSIONS} $lang{SUM}",
       'status'      => "Online $lang{STATUS}"
     },
     FILTER_COLS  => {
       duration_sec    => 'sec2time_str',
       online_duration => 'sec2time_str',
       client_ip_num   => 'int2ip',
     },
     #SELECT_VALUE    => {
     #   status  => \%online_status,
     #},
     TABLE           => {
       width      => '100%',
       caption    => "$cure",
       SELECT_ALL => ($FORM{ZAPED}) ? "users_list:IDS:$lang{SELECT_ALL}" : undef,
       qs         => $pages_qs,
       ID         => 'DV_ONLINE',
       EXPORT     => 1,
     },
     SKIP_PAGES   => 1
  });

  my $dub_ports  = ($Sessions->{dub_ports}) ? $Sessions->{dub_ports} : undef;
  my $dub_logins = ($Sessions->{dub_logins}) ? $Sessions->{dub_logins} : undef;
  my $dub_ips    = ($Sessions->{dub_ips}) ? $Sessions->{dub_ips} : undef;
  my $online     = $Sessions->{nas_sorted};

  foreach my $nas_row (@$nas_list) {
    next if (!defined($online->{ $nas_row->{nas_id} }));
    next if (($FORM{NAS_ID} && $FORM{NAS_ID} != $nas_row->{nas_id}) && !$FORM{ZAPED});

    my $l     = $online->{ $nas_row->{nas_id} };
    my $total = $#{$l} + 1;
    $table->{rowcolor} = 'row_active';
    $table->{extra} = "colspan='" . ($Sessions->{SEARCH_FIELDS_COUNT} ) . "' class='small'";
    $table->addrow("$nas_row->{nas_id}:"
      . $html->button($html->b($nas_row->{nas_name}), "index=" . get_function_index('form_nas') . "&NAS_ID=$nas_row->{nas_id}")
      . ":$nas_row->{nas_ip}:$lang{TOTAL}: $total ("
      . $html->button("Zap $lang{SESSIONS}", "index=$index&zapall=1&NAS_ID=$nas_row->{nas_id}", { MESSAGE => "Do you realy want zap all sessions on NAS '$nas_row->{nas_id}' ?" }) . ') '
      . $html->button("$lang{ERROR}", "index=".get_function_index('dv_error')."&NAS_ID=$nas_row->{nas_id}&search_form=1&search=1") . ' '
      . $html->button("", "#", { IMG => ':chart_16.png', IMG_ALT => "$lang{GRAPH} $lang{NAS}", NEW_WINDOW => ((-f '../charts.cgi') ? dv_get_chart_query("NAS_ID=$nas_row->{nas_id}", '1', $chart_new_window_width, $chart_height) : "index.cgi?MODULE=grapher&qindex=-1"), NEW_WINDOW_SIZE => "$new_window_size" }));

    foreach my $line (@$l) {
      undef($table->{rowcolor});
      undef($table->{extra});

      if (defined($dub_logins->{ $line->{user_name} }) && $dub_logins->{ $line->{user_name} } > 1) {
        $table->{rowcolor} = '#FFFF00';
      }
      elsif ($nas_row->{nas_type} ne 'ipcad'
             && $nas_row->{nas_type} ne 'dhcp'
             && defined($line->{nas_port_id})
             && defined($nas_row->{nas_id})
             && defined($dub_ports->{ $nas_row->{nas_id} }{ $line->{nas_port_id} })
             && $dub_ports->{ $nas_row->{nas_id} }{ $line->{nas_port_id} } > 1) {
        $table->{rowcolor} = '#00FF40';
      }
      elsif ($line->{client_ip} && defined($dub_ips->{ $nas_row->{nas_id} }{ $line->{client_ip} }) && $dub_ips->{ $nas_row->{nas_id} }{ $line->{client_ip} } > 1) {
        $table->{rowcolor} = '#0080C0';
      }

      my @fields_array = ();
      if ($FORM{ZAPED}) {
        push @fields_array, $html->form_input('IDS', "$line->{acct_session_id}", { TYPE => 'checkbox', FORM_ID => 'users_list' });
      }

      for (my $i = 0; $i < $Sessions->{SEARCH_FIELDS_COUNT}; $i++) {
        my $val = '';
        my $col_name = $Sessions->{COL_NAMES_ARR}->[$i];
        if ($conf{EXT_BILL_ACCOUNT} && $Sessions->{COL_NAMES_ARR}->[$i] eq 'ext_bill_deposit') {
          $val = ($line->{ext_bill_deposit} < 0) ? $html->color_mark($line->{ext_bill_deposit}, $_COLORS[6]) : $line->{ext_bill_deposit};
        }
        elsif ($col_name eq 'deleted') {
          $val = $html->color_mark($bool_vals[ $line->{deleted} ], ($line->{deleted} == 1) ? $state_colors[ $line->{deleted} ] : '');
        }
        elsif ($col_name eq 'status') {
          $val = $online_status{  $line->{status} };
        }
        elsif ($col_name eq 'duration_sec2') {
          $val = sec2time_str($line->{duration_sec2});
        }
        elsif ($col_name eq 'client_ip_num') {
          $val = int2ip($line->{client_ip_num});
          $line->{client_ip}=$val;
        }
        elsif ($col_name eq 'dv_status') {
          if (defined($line->{dv_status})){
            my ($status, $color) = split( /:/, $service_status->{ $line->{dv_status} } );
            $val = $html->color_mark( $status, $color );
          }
          else {
            $val = '-';
          }
        }
        elsif ($col_name eq 'user_name' || $col_name eq 'login') {
          if ($line->{uid}) {
            $val = $html->button($line->{$Sessions->{COL_NAMES_ARR}->[$i]}, "index=15&UID=$line->{uid}");
          }
          else {
            $val = $line->{$Sessions->{COL_NAMES_ARR}->[$i]};
          }
        }
        elsif ($col_name =~ /acct_input_octets|acct_output_octets|ex_input_octets|ex_output_octets/) {
          $val = int2byte($line->{$Sessions->{COL_NAMES_ARR}->[$i]});
        }
        elsif($col_name eq 'CID') {
          if ($line->{$col_name}) {
            $val = $html->color_mark($line->{$col_name}, 'code');
            if ($line->{$col_name} =~ /$Abills::Filters::MAC/){
              $val .= ' ' . $html->button( $lang{INFO}, "index=$index&mac_info=$line->{CID}&UID=$line->{uid}",
                { class => 'info' } );
            }
          }
        }
        elsif ($col_name eq 'guest') {
          $val = ($line->{$col_name}) ? $html->color_mark($lang{YES}, "$_COLORS[6]") : $lang{NO};
        }
        else {
          $val =  $line->{$col_name};
        }

        if ($val && $FORM{FILTER} && $FORM{FILTER_FIELD} eq uc($col_name)) {
          my $filter = $FORM{FILTER};
          $filter=~s/\*//g;
          my $search_color_mark=$html->color_mark($filter, $_COLORS[6]);
          $val =~ s/(.*)$filter(.*)/$1$search_color_mark$2/i;
        }

        push @fields_array, $val;
      }

      $table->addrow(@fields_array,
         $html->button('P', "index=$index&ping=". int2ip($line->{client_ip_num}) ."&SESSION_ID=$line->{acct_session_id}$pages_qs",
           { TITLE => 'ping', BUTTON => 1 }),
         $html->button('Z', "index=$index&zap=$line->{uid}+$nas_row->{nas_id}+"
           . ($line->{nas_port_id} || q{}) ."+$line->{acct_session_id}$pages_qs",
           { TITLE => 'Zap', class => 'del', NO_LINK_FORMER => 1 }),
         ($FORM{ZAPED}) ? '' : $html->button('H', "index=$index&FRAMED_IP_ADDRESS="
            . ($line->{client_ip} || q{0.0.0.0})
            . "&hangup=$nas_row->{nas_id}+". ($line->{nas_port_id} || q{})
            . "+$line->{acct_session_id}+$line->{user_name}&UID=$line->{uid}$pages_qs",
           { TITLE => 'Hangup', class => 'off' }),
         $html->button("$lang{GRAPH} $lang{USER}", "#", { class => 'stats', NEW_WINDOW => ((-f '../charts.cgi') ? dv_get_chart_query("LOGIN=$line->{user_name}", '1', $chart_new_window_width, $chart_height) : "index.cgi?MODULE=grapher&qindex=-1"), NEW_WINDOW_SIZE => "$new_window_size" })
      );
    }
  }

  my $output = $table->show();

  if ($FORM{ZAPED}) {
    $output = $html->form_main(
      {
        CONTENT => $output,
        HIDDEN  => {
          index  => "$index",
          ZAPED  => 1,
          NAS_ID => $FORM{NAS_ID}
        },
        SUBMIT => {
          del   => "$lang{DEL}",
          tolog => "$lang{ADD} to LOG"
        },
        METHOD => 'POST',
        NAME   => 'users_list',
        ID     => 'users_list',
      }
    );
  }
  else {
    $output .= dv_online_search();

    $output .=
      $html->button('Zap All', "index=$index&zapall=1", { IMG => ':tech_work.png', MESSAGE => "Do you realy want ZAP all sessions ?" }) . ' '
    . $html->button("$lang{GRAPH} $lang{NAS}",         "#", { IMG => ':chart.png', NEW_WINDOW => ((-f '../charts.cgi') ? dv_get_chart_query('NAS_ID=all', '1', $chart_new_window_width, $chart_height)  : "index.cgi?MODULE=grapher&qindex=-1"), NEW_WINDOW_SIZE => "$new_window_size" }) . ' '
    . $html->button("$lang{GRAPH} $lang{TARIF_PLANS}", "#", { IMG => ':chart.png', NEW_WINDOW => ((-f '../charts.cgi') ? dv_get_chart_query('TP_ID=all', '1', $chart_new_window_width, $chart_height)   : "index.cgi?MODULE=grapher&qindex=-1"), NEW_WINDOW_SIZE => "$new_window_size" }) . ' '
    . $html->button("$lang{GRAPH} $lang{GROUPS}",      "#", { IMG => ':chart.png', NEW_WINDOW => ((-f '../charts.cgi') ? dv_get_chart_query('GID=all', '1', $chart_new_window_width, $chart_height)   : "index.cgi?MODULE=grapher&qindex=-1"), NEW_WINDOW_SIZE => "$new_window_size" });
  }

  print $output;

  return 1;
}


#**********************************************************
=head2 dv_online_search($attr)

=cut
#**********************************************************
sub dv_online_search {

  my %FILTER_FIELDS = (
      USER_NAME      => $lang{LOGIN},
      FIO            => $lang{FIO},
      NAS_PORT_ID    => $lang{PORT},
      DURATION       => $lang{DURATION},
      CLIENT_IP      => 'IP',
      CID            => 'CID',
      TP_ID          => $lang{TARIF_PLAN},
      CONNECT_INFO   => 'CONNECT_INFO',
      GUEST          => $lang{GUEST},
      TURBO_MODE     => $lang{TURBO_MODE},
      JOIN_SERVICE   => $lang{JOIN_SERVICE},
      ADDRESS_FULL   => $lang{ADDRESS},
      ACCT_SESSION_ID=> 'SESSION_ID',
      UID            => 'UID',
      LAST_ALIVE     => $lang{LAST_UPDATE}
  );

  my $FIELDS_SEL = $html->form_select(
      'FILTER_FIELD',
      {
        SELECTED => $FORM{FILTER_FIELD},
        SEL_HASH => \%FILTER_FIELDS,
        NO_ID    => 1
      }
    );

  return $html->form_main(
    {
      CONTENT => "$lang{FILTERS}: ". $html->form_input('FILTER', $FORM{FILTER}). " $lang{FIELDS}: ". $FIELDS_SEL . " $lang{REFRESH} (sec): ". $html->form_input('REFRESH', int($FORM{REFRESH} || 0), { SIZE => 4 }). $html->form_input('SHOW', $lang{SHOW}, { TYPE => 'SUBMIT' }),

      HIDDEN  => {
        index  => "$index",
        NAS_ID => $FORM{NAS_ID}
      },
      METHOD => 'GET',
      class  => 'form-inline'
    }
  );
}

#**********************************************************
=head2 dv_sessions($list, $sessions, $attr) - Whow sessions from log

=cut
#**********************************************************
sub dv_sessions {
  my ($list, $sessions, $attr) = @_;

  my $ACCT_TERMINATE_CAUSES = dv_terminate_causes({ REVERSE => 1 });

  if (! $sessions) {
    $sessions = Dv_Sessions->new($db, $admin, \%conf);
  }

  if (! $list || ref $list eq 'HASH') {
    $sessions->{SEL_NAS} = $html->form_select(
      'NAS_ID',
      {
        SELECTED       => $FORM{NAS_ID},
        SEL_LIST       => $Nas->list({%LIST_PARAMS, COLS_NAME => 1}),
        SEL_KEY        => 'nas_id',
        SEL_VALUE      => 'nas_name',
        MAIN_MENU      => get_function_index('form_nas'),
        MAIN_MENU_AGRV => ($FORM{NAS_ID}) ? "NAS_ID=$FORM{NAS_ID}" : undef,
        SEL_OPTIONS    => { '' => $lang{ALL} },
      }
    );

    $sessions->{TERMINATE_CAUSE_SEL} = $html->form_select(
      'TERMINATE_CAUSE',
      {
        SELECTED    => $FORM{TERMINATE_CAUSE} || '',
        SEL_HASH    => $ACCT_TERMINATE_CAUSES,
        SEL_OPTIONS => { '' => '--' }
      }
    );

    form_search({ SEARCH_FORM => $html->tpl_show(_include('dv_sessions_search', 'Dv'), { %FORM, %$sessions }, { OUTPUT2RETURN => 1 }) });

    if ($FORM{search}) {
      $sessions = Dv_Sessions->new($db, $admin, \%conf);
    }
    else {
      return 0;
    }
  }

  if (! $FORM{sort}) {
    if ($FORM{UID} || $user->{UID}) {
      $LIST_PARAMS{SORT} = '1';
      $LIST_PARAMS{DESC} = 'desc';
    }
    else {
      $LIST_PARAMS{SORT} = '2';
      $LIST_PARAMS{DESC} = 'desc';
    }
  }

  if($user->{UID}) {
    delete $LIST_PARAMS{LOGIN};
  }

  $LIST_PARAMS{SKIP_DEL_CHECK}=1 ;
  my Abills::HTML $table;
  ($table, $list) = result_former({
     INPUT_DATA      => $sessions,
     FUNCTION        => 'list',
     BASE_FIELDS     => 0,
     DEFAULT_FIELDS  => (($user->{UID}) ? 'DATE,DURATION_SEC,SENT,RECV,TP_ID,IP,SUM' : (((! $FORM{UID}) ?  'LOGIN,' : '' ) . 'DATE,DURATION_SEC,SENT,RECV,TP_ID,IP,CID,SUM,NAS_ID')),
     FUNCTION_FIELDS => 'form_payments, dv_stats',
     EXT_TITLES      => {
       'ip'          => 'IP',
       'netmask'     => 'NETMASK',
       'duration_sec'=> $lang{DURATION},
       'speed'       => $lang{SPEED},
       'port_id'     => $lang{PORT},
       'cid'         => 'CID',
       'filter_id'   => 'Filter ID',
       'tp_id'       => "$lang{TARIF_PLAN}",
       'dv_status'   => "$lang{STATUS}",
       'terminate_cause' => $lang{ACCT_TERMINATE_CAUSE},
       'start'       => "$lang{START} $lang{SESSIONS}",
       'end'         => "$lang{END} $lang{SESSIONS}",
       'duration'    => "$lang{DURATION}",
       'sent'        => (($TRAFFIC_NAMES{0}) ? $TRAFFIC_NAMES{0} : '') . " $lang{RECV}",
       'recv'        => (($TRAFFIC_NAMES{0}) ? $TRAFFIC_NAMES{0} : '') . " $lang{SENT}",
       'sum'         => "$lang{SUM}",
       'nas_id'      => $lang{NAS},
       'acct_session_id' => 'Acct-Session-Id'
     },
     FILTER_COLS  => {
       duration_sec    => 'sec2time_str',
       sent            => 'int2byte',
       recv            => 'int2byte',
       terminate_cause => 'dv_terminate_causes',
     },
     TABLE           => {
       width        => '100%',
       caption      => ($user->{UID}) ? undef : "$lang{SESSIONS}",
       qs           => $pages_qs,
       recs_on_page => $LIST_PARAMS{PAGE_ROWS},
       ID           => 'DV_SESSIONS',
       EXPORT       => 1,
     },
  });

  if ($sessions->{TOTAL} < 1) {
    $html->message('info', $lang{INFO}, "$lang{NO_RECORD}");
    return 0;
  }

  foreach my $line (@$list) {
    my $delete = ($permissions{3}{1}) ? $html->button(
        $lang{DEL},
        "index=". get_function_index('dv_stats') ."$pages_qs&del=$line->{uid}+$line->{acct_session_id}+". ($line->{nas_id} || q{}). ((! $FORM{UID}) ? "&UID=$line->{uid}" : ''),
        { MESSAGE => "$lang{DEL} $lang{SESSIONS} $lang{SESSION_ID} " . ($line->{acct_session_id}) . "?",
          class => 'del',
          NO_LINK_FORMER => 1
        }
      ) : '';

    my @fields_array = ();
    for (my $i = 0; $i < $sessions->{SEARCH_FIELDS_COUNT}; $i++) {
      my $field_name = $sessions->{COL_NAMES_ARR}->[$i];
      if ($field_name =~ /sent|recv/) {
        $line->{$field_name} = int2byte($line->{$field_name}, { DIMENSION => $FORM{DIMENSION} });
      }
      elsif ($field_name eq 'login' && $line->{uid}) {
        $line->{login} = $html->button($line->{login}, "index=11&UID=$line->{uid}");
      }
      elsif ($field_name eq 'terminate_cause') {
        $line->{terminate_cause} = $ACCT_TERMINATE_CAUSES->{ $line->{terminate_cause} };
      }
      elsif ($field_name eq 'duration_sec') {
        $line->{duration_sec} = sec2time_str($line->{duration_sec});
      }

      push @fields_array, $line->{$field_name};
    }

    $table->addrow(
      @fields_array,
      $html->button("D", "index=" . get_function_index(($user->{UID}) ? 'dv_user_stats' : 'dv_stats') . "&UID=$line->{uid}" . "&SESSION_ID=$line->{acct_session_id}", { TITLE => "$lang{DETAIL}", class => 'stats' }),
      $delete
    );
  }

  if (! $FORM{EXPORT_CONTENT} && $attr->{OUTPUT2RETURN}) {
    return $table->show({ OUTPUT2RETURN => 1 });
  }

  print $table->show();

  return 1;
}

#**********************************************************
=head2 dv_use_all_monthes()

=cut
#**********************************************************
sub dv_use_allmonthes {

  $FORM{allmonthes} = 1;
  dv_use();

  return 1;
}

#**********************************************************
# dv_use();
#**********************************************************
#@deprecated
sub dv_use {

  my %CAPTIONS_HASH = (
    '1:DATE:right'          => $lang{DATE},
    '2:USERS:left'          => $lang{USERS},
    '3:USERS_FIO:left'      => $lang{FIO},
    '4:TP:left'             => $lang{TARIF_PLAN},
    '5:SESSIONS:right'      => $lang{SESSIONS},
    '6:TRAFFIC_RECV:right'  => "$lang{TRAFFIC} $lang{RECV}",
    '7:TRAFFIC_SENT:right'  => "$lang{TRAFFIC} $lang{SENT}",
    '8:TRAFFIC_SUM:right'   => $lang{TRAFFIC},
    '9:TRAFFIC_2_SUM:right' => $lang{TRAFFIC} . " 2",
    '91:DURATION:right'     => $lang{DURATION},
    '92:SUM:right'          => $lang{SUM}
  );

  my %ACCT_TERMINATE_CAUSES = (
    'Unknown'                      => 0,
    'User-Request'                 => 1,
    'Lost-Carrier'                 => 2,
    'Lost-Service'                 => 3,
    'Idle-Timeout'                 => 4,
    'Session-Timeout'              => 5,
    'Admin-Reset'                  => 6,
    'Admin-Reboot'                 => 7,
    'Port-Error'                   => 8,
    'NAS-Error'                    => 9,
    'NAS-Request'                  => 10,
    'NAS-Reboot'                   => 11,
    'Port-Unneeded'                => 12,
    'Port-Preempted'               => 13,
    'Port-Suspended'               => 14,
    'Service-Unavailable'          => 15,
    'Callback'                     => 16,
    'User-Error'                   => 17,
    'Host-Request'                 => 18,
    'Supplicant-Restart'           => 19,
    'Reauthentication-Failure'     => 20,
    'Port-Reinit'                  => 21,
    'Port-Disabled'                => 22,
    'Lost-Alive/Billd Calculation' => 23
  );

  my %ACCT_TERMINATE_CAUSES_REV = reverse %ACCT_TERMINATE_CAUSES;
  my $i                         = 1;
  my $list                      = $Conf->config_list({ PARAM => 'ifu*' });
  my %INFO_LISTS                = ();

  foreach my $line (@$list) {
    my $field_id = '';
    if ($line->[0] =~ /ifu(\S+)/) {
      $field_id = $1;
    }

    my (undef, $type, $name) = split(/:/, $line->[1]);

    $CAPTIONS_HASH{ (90 + $i) . ':' . $field_id . ':left' } = $name;

    if ($type == 2) {
      my $list2 = $users->info_lists_list({ LIST_TABLE => $field_id . '_list' });
      foreach my $line2 (@$list2) {
        $INFO_LISTS{$field_id}{ $line2->[0] } = $line2->[1];
      }
    }
    $i++;
  }

  my %HIDDEN = ();

  $HIDDEN{COMPANY_ID} = $FORM{COMPANY_ID} if ($FORM{COMPANY_ID});
  $HIDDEN{sid} = $sid if ($FORM{sid});

  reports(
    {
      DATE      => $FORM{DATE},
      REPORT    => '',
      HIDDEN    => \%HIDDEN,
      EX_PARAMS => {
        HOURS => "$lang{HOURS}",
        USERS => "$lang{USERS}"
      },
      EXT_TYPE => {
        TP              => "$lang{TARIF_PLANS}",
        GID             => "$lang{GROUPS}",
        TERMINATE_CAUSE => 'TERMINATE_CAUSE',
        COMPANIES       => $lang{COMPANIES}
      },
      PERIOD_FORM => 1,
      FIELDS      => {%CAPTIONS_HASH},
      XML         => 1,
      EX_INPUTS   => [
        $html->form_select(
          'DIMENSION',
          {
            SELECTED => $FORM{DIMENSION},
            SEL_HASH => {
              ''   => 'Auto',
              'Bt' => 'Bt',
              'Kb' => 'Kb',
              'Mb' => 'Mb',
              'Gb' => 'Gb'
            },
            NO_ID => 1
          }
        )
      ]
    }
  );

  if ($FORM{TP_ID}) {
    $LIST_PARAMS{TP_ID} = $FORM{TP_ID};
    $pages_qs .= "&TP_ID=$FORM{TP_ID}";
  }

  if ($FORM{COMPANY_ID}) {
    $LIST_PARAMS{COMPANY_ID} = $FORM{COMPANY_ID};
    $pages_qs .= "&COMPANY_ID=$FORM{COMPANY_ID}";
  }

  my $output = '';

  my %TP_NAMES    = ();
  my %GROUP_NAMES = ();

  my %DATA_HASH = ();
  my %DATA_HASH2= ();
  my %CHART     = ();
  my %AVG       = (
    MONEY    => 0,
    TRAFFIC  => 0,
    DURATION => 0
  );

  my @CHART_TYPE  = ('column', 'line');
  my @CHART_TYPE2 = ('area',   'area');
  my $graph_type  = '';
  my $table_sessions;
  my $type        = $FORM{TYPE} || '';

  #Day reposrt
  if ($FORM{DATE}) {
    #Used Traffic
    $table_sessions = $html->table(
      {
        width      => '100%',
        caption    => "$lang{SESSIONS}",
        title      => [ "$lang{DATE}", "$lang{USERS}", "$lang{SESSIONS}", "$lang{TRAFFIC} ", "$lang{TRAFFIC} 2", $lang{DURATION}, $lang{SUM} ],
        cols_align => [ 'right', 'left', 'right', 'right', 'right', 'right', 'right' ],
        qs         => $pages_qs,
        ID         => 'DV_REPORTS_SESSIONS'
      }
    );

    if ($FORM{EX_PARAMS} && $FORM{EX_PARAMS} eq 'HOURS') {

      $list = $Sessions->reports({%LIST_PARAMS});
      my $num;
      foreach my $line (@$list) {
        $table_sessions->addrow($html->b($line->[0]), $line->[1], $line->[2], int2byte($line->[3], { DIMENSION => $FORM{DIMENSION} }), int2byte($line->[4], { DIMENSION => $FORM{DIMENSION} }), $line->[5], $html->b($line));

        $AVG{USERS}    = $line->[1]           if ($AVG{USERS} < $line->[1]);
        $AVG{TRAFFIC}  = $line->[3]           if ($AVG{TRAFFIC} < $line->[3]);
        $AVG{DURATION} = time2sec($line->[5]) if ($AVG{DURATION} < time2sec($line->[5]));
        $AVG{MONEY}    = $line->[6]           if ($AVG{MONEY} < $line->[6]);

        if ($line->[0] =~ /(\d+)-(\d+)-(\d+) (\d+)/) {
          $num = $4 + 1;
        }
        elsif ($line->[0] =~ /(\d+)-(\d+)/) {
          $CHART{X_LINE}[$num] = $line->[0];
          $num++;
        }

        $DATA_HASH{USERS}[$num]     = $line->[1];
        $DATA_HASH2{TRAFFIC}[$num]  = $line->[3];
        $DATA_HASH2{DURATION}[$num] = time2sec($line->[5]);
        $DATA_HASH{MONEY}[$num]     = $line->[6];

      }

      $graph_type = 'day_stats';
      $output     = $html->make_charts(
        {
          PERIOD        => $graph_type,
          DATA          => \%DATA_HASH2,
          AVG           => \%AVG,
          TYPE          => [ 'area', 'area' ],
          TRANSITION    => 1,
          OUTPUT2RETURN => 1
        }
      );

    }
    else {
      $list = $Sessions->reports({%LIST_PARAMS});
      foreach my $line (@$list) {
        $table_sessions->addrow($html->b($line->[0]), $html->button("$line->[1]", "index=15&UID=$line->[7]&DATE=$line->[0]"), $line->[2], int2byte($line->[3], { DIMENSION => $FORM{DIMENSION} }), int2byte($line->[4], { DIMENSION => $FORM{DIMENSION} }), $line->[5], $html->b($line->[6]));
      }
    }
  }
  else {
    #Used Traffic
    my @caption     = ();
    my @field_align = ();
    my %fields_hash = ();
    my @fields_arr  = ();

    if ($FORM{FIELDS}) {
      @fields_arr = split(/, /, $FORM{FIELDS});
      foreach my $line (@fields_arr) {
        $fields_hash{$line} = 1;
      }

      $i = 0;
      foreach my $line (sort keys %CAPTIONS_HASH) {
        my (undef, $val, $align) = split(/:/, $line);

        if ($fields_hash{$val}) {
          push @caption,     $CAPTIONS_HASH{$line};
          push @field_align, $align;
          $fields_arr[$i] = $val;
          $i++;
        }
      }
    }
    else {
      @caption = ("$lang{DATE}", "$lang{USERS}", "$lang{SESSIONS}", "$lang{TRAFFIC} ", "$lang{TRAFFIC} 2", $lang{DURATION}, $lang{SUM});
      @field_align = ('right', 'right', 'right', 'right', 'right', 'right', 'right');
    }

    $graph_type = 'month_stats';

    if ($type eq 'USER') {
      $caption[0] = "$lang{USER}";
    }
    if ($type eq 'COMPANIES') {
      $caption[0] = "$lang{COMPANIES}";
    }
    elsif ($type eq 'TERMINATE_CAUSE') {
      $caption[0] = "$lang{ERROR}";
      @CHART_TYPE = ('pie');
      $graph_type = 'pie';
    }
    elsif ($type eq 'TP') {
      $caption[0] = "$lang{TARIF_PLAN}";
      @CHART_TYPE2 = ('column', 'line');
      $CHART{AXIS_CATEGORY_skip} = 0;
    }
    elsif ($type eq 'GID') {
      @CHART_TYPE2 = ('column', 'line');
      $CHART{AXIS_CATEGORY_skip} = 0;

      $caption[0] = $lang{GROUPS};
      my $list2 = $users->groups_list();

      foreach my $line (@$list2) {
        $GROUP_NAMES{ $line->[0] } = $line->[1];
      }

    }
    elsif ($FORM{TP_ID}) {
      $caption[0]     = "$lang{LOGINS}";
      $field_align[0] = 'left';
    }

    $table_sessions = $html->table(
      {
        width      => '100%',
        caption    => "$lang{SESSIONS}",
        title      => \@caption,
        cols_align => \@field_align,
        qs         => $pages_qs,
        ID         => 'DV_REPORTS_SESSIONS'
      }
    );

    my $num  = 0;
    $list = $Sessions->reports({%LIST_PARAMS, COLS_NAME => undef });

    foreach my $line (@$list) {
      my @rows = ();
      if ($FORM{FIELDS}) {
        for ($i = 0 ; $i <= $#caption ; $i++) {
          if ($fields_arr[$i] =~ /TRAFFIC/) {
            push @rows, int2byte($line->[$i], { DIMENSION => $FORM{DIMENSION} });
          }
          elsif ($fields_arr[$i] =~ /USERS/ || $fields_arr[$i] =~ /USERS_FIO/) {
            push @rows, $html->button("$line->[$i]", "index=11&UID=" . ($line->[ $#fields_arr + 1 ]));
          }
          elsif ($fields_arr[$i] =~ /^_/ && ref($INFO_LISTS{ $fields_arr[$i] }) eq 'HASH') {
            push @rows, ($INFO_LISTS{ $fields_arr[$i] }{ $line->[$i] }) ? $INFO_LISTS{ $fields_arr[$i] }{ $line->[$i] } : '';
          }
          elsif ($fields_arr[$i] =~ 'TP') {
            if (scalar keys %TP_NAMES == 0) {
              $list = $Tariffs->list({ MODULE => 'Dv', NEW_MODEL_TP => 1, COLS_NAME => 1 });
              foreach my $line2 (@$list) {
                $TP_NAMES{ $line2->{id} } = $line2->{name};
              }
            }

          push @rows, (($type eq 'TP') ? $line->{id} : $line->{name})
              . '. ' . $html->button($TP_NAMES{ (($type eq 'TP') ? $line->{id} : $line->{name}) }, "index=$index&TP_ID=" . (($type eq 'TP') ? $line->{id} : $line->{name}) . "$pages_qs");
          }
          elsif ($fields_arr[$i] =~ 'GID') {
            push @rows, $line->[0] . '. ' . $html->button($GROUP_NAMES{ $line->[0] }, "index=$index&GID=$line->[0]$pages_qs");
          }
          else {
            push @rows, $line->[$i];
          }
        }
      }
      else {
        my $button = '';
        if ($type eq 'USER') {
          $button = $html->button($line->[0], "index=11&UID=$line->[7]");
        }
        elsif ($type eq 'TP') {
          $button = $line->[0] . '. ' . $html->button($TP_NAMES{ $line->[0] }, "index=$index&TP_ID=$line->[0]$pages_qs");
        }
        elsif ($type eq 'COMPANIES') {
          $button = $html->button("$line->[0]", "index=13&COMPANY_ID=$line->[8]");
        }
        elsif ($type eq 'GID') {
          $button = $line->[0] . '. ' . $html->button($GROUP_NAMES{ $line->[0] }, "index=$index&GID=$line->[0]$pages_qs");
        }
        elsif ($FORM{TP_ID}) {
          $button = $html->button("$line->[0]", "index=11&$type=$line->[0]&UID=$line->[7]");
        }
        elsif ($type eq 'TERMINATE_CAUSE') {
          $button = $html->button($ACCT_TERMINATE_CAUSES_REV{ $line->[0] }, "index=$index&$type=$line->[0]&TERMINATE_CAUSE=$line->[0]$pages_qs");

          $DATA_HASH{TYPE}[ $num + 1 ] = $line->[3];
          $CHART{X_TEXT}[$num] = $line->[0];

          $num++;
        }
        else {
          $button = $html->button($line->[0], "index=$index&$type=$line->[0]$pages_qs");
        }

        @rows = ($button, $line->[1], $line->[2], int2byte($line->[3], { DIMENSION => $FORM{DIMENSION} }), int2byte($line->[4], { DIMENSION => $FORM{DIMENSION} }), $line->[5], $html->b($line->[6]));

        if ($type ne 'TERMINATE_CAUSE') {
          $AVG{USERS} = $line->[1] if ($AVG{USERS} && $AVG{USERS} < $line->[1]);
          $AVG{TRAFFIC} = $line->[3] if ($AVG{TRAFFIC} && $AVG{TRAFFIC} < $line->[3]);

          $AVG{DURATION} = time2sec($line->[5]) if ($AVG{DURATION} < time2sec($line->[5]));
          $AVG{MONEY}    = $line->[6]           if ($AVG{MONEY} < $line->[6]);

          if ($line->[0] =~ /(\d+)-(\d+)-(\d+)/) {
            $num = $3;
          }
          elsif ($line->[0] =~ /(\d+)-(\d+)/) {
            $CHART{X_LINE}[$num] = $line->[0];
            $num++;
          }
          else {
            $CHART{X_TEXT}[$num] = $line->[0];
            $num++;
          }

          $DATA_HASH{USERS}[$num]     = $line->[1];
          $DATA_HASH2{TRAFFIC}[$num]  = $line->[3];
          $DATA_HASH2{DURATION}[$num] = time2sec($line->[5]);
          $DATA_HASH{MONEY}[$num]     = $line->[6];
        }
      }

      $table_sessions->addrow(@rows);
    }

    if ($graph_type ne 'pie') {

      $output = $html->make_charts(
        {
          PERIOD        => $graph_type,
          DATA          => \%DATA_HASH2,
          AVG           => \%AVG,
          TYPE          => \@CHART_TYPE2,
          TRANSITION    => 1,
          OUTPUT2RETURN => 1,
          %CHART
        }
      );
    }
  }

  my $table = $html->table(
    {
      width      => '100%',
      cols_align => [ 'right', 'right', 'right', 'right', 'right', 'right' ],
      rows       => [
        [
          "$lang{USERS}: " . $html->b($Sessions->{USERS}),
          "$lang{SESSIONS}: " . $html->b($Sessions->{SESSIONS}),
          "$lang{TRAFFIC}: "
          . $html->b(int2byte($Sessions->{TRAFFIC}))
          . $html->br()
          . "$lang{TRAFFIC} IN: "
          . $html->b(int2byte($Sessions->{TRAFFIC_IN}))
          . $html->br()
          . "$lang{TRAFFIC} OUT: "
          . $html->b(int2byte($Sessions->{TRAFFIC_OUT}))
          ,

          "$lang{TRAFFIC} 2: " . $html->b(int2byte($Sessions->{TRAFFIC_2})) . $html->br() . "$lang{TRAFFIC} 2 IN: " . $html->b(int2byte($Sessions->{TRAFFIC_2_IN})) . $html->br() . "$lang{TRAFFIC} 2 OUT: " . $html->b(int2byte($Sessions->{TRAFFIC_2_OUT})),

          "$lang{DURATION}: " . $html->b($Sessions->{DURATION}),
          "$lang{SUM}: " . $html->b($Sessions->{SUM})
        ]
      ],
      rowcolor => 'even'
    }
  );

  print $table_sessions->show() . $table->show();

  $table = $html->table({ rows => [ [$output] ] });
  print $table->show();

  if ($graph_type ne '') {
    $html->make_charts(
      {
        PERIOD     => $graph_type,
        DATA       => \%DATA_HASH,
        AVG        => \%AVG,
        TYPE       => \@CHART_TYPE,
        TRANSITION => 1,
        %CHART
      }
    );
  }

  return 1;
}

#**********************************************************
=head2 sec2time_str($sec);

=cut
#**********************************************************
sub sec2time_str {
  my($value) = @_;

  return sec2time($value, { str => 1 });
}

#**********************************************************
=head2 dv_report_use();

=cut
#**********************************************************
sub dv_report_use {

  my %HIDDEN = ();
  $HIDDEN{COMPANY_ID} = $FORM{COMPANY_ID} if ($FORM{COMPANY_ID});
  $HIDDEN{sid} = $sid if ($FORM{sid});

  my %ext_fields = (
        arpu         => $lang{ARPU},
        arpuu        => $lang{ARPPU},
        date         => $lang{DATE},
        month        => $lang{MONTH},
        login        => $lang{USER},
        fio          => $lang{FIO},
        hour         => $lang{HOURS},
        build        => $lang{ADDRESS_BUILD},
        district_name=> $lang{DISTRICT},
        street_name  => $lang{ADDRESS_STREET},
        login_count  => $lang{USERS},
        count        => $lang{COUNT},
        sum          => $lang{SUM},
        terminate_cause => "$lang{HANGUP} $lang{STATUS}",
        gid             => $lang{GROUPS},
        duration_sec    => $lang{DURATION},
        users_count     => $lang{USERS},
        sessions_count  => $lang{SESSIONS},
        traffic_recv    => $lang{SENT},
        traffic_sent    => $lang{RECV},
        traffic_sum     => $lang{TRAFFIC},
        traffic_2_sum   => "$lang{TRAFFIC} 2",
        company_name    => $lang{COMPANY}
  );

  reports(
    {
      DATE        => $FORM{DATE},
      HIDDEN      => \%HIDDEN,
      REPORT      => '',
      PERIOD_FORM => 1,
      EXT_TYPE    => {
        PER_MONTH       => $lang{PER_MONTH},
        DISTRICT        => $lang{DISTRICT},
        STREET          => $lang{STREET},
        BUILD           => $lang{BUILD},
        TP              => "$lang{TARIF_PLANS}",
        GID             => "$lang{GROUPS}",
        TERMINATE_CAUSE => 'TERMINATE_CAUSE',
        COMPANIES       => $lang{COMPANIES}
      },
    }
  );

  %CHARTS    = (
    TYPES => {
          login_count    => 'column',
          users_count    => 'column',
          sessions_count => 'column',
          traffic_recv   => 'column',
          traffic_sent   => 'column',
          duration_sec   => 'column'
        },
    PERIOD        => (! $FORM{TYPE} && ! $FORM{DATE}) ? 'month_stats' : ''
  );

  my %TP_NAMES = ();
  my $list = $Tariffs->list({ MODULE => 'Dv', NEW_MODEL_TP => 1, COLS_NAME => 1 });
  foreach my $line (@$list) {
    $TP_NAMES{ $line->{id} } = $line->{name};
  }

  if ($FORM{TERMINATE_CAUSE}) {
    $LIST_PARAMS{TERMINATE_CAUSE} = $FORM{TERMINATE_CAUSE};
  }
  elsif ($FORM{TP_ID}) {
    $LIST_PARAMS{TP_ID} = $FORM{TP_ID};
  }

  $Sessions->{debug}=1 if ($FORM{DBEUG});
  my $table;
  our %DATA_HASH;
  ($table, $list) = result_former({
     INPUT_DATA      => $Sessions,
     FUNCTION        => 'reports2',
     BASE_FIELDS     => 1,
     DEFAULT_FIELDS  => 'USERS_COUNT,SESSIONS_COUNT,TRAFFIC_RECV,TRAFFIC_SENT,DURATION_SEC,SUM',
     SKIP_USER_TITLE => (! $FORM{TYPE} || $FORM{TYPE} ne 'USER') ? 1 : undef,
     SELECT_VALUE    => {
       terminate_cause => dv_terminate_causes({ REVERSE => 1 }),
       gid             => sel_groups({ HASH_RESULT => 1 }),
       tp_id           => \%TP_NAMES
     },
     CHARTS       => 'users_count,sessions_count,traffic_recv,traffic_sent,duration_sec',
     CHARTS_XTEXT => 'auto', #$x_text,
     EXT_TITLES   => \%ext_fields,
     FILTER_COLS  => {
       duration_sec    => 'sec2time_str',
       traffic_recv    => 'int2byte',
       traffic_sent    => 'int2byte',
       traffic_sum     => 'int2byte',
       terminate_cause => "search_link:dv_report_use:TERMINATE_CAUSE,$pages_qs",
       company_name    => "search_link:dv_report_use:COMPANY_NAME,$pages_qs",
       tp_id           => "search_link:dv_report_use:TP_ID,$pages_qs",
       month           => "search_link:dv_report_use:MONTH,$pages_qs",
       gid             => "search_link:dv_report_use:GID,$pages_qs",
       date            => "search_link:dv_report_use:DATE,DATE",
       login           => "search_link:from_users:UID,type=1,$pages_qs",
       build           => "search_link:dv_report_use:LOCATION_ID,LOCATION_ID,TYPE=USER,$pages_qs",
       district_name   => "search_link:dv_report_use:DISTRICT_ID,DISTRICT_ID,TYPE=USER,$pages_qs",
       street_name     => "search_link:dv_report_use:STREET_ID,STREET_ID,TYPE=USER,$pages_qs",
     },
     TABLE   => {
       width      => '100%',
       caption    => "$lang{REPORTS}",
       qs         => $pages_qs,
       ID         => 'REPORTS_DV_USE',
       EXPORT     => 1,
       SHOW_COLS_HIDDEN => { TYPE      => $FORM{TYPE},
                             show      => 1,
                             FROM_DATE => $FORM{FROM_DATE},
                             TO_DATE   => $FORM{TO_DATE},
                           }
     },
     MAKE_ROWS    => 1,
     SEARCH_FORMER=> 1,
     #TOTAL        => 1
  });

  print $html->make_charts(
      {
        DATA          => \%DATA_HASH,
        #AVG           => \%AVG,
        #TYPE          => \@CHART_TYPE,
        TITLE         => 'Internet',
        TRANSITION    => 1,
        OUTPUT2RETURN => 1,
        %CHARTS
      }
  );

  print $table->show();

  $table = $html->table(
    {
      width      => '100%',
      cols_align => [ 'right', 'right', 'right', 'right', 'right', 'right' ],
      rows       => [
        [
          "$lang{USERS}: " . $html->b($Sessions->{USERS}),
          "$lang{SESSIONS}: " . $html->b($Sessions->{SESSIONS}),
          "$lang{TRAFFIC}: "
          . $html->b(int2byte($Sessions->{TRAFFIC}))
          . $html->br()
          . "$lang{TRAFFIC} IN: "
          . $html->b(int2byte($Sessions->{TRAFFIC_IN}))
          . $html->br()
          . "$lang{TRAFFIC} OUT: "
          . $html->b(int2byte($Sessions->{TRAFFIC_OUT}))
          ,

          "$lang{TRAFFIC} 2: " . $html->b(int2byte($Sessions->{TRAFFIC_2})) . $html->br() . "$lang{TRAFFIC} 2 IN: " . $html->b(int2byte($Sessions->{TRAFFIC_2_IN})) . $html->br() . "$lang{TRAFFIC} 2 OUT: " . $html->b(int2byte($Sessions->{TRAFFIC_2_OUT})),

          "$lang{DURATION}: " . $html->b(sec2time($Sessions->{DURATION_SEC}, { str => 1 })),
          "$lang{SUM}: " . $html->b($Sessions->{SUM})
        ]
      ],
      rowcolor => 'even'
    }
  );

  print $table->show();

  return 1;
}

#**********************************************************
=head2 dv_error($attr)

=cut
#**********************************************************
sub dv_error {
  my ($attr)    = @_;

  my %log_levels_rev = reverse %Log::log_levels;
  my @ACTIONS = ('', 'AUTH', 'ACCT', 'HANGUP', 'CALCULATION', 'CMD', 'LOST_ALIVE', 'GUEST_MODE', 'DUB_IP');

  if ($attr->{USER_INFO}) {
    my $user = $attr->{USER_INFO};
    $LIST_PARAMS{LOGIN} = $user->{LOGIN};

    if ($conf{DV_LOGIN}) {
      $Dv->info($user->{UID});
      $LIST_PARAMS{LOGIN}.=";$Dv->{DV_LOGIN}";
    }
  }
  elsif ($FORM{LOGIN}) {
    $LIST_PARAMS{LOGIN} = $FORM{LOGIN};
    $pages_qs .= "&LOGIN=$FORM{LOGIN}";
  }
  elsif ($FORM{UID}) {
    dv_user();
    return 1;
  }

  #Sql Part
  if ($conf{ERROR2DB}) {
    my %nas_ids = (
      '' => '',
      0  => 'UNKNOWN',
    );

    my $list = $Nas->list();
    foreach my $line (@$list) {
      $nas_ids{ $line->[0] } = $line->[1];
    }

    if($FORM{search_form}) {
      $Dv->{LOG_TYPE_SEL} = $html->form_select(
        'LOG_TYPE',
        {
          SELECTED => $FORM{LOG_TYPE},
          SEL_HASH => { '' => '', %log_levels_rev },
          NO_ID    => 1
        }
      );

      $Dv->{NAS_ID_SEL} = $html->form_select(
        'NAS_ID',
        {
          SELECTED => $FORM{NAS_ID},
          SEL_HASH => \%nas_ids,
        }
      );

      $Dv->{ACTIONS_SEL} = $html->form_select(
        'ACTION',
        {
          SELECTED  => $FORM{ACTION},
          SEL_ARRAY => \@ACTIONS,
        }
      );

      form_search({ SEARCH_FORM => $html->tpl_show(_include('dv_errors_search', 'Dv'), { %FORM, %$Dv }, { OUTPUT2RETURN => 1 }) });
    }
    if (!$FORM{sort}) {
      $LIST_PARAMS{SORT} = 1;
      $LIST_PARAMS{DESC} = 'DESC';
    }

    $list = $Log->log_list({%LIST_PARAMS, COLS_NAME => 1,});
    my $table = $html->table(
      {
        caption    => $lang{TOTAL},
        width      => '100%',
        cols_align => [ 'right', 'right' ],
      }
    );

    my $total = 0;
    foreach my $line (@{ $Log->{list} }) {
      $table->addrow($log_levels_rev{ $line->{log_type} },
                                      $html->button($line->{count}, "index=". get_function_index('dv_error') . "&LOG_TYPE=$line->{log_type}"));
      $total += $line->{count};
    }

    $table->addrow($lang{TOTAL}, $total);

    print $table->show();

    if(defined $FORM{LOG_TYPE}){
      $list = $Log->log_list({%LIST_PARAMS, COLS_NAME => 1, LOG_TYPE => $FORM{LOG_TYPE}, FROM_DATE => $FORM{DATE} || '', TO_DATE => $FORM{DATE} || ''});
    }

    $table = $html->table(
      {
        caption => "Internet $lang{ERROR}",
        width   => '100%',
        title   => [ $lang{DATE}, "$lang{TYPE}", "$lang{ACTION}", "$lang{USER}", "$lang{TEXT}", "NAS" ],
        pages   => $total,
        qs      => $pages_qs,
        ID      => 'DV_ERRORS',
        EXPORT  => ' XML:&xml=1',
        MENU    => "$lang{SEARCH}:index=$index&search_form=1:search",
      }
    );

    foreach my $line (@$list) {
      my $message = $line->{message};

      if($line->{log_type} < 5) {
        $message = $html->color_mark($line->{message}, "$_COLORS[6]");
      }
      elsif($line->{action} eq 'GUEST_MODE') {
        $message = $html->color_mark($line->{message}, "$_COLORS[8]");
        $line->{action} = $html->color_mark($line->{action}, "$_COLORS[8]");
      }

      $table->addrow($line->{date},
      $log_levels_rev{ $line->{log_type} },
      $line->{action},
      ($conf{DV_LOGIN}) ? $html->button($line->{user}, "index=". get_function_index('dv_users_list'). "&DV_LOGIN=$line->{user}&search=1")  : $html->button($line->{user}, "index=11&LOGIN=$line->{user}"),
      $message,
      $nas_ids{ $line->{nas_id} });
    }

    print $table->show();
  }

  #File part
  if (! $conf{LOGFILE} || !-f $conf{LOGFILE}) {
    $html->message('info', $lang{INFO}, "'". ($conf{LOGFILE} || q{}) . "' $lang{NOT_EXIST} (\$conf{LOGFILE})");
    return 0;
  }

  if (defined($FORM{LOG_TYPE})) {
    $pages_qs .= "&LOG_TYPE=$FORM{LOG_TYPE}";
  }

  my ($list, $types, $totals) = show_log(
    ($LIST_PARAMS{LOGIN} || ''),
    $conf{LOGFILE},
    {
      DATE      => $FORM{DATE},
      LOG_TYPE  => ($FORM{LOG_TYPE}) ? $log_levels_rev{ $FORM{LOG_TYPE} } : undef,
      PG        => $PG || 25,
      PAGE_ROWS => 25
    }
  );

  my $table = $html->table(
    {
      caption => "System $lang{ERROR}",
      width   => '100%',
      pages   => $totals,
      qs      => $pages_qs,
      ID      => 'DV_ERRORS2',
    }
  );

  foreach my $line (@$list) {
    if ($line =~ m/LOG_WARNING/i) {
      $line = $html->color_mark($line, $_COLORS[6]);
    }

    $table->addrow($line);
  }
  print $table->show();

  $table = $html->table(
    {
      width      => '100%',
      cols_align => [ 'right', 'right' ]
    }
  );

  $table->addrow($html->button("$lang{TOTAL}", "index=$index&$pages_qs"), $totals);
  while (my ($k, $v) = each %$types) {
    $table->addrow($html->button($k, "index=$index&LOG_TYPE=$k$pages_qs"), $v);
  }

  $table->addrow($lang{SIZE}, int2byte((-s $conf{LOGFILE}))) if (! $LIST_PARAMS{LOGIN} || $LIST_PARAMS{LOGIN} eq '');

  print $table->show();

  return 1;
}

#**********************************************************
=head dv_stats($attr)

=cut
#**********************************************************
sub dv_stats {
  my ($attr) = @_;

  if (defined($attr->{USER_INFO})) {
    my $user = $attr->{USER_INFO};

    my $uid = $user->{UID};
    $LIST_PARAMS{UID} = $uid;
    if (!defined($FORM{sort})) {
      $LIST_PARAMS{SORT} = 2;
      $LIST_PARAMS{DESC} = 'DESC';
    }

    if ($FORM{OP_SID} && $COOKIES{OP_SID} && $FORM{OP_SID} eq $COOKIES{OP_SID}) {
      $html->message('err', $lang{ERROR}, "$lang{EXIST} $FORM{OP_SID} eq $COOKIES{OP_SID}");
    }
    elsif ($FORM{bm}) {
      require Bills;
      Bills->import();

      my $Bill = Bills->new($db, $admin, \%conf);
      $Bill->action('add', "$FORM{BILL_ID}", $FORM{sum});
      if (! _error_show($Bill)) {
        $html->message('info', $lang{INFO}, "$lang{ADDED}: SUM $FORM{sum}, BILL_ID: $FORM{BILL_ID}");
      }
    }
    elsif ($FORM{SESSION_ID}) {
      $pages_qs .= "&SESSION_ID=$FORM{SESSION_ID}";
      dv_session_detail({ USER_INFO => $attr->{USER_INFO} });
      return 0;
    }
  }
  elsif ($FORM{UID}) {
    $LIST_PARAMS{UID} = $FORM{UID};
  }

  if ($FORM{del} && $FORM{COMMENTS}) {
    if (!defined($permissions{3}{1})) {
      $html->message('err', $lang{ERROR}, 'ACCESS DENY');
      return 0;
    }

    my ($uid, $session_id, $nas_id) = split(/ /, $FORM{del}, 7);

    my $list = $Sessions->list({
      LOGIN      => '_SHOW',
      START      => '_SHOW',
      DURATION   => '_SHOW',
      SUM        => '_SHOW',
      UID        => $uid,
      ACCT_SESSION_ID => $session_id,
      NAS_ID     => $nas_id,
      COLS_NAME  => 1
    });

    if ($Sessions->{TOTAL}) {
      my $session_info = $list->[0];
      $Sessions->del($uid, $session_id, $nas_id, $session_info->{start});

      if (! _error_show($Sessions)) {
        my $table = $html->table(
          {
            width => '100%',
            rows  => [
              [ $lang{LOGIN},    $session_info->{login} ],
              [ 'SESSION_ID',    $session_id            ],
              [ 'NAS_ID',        $nas_id                ],
              [ $lang{START},    $session_info->{start} ],
              [ $lang{DURATION}, $session_info->{duration} ],
              [ $lang{SUM},      $session_info->{sum}   ]
            ]
          }
        );

        $html->message( 'info', $lang{DELETED}, $table->show() );
        form_back_money( 'log', $session_info->{sum}, { UID => $uid } );    #
        return 0;
      }
    }
  }

  $Dv->info($FORM{UID});

  #Join Service
  if ($users->{COMPANY_ID}) {
    if ($Dv->{JOIN_SERVICE}) {
      my @uids = ();
      my $list = $Dv->list(
          {
            JOIN_SERVICE => ($Dv->{JOIN_SERVICE}==1) ? $Dv->{UID} : $Dv->{JOIN_SERVICE},
            COMPANY_ID   => $attr->{USER_INFO}->{COMPANY_ID},
            LOGIN        => '_SHOW',
            PAGE_ROWS    => 10000,
            COLS_NAME    => 1
          }
        );

      foreach my $line (@$list) {
        if ($Dv->{JOIN_SERVICE} && $Dv->{JOIN_SERVICE} == 1) {
          $Dv->{JOIN_SERVICES_USERS} .= $html->button("$line->{login}", "&index=$index&UID=$line->{uid}", { BUTTON => 1 }) . ' ';
        }

        push @uids, $line->{uid};
      }

      $LIST_PARAMS{UIDS} = ($Dv->{JOIN_SERVICE} > 1) ? $Dv->{JOIN_SERVICE} : $FORM{UID};
      $LIST_PARAMS{UIDS} .= ',' . join(', ', @uids) if ($#uids > -1);

      if ($Dv->{JOIN_SERVICE} > 1) {
        $Dv->{JOIN_SERVICES_USERS} .= $html->button("$lang{MAIN}", "index=$index&UID=$Dv->{JOIN_SERVICE}", { BUTTON => 1 }) . ' ';
      }

      my $table = $html->table(
      {
        width => '100%',
        rows  => [ [ "$lang{JOIN_SERVICE}:", $Dv->{JOIN_SERVICES_USERS} ] ]
      });
      $Sessions->{JOIN_SERVICE_STATS} .= $table->show();
    }
  }

  if ($FORM{rows}) {
    $LIST_PARAMS{PAGE_ROWS} = $FORM{rows};
    $LIST_PARAMS{FROM_DATE} = $FORM{FROM_DATE};
    $LIST_PARAMS{TO_DATE}   = $FORM{TO_DATE};
    $conf{list_max_recs}    = $FORM{rows};
    $pages_qs .= "&rows=$conf{list_max_recs}";
  }

  if (!$LIST_PARAMS{UID} && $FORM{LOGIN}) {
    $users = Users->new($db, $admin, \%conf);
    my $list = $users->list({ LOGIN     => $FORM{LOGIN},
                              ACTIVATE  => '_SHOW',
                              COLS_NAME => 1 });

    if ($users->{TOTAL} == 1) {
      $LIST_PARAMS{UID}      = $list->[0]->{uid};
      $FORM{UID}             = $LIST_PARAMS{UID};
      #$uid                   = $LIST_PARAMS{UID};
      $LIST_PARAMS{ACTIVATE} = $list->[0]->{activate};
    }
    else {
      $html->message('err', $lang{ERROR}, "'$FORM{LOGIN}' $lang{NOT_EXIST}");
      return 0;
    }

    $pages_qs .= "&UID=$LIST_PARAMS{UID}";
  }

  $Sessions->{PERIOD_STATS} = dv_stats_periods({ UID => $FORM{UID} });
  $Sessions->{PERIOD_STATS} .= dv_period_select({ UID => $FORM{UID} });

  if (defined($FORM{show})) {
    $pages_qs .= "&show=1&FROM_DATE=$FORM{FROM_DATE}&TO_DATE=$FORM{TO_DATE}";
  }
  elsif (defined($FORM{PERIOD})) {
    $LIST_PARAMS{PERIOD} = $FORM{PERIOD};
    $pages_qs .= "&PERIOD=$FORM{PERIOD}";
  }
  elsif ($FORM{DATE}) {
    $LIST_PARAMS{DATE} = $FORM{DATE};
    $pages_qs .= "&DATE=$FORM{DATE}";
  }

  $Tariffs->ti_list({ TP_ID => $Dv->{TP_NUM} });
  if ($Tariffs->{TOTAL} > 0) {
    my $list = $Tariffs->tt_list({ TI_ID => $Tariffs->{list}->[0]->[0], COLS_NAME => 1 });
    foreach my $line ( @$list ) {
      $TRAFFIC_NAMES{ $line->{id} } = $line->{descr};
    }
  }

  #Show rest of prepaid traffic
  if (
    $Sessions->prepaid_rest(
      {
        UID  => ($Dv->{JOIN_SERVICE} && $Dv->{JOIN_SERVICE} > 1) ? $Dv->{JOIN_SERVICE} : $LIST_PARAMS{UID},
        UIDS => $LIST_PARAMS{UIDS}
      }
    )
  )
  {
    #Prepaid: period, traffic_type
    my $list  = $Sessions->{INFO_LIST};
    my $table = $html->table(
      {
        caption     => $lang{PREPAID},
        width       => '100%',
        title_plain => [ $lang{DAY}, $lang{TRAFFIC_CLASS}, $lang{BEGIN}, $lang{END}, $lang{START}, "$lang{TOTAL} (MB)", "$lang{REST} (MB)", "$lang{OVERQUOTA} (MB)" ],
        cols_align  => [ 'left', 'right', 'right', 'right', 'right', 'right', 'right' ],
        ID          => 'PREAPID_TRAFIC'
      }
    );

    foreach my $line (@$list) {
      my $traffic_rest = ($conf{DV_INTERVAL_PREPAID}) ? $Sessions->{REST}->{ $line->{interval_id} }->{ $line->{traffic_class} }  :  $Sessions->{REST}->{ $line->{traffic_class} };
      $table->addrow(
        ($line->{day} == 0 ) ? $lang{ALL}  : $WEEKDAYS[$line->{day}],
        $line->{traffic_class} . ':' . (($TRAFFIC_NAMES{ $line->{traffic_class} }) ? $TRAFFIC_NAMES{ $line->{traffic_class} } : '').
        ($conf{DV_INTERVAL_PREPAID} ? "/ $line->{interval_id}" : '') ,
        $line->{interval_begin},
        $line->{interval_end},
        $line->{activate},
        $line->{prepaid},
        ($line->{prepaid} > 0 && $traffic_rest > 0) ? $traffic_rest : 0,
        ($line->{prepaid} > 0 && $traffic_rest < 0) ? $html->color_mark(abs($traffic_rest), 'text-danger') : 0,
      );
    }

    $Sessions->{PREPAID_INFO} = $table->show();
  }

  $pages_qs .= "&DIMENSION=$FORM{DIMENSION}" if ($FORM{DIMENSION});

  if (!defined($FORM{sort})) {
    $LIST_PARAMS{SORT} = 2;
    $LIST_PARAMS{DESC} = 'DESC';
  }

  $Sessions->{TOTALS_AVG} = dv_stats_calculation($Sessions);

  #Session List
  my $list = $Sessions->list({%LIST_PARAMS, COLS_NAME => 1 });

  if ($Sessions->{TOTAL} < 1) {
    $html->message('info', $lang{INFO}, $lang{NO_RECORD}, { ID => 981 });
  }

  my $table = $html->table(
    {
      caption     => $lang{SUM},
      width       => '100%',
      title_plain => [
        $lang{SESSIONS},
        $lang{DURATION},
        (($TRAFFIC_NAMES{0}) ? $TRAFFIC_NAMES{0} : "$lang{TRAFFIC}") . " $lang{RECV}",
        (($TRAFFIC_NAMES{0}) ? $TRAFFIC_NAMES{0} : "$lang{TRAFFIC}") . " $lang{SENT}",
        (($TRAFFIC_NAMES{0}) ? $TRAFFIC_NAMES{0} : "$lang{TRAFFIC}") . " $lang{SUM}",
        (($TRAFFIC_NAMES{1}) ? $TRAFFIC_NAMES{1} : "$lang{TRAFFIC} 2") . " $lang{SENT}",
        (($TRAFFIC_NAMES{1}) ? $TRAFFIC_NAMES{1} : "$lang{TRAFFIC} 2") . " $lang{RECV}",
        (($TRAFFIC_NAMES{1}) ? $TRAFFIC_NAMES{1} : "$lang{TRAFFIC} 2") . " $lang{SUM}",
        "$lang{SUM}"
      ],
      cols_align => [ 'right', 'right', 'right', 'right', 'right', 'right', 'right', 'right', 'right' ],
      rows       => [
        [
          $Sessions->{TOTAL},
          sec2time_str($Sessions->{DURATION}),
          int2byte($Sessions->{TRAFFIC_IN},                              { DIMENSION => $FORM{DIMENSION} }),
          int2byte($Sessions->{TRAFFIC_OUT},                             { DIMENSION => $FORM{DIMENSION} }),
          int2byte(($Sessions->{TRAFFIC_OUT} || 0) + ($Sessions->{TRAFFIC_IN} || 0),   { DIMENSION => $FORM{DIMENSION} }),
          int2byte($Sessions->{TRAFFIC2_IN},                             { DIMENSION => $FORM{DIMENSION} }),
          int2byte($Sessions->{TRAFFIC2_OUT},                            { DIMENSION => $FORM{DIMENSION} }),
          int2byte(($Sessions->{TRAFFIC2_OUT} || 0) + ($Sessions->{TRAFFIC2_IN} || 0), { DIMENSION => $FORM{DIMENSION} }),
          $Sessions->{SUM}
        ]
      ],
      ID => 'TOTALS_FULL'
    }
  );

  $Sessions->{TOTALS_FULL} = $table->show();
  if ($Sessions->{TOTAL} > 0) {
    $Sessions->{SESSIONS} = dv_sessions($list, $Sessions, { OUTPUT2RETURN => 1 });
  }

  if (-f '../charts.cgi' || -f 'charts.cgi') {
    my $second_login = "";
    if ($conf{DV_LOGIN}) {
      $Dv->info($users->{UID});
      if ($Dv->{DV_LOGIN}) {
        $second_login .= ",$Dv->{DV_LOGIN}";
      }
    }
    if($users->{LOGIN}) {
      $Sessions->{GRAPHS} = dv_get_chart_iframe("LOGIN=$users->{LOGIN}$second_login", '1,2');
    }
  }

  $html->tpl_show(_include('dv_stats', 'Dv'), $Sessions);

  return 1;
}

#**********************************************************
=head2 dv_stats_calculation($sessions);

=cut
#**********************************************************
sub dv_stats_calculation {
  my ($sessions_) = @_;

  $sessions_->calculation({%LIST_PARAMS});
  my $table = $html->table(
    {
      width       => '640',
      title_plain => [ "-", "$lang{MIN}", "$lang{MAX}", "$lang{AVG}", "$lang{TOTAL}" ],
      cols_align  => [ 'left', 'right', 'right', 'right', 'right' ],
      rows        => [
        [ $lang{DURATION},         sec2time_str($sessions_->{MIN_DUR}),  sec2time_str($sessions_->{MAX_DUR}), sec2time_str($sessions_->{AVG_DUR}), sec2time_str($sessions_->{TOTAL_DUR}) ],
        [ "$lang{TRAFFIC} $lang{RECV}", int2byte($sessions_->{MIN_RECV}), int2byte($sessions_->{MAX_RECV}), int2byte($sessions_->{AVG_RECV}), int2byte($sessions_->{TOTAL_RECV}) ],
        [ "$lang{TRAFFIC} $lang{SENT}", int2byte($sessions_->{MIN_SENT}), int2byte($sessions_->{MAX_SENT}), int2byte($sessions_->{AVG_SENT}), int2byte($sessions_->{TOTAL_SENT}) ],
        [ "$lang{TRAFFIC} $lang{SUM}",  int2byte($sessions_->{MIN_SUM}),  int2byte($sessions_->{MAX_SUM}),  int2byte($sessions_->{AVG_SUM}),  int2byte($sessions_->{TOTAL_SUM}) ]
      ],
      ID => 'DV_TRAFFIC_CALCULATIONS'
    }
  );

  return $table->show();
}

#**********************************************************
=head2 form_stats()

=cut
#**********************************************************
sub dv_user_stats {
  my ($attr) = @_;

  my $uid = $LIST_PARAMS{UID};
  if (defined($FORM{SESSION_ID})) {
    $pages_qs .= "&SESSION_ID=$FORM{SESSION_ID}";
    dv_session_detail({ LOGIN => $LIST_PARAMS{LOGIN} });
    return 0;
  }

  _error_show($Sessions);

  #Join Service
  if ($user->{COMPANY_ID}) {
    if ($FORM{COMPANY_ID}) {
      $users = Users->new($db, $admin, \%conf);
      dv_use();
      return 0;
    }

    require Customers;
    Customers->import();
    my $customer = Customers->new($db, $admin, \%conf);
    my $company  = $customer->company();
    my $ulist    = $company->admins_list(
      {
        COMPANY_ID => $user->{COMPANY_ID},
        UID        => $uid
      }
    );

    if ($company->{TOTAL} > 0 && $ulist->[0]->[0] > 0) {
      $Dv->{JOIN_SERVICES_USERS} = $html->button("$lang{COMPANY}", "&sid=$sid&index=$index&COMPANY_ID=$user->{COMPANY_ID}", { BUTTON => 1 }) . ' ';
    }

    $Dv->info($uid);

    if ($Dv->{JOIN_SERVICE}) {
      my @uids = ();
      my $list = $Dv->list(
        {
          JOIN_SERVICE => ($Dv->{JOIN_SERVICE}==1) ? $uid : $Dv->{JOIN_SERVICE},
          COMPANY_ID   => $attr->{USER_INFO}->{COMPANY_ID},
          LOGIN        => '_SHOW',
          PAGE_ROWS    => 1000,
          COLS_NAME    => 1
        }
      );

      if ($Dv->{JOIN_SERVICE} == 1) {
        $Dv->{JOIN_SERVICES_USERS} .= (!$FORM{JOIN_STATS}) ? $html->b("$lang{ALL} $lang{USERS}") . ' :: '
                 : $html->button("$lang{ALL}", "&sid=$sid&index=$index&JOIN_STATS=" . $uid, { BUTTON => 1 }) . ' ';
      }
      #elsif ($Dv->{JOIN_SERVICE} > 1) {
      #  $Dv->{JOIN_SERVICES_USERS} .= $html->button("$lang{MAIN}", "index=$index&UID=$Dv->{JOIN_SERVICE}", { BUTTON => 1 });
      #}

      foreach my $line (@$list) {
        if ($FORM{JOIN_STATS} && $FORM{JOIN_STATS} == $line->{uid}) {
          $Dv->{JOIN_SERVICES_USERS} .= $html->b($line->{login}) . ' ';
          $uid = $FORM{JOIN_STATS};
        }
        elsif($Dv->{JOIN_SERVICE} == 1) {
          $Dv->{JOIN_SERVICES_USERS} .= $html->button($line->{login}, "&sid=$sid&index=$index&JOIN_STATS=" . $line->{uid}, { BUTTON => 1 }) . ' ';
        }

        push @uids, $line->{uid};
      }

      $LIST_PARAMS{UIDS}  = ($Dv->{JOIN_SERVICE} > 1) ? $Dv->{JOIN_SERVICE} : $uid;
      $LIST_PARAMS{UIDS} .= ',' . join(', ', @uids) if ($#uids > -1 && !$FORM{JOIN_STATS});
    }

    my $table = $html->table(
      {
        width => '100%',
        rows  => [ [ "$lang{JOIN_SERVICE}: ", $Dv->{JOIN_SERVICES_USERS} ] ]
      }
    );
    $Sessions->{JOIN_SERVICE_STATS} .= $table->show();
  }

  if ($FORM{rows}) {
    $LIST_PARAMS{PAGE_ROWS} = $FORM{rows};
    $LIST_PARAMS{PG}        = $FORM{pg};
    $LIST_PARAMS{FROM_DATE} = $FORM{FROM_DATE};
    $LIST_PARAMS{TO_DATE}   = $FORM{TO_DATE};
    $conf{list_max_recs}    = $FORM{rows};
    $pages_qs .= "&rows=$conf{list_max_recs}";
  }

  #online sessions
  my $list = $Sessions->online(
    {
      CLIENT_IP          => '_SHOW',
      CID                => '_SHOW',
      DURATION_SEC2      => '_SHOW',
      ACCT_INPUT_OCTETS  => '_SHOW',
      ACCT_OUTPUT_OCTETS => '_SHOW',
      UID                => $user->{UID}
    }
  );

  if ($Sessions->{TOTAL} > 0) {
    my $table = $html->table(
      {
        caption     => "Online",
        width       => '100%',
        title_plain => [ "IP", "CID", "$lang{DURATION}", "$lang{RECV}", "$lang{SEND}" ],
        cols_align  => [ 'left', 'right', 'right', 'right', 'right', 'right' ],
        ID          => 'ONLINE'
      }
    );

    foreach my $line (@$list) {
      $table->addrow($line->{client_ip},
         $line->{CID},
         sec2time_str($line->{duration_sec2}),
         int2byte($line->{acct_output_octets}),
         int2byte($line->{acct_input_octets}),
      );
    }
    $Sessions->{ONLINE} = $table->show({ OUTPUT2RETURN => 1 });
  }

  #PEriods totals
  $Sessions->{PERIOD_STATS} = dv_stats_periods({ UID => $LIST_PARAMS{UID} });
  $Sessions->{PERIOD_SELECT}= dv_period_select({ UID => $LIST_PARAMS{UID} });

  $Dv->info($user->{UID});
  $Tariffs->ti_list({ TP_ID => $Dv->{TP_NUM} });
  if ($Tariffs->{TOTAL} > 0) {
    $list = $Tariffs->tt_list({ TI_ID => $Tariffs->{list}->[0]->[0], COLS_NAME => 1 });
    foreach my $line ( @$list ) {
      $TRAFFIC_NAMES{ $line->{id} } = $line->{descr};
    }
  }

  if (defined($FORM{show})) {
    $pages_qs .= "&show=1&FROM_DATE=$FORM{FROM_DATE}&TO_DATE=$FORM{TO_DATE}";
  }
  elsif (defined($FORM{PERIOD})) {
    $LIST_PARAMS{PERIOD} = int($FORM{PERIOD});
    $pages_qs .= "&PERIOD=$FORM{PERIOD}";
  }

  #Show rest of prepaid traffic
  if (
    $Sessions->prepaid_rest(
      {
        UID  => ($Dv->{JOIN_SERVICE} && $Dv->{JOIN_SERVICE} > 1) ? $Dv->{JOIN_SERVICE} : $LIST_PARAMS{UID},
        UIDS => $LIST_PARAMS{UIDS}
      }
    )
  )
  {
    $list  = $Sessions->{INFO_LIST};
    my $table = $html->table(
      {
        caption     => "$lang{PREPAID}",
        width       => '100%',
        title_plain => [ "$lang{TRAFFIC} $lang{TYPE}", "$lang{BEGIN}", "$lang{END}", "$lang{START}", "$lang{TOTAL} (MB)", "$lang{REST} (MB)", "$lang{OVERQUOTA} (MB)" ],
        cols_align  => [ 'left', 'right', 'right', 'right', 'right', 'right', 'right' ],
        ID          => 'DV_STATS_PREPAID'
      }
    );

    foreach my $line (@$list) {
      my $traffic_rest = ($conf{DV_INTERVAL_PREPAID}) ? $Sessions->{REST}->{ $line->{interval_id} }->{ $line->{traffic_class} }  :  $Sessions->{REST}->{ $line->{traffic_class} };

      $table->addrow(
        $line->{traffic_class} . ':' . (($TRAFFIC_NAMES{ $line->{traffic_class} }) ? $TRAFFIC_NAMES{ $line->{traffic_class} } : '').
        ($conf{DV_INTERVAL_PREPAID} ? "/ $line->{interval_id}" : '') ,
        $line->{interval_begin},
        $line->{interval_end},
        $line->{activate},
        $line->{prepaid},
        ($line->{prepaid} > 0 && $traffic_rest > 0) ? $traffic_rest      : 0,
        ($line->{prepaid} > 0 && $traffic_rest < 0) ? $html->color_mark(abs($traffic_rest), 'red') : 0,
      );
    }

    $Sessions->{PREPAID_INFO} = $table->show({ OUTPUT2RETURN => 1 });
  }

  $pages_qs .= "&DIMENSION=$FORM{DIMENSION}" if ($FORM{DIMENSION});

  #Session List
  if (!$FORM{sort}) {
    $LIST_PARAMS{SORT} = 2;
    $LIST_PARAMS{DESC} = 'DESC';
  }

  $list  = $Sessions->list({ %LIST_PARAMS,
                             COLS_NAME => 1 });

  my $table = $html->table(
    {
      caption     => "$lang{SUM}",
      width       => '100%',
      title_plain => [
        "$lang{SESSIONS}",
        "$lang{DURATION}",
        (($TRAFFIC_NAMES{0}) ? $TRAFFIC_NAMES{0} : "$lang{TRAFFIC}") . " $lang{SENT}",
        (($TRAFFIC_NAMES{0}) ? $TRAFFIC_NAMES{0} : "$lang{TRAFFIC}") . " $lang{RECV}",
        (($TRAFFIC_NAMES{0}) ? $TRAFFIC_NAMES{0} : "$lang{TRAFFIC}") . " $lang{SUM}",
        (($TRAFFIC_NAMES{1}) ? $TRAFFIC_NAMES{1} : "$lang{TRAFFIC}") . " $lang{SENT}",
        (($TRAFFIC_NAMES{1}) ? $TRAFFIC_NAMES{1} : "$lang{TRAFFIC}") . " $lang{RECV}",
        (($TRAFFIC_NAMES{1}) ? $TRAFFIC_NAMES{1} : "$lang{TRAFFIC}") . " $lang{SUM}",
        "$lang{SUM}"
      ],

      cols_align => [ 'right', 'right', 'right', 'right' ],
      rows       => [
        [
          $Sessions->{TOTAL},
          sec2time_str($Sessions->{DURATION}),
          int2byte($Sessions->{TRAFFIC_IN},                              { DIMENSION => $FORM{DIMENSION} }),
          int2byte($Sessions->{TRAFFIC_OUT},                             { DIMENSION => $FORM{DIMENSION} }),
          int2byte(($Sessions->{TRAFFIC_OUT} || 0) + ($Sessions->{TRAFFIC_IN} || 0),   { DIMENSION => $FORM{DIMENSION} }),
          int2byte($Sessions->{TRAFFIC2_IN},                             { DIMENSION => $FORM{DIMENSION} }),
          int2byte($Sessions->{TRAFFIC2_OUT},                            { DIMENSION => $FORM{DIMENSION} }),
          int2byte(($Sessions->{TRAFFIC2_OUT} || 0) + ($Sessions->{TRAFFIC2_IN}  || 0), { DIMENSION => $FORM{DIMENSION} }),
          $Sessions->{SUM}
        ]
      ]
    }
  );

  $Sessions->{TOTALS_FULL} = $table->show({ OUTPUT2RETURN => 1 });

  if (-f '../charts.cgi' || -f 'charts.cgi') {
    my $second_login = "";
    if ($conf{DV_LOGIN}) {
      $Dv->info($user->{UID});
      if ($Dv->{DV_LOGIN}) {
        $second_login .= ",$Dv->{DV_LOGIN}";
      }
    }

    #my $frameopts = "width='100%' height='500px' frameborder='0' seamless  seamless='seamless' scrolling='false'";
    $Sessions->{GRAPHS}  = dv_get_chart_iframe("LOGIN=$LIST_PARAMS{LOGIN}$second_login", '1,2');
  }

  $Sessions->{SESSIONS} = dv_sessions($list, $Sessions, { OUTPUT2RETURN => 1 }) if ($Sessions->{TOTAL} > 0);

  $html->tpl_show(_include('dv_stats', 'Dv'), $Sessions);

  return 1;
}

#**********************************************************
=head2 dv_session_detail($attr)

=cut
#**********************************************************
sub dv_session_detail {
  my ($attr) = @_;
  my $user;

  my $uid= $FORM{UID} || 0;
  if (defined($attr->{USER_INFO})) {
    $user = $attr->{USER_INFO};
    $LIST_PARAMS{LOGIN} = $user->{LOGIN};

    if ($FORM{RECALC}) {
      $Sessions->session_detail({%FORM});

      require Billing;
      Billing->import();
      my $Billing = Billing->new($db, \%conf);

      my (undef, $SUM, undef, $TARIF_PLAN) = $Billing->session_sum(
        $Sessions->{LOGIN},
        $Sessions->{START_UNIXTIME},
        $Sessions->{DURATION},
        {
          OUTBYTE  => $Sessions->{SENT},
          INBYTE   => $Sessions->{RECV},
          OUTBYTE2 => $Sessions->{SENT2},
          INBYTE2  => $Sessions->{RECV2}
        },
        {
          disable_rt_billing => 1,
          TP_NUM             => $Sessions->{TP_ID}
        }
      );

      my $change = '';

      if ($Sessions->{SUM} != $SUM) {
        $change = "$lang{CHANGE}  " . $html->button($lang{YES}, "index=$index&RECALC=1&SESSION_ID=$FORM{SESSION_ID}&UID=$user->{UID}&change=1", { BUTTON => 1 }) . ' ?';

        if ($FORM{change}) {
          require Bills;
          Bills->import();
          my $Bill = Bills->new($db, $admin, \%conf);
          $Bill->action('add',  "$Sessions->{BILL_ID}", $Sessions->{SUM}) if ($Sessions->{SUM});
          $Bill->action('take', "$Sessions->{BILL_ID}", $SUM)             if ($SUM > 0);

          $Sessions->query2("UPDATE dv_log SET sum='$SUM' WHERE acct_session_id='$Sessions->{SESSION_ID}';", 'do');

          if (! _error_show($Bill)) {
            $html->message('info', $lang{INFO}, "$lang{ADDED}: SUM $FORM{sum}, BILL_ID: $FORM{BILL_ID}");
          }
          $change = $lang{CHANGED};
        }
      }

      $html->message('info', "$lang{RECALCULATE}", "$lang{TARIF_PLAN}: $TARIF_PLAN, $lang{SUM}: $Sessions->{SUM} -> $SUM  $change");
    }
  }
  elsif (defined($LIST_PARAMS{LOGIN})) {

  }
  elsif ($FORM{UID}) {
    dv_user();
    return 0;
  }

  my $ACCT_TERMINATE_CAUSES = dv_terminate_causes({ REVERSE => 1 });
  $Sessions->session_detail({%FORM});

  $Sessions->{ACCT_TERMINATE_CAUSE} = "$Sessions->{ACCT_TERMINATE_CAUSE} : " . $ACCT_TERMINATE_CAUSES->{ $Sessions->{ACCT_TERMINATE_CAUSE} };

  $Sessions->{_SENT}  = int2byte($Sessions->{SENT});
  $Sessions->{_RECV}  = int2byte($Sessions->{RECV});
  $Sessions->{_RECV2} = int2byte($Sessions->{SENT2});
  $Sessions->{_SENT2} = int2byte($Sessions->{RECV2});
  $Sessions->{RECALC} = $html->button($lang{RECALCULATE}, "index=$index&RECALC=1&SESSION_ID=$FORM{SESSION_ID}&UID=$uid", { BUTTON => 1 });

  $Dv->info($uid);
  $Tariffs->ti_list({ TP_ID => $Sessions->{TP_NUM} });
  #my %TRAFFIC_NAMES = ();

  if ($Tariffs->{TOTAL} > 0) {
    my $list = $Tariffs->tt_list({ TI_ID => $Tariffs->{list}->[0]->[0], COLS_NAME => 1 });
    foreach my $line ( @$list ) {
      $TRAFFIC_NAMES{ $line->{id} } = $line->{descr};
    }
  }

  $html->tpl_show(
    _include('dv_session_detail', 'Dv'),
    {
      %$Sessions,
      TRAFFIC_NAMES_0 => $TRAFFIC_NAMES{0},
      TRAFFIC_NAMES_1 => $TRAFFIC_NAMES{1}
    }
  );

  my %ORDERS = (
    hours    => $lang{HOURS},
    days     => $lang{DAYS},
    sessions => $lang{SESSIONS}
  );

  print $html->form_main(
    {
      CONTENT => $html->form_select(
        'PERIOD',
        {
          SELECTED => $FORM{PERIOD},
          SEL_HASH => \%ORDERS,
          NO_ID    => 1
        }
      )
      . "SESSION_ID:"
      . $html->form_select(
        'SESSION_ID',
        {
          SELECTED    => "$FORM{SESSION_ID}",
          SEL_OPTIONS => {
            $FORM{SESSION_ID} => "$FORM{SESSION_ID}",
            '0'               => "$lang{ALL}"
          },
          NO_ID => 1
        }
      ),
      HIDDEN => {
        index => $index,
        UID   => $user->{UID}
      },
      SUBMIT => { SHOW => $lang{SHOW} }
    }
  );

  $pages_qs .= "&PERIOD=$FORM{PERIOD}" if (defined($FORM{PERIOD}));

  #Log intervals
  my $list = $Sessions->list_log_intervals({ ACCT_SESSION_ID => $FORM{SESSION_ID} });
  if ($Sessions->{TOTAL} > 0) {
    my $table = $html->table(
      {
        width      => '100%',
        caption    => "$lang{INTERVALS}",
        title      => [ "$lang{INTERVALS}", "$lang{TRAFFIC}", "$lang{SENT}", "$lang{RECV}", "$lang{DURATION}", "$lang{SUM}" ],
        cols_align => [ 'right', 'right', 'right', 'right', 'right', 'right', 'right' ],
        qs         => $pages_qs,
        ID         => 'DV_SESSION_DETAIL'
      }
    );

    foreach my $line (@$list) {
      $table->addrow($line->[0], $line->[1], int2byte($line->[2]), int2byte($line->[3]), $line->[4], $line->[5]);
    }

    print $table->show();
  }

  #Log detail list
  if (!$FORM{sort}) {
    $LIST_PARAMS{SORT} = 1;
    $LIST_PARAMS{DESC} = 'DESC';
  }

  $list = $Sessions->detail_list({ %LIST_PARAMS, %FORM });
  my $table = $html->table(
    {
      width      => '100%',
      title      => [ "LAST_UPDATE", "$lang{SESSION_ID}", "NAS ID", "$lang{SENT}", "$lang{RECV}", "$lang{SENT} 2", "$lang{RECV} 2", "$lang{SUM}" ],
      cols_align => [ 'right', 'right', 'right', 'right', 'right', 'right', 'right', 'right' ],
      pages      => $Sessions->{TOTAL},
      qs         => $pages_qs,
      ID         => 'DETAIL_LIST'
    }
  );

  foreach my $line (@$list) {
    $table->addrow($line->[0], $html->button($line->[1], "index=$index&UID=$uid&SESSION_ID=$line->[1]"),
      $line->[2],
      int2byte($line->[3]),
      int2byte($line->[4]),
      int2byte($line->[5]),
      int2byte($line->[6]),
      $line->[7]);
  }

  print $table->show();

  $table = $html->table(
    {
      width      => '100%',
      cols_align => [ 'right', 'right' ],
      rows       => [ [ "$lang{TOTAL}:", $html->b($Sessions->{TOTAL}) ] ]
    }
  );
  print $table->show();

  return 1;
}

#**********************************************************
=head2 dv_user_chg_tp($attr)

=cut
#**********************************************************
sub dv_user_chg_tp {
  my ($attr) = @_;

  my $Shedule = Shedule->new($db, $admin, \%conf);
  my $period = $FORM{period} || 0;

  if (!$conf{DV_USER_CHG_TP}) {
    $html->message('err', "$lang{CHANGE} $lang{TARIF_PLAN}", "$lang{NOT_ALLOW}", { ID => 140 });
    return 0;
  }

  if ($LIST_PARAMS{UID}) {
    $Dv = $Dv->info($LIST_PARAMS{UID}, { DOMAIN_ID => $user->{DOMAIN_ID} });
    if ($Dv->{TOTAL} < 1) {
      $html->message('info', $lang{INFO}, "$lang{NOT_ACTIVE}", { ID => 22 });
      return 0;
    }
  }
  else {
    $html->message('err', $lang{ERROR}, $lang{USER_NOT_EXIST}, { ID => 19 });
    return 0;
  }

  if ($conf{FEES_PRIORITY} && $conf{FEES_PRIORITY} =~ /bonus/ && $user->{EXT_BILL_DEPOSIT}) {
    $user->{DEPOSIT} += $user->{EXT_BILL_DEPOSIT};
  }
  my %CHANGE_PARAMS = ();

  if ($user->{GID}) {
    #Get user groups
    $user->group_info($user->{GID});
    if ($user->{DISABLE_CHG_TP}) {
      $html->message('err', "$lang{CHANGE} $lang{TARIF_PLAN}", "$lang{NOT_ALLOW}", { ID => 143 });
      return 0;
    }
  }

  #Get TP groups
  $Tariffs->tp_group_info($Dv->{TP_GID});
  if (!$Tariffs->{USER_CHG_TP}) {
    $html->message('err', "$lang{CHANGE} $lang{TARIF_PLAN}", "$lang{NOT_ALLOW}", { ID => 140 });
    return 0;
  }

  #Get next abon day
  if (
       $Dv->{MONTH_ABON} > 0
    && !$Dv->{STATUS}
    && !$user->{DISABLE}
    && ( $user->{DEPOSIT} + $user->{CREDIT} > 0
      || $Dv->{POSTPAID_ABON}
      || $Dv->{PAYMENT_TYPE} == 1)
  )
  {
    if ($user->{ACTIVATE} ne '0000-00-00') {
      my ($Y, $M, $D) = split(/-/, $user->{ACTIVATE}, 3);
      $M--;
      $Dv->{ABON_DATE} = POSIX::strftime("%Y-%m-%d", localtime((POSIX::mktime(0, 0, 0, $D, $M, ($Y - 1900), 0, 0, 0) + 31 * 86400 + (($conf{START_PERIOD_DAY}) ? $conf{START_PERIOD_DAY} * 86400 : 0))));
    }
    else {
      my ($Y, $M, $D) = split(/-/, $DATE, 3);

      if ($conf{START_PERIOD_DAY} && $conf{START_PERIOD_DAY} > $D) {
        $D = $conf{START_PERIOD_DAY};
      }
      else {
        $M++;
        $D = '01';
      }

      if ($M == 13) {
        $M = 1;
        $Y++;
      }

      $Dv->{ABON_DATE} = sprintf("%d-%02d-%02d", $Y, $M, $D);
    }
  }

  if ($FORM{set} && $FORM{ACCEPT_RULES}) {
    if (!$FORM{TP_ID} || $FORM{TP_ID} < 1) {
      $html->message('err', "$lang{ERROR}", "$lang{ERR_WRONG_DATA}: $lang{TARIF_PLAN}", { ID => 141 });
    }
    elsif ($conf{DV_USER_CHG_TP_NPERIOD}) {
      my ($CUR_Y, $CUR_M, $CUR_D) = split(/-/, $DATE);

      # Get next month
      my ($Y, $M, $D);
      if ($user->{ACTIVATE} eq '0000-00-00') {
        # Get next month
        ($Y, $M, $D) = split(/-/, $DATE, 3);
      }
      else {
        ($Y, $M, $D) = split(/-/, $user->{ACTIVATE}, 3);
      }

      # Renew expired accounts
      if ($user->{EXPIRE} ne '0000-00-00' && $Dv->{TP_AGE} > 0) {
        ($Y, $M, $D) = split(/-/, $user->{EXPIRE});
        my $seltime = POSIX::mktime(0, 0, 0, $D, ($M - 1), ($Y - 1900));
        my $tp_age = $Dv->{TP_INFO}->{AGE};
        # REnew expire tarif
        if ($seltime < time()) {
          my ($EXPIRE_Y, $EXPIRE_M, $EXPIRE_D) = split(/-/, POSIX::strftime("%Y-%m-%d", localtime((POSIX::mktime(0, 0, 0, $CUR_D, ($CUR_M), ($CUR_Y - 1900), 0, 0, 0) + $tp_age * 86400))));
          $CHANGE_PARAMS{EXPIRE} = "$EXPIRE_Y-$EXPIRE_M-$EXPIRE_D";
          ($Y, $M, $D) = split(/-/, $DATE, 3);
          $Dv->{TP_INFO} = $Tariffs->info($FORM{TP_ID});
          goto CHG_TP;
        }
        else {
          ($Y, $M, $D) = split(/-/, POSIX::strftime("%Y-%m-%d", localtime((POSIX::mktime(0, 0, 0, $D, ($M), ($Y - 1900), 0, 0, 0) + $tp_age * 86400))));
        }
      }

      if ($Dv->{STATUS} == 5) {

      }
      # For daily fees or moth distribution next day fees
      elsif (!$conf{DV_USER_CHG_TP_NEXT_MONTH} && ($Dv->{MONTH_ABON} == 0 || $Dv->{ABON_DISTRIBUTION})) {
        ($Y, $M, $D) = split(/-/, POSIX::strftime("%Y-%m-%d", localtime((POSIX::mktime(0, 0, 0, $D, ($M - 1), ($Y - 1900), 0, 0, 0) + 86400))));
      }
      else {
        if ($user->{ACTIVATE} ne '0000-00-00') {
          ($Y, $M, $D) = split(/-/, POSIX::strftime("%Y-%m-%d", localtime((POSIX::mktime(0, 0, 0, $D, ($M - 1), ($Y - 1900), 0, 0, 0) + 30 * 86400))));
        }
        else {
          if ($conf{START_PERIOD_DAY} && $conf{START_PERIOD_DAY} > $D) {
            $D = $conf{START_PERIOD_DAY};
          }
          else {
            $M++;
            if ($M == 13) {
              $M = 1;
              $Y++;
            }
            $D = '01';
          }
        }
      }

      CHG_TP:
      $M = sprintf("%02d", $M);
      $D = sprintf("%02d", $D);
      my $seltime = POSIX::mktime(0, 0, 0, $D, ($M - 1), ($Y - 1900));

      if ($seltime > time()) {
        $Shedule->add(
          {
            UID      => $LIST_PARAMS{UID},
            TYPE     => 'tp',
            ACTION   => $FORM{TP_ID},
            D        => $D,
            M        => $M,
            Y        => $Y,
            MODULE   => 'Dv',
            COMMENTS => "$lang{FROM}: $Dv->{TP_ID}:$Dv->{TP_NAME}"
          }
        );
      }
      else {
        $FORM{UID} = $LIST_PARAMS{UID};
        $FORM{STATUS} = 0 if ($Dv->{STATUS} == 5);
        $Dv->change({%FORM});
        $user->change(
          $LIST_PARAMS{UID},
          {
            ACTIVATE => ($user->{ACTIVATE} ne '0000-00-00') ? "$DATE" : undef,
            UID => $LIST_PARAMS{UID},
            %CHANGE_PARAMS
          }
        );

        if (! _error_show($user)) {
          $html->message('info', $lang{CHANGED}, "$lang{CHANGED}");
          $Dv->info($user->{UID});
          service_get_month_fee($Dv) if (!$FORM{DV_NO_ABON});
        }
      }
    }
    elsif ($period == 1 && $conf{DV_USER_CHG_TP_SHEDULE}) {
      my ($year, $month, $day) = split(/-/, $FORM{DATE}, 3);
      my $seltime = POSIX::mktime(0, 0, 0, $day, ($month - 1), ($year - 1900));

      if ($seltime <= time()) {
        $html->message('info', $lang{INFO}, "$lang{ERR_WRONG_DATA}");
        return 0;
      }

      $Shedule->add(
        {
          UID      => $LIST_PARAMS{UID},
          TYPE     => 'tp',
          ACTION   => $FORM{TP_ID},
          D        => sprintf("%02d", $day),
          M        => sprintf("%02d", $month),
          Y        => $year,
          MODULE   => 'Dv',
          COMMENTS => "$lang{FROM}: $Dv->{TP_ID}:$Dv->{TP_NAME}"
        }
      );

      if (! _error_show($Shedule)) {
        $html->message('info', $lang{CHANGED}, "$lang{CHANGED}");
        $Dv->info($user->{UID});
      }
    }

    #Imidiatly change TP
    else {
      if ($user->{CREDIT} + $user->{DEPOSIT} < 0) {
        $html->message('err', "$lang{ERROR}", "$lang{ERR_SMALL_DEPOSIT} - $lang{DEPOSIT}: $user->{DEPOSIT} $lang{CREDIT}: $user->{CREDIT}", { ID => 15 });
        return 0;
      }

      $FORM{UID} = $LIST_PARAMS{UID};

      $Dv->{ABON_DATE} = undef;
      if ($Dv->{MONTH_ABON} > 0 && !$Dv->{STATUS} && !$users->{DISABLE}) {
        if ($user->{ACTIVATE} ne '0000-00-00') {
          my ($Y, $M, $D) = split(/-/, $user->{ACTIVATE}, 3);
          $M--;
          $Dv->{ABON_DATE} = POSIX::strftime("%Y-%m-%d", localtime((POSIX::mktime(0, 0, 0, $D, $M, ($Y - 1900), 0, 0, 0) + 31 * 86400 + (($conf{START_PERIOD_DAY}) ? $conf{START_PERIOD_DAY} * 86400 : 0))));
        }
        else {
          my ($Y, $M, $D) = split(/-/, $DATE, 3);
          $M++;
          if ($M == 13) {
            $M = 1;
            $Y++;
          }

          if ($conf{START_PERIOD_DAY}) {
            $D = sprintf("%02d", $conf{START_PERIOD_DAY});
          }
          else {
            $D = '01';
          }
          $Dv->{ABON_DATE} = sprintf("%d-%02d-%02d", $Y, $M, $D);
        }
      }

      if ($Dv->{ABON_DATE}) {
        my ($year, $month, $day) = split(/-/, $Dv->{ABON_DATE}, 3);
        my $seltime = POSIX::mktime(0, 0, 0, $day, ($month - 1), ($year - 1900));

        if ($seltime <= time()) {
          $html->message('info', $lang{INFO}, "$lang{ERR_WRONG_DATA} ($year, $month, $day)/" . $seltime . "-" . time());
          return 0;
        }
        elsif ($FORM{date_D} && $FORM{date_D} > ($month != 2 ? (($month % 2) ^ ($month > 7)) + 30 : (!($year % 400) || !($year % 4) && ($year % 25) ? 29 : 28))) {
          $html->message('info', $lang{INFO}, "$lang{ERR_WRONG_DATA} ($year-$month-$day)");
          return 0;
        }

        $Shedule->add(
          {
            UID      => $LIST_PARAMS{UID},
            TYPE     => 'tp',
            ACTION   => $FORM{TP_ID},
            D        => $day,
            M        => $month,
            Y        => $year,
            MODULE   => 'Dv',
            COMMENTS => "$lang{FROM}: $Dv->{TP_ID}:$Dv->{TP_NAME}"
          }
        );

        if (! _error_show($Shedule->{errno})) {
          $html->message('info', $lang{CHANGED}, "$lang{CHANGED}");
        }
      }
      else {
        $Dv->change({%FORM});

        if (! _error_show($Dv)) {
          #Take fees
          if (!$Dv->{STATUS}) {
            service_get_month_fee($Dv) if (!$FORM{DV_NO_ABON});
            $user->change(
              $user->{UID},
              {
                ACTIVATE => "$DATE",
                UID      => $user->{UID}
              }
            );
          }

          $html->message('info', $lang{CHANGED}, "$lang{CHANGED}");
          $Dv->info($Dv->{UID});
        }
      }

      $Dv->info($Dv->{UID});
    }
  }
  elsif ($FORM{del}) {
    $Shedule->del(
      {
        UID => $LIST_PARAMS{UID},
        ID  => $FORM{SHEDULE_ID}
      }
    );

    $html->message('info', $lang{DELETED}, "$lang{DELETED} [$FORM{SHEDULE_ID}]");
  }

  my $message='';
  my $date_ = ($FORM{date_y} || ''). '-' . ($FORM{date_m} || '') .'-'. ($FORM{date_d} || '');
  $Shedule->info(
    {
      UID      => $user->{UID},
      TYPE     => 'tp',
      DESCRIBE => "$message\n$lang{FROM}: '$date_'",
      MODULE   => 'Dv'
    }
  );

  my $table;
  if ($Shedule->{TOTAL} > 0) {
    $Tariffs->info(0, { ID => $Shedule->{ACTION}, MODULE => 'Dv' });

    $table = $html->table(
      {
        width      => '100%',
        caption    => "$lang{SHEDULE}",
        cols_align => [ 'left', 'left' ],
        rows       => [ [ "$lang{TARIF_PLAN}:", "$Shedule->{ACTION} : $Tariffs->{NAME}" ], [ "$lang{DATE}:", "$Shedule->{Y}-$Shedule->{M}-$Shedule->{D}" ], [ "$lang{ADDED}:", "$Shedule->{DATE}" ], [ "ID:", "$Shedule->{SHEDULE_ID}" ] ]
      }
    );
    $Tariffs->{TARIF_PLAN_SEL} = $table->show({ OUTPUT2RETURN => 1 }) . $html->form_input('SHEDULE_ID', "$Shedule->{SHEDULE_ID}", { TYPE => 'HIDDEN', OUTPUT2RETURN => 1 });
    $Tariffs->{TARIF_PLAN_TABLE} = $Tariffs->{TARIF_PLAN_SEL};
    if (!$Shedule->{ADMIN_ACTION}) {
      $Tariffs->{ACTION}     = 'del';
      $Tariffs->{LNG_ACTION} = "$lang{DEL}  $lang{SHEDULE}";
      #$Tariffs->{ACTION_FLAG}= $html->form_input('del', "1", { TYPE => 'text', OUTPUT2RETURN => 1 });
    }
  }
  else {
    $Tariffs->{TARIF_PLAN_SEL} = $html->form_select(
      'TP_ID',
      {
        SELECTED   => $Dv->{TP_ID},
        SEL_LIST   => $Tariffs->list(
          {
            TP_GID       => $Dv->{TP_GID},
            CHANGE_PRICE => '<=' . ($user->{DEPOSIT} + $user->{CREDIT}),
            MODULE       => 'Dv',
            NEW_MODEL_TP => 1,
            TP_CHG_PRIORITY => $Dv->{TP_PRIORITY},
            COLS_NAME    => 1
          }
        ),
      }
    );

    $table = $html->table(
      {
        width      => '100%',
        caption    => $lang{TARIF_PLANS},
        cols_align => [ 'left', 'left' ],
      }
    );

    my $tp_list = $Tariffs->list(
      {
        TP_GID       => $Dv->{TP_GID},
        CHANGE_PRICE => '<=' . ($user->{DEPOSIT} + $user->{CREDIT}),
        MODULE       => 'Dv',
        MONTH_FEE    => '_SHOW',
        DAY_FEE      => '_SHOW',
        CREDIT       => '_SHOW',
        COMMENTS     => '_SHOW',
        TP_CHG_PRIORITY     => $Dv->{TP_PRIORITY},
        NEW_MODEL_TP => 1,
        COLS_NAME    => 1,
        DOMAIN_ID    => $user->{DOMAIN_ID}
      }
    );

    my @skip_tp_changes = ();
    if ($conf{DV_SKIP_CHG_TPS}) {
      @skip_tp_changes = split(/,\s?/, $conf{DV_SKIP_CHG_TPS});
    }
    foreach my $tp (@$tp_list) {
      next if (in_array($tp->{id}, \@skip_tp_changes));
      next if ($tp->{id} == $Dv->{TP_ID} && $user->{EXPIRE} eq '0000-00-00');
      $table->{rowcolor} = ($table->{rowcolor} && $table->{rowcolor} eq $_COLORS[1]) ? $_COLORS[2] : $_COLORS[1];
      my $radio_but = '';

      $user->{CREDIT}=($user->{CREDIT}>0)? $user->{CREDIT}  : (($tp->{credit} > 0) ? $tp->{credit} : 0);

      if ($tp->{day_fee} + $tp->{month_fee} < $user->{DEPOSIT} + $user->{CREDIT} || $tp->{abon_distribution}) {
        $radio_but = $html->form_input('TP_ID', "$tp->{id}", { TYPE => 'radio', OUTPUT2RETURN => 1 });
      }
      else {
        $radio_but = "$lang{ERR_SMALL_DEPOSIT}";
      }

      $table->addrow($tp->{id}, $html->b($tp->{name}) . $html->br() . convert($tp->{comments}, { text2html => 1 }), $radio_but);
    }
    $Tariffs->{TARIF_PLAN_TABLE} = $table->show({ OUTPUT2RETURN => 1 });

    if ($Tariffs->{TOTAL} == 0) {
      $html->message('info', $lang{INFO}, "$lang{ERR_SMALL_DEPOSIT}", { ID => 142 });
      return 0;
    }

    $Tariffs->{PARAMS} .= form_period($period, { ABON_DATE => $Dv->{ABON_DATE}, TP => $Tariffs }) if ($conf{DV_USER_CHG_TP_SHEDULE} && !$conf{DV_USER_CHG_TP_NPERIOD});
    $Tariffs->{ACTION} = 'set';
    $Tariffs->{LNG_ACTION} = $lang{CHANGE};
    #$html->form_input('hold_up_window', '--'.$lang{CHANGE}, { TYPE          => 'submit',
    #                                 OUTPUT2RETURN => 1 });
  }

  $Tariffs->{UID}     = $attr->{USER_INFO}->{UID};
  #$tariffs->{m}       = $m;
  $Tariffs->{TP_ID}   = $Dv->{TP_ID};
  $Tariffs->{TP_NAME} = "$Dv->{TP_ID}:$Dv->{TP_NAME}";
  $html->tpl_show(templates('form_client_chg_tp'), $Tariffs);

  return 1;
}

#**********************************************************
=head2 cisco_isg_cmd($user_ip, $command, $attr) - Cisco ISG functions
  Arguments:
    $user_ip - User IP
    $command - Command
       account-status-query
       account-logon
       deactivate-service
       activate-service
       account-logon
       account-logoff

    $attr    -
  Results:

=cut
#**********************************************************
sub cisco_isg_cmd {
  my ($user_ip, $command, $attr) = @_;

  my $debug = $conf{ISG_DEBUG} || 0;
  my $service_name = $attr->{SERVICE_NAME};

  if ($debug > 0) {
    print "Content-Type: text/html\n\n";
    print "Command: $command" . $html->br();
    print "User name: $attr->{USER_NAME}" . $html->br();
    print "User IP: $user_ip" . $html->br();
  }

  if (! $conf{DV_ISG}) {
    return 1;
  }

  #Get user NAS server from ip pools
  if (!$Nas->{NAS_ID}) {
    my $list = $Nas->nas_ip_pools_list({ COLS_NAME => 1 });
    foreach my $line (@$list) {
      if ($line->{ip} <= ip2int($user_ip) && ip2int($user_ip) <= $line->{last_ip_num}) {
        $Nas->info({ NAS_ID => $line->{active_nas_id} });
        last;
      }
    }
  }

  if (!$Nas->{NAS_ID}) {
    $html->message('err', $lang{ERROR}, $lang{ERR_UNKNOWN_IP}, { ID => 913 });
    return 0;
  }

  #Get Active session info
  my %RAD_PAIRS = ();
  my $type;
  require Radius;
  Radius->import();

  my $r = Radius->new(
    Host   => $Nas->{NAS_MNG_IP_PORT},
    Secret => $Nas->{NAS_MNG_PASSWORD}
  ) or return "Can't connect '$Nas->{NAS_MNG_IP_PORT}' $!";

  $conf{'dictionary'} = $base_dir . '/Abills/dictionary' if (!$conf{'dictionary'});
  $r->load_dictionary($conf{'dictionary'});

  $r->clear_attributes();
  $r->add_attributes({ Name => 'User-Name',          Value => "$attr->{USER_NAME}" });
  $r->add_attributes({ Name => 'Cisco-Account-Info', Value => "S$user_ip" });
  $r->add_attributes({ Name => 'Cisco-AVPair',       Value => "subscriber:command=$command" });

  # Deactivate cur service
  if ($attr->{CURE_SERVICE}) {
    $r->add_attributes({ Name => 'Cisco-AVPair', Value => "subscriber:service-name=$attr->{CURE_SERVICE}" });
  }

  if($attr->{'User-Password'}) {
    $r->add_attributes({ Name => 'User-Password',  Value => $attr->{'User-Password'} });
  }

  $r->send_packet(43) and $type = $r->recv_packet;

  if (!defined $type) {
    $html->message('err', $lang{ERROR}, "No responce from CoA server '$Nas->{NAS_MNG_IP_PORT}' $! / " . $r->get_error(), { ID => 106 });
    return 0;
  }

  if ($command eq 'account-status-query') {
    for my $ra ($r->get_attributes) {
      if ($ra->{'Value'} =~ /\$MA(\S+)/) {
        $Dv->{ISG_CID_CUR} = $1;
      }
      elsif($ra->{'Name'} eq 'Reply-Message') {
        $Dv->{MESSAGE} = $ra->{'Value'};
      }
      elsif ($ra->{'Value'} =~ /^S(\S+)/) {
        $Dv->{ISG_CID_CUR} = $1;
      }
      elsif ($ra->{'Value'} =~ /^N1TURBO_SPEED(\d+);(\d+)/) {
        $Dv->{TURBO_MODE_RUN} = $2;
      }
      elsif ($ra->{'Value'} =~ /^N1(TP_[0-9\_]+);(\d+)/) {
        $Dv->{CURE_SERVICE}         = $1;
        $Dv->{ISG_SESSION_DURATION} = $2;
      }

      $RAD_PAIRS{ $ra->{'Name'} } = $ra->{'Value'};
      if ($debug > 0) {
        print "$ra->{'Name'} -> $ra->{'Value'}" . $html->br();
      }
    }

    # name=Cisco-Account-Info value=N1TP_100;3541;test;8657;8149;1781505;2915555
    # name=User-Name value=test
    # name=Cisco-Command-Code value=1
    # name=Cisco-Account-Info value=S85.132.11.5
    # name=Cisco-AVPair value=sg-version=1.0
    # name=Cisco-NAS-Port value=0/0/1/40
    # name=NAS-Port value=0
    # name=NAS-Port-Id value=0/0/1/40
    # name=Framed-IP-Address value=85.132.11.5 Content-Type: text/html

    # If ISG return error push error to log
    if ($RAD_PAIRS{'Error-Cause'}) {
      my $message = "NAS: $Nas->{NAS_ID}, $RAD_PAIRS{'Error-Cause'} / $RAD_PAIRS{'Reply-Message'}";
      $html->message('err', $lang{ERROR}, $message, { ID => 100 });
      $Log->log_add(
        {
          LOG_TYPE  => $Log::log_levels{'LOG_WARNING'},
          ACTION    => 'AUTH',
          USER_NAME => $attr->{USER_NAME} || '-',
          MESSAGE   => $message,
          DB        => 1,
          NAS_ID    => $Nas->{NAS_ID} || 0
        }
      );

      return 0;
    }
    else {
      if (!$Dv->{ISG_CID_CUR}) {
        $html->message('err', $lang{ERROR}, "$lang{NOT_EXIST} ID: '$user_ip' ", { ID => 11 });
      }
      elsif ($Dv->{ISG_CID_CUR} =~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/) {
        my $DHCP_INFO = dv_dhcp_get_mac($Dv->{ISG_CID_CUR});
        $Dv->{ISG_CID_CUR} = $DHCP_INFO->{MAC} || '';
        if ($Dv->{ISG_CID_CUR} eq '') {
          $html->message('err', $lang{ERROR}, "IP: '$user_ip', MAC $lang{NOT_EXIST}. DHCP $lang{ERROR} ", { ID => 12 });
          return 0;
        }
      }
    }
  }
  elsif ($command eq 'deactivate-service') {
  }
  elsif ($command eq 'activate-service') {
    for my $ra ($r->get_attributes) {

      #MAC as ID
      if ($ra->{'Value'} =~ /\$MA(\S+)/) {
        $Dv->{ISG_CID_CUR} = $1;
      }
      #IP user ID
      elsif ($ra->{'Value'} =~ /S(\S+)/) {
        $Dv->{ISG_CID_CUR} = $1;
      }
      $RAD_PAIRS{ $ra->{'Name'} } = $ra->{'Value'};
    }

    if ($RAD_PAIRS{'Error-Cause'}) {
      $html->message('err', $lang{ERROR}, "$RAD_PAIRS{'Error-Cause'} / $RAD_PAIRS{'Reply-Message'}", { ID => 101 });
      $Log->log_add(
        {
          LOG_TYPE  => $Log::log_levels{'LOG_WARNING'},
          ACTION    => 'AUTH',
          USER_NAME => $attr->{USER_NAME} || '-',
          MESSAGE   => "Service Enable IP: $user_ip '$service_name' Error: $RAD_PAIRS{'Error-Cause'} / $RAD_PAIRS{'Reply-Message'}",
          DB        => 1,
          NAS_ID    => $Nas->{NAS_ID} || 0
        }
      );
    }
    else {
      $html->message('info', $lang{INFO}, "$lang{SERVICE} $lang{ENABLE}");
      $Log->log_add(
        {
          LOG_TYPE  => $Log::log_levels{'LOG_INFO'},
          ACTION    => 'AUTH',
          USER_NAME => $attr->{USER_NAME} || '-',
          MESSAGE   => "Service Enable '$service_name' IP: $user_ip",
          DB        => 1,
          NAS_ID    => $Nas->{NAS_ID} || 0
        }
      );
      return 0;
    }
  }
  elsif ($command eq 'account-logon') {
    for my $ra ($r->get_attributes) {
      #MAC as ID
      if ($ra->{'Value'} =~ /\$MA(\S+)/) {
        $Dv->{ISG_CID_CUR} = $1;
      }

      #IP user ID
      elsif ($ra->{'Value'} =~ /S(\S+)/) {
        $Dv->{ISG_CID_CUR} = $1;
      }
      $RAD_PAIRS{ $ra->{'Name'} } = $ra->{'Value'};

      if ($debug > 0) {
        print "$ra->{'Name'} -> $ra->{'Value'}" . $html->br();
      }
    }

    if ($RAD_PAIRS{'Error-Cause'}) {
      $html->message('err', $lang{ERROR}, "$lang{LOGON} $lang{ERROR} [$RAD_PAIRS{'Error-Cause'}] $RAD_PAIRS{'Reply-Message'}", { ID => 101 });
      $Log->log_add(
        {
          LOG_TYPE  => $Log::log_levels{'LOG_WARNING'},
          ACTION    => 'AUTH',
          USER_NAME => $attr->{USER_NAME} || '-',
          MESSAGE   => "Logon Error: $RAD_PAIRS{'Error-Cause'} / $RAD_PAIRS{'Reply-Message'}",
          DB        => 1,
          NAS_ID    => $Nas->{NAS_ID} || 0
        }
      );
    }
    else {
      $html->message('info', $lang{INFO}, "$lang{LOGON}");
      $Log->log_add(
        {
          LOG_TYPE  => $Log::log_levels{'LOG_INFO'},
          ACTION    => 'AUTH',
          USER_NAME => $attr->{USER_NAME} || '-',
          MESSAGE   => "Logon",
          DB        => 1,
          NAS_ID    => $Nas->{NAS_ID} || 0
        }
      );

      return 0;
    }
  }
  elsif ($command eq 'account-logoff') {
    for my $ra ($r->get_attributes) {
      #MAC as ID
      if ($ra->{'Value'} =~ /\$MA(\S+)/) {
        $Dv->{ISG_CID_CUR} = $1;
      }
      #IP user ID
      elsif ($ra->{'Value'} =~ /S(\S+)/) {
        $Dv->{ISG_CID_CUR} = $1;
      }

      $RAD_PAIRS{ $ra->{'Name'} } = $ra->{'Value'};

      if ($debug > 0) {
        print "$ra->{'Name'} -> $ra->{'Value'}" . $html->br();
      }
    }

    if ($RAD_PAIRS{'Error-Cause'}) {
      $html->message('err', $lang{ERROR}, "$lang{LOGON} $lang{ERROR} [$RAD_PAIRS{'Error-Cause'}] $RAD_PAIRS{'Reply-Message'}", { ID => 101 });
      $Log->log_add(
        {
          LOG_TYPE  => $Log::log_levels{'LOG_WARNING'},
          ACTION    => 'AUTH',
          USER_NAME => $attr->{USER_NAME} || '-',
          MESSAGE   => "Logon Error: $RAD_PAIRS{'Error-Cause'} / $RAD_PAIRS{'Reply-Message'}",
          DB        => 1,
          NAS_ID    => $Nas->{NAS_ID} || 0
        }
      );
    }
    else {
      $html->message('info', $lang{INFO}, "$lang{LOGON}");
      $Log->log_add(
        {
          LOG_TYPE  => $Log::log_levels{'LOG_INFO'},
          ACTION    => 'AUTH',
          USER_NAME => $attr->{USER_NAME} || '-',
          MESSAGE   => "Logon",
          DB        => 1,
          NAS_ID    => $Nas->{NAS_ID} || 0
        }
      );

      return 0;
    }
  }

  return 1;
}

#**********************************************************
=head2 dv_turbo_mode_report()

=cut
#**********************************************************
sub dv_turbo_mode_report {
  dv_turbo_mode({ REPORT => 1 });

  return 1;
}

#**********************************************************
=head2 dv_turbo_mode($attr)

=cut
#**********************************************************
sub dv_turbo_mode {
  my ($attr) = @_;

  if (form_purchase_module({
    HEADER           => $user->{UID},
    MODULE           => 'Turbo',
    REQUIRE_VERSION  => 2.20
    })) {
    return 0;
  }

  my $Turbo    = Turbo->new($db, $admin, \%conf);
  #my $sessions = Turbo->new($db, $admin, \%conf);

  if ($FORM{del} && defined($FORM{COMMENTS})) {
    $Turbo->del({ ID => $FORM{del} });
    if (!_error_show($Turbo)) {
      $html->message('info', $lang{INFO}, "Torbo $lang{DELETED}");
    }
  }

  if (!defined($FORM{sort})) {
    $LIST_PARAMS{SORT} = 4;
    $LIST_PARAMS{DESC} = 'DESC';
  }

  $LIST_PARAMS{ACTIVE} = 1 if (!$attr->{REPORT});

  my $list = $Turbo->list({%LIST_PARAMS, COLS_NAME => 1 });

  if ($Turbo->{TOTAL} < 1) {
    $html->message('info', $lang{INFO}, "$lang{NO_RECORD}");
    return 0;
  }

  my @caption = ("$lang{USER}", "$lang{TARIF_PLAN}", "$lang{REMAIN} $lang{TIME}", "$lang{START}", "$lang{DURATION}", "$lang{SPEED}");

  if ($Sessions->{SEARCH_FIELDS_COUNT}) {
    push @caption, 'TC';
  }

  my $table = $html->table(
    {
      width        => '100%',
      caption      => "TURBO $lang{SESSIONS}",
      title        => [ @caption, "-" ],
      cols_align   => [ 'left', 'right', 'right', 'RIGHT', 'right', 'right', 'right', 'right', 'right', 'right', 'center:noprint', 'center:noprint' ],
      qs           => $pages_qs,
      pages        => $Turbo->{TOTAL},
      recs_on_page => $LIST_PARAMS{PAGE_ROWS},
      ID           => 'DV_TURBO_SESSIONS'
    }
  );

  my $delete = '';
  require Billing;
  Billing->import();
  Billing->new($db, \%conf);

  foreach my $line (@$list) {
    if ($permissions{3}{1}) {
      $delete = $html->button($lang{DEL}, "index=" . $index . "$pages_qs&del=$line->{id}", { MESSAGE => "$lang{DEL} $lang{SESSIONS} $line->{id} ", class => 'del' });
    }

    $table->addrow($html->button("$line->{login}", "index=11&UID=$line->{uid}"),
       $line->{mode_id},
       $line->{last_time},
       $line->{start},
       $line->{time},
       $line->{speed},
       $delete
    );
  }

  print $table->show();

  return 1;
}

#**********************************************************
=head2 dv_user_info()

=cut
#**********************************************************
sub dv_user_info {
  my $DHCP_INFO = undef;

  my $service_status = sel_status({ HASH_RESULT => 1 });

  if ($conf{DV_ISG}) {
    #Check deposit and disable STATUS
    my $list = $Dv->list(
      {
        LOGIN         => $user->{LOGIN},
        CREDIT        => '_SHOW',
        DEPOSIT       => '_SHOW',
        DV_STATUS     => '_SHOW',
        TP_NAME       => '_SHOW',
        TP_CREDIT     => '>0',
        PAYMENTS_TYPE => 0,
        COLS_NAME     => 1
      }
    );

    if ($Dv->{TOTAL} < 1) {

    }
    elsif (($list->[0]->{credit} > 0 && ($list->[0]->{deposit} + $list->[0]->{credit} < 0))
      || ($list->[0]->{credit} == 0 && $list->[0]->{deposit} + $list->[0]->{credit}) < 0)
    {
      form_neg_deposit($user);
      return 0;
    }
    elsif ($list->[0]->{dv_status} && $list->[0]->{dv_status} == 1) {
      $html->message('err', $lang{ERROR}, "$lang{SERVICES} '$list->[0]->{tp_name}' $lang{DISABLE}", { ID => 15 });
      return 0;
    }

    if (!cisco_isg_cmd($user->{REMOTE_ADDR}, "account-status-query", { USER_NAME => $user->{LOGIN} })) {
      return 0;
    }

    if ($Dv->{ISG_CID_CUR}) {
      #change speed (active turbo mode)
      if ($FORM{SPEED}) {
        if ($Dv->{CURE_SERVICE} =~ /TP/ || !$Dv->{TURBO_MODE_RUN}) {
          my $service_name = 'TURBO_SPEED' . $FORM{SPEED};

          #Deactive cure service (TP Service)
          if ($Dv->{CURE_SERVICE} =~ /TP/) {
            if (!cisco_isg_cmd($user->{REMOTE_ADDR}, "deactivate-service", { USER_NAME    => $user->{LOGIN},
                                                                             CURE_SERVICE => $Dv->{CURE_SERVICE},
                                                                             SERVICE_NAME => $service_name  })) {

            }
          }

          #Activate service
          if (!cisco_isg_cmd($user->{REMOTE_ADDR}, "deactivate-service", { USER_NAME => $user->{LOGIN}, SERVICE_NAME => $service_name })) {
            return 0;
          }
        }
        elsif ($Dv->{TURBO_MODE_RUN}) {
          $html->message('info', $lang{INFO}, "TURBO $lang{MODE} $lang{ENABLE}");
        }
      }
    }
  }
  # Users autoregistrations
  elsif ($conf{DV_IP_DISCOVERY}) {
    $Sessions->online(
      {
        CLIENT_IP => $user->{REMOTE_ADDR},
        USER_NAME => $user->{LOGIN},
      }
    );

    if ($Sessions->{TOTAL} < 1) {
      $DHCP_INFO = dv_dhcp_get_mac($user->{REMOTE_ADDR}, { CHECK_STATIC => 1 });
      if (!$DHCP_INFO->{MAC}) {
        $html->message('err', $lang{ERROR}, "DHCP $lang{ERROR}\n MAC: $lang{NOT_EXIST}\n IP: '$user->{REMOTE_ADDR}'", { ID => 112 });
        return 0;
      }
      elsif ($DHCP_INFO->{STATIC}) {
        if ($DHCP_INFO->{IP} ne "$user->{REMOTE_ADDR}") {
          $html->message('err', $lang{ERROR}, "$lang{ERR_IP_ADDRESS_CONFLICT}\n MAC: $lang{NOT_EXIST}\n IP: '$user->{REMOTE_ADDR}' ", { ID => 114 });
        }
      }
      else {
        if($FORM{discovery}) {
          if (dv_dhcp_get_mac_add($user->{REMOTE_ADDR}, $DHCP_INFO)) {
            $html->message('info', $lang{INFO}, "$lang{ACTIVATE}\n\n IP: $Dv->{NEW_IP}\n CID: $DHCP_INFO->{MAC}");
          }
        }

        if (! $Dv->{NEW_IP}) {
          $html->tpl_show(_include('dv_guest_mode', 'Dv'),
                                                   { %$Dv,
                                                     %$DHCP_INFO,
                                                     ID => 'dv_guest_mode' });
        }
      }
    }
  }

  if ($FORM{activate}) {
    $Dv->change(
      {
        UID    => $LIST_PARAMS{UID},
        STATUS => 0,
        CID    => ($Dv->{ISG_CID_CUR}) ? $Dv->{ISG_CID_CUR} : undef
      }
    );

    if (!$Dv->{errno}) {
      $Dv->{ACCOUNT_ACTIVATE}=$user->{ACTIVATE};
      $html->message('info', $lang{INFO}, "$lang{ACTIVATE} CID: $Dv->{ISG_CID_CUR}") if ($Dv->{ISG_CID_CUR});
      service_get_month_fee($Dv) if (!$Dv->{STATUS});
    }
    else {
      $html->message('err', $lang{ACTIVATE}, "$lang{ERROR} CID: $Dv->{ISG_CID_CUR}", { ID => 102 });
    }

    #Log on
    if (!cisco_isg_cmd($user->{REMOTE_ADDR}, "account-logoff",
       { USER_NAME => $user->{LOGIN},
         #'User-Password' => '123456'
        })) {
      return 0;
    }
  }
  elsif ($FORM{logon}) {
    #Logon
    if (!cisco_isg_cmd($user->{REMOTE_ADDR}, "account-logoff",
       { USER_NAME => $user->{LOGIN},
        })) {
      return 0;
    }
  }
#  elsif ($FORM{discovery}) {
#    if (dv_dhcp_get_mac_add($user->{REMOTE_ADDR}, $DHCP_INFO)) {
#      $html->message('info', $lang{INFO}, "$lang{ACTIVATE}\n\n IP: $Dv->{NEW_IP}\n CID: $DHCP_INFO->{MAC}");
#    }
#  }
  elsif ($FORM{hangup}) {
    require Abills::Nas::Control;
    Abills::Nas::Control->import();
    my $Nas_cmd = Abills::Nas::Control->new($db, \%conf);

    $Nas_cmd->hangup(
      $Nas,
      0,
      $user->{LOGIN},
      {
        ACCT_SESSION_ID      => '',
        FRAMED_IP_ADDRESS    => $user->{REMOTE_ADDR},
        UID                  => $user->{UID},
        USER_INFO            => $user->{LOGIN},
        CID                  => 'User hangup',
        ACCT_TERMINATE_CAUSE => 1
      }
    );
  }

  $Dv->info($LIST_PARAMS{UID}, { DOMAIN_ID => $user->{DOMAIN_ID} });
  $user->{DV_STATUS} = $Dv->{STATUS};

  if ($Dv->{TOTAL} < 1) {
    $html->message('info', "Internet $lang{SERVICE}", "$lang{NOT_ACTIVE}", { ID => 17 });
    return 0;
  }

  $Dv->{NEXT_FEES_WARNING} = dv_warning({ USER => $user,
                                          DV   => $Dv
                                         });

  if ($Dv->{NEXT_FEES_WARNING}) {
    $Dv->{NEXT_FEES_WARNING}=$html->message('info', "", $Dv->{NEXT_FEES_WARNING}, { OUTPUT2RETURN => 1 }) ;
  }

  my ($status, $color) = split(/:/, $service_status->{ $Dv->{STATUS} });
  $user->{SERVICE_STATUS} = $Dv->{STATUS};

  if ($Dv->{STATUS} == 2) {
    $Dv->{STATUS} = $html->color_mark($status, $color) . ' ';
    $Dv->{STATUS} .= ($user->{DISABLE} > 0) ? $html->b("($lang{ACCOUNT} $lang{DISABLE})")
                                            : $html->button($lang{ACTIVATE}, "&index=$index&sid=$sid&activate=1", { ex_params => ' ID="ACTIVATE"', BUTTON => 1 });
  }
  elsif ($Dv->{STATUS} == 5) {
    $Dv->{STATUS} = $html->color_mark($status, $color) . ' ';

    if ($Dv->{MONTH_ABON} && $user->{DEPOSIT} && $Dv->{MONTH_ABON} <= $user->{DEPOSIT}) {
      $Dv->{STATUS} .= ($user->{DISABLE} > 0) ? $html->b("($lang{ACCOUNT} $lang{DISABLE})")
                                              : $html->button($lang{ACTIVATE}, "&index=$index&sid=$sid&activate=1", { ex_params => ' ID="ACTIVATE"', BUTTON => 1 });
    }
    else {
      if ($functions{$index} && $functions{$index} eq 'dv_user_info') {
        form_neg_deposit($user);
      }
    }
  }

  $Dv->{STATUS_VALUE} = $html->color_mark($status, $color);

  while (my ($k, $v) = each %functions) {
    if ($v eq 'dv_user_info') {
      $index = $k;
      last;
    }
  }

  if ($conf{DV_USER_CHG_TP}) {
    $Dv->{TP_CHANGE} = $html->button("$lang{CHANGE}", 'index=' . get_function_index('dv_user_chg_tp') . '&sid=' . $sid, { class => 'change rightAlignText' });
  }

  #Activate Cisco ISG Account
  if ($conf{DV_ISG}) {
    if ($user->{DISABLE}) {
      $html->message('err', $lang{ERROR}, "$lang{USER}  $lang{DISABLE}", { ID => 16 });
    }
    elsif ($Dv->{CID} ne $Dv->{ISG_CID_CUR} || $Dv->{CID} eq '') {
      $html->message('info', $lang{INFO}, "$lang{NOT_ACTIVE}\n\n CID: $Dv->{ISG_CID_CUR}\n IP: $user->{REMOTE_ADDR} ", { ID => 121  });
      $html->form_main(
        {
          CONTENT => '',
          HIDDEN  => {
            index => "$index",
            CID   => "$Dv->{ISG_CID_CUR}",
            sid   => $sid
          },
          SUBMIT => { activate => "$lang{ACTIVATE}" }
        }
      );

      $Dv->{CID} = $Dv->{ISG_CID_CUR};
      $Dv->{IP}  = $user->{REMOTE_ADDR};
      $Dv->{CID} .= ' ' . $html->color_mark($lang{NOT_ACTIVE}, $_COLORS[6]);
    }

    #Self hangup
    elsif ($Dv->{CID} eq $Dv->{ISG_CID_CUR}) {
      my $table = $html->table(
        {
          width    => '600',
          rowcolor => 'row_active',
          rows     => [
            [
              ($Dv->{ISG_SESSION_DURATION}) ? "$lang{SESSIONS} $lang{DURATION}: " . sec2time($Dv->{ISG_SESSION_DURATION}, { str => 1 }) : '',
              ($Dv->{CURE_SERVICE} && $Dv->{CURE_SERVICE} !~ /TP/ && !$Dv->{TURBO_MODE_RUN}) ? $html->form_input('logon', "$lang{LOGON} ", { TYPE => 'submit', OUTPUT2RETURN => 1 }) : '',
              #$html->form_input('hangup', $lang{HANGUP}, { TYPE => 'submit', OUTPUT2RETURN => 1 })
            ]
          ],
        }
      );

      print $html->form_main(
        {
          CONTENT => $table->show({ OUTPUT2RETURN => 1 }),
          HIDDEN  => {
            index => $index,
            CID   => $Dv->{ISG_CID_CUR},
            sid   => $sid
          },
        }
      );
    }
  }

  #Turbo mode Enable function
  if ($conf{DV_TURBO_MODE} && !$Dv->{TURBO_MODE}) {
    my (@turbo_mods) = split(/;/, $conf{DV_TURBO_MODE});
    my @turbo_mods_full = ();

    my $i = 1;
    my ($speed, $time, $price, $name, $bonus);
    foreach my $line (@turbo_mods) {
      ($speed, $time, $price, $name, $bonus) = split(/:/, $line, 5);

      if ($bonus && ! $Dv->{FREE_TURBO_MODE} ) {
        next;
      }

      push @turbo_mods_full, sprintf("$name\n $lang{SPEED}: $speed\n $lang{TIME}: %s\n $lang{PRICE}: %.2f %s", sec2time($time, { format => 1 }), $price, (($bonus) ? "($lang{BONUS})" : ''));
      if ($FORM{SPEED} && $FORM{SPEED} == $i) {
        $FORM{MODE_ID} = $i - 1;
        $FORM{SPEED}   = $speed;
        $FORM{TIME}    = $time;
        last;
      }
      $i++;
    }

    if (form_purchase_module({
      HEADER           => $user->{UID},
      MODULE           => 'Turbo',
      REQUIRE_VERSION  => 2.20
      })) {
      return 0;
    }

    my $Turbo = Turbo->new($db, $admin, \%conf);
    my $list = $Turbo->list(
      {
        UID    => $LIST_PARAMS{UID},
        ACTIVE => 1,
      }
    );

    if ($Turbo->{TOTAL} > 0 || $Dv->{TURBO_MODE_RUN}) {
      my $last = $list->[0]->[2] || $Dv->{TURBO_MODE_RUN};
      $html->message('info', $lang{INFO}, $html->b("$turbo_mods_full[$list->[0]->[1]]") . "\n$lang{REMAIN} $lang{TIME}: $last sec.");
    }
    elsif ($FORM{change} && $FORM{SPEED}) {
      if ($user->{DEPOSIT} + $user->{CREDIT} > $price) {
        $Turbo->add(
          {
            UID        => $LIST_PARAMS{UID},
            MODE_ID    => $FORM{MODE_ID},
            SPEED      => int($FORM{SPEED}),
            SPEED_TYPE => 0,
            TIME       => $FORM{TIME},
          }
        );

        if (_error_show($Turbo, { SILENT_MODE => 1 })) {
          return 0;
        }

        if ($price > 0) {
          $Fees->take($user, $price, { DESCRIBE => "Turbo mode: $Turbo->{INSERT_ID}" });
        }

        if ($bonus) {
           if ($Dv->{FREE_TURBO_MODE} < 1) {
              $html->message('err', "$lang{ERROR}", "$lang{BONUS} Turbo $lang{EXPIRE}");
              return 0;
           }
           else {
             $Dv->change({
                UID             => $user->{UID},
                FREE_TURBO_MODE => ($Dv->{FREE_TURBO_MODE}-1)
             });
           }
         }

        if ($conf{DV_TURBO_CMD}) {
          cmd($conf{DV_TURBO_CMD}, {
                                    PARAMS => { %$user,
                                    DEBUG  => $conf{DV_TURBO_CMD_DEBUG},
                                    IP     => $ENV{REMOTE_ADDR}
                                    } });
        }

        $html->message('info', $lang{INFO}, $html->b("$turbo_mods_full[$FORM{MODE_ID}]") . "\n$lang{REMAIN} $lang{TIME}: $FORM{TIME} sec.");
      }
      else {
        $html->message('err', "$lang{ERROR}:Turbo", "$lang{ERR_SMALL_DEPOSIT}");
      }
    }
    else {
      $Dv->{SPEED_SEL} = $html->form_select(
        'SPEED',
        {
          SELECTED     => $FORM{SPEED},
          SEL_ARRAY    => [ '', @turbo_mods_full ],
          ARRAY_NUM_ID => 1
        }
      );

      $html->tpl_show(_include('dv_user_speed', 'Dv'), $Dv);
    }
  }

  if ($Dv->{IP} eq '0.0.0.0') {
    $Dv->{IP} = $lang{NO};
  }

  if ($conf{DV_USER_SERVICE_HOLDUP}) {
    $Dv->{HOLDUP_BTN} = dv_holdup_service($Dv);
  }

  $html->tpl_show(_include('dv_user_info', 'Dv'), $Dv,
                                                  {  ID => 'dv_user_info' });

  if($conf{DV_ALERT_REDIRECT_FILTER} && $conf{DV_ALERT_REDIRECT_FILTER} eq $Dv->{FILTER_ID}) {
    $Dv->change({ UID => $user->{UID},
                  FILTER_ID => ''
               });
  }

  return 1;
}

#**********************************************************
=head2 dv_holdup_service($attr)

=cut
#**********************************************************
sub dv_holdup_service {
  #my ($attr) = @_;

  my ($hold_up_min_period, $hold_up_max_period, $hold_up_period, $holdup_fees, $hold_fees_deposit, $active_fees, $holdup_skip_gids) = split(/:/, $conf{DV_USER_SERVICE_HOLDUP});

  if ($holdup_skip_gids) {
    my @holdup_skip_gids_arr = split(/,\s?/, $holdup_skip_gids);
    if (in_array($user->{GID}, \@holdup_skip_gids_arr)) {
      return '';
    }
  }

  if ($holdup_fees && $holdup_fees > 0) {
    $Dv->{DAY_FEES}="$lang{DAY_FEE}: ". sprintf("%.2f", $holdup_fees);
  }

  my $Shedule = Shedule->new($db, $admin, \%conf);

  if ($FORM{del}) {
    $Shedule->del(
      {
        UID => $user->{UID},
        IDS => $FORM{del},
      }
    );

    $Dv->{STATUS_DAYS}=1;

    service_get_month_fee($Dv, { QUITE => 1 });

    if ( $user->{DV_STATUS} == 3) {
      $Dv->change(
          {
            UID    => $user->{UID},
            STATUS => 0,
          }
      );

      $html->message('info', $lang{SERVICE}, "$lang{ACTIVATE}");
      return '';
    }

    $html->message('info', $lang{HOLD_UP}, "$lang{DELETED}");
  }

  my $list = $Shedule->list(
    {
      UID    => $user->{UID},
      MODULE => 'Dv',
      TYPE   => 'status',
      COLS_NAME=>1
    }
  );

  my %Shedule_val = ();
  my @del_arr     = ();

  foreach my $line (@$list) {
    $Shedule_val{ $line->{action} } = ($line->{y} || '*') .'-'. ($line->{m} || '*') .'-'. ($line->{d} || '*');
    push @del_arr, $line->{id};
  }

  my $del_ids = join(', ', @del_arr);

  if ($Shedule->{TOTAL}) {
    $html->message('info', $lang{INFO}, "$lang{HOLD_UP} ". ($Shedule_val{3} || '-') ."$lang{TO} ". ($Shedule_val{0} || '-') .
        (($Shedule->{TOTAL} > 1) ? $html->br() . $html->button($lang{DEL}, "index=$index&del=$del_ids". (($sid) ? "&sid=$sid" : q{}), { BUTTON => 1, MESSAGE => "$lang{DEL} $lang{HOLD_UP}?" }) : ''));
    return '';
  }

  if ($FORM{add} && $FORM{ACCEPT_RULES}) {
    my ($from_year, $from_month, $from_day) = split(/-/, $FORM{FROM_DATE}, 3);
    my ($to_year,   $to_month,   $to_day)   = split(/-/, $FORM{TO_DATE},   3);
    my $block_days = date_diff($FORM{FROM_DATE}, $FORM{TO_DATE});

    if ($block_days < $hold_up_min_period) {
      $html->message('err', "$lang{ERR_WRONG_DATA}", "$lang{MIN} $lang{HOLD_UP}   $hold_up_min_period $lang{DAYS}");
    }
    elsif ($block_days > $hold_up_max_period) {
      $html->message('err', "$lang{ERR_WRONG_DATA}", "$lang{MAX} $lang{HOLD_UP}   $hold_up_max_period $lang{DAYS}");
    }
    elsif (date_diff($DATE, $FORM{FROM_DATE}) < 1) {
      $html->message('info', $lang{INFO}, "$lang{ERR_WRONG_DATA}\n $lang{FROM}: $FORM{FROM_DATE}");
    }
    elsif ($block_days < 1) {
      $html->message('info', $lang{INFO}, "$lang{ERR_WRONG_DATA}\n $lang{TO}: $FORM{TO_DATE}");
    }
    else {
      $Shedule->add(
        {
          UID    => $user->{UID},
          TYPE   => 'status',
          ACTION => '3',
          D      => $from_day,
          M      => $from_month,
          Y      => $from_year,
          MODULE => 'Dv'
        }
      );

      $Shedule->add(
        {
          UID    => $user->{UID},
          TYPE   => 'status',
          ACTION => '0',
          D      => $to_day,
          M      => $to_month,
          Y      => $to_year,
          MODULE => 'Dv'
        }
      );

      if (!_error_show($Shedule)) {
        #compensate period
        if ($conf{DV_HOLDUP_COMPENSATE}) {
          dv_compensation({ QUITE => 1, HOLD_UP => 1 });
        }

        $html->message('info', $lang{INFO}, "$lang{HOLD_UP}\n $lang{DATE}: $FORM{FROM_DATE} -> $FORM{TO_DATE}\n  $lang{DAYS}: " . sprintf("%d", $block_days));
        return '';
      }
    }
  }

  if ($hold_up_period) {
    $admin->action_list(
      {
        UID       => $user->{UID},
        TYPE      => 14,
        FROM_DATE => POSIX::strftime("%Y-%m-%d", localtime(time - 86400 * $hold_up_period)),
        TO_DATE   => "$DATE",
      }
    );

    if ($admin->{TOTAL} > 0) {
      return '';
    }
  }

  if (($user->{DV_STATUS} && $user->{DV_STATUS} == 3) || $user->{DISABLE}) {
    $html->message('info', $lang{INFO}, "$lang{HOLD_UP}\n " . $html->button("$lang{ACTIVATE}", "index=$index&del=1&sid=$sid", { BUTTON => 1, MESSAGE => "$lang{ACTIVATE}?" }) );
    return '';
  }

  $Dv->{DATE_FROM} = $html->date_fld2(
    'FROM_DATE',
    {
      FORM_NAME => 'holdup',
      WEEK_DAYS => \@WEEKDAYS,
      MONTHES   => \@MONTHES,
      NEXT_DAY  => 1
    }
  );

  $Dv->{DATE_TO} = $html->date_fld2(
    'TO_DATE',
    {
      FORM_NAME => 'holdup',
      WEEK_DAYS => \@WEEKDAYS,
      MONTHES   => \@MONTHES,
    }
  );

  return $html->tpl_show(_include('dv_hold_up', 'Dv'), $Dv, { OUTPUT2RETURN => 1 });
}

#**********************************************************
=head2 dv_periodic_logrotate($attr)

=cut
#**********************************************************
sub dv_periodic_logrotate {
  my ($attr) = @_;
  my $debug = $attr->{DEBUG} || 0;

  return '' if ($attr->{SKIP_ROTATE});

  # Clean s_detail table
  my (undef, undef, $d) = split(/-/, $ADMIN_REPORT{DATE}, 3);
  $conf{DV_LOG_CLEAN_PERIOD} = 180 if (!$conf{DV_LOG_CLEAN_PERIOD});

  if ($d == 1 && $conf{DV_LOG_CLEAN_PERIOD}) {
    $DEBUG .= "Make log rotate\n" if ($debug > 0);

    $Sessions->log_rotate(
      {
        TYPES  => [ 'SESSION_DETAILS', 'SESSION_INTERVALS' ],
        PERIOD => $conf{DV_LOG_CLEAN_PERIOD}
      }
    );
  }
  else {
    $Sessions->log_rotate({ DAILY => 1 });
  }

  return 1;
}

#**********************************************************
=head2 dv_daily_fees($attr) - daily fees

=cut
#**********************************************************
sub dv_daily_fees {
  my ($attr) = @_;

  my $debug        = $attr->{DEBUG} || 0;
  my $debug_output = '';
  my $DOMAIN_ID    = $attr->{DOMAIN_ID} || 0;

  if ($attr->{USERS_WARNINGS_TEST}) {
    return $debug_output;
  }

  if (!$ADMIN_REPORT{DATE}) {
    $ADMIN_REPORT{DATE} = $DATE ;
  }

  $debug_output .= "DV: Daily periodic fees\n" if ($debug > 1);

  $LIST_PARAMS{TP_ID}     = $attr->{TP_ID} if ($attr->{TP_ID});
  $LIST_PARAMS{DOMAIN_ID} = $DOMAIN_ID;
  my %USERS_LIST_PARAMS         = ( REGISTRATION => "<$ADMIN_REPORT{DATE}" );
  $USERS_LIST_PARAMS{LOGIN}     = $attr->{LOGIN} if ($attr->{LOGIN});
  $USERS_LIST_PARAMS{GID}       = $attr->{GID} if ($attr->{GID});

  #$USERS_LIST_PARAMS{ACTIVE_DAY_FEE} = 1;
  $Tariffs->{debug} = 1 if ($debug > 6);

  my $list = $Tariffs->list({%LIST_PARAMS,
                             MODULE     => 'Dv',
                             COLS_NAME  => 1,
                             COLS_UPPER => 1 });

  my %FEES_METHODS = %{ get_fees_types({ SHORT => 1 }) };

  foreach my $TP_INFO (@$list) {
    my %FEES_PARAMS = ();
    if ($TP_INFO->{DAY_FEE} > 0) {
      $debug_output .= "TP ID: $TP_INFO->{ID} DF: $TP_INFO->{DAY_FEE} POSTPAID: $TP_INFO->{POSTPAID_DAILY_FEE} REDUCTION: $TP_INFO->{REDUCTION_FEE} EXT_BILL: $TP_INFO->{EXT_BILL_ACCOUNT} CREDIT: $TP_INFO->{CREDIT}\n" if ($debug > 1);

      $USERS_LIST_PARAMS{DOMAIN_ID} = $TP_INFO->{DOMAIN_ID};
      #Get active yesterdays logins
      my %active_logins = ();
      if ($TP_INFO->{ACTIVE_DAY_FEE} > 0) {
        my $report_list = $Sessions->reports(
          {
            INTERVAL => "$attr->{YESTERDAY}/$attr->{YESTERDAY}",
            TP_ID    => $TP_INFO->{ID},
          }
        );

        foreach my $l (@$report_list) {
          $active_logins{ $l->[0] } = $l->[6];
        }
      }

      $Dv->{debug} = 1 if ($debug > 6);
      my $ulist = $Dv->list(
        {
          LOGIN        => '_SHOW',
          ACTIVATE     => "<=$ADMIN_REPORT{DATE}",
          EXPIRE       => "0000-00-00,>$ADMIN_REPORT{DATE}",
          DV_EXPIRE    => "0000-00-00,>$ADMIN_REPORT{DATE}",
          JOIN_SERVICE => "<2",
          DV_STATUS    => "0;5",
          LOGIN_STATUS => 0,
          TP_ID        => $TP_INFO->{ID},
          SORT         => 1,
          PAGE_ROWS    => 1000000,
          TP_CREDIT    => '_SHOW',
          REDUCTION    => '_SHOW',
          BILL_ID      => '_SHOW',
          DEPOSIT      => '_SHOW',
          CREDIT       => '_SHOW',
          DELETED      => 0,
          COLS_NAME    => 1,
          %USERS_LIST_PARAMS
        }
      );

      foreach my $u (@$ulist) {
        #Check bill id and deposit
        my %user = (
          LOGIN     => $u->{login},
          UID       => $u->{uid},
          #Check ext deposit
          BILL_ID   => ($TP_INFO->{EXT_BILL_ACCOUNT} > 0) ? $u->{ext_bill_id} : $u->{bill_id},
          REDUCTION => $u->{reduction},
          ACTIVATE  => $u->{activate},
          DEPOSIT   => $u->{deposit},
          CREDIT    => ($u->{credit} > 0) ? $u->{credit} : ($conf{user_credit_change}) ? 0 : $TP_INFO->{CREDIT},
          DV_STATUS => $u->{dv_status},
        );

        if (defined($user{BILL_ID}) && $user{BILL_ID} > 0 && defined($user{DEPOSIT})) {
          #If deposit is above-zero or TARIF PALIN is POST PAID or PERIODIC PAYMENTS is POSTPAID
          #Active day fees
          if ( (($user{DEPOSIT} + $user{CREDIT} > 0 || $TP_INFO->{PAYMENT_TYPE} == 1 || $TP_INFO->{POSTPAID_DAILY_FEE} == 1) && $TP_INFO->{ACTIVE_DAY_FEE} == 0)
            || ($TP_INFO->{ACTIVE_DAY_FEE} == 1 && $active_logins{ $user{LOGIN} }))
          {
            my $sum = $TP_INFO->{DAY_FEE};

            # IF TP have PARIODIC PAYMENTS USER reduction
            if ($TP_INFO->{REDUCTION_FEE} == 1 && $user{REDUCTION} > 0) {
              if ($user{REDUCTION} >= 100) {
                $debug_output .= "UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION} next\n" if ($debug > 3);
                next;
              }
              $sum = $sum * (100 - $user{REDUCTION}) / 100;
            }

            my %FEES_DSC = (
              MODULE          => 'Internet',
              TP_ID           => $TP_INFO->{ID},
              TP_NAME         => $TP_INFO->{NAME},
              FEES_PERIOD_DAY => $lang{DAY_FEE_SHORT},
              FEES_METHOD     => $FEES_METHODS{$TP_INFO->{FEES_METHOD}},
            );

            my %PARAMS = (
              DATE     => "$ADMIN_REPORT{DATE} $TIME",
              METHOD   => ($TP_INFO->{FEES_METHOD}) ? $TP_INFO->{FEES_METHOD} : 1,
              DESCRIBE => fees_dsc_former(\%FEES_DSC),
            );

            if ($debug > 4) {
              $debug_output .= " UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION}\n";
            }
            else {
              $Fees->take(\%user, $sum, {%PARAMS});
              if ($Fees->{errno}) {
                print "Dv Error: [ $user{UID} ] $user{LOGIN} SUM: $sum [$Fees->{errno}] $Fees->{errstr} ";
                if ($Fees->{errno} == 14) {
                  print "[ $user{UID} ] $user{LOGIN} - Don't have money account";
                }
                print "\n";
              }
              elsif ($debug > 0) {
                $debug_output .= " $user{LOGIN}  UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION}\n" if ($debug > 0);
              }
            }
          }

          # If status too small deposit get fine from user
          elsif ($TP_INFO->{FINE} > 0) {
            if ($conf{DV_FINE_LIMIT} && $user{DEPOSIT} + $user{CREDIT} < $conf{DV_FINE_LIMIT}) {
              next;
            }

            %FEES_PARAMS = (
              DESCRIBE => "$lang{FINE}",
              METHOD   => 2,
              DATE     => $ADMIN_REPORT{DATE},
            );
            #$EXT_INFO = "FINE";
            $Fees->take(\%user, $TP_INFO->{FINE}, {%FEES_PARAMS});
            $debug_output .= " $user{LOGIN}  UID: $user{UID} SUM: $TP_INFO->{FINE} REDUCTION: $user{REDUCTION} FINE\n" if ($debug > 0);
          }
        }
        else {
          print "[ $user{UID} ] $user{LOGIN} - Don't have money account (Dv)\n";
        }
      }
    }
  }

  #Daily bonus PAYMENTS
  #Make traffic recalculation for expration
  $list = $Tariffs->list({%LIST_PARAMS, MODULE => 'Dv' });
  $debug_output .= "Bonus payments\n";
  require Billing;
  Billing->import();
  my $Billing = Billing->new($db, \%conf);

  foreach my $tp_line (@$list) {
    my $ti_list = $Tariffs->ti_list({ TP_ID => $tp_line->[18] });
    next if ($Tariffs->{TOTAL} != 1);

    $debug_output .= "TP_ID: $tp_line->[0]\n" if ($debug > 6);
    foreach my $ti (@$ti_list) {

      my $tt_list = $Tariffs->tt_list({ EXPRESSION => '_SHOW',
                                        TI_ID     => $ti->[0],
                                        COLS_NAME => 1, });
      next if ($Tariffs->{TOTAL} < 1);

      my %expr_hash     = ();
      my $traffic_class = 0;

      foreach my $tt (@$tt_list) {
        my $expression = $tt->{expression};
        next if ($expression !~ /BONUS_TRAFFIC_/);

        $expression =~ s/BONUS_TRAFFIC/TRAFFIC/g;

        $debug_output .= "TP: $tp_line->[0] TI: $ti->[0] TT: $tt->{id}\n";
        $debug_output .= "  Expr: $expression\n" if ($debug > 3);
        $traffic_class = $tt->{id};

        $expr_hash{$traffic_class} = $expression;

        #last;

        if (!defined($expr_hash{$traffic_class})) {
          next;
        }

        #Get users for bonus payments
        #Ipn users for daily payments
        my $ulist = $Dv->list(
          {
            LOGIN        => '_SHOW',
            ACTIVATE     => "<=$ADMIN_REPORT{DATE}",
            EXPIRE       => "0000-00-00,>$ADMIN_REPORT{DATE}",
            DV_EXPIRE    => "0000-00-00,>$ADMIN_REPORT{DATE}",
            DV_STATUS    => 0,
            LOGIN_STATUS => 0,
            TP_ID        => $tp_line->[0],
            SORT         => 1,
            PAGE_ROWS    => 1000000,
            TP_CREDIT    => '_SHOW',
            COMPANY_ID   => '_SHOW',
            COLS_NAME    => 1,
            LOGIN        => '_SHOW',
            BILL_ID      => '_SHOW',
            REDUCTION    => '_SHOW',
            DEPOSIT      => '_SHOW',
            CREDIT       => '_SHOW',
            COMPANY_ID   => '_SHOW',
            %USERS_LIST_PARAMS
          }
        );

        foreach my $u (@$ulist) {
          my %user = (
            LOGIN      => $u->{login},
            UID        => $u->{uid},
            BILL_ID    => ($tp_line->[14] > 0) ? $u->{bill_id} : $u->{ext_bill_id},
            REDUCTION  => $u->{reduction},
            ACTIVATE   => $u->{activate},
            DEPOSIT    => $u->{deposit},
            CREDIT     => ($u->{credit} > 0) ? $u->{credit} : $tp_line->[15],
            COMPANY_ID => $u->{company_id}
          );

          $Billing->{PERIOD_TRAFFIC} = undef;

          my $RESULT = $Billing->expression(
            $user{UID},
            \%expr_hash,
            {
              START_PERIOD  => $attr->{YESTERDAY},
              STOP_PERIOD   => $attr->{DATE},
              debug         => 0,
              IPN           => 1,
              TRAFFIC_CLASS => $traffic_class
            }
          );

          #my $message = '';
          my $sum     = 0;

          my %FEES_PARAMS = (
            DATE   => $ADMIN_REPORT{DATE},
            METHOD => 0
          );

          if ($RESULT->{'TRAFFIC_IN'}) {
            $FEES_PARAMS{DESCRIBE} = "$lang{USED} $lang{TRAFFIC}: " . $RESULT->{'TRAFFIC_IN'} . "SUM: $RESULT->{PRICE_IN}";
            $sum = $RESULT->{'TRAFFIC_IN'} * $RESULT->{PRICE_IN};    #(($RESULT->{PRICE_IN}) ? $RESULT->{PRICE_IN} : 0);
          }

          if ($RESULT->{'TRAFFIC_OUT'}) {
            $FEES_PARAMS{DESCRIBE} = "$lang{USED} $lang{TRAFFIC}: " . $RESULT->{'TRAFFIC_OUT'} . "SUM: $RESULT->{PRICE_OUT}";
            $sum = $RESULT->{'TRAFFIC_OUT'} * $RESULT->{PRICE_OUT};
          }
          elsif ($RESULT->{'TRAFFIC_SUM'}) {
            $FEES_PARAMS{DESCRIBE} = "$lang{USED} $lang{TRAFFIC}: " . $RESULT->{'TRAFFIC_SUM'} . " SUM: $RESULT->{PRICE}";
            $sum = $RESULT->{'TRAFFIC_SUM'} * $RESULT->{PRICE};
          }

          if ($sum > 0 && $debug < 5) {
            $Payments->add(
              \%user,
              {
                SUM      => $sum,
                METHOD   => 4,
                DESCRIBE => "$lang{TRAFFIC_CLASS}: $traffic_class $lang{BONUS}",
              }
            );
          }

          $debug_output .= " Login: $u->{login} ($u->{uid})  TP_ID: $u->{tp_id} Payments: $sum REDUCTION: $u->{reduction} $u->{deposit} $u->{credit} - $user{ACTIVATE}\n" if ($debug > 0);
        }
      }
    }
  }

  $DEBUG .= $debug_output;
  return $debug_output;
}

#**********************************************************
=head2 dv_holdup_fees($attr) - holdup fees

=cut
#**********************************************************
sub dv_holdup_fees {
  my ($attr) = @_;

  my $debug = $attr->{DEBUG} || 0;
  my $debug_output = '';
  $debug_output .= "DV: Holdup abon\n" if ($debug > 1);
  return $debug_output if (!$conf{DV_USER_SERVICE_HOLDUP});
  my ($hold_up_min_period, $hold_up_max_period, $hold_up_period, $holdup_fees, $hold_fees_deposit) = split(/:/, $conf{DV_USER_SERVICE_HOLDUP});
  return $debug_output if (!$holdup_fees || $holdup_fees == 0);

  my %USERS_LIST_PARAMS = ();
  $USERS_LIST_PARAMS{LOGIN}    = $attr->{LOGIN} if ($attr->{LOGIN});
  $USERS_LIST_PARAMS{EXT_BILL} = 1              if ($conf{BONUS_EXT_FUNCTIONS});
  $USERS_LIST_PARAMS{TP_ID}    = $attr->{TP_ID} if ($attr->{TP_ID});

  my $ulist = $Dv->list(
    {
      ACTIVATE     => "<=$ADMIN_REPORT{DATE}",
      EXPIRE       => "0000-00-00,>$ADMIN_REPORT{DATE}",
      DV_EXPIRE    => "0000-00-00,>$ADMIN_REPORT{DATE}",
      DV_STATUS    => "3",
      LOGIN_STATUS => 0,
      SORT         => 1,
      PAGE_ROWS    => 1000000,
      TP_CREDIT    => '_SHOW',
      LOGIN        => '_SHOW',
      BILL_ID      => '_SHOW',
      REDUCTION    => '_SHOW',
      DEPOSIT      => '_SHOW',
      CREDIT       => '_SHOW',
      COMPANY_ID   => '_SHOW',
      EXT_DEPOSIT  => '_SHOW',
      COLS_NAME    => 1,
      %USERS_LIST_PARAMS
    }
  );

  my $ext_deposit_op = 0;

  foreach my $u (@$ulist) {
    my %user = (
      LOGIN        => $u->{login},
      UID          => $u->{uid},
      BILL_ID      => ($ext_deposit_op > 0) ? $u->{ext_bill_id} : $u->{bill_id},
      MAIN_BILL_ID => ($ext_deposit_op > 0) ? $u->{bill_id} : 0,
      REDUCTION    => $u->{reduction},
      ACTIVATE     => $u->{activate},
      DEPOSIT      => $u->{deposit},
      CREDIT       => ($u->{credit} > 0) ? $u->{credit} : 0,
      COMPANY_ID   => $u->{company_id},
      DV_STATUS    => $u->{dv_status},
      EXT_DEPOSIT  => ($u->{ext_deposit}) ? $u->{ext_deposit} : 0,
    );

    $debug_output .= " Login: $user{LOGIN} ($user{UID}) TP_ID: ($u->{tp_id} Fees: $holdup_fees REDUCTION: $user{REDUCTION} DEPOSIT: $u->{deposit} CREDIT $user{CREDIT} ACTIVE: $user{ACTIVATE} TP: $u->{tp_num}\n" if ($debug > 3);

    if (($user{BILL_ID} && $user{BILL_ID} > 0) && defined($user{DEPOSIT})) {
      if ($debug > 4) {
        $debug_output .= " UID: $user{UID} SUM: $holdup_fees REDUCTION: $user{REDUCTION}\n";
      }
      else {
        my %FEES_PARAMS = (
          DATE     => $ADMIN_REPORT{DATE},
          METHOD   => 1,
          DESCRIBE => "$lang{HOLD_UP}"
        );
        $Fees->take(\%user, $holdup_fees, {%FEES_PARAMS});
        $debug_output .= " $user{LOGIN}  UID: $user{UID} SUM: $holdup_fees REDUCTION: $user{REDUCTION}\n" if ($debug > 0);
      }
    }
    else {
      my $ext = ($ext_deposit_op > 0) ? 'Ext bill' : '';
      print "UID: $user{UID} LOGIN: $user{LOGIN} Don't have $ext money account\n";
    }
  }

  $DEBUG .= $debug_output;
  return $debug_output;
}

#**********************************************************
=head2 dv_monthly_next_tp($attr) Change tp in next period

=cut
#**********************************************************
sub dv_monthly_next_tp {
  my ($attr) = @_;

  my $debug         = $attr->{DEBUG} || 0;
  my $debug_output  = '';
  $Tariffs->{debug}=1 if ($debug > 6);

  my %USERS_LIST_PARAMS = ();
  $USERS_LIST_PARAMS{LOGIN} = $attr->{LOGIN} if ($attr->{LOGIN});
  $USERS_LIST_PARAMS{EXT_BILL} = 1 if ($conf{BONUS_EXT_FUNCTIONS});
  $USERS_LIST_PARAMS{REGISTRATION} = "<$ADMIN_REPORT{DATE}";
  $USERS_LIST_PARAMS{GID}   = $attr->{GID} if ($attr->{GID});

  my $list          = $Tariffs->list({ NEXT_TARIF_PLAN => '>0',
                                       CREDIT          => '_SHOW',
                                       NEXT_TP_ID      => '_SHOW',
                                       NEW_MODEL_TP    => 1,
                                       MODULE          => 'Dv',
                                       COLS_NAME       => 1 });

  my ($y, $m, $d)   = split(/-/, $ADMIN_REPORT{DATE}, 3);
  #my $days_in_month = days_in_month({ DATE => $ADMIN_REPORT{DATE} });;
  my $date_unixtime = POSIX::mktime(0, 0, 0, $d, ($m - 1), $y - 1900, 0, 0, 0);
  my $START_PERIOD_DAY = ($conf{START_PERIOD_DAY}) ? $conf{START_PERIOD_DAY} : 1;
  my %CHANGED_TPS = ();

  foreach my $tp_info (@$list) {
    $Dv->{debug} = 1 if ($debug > 6);
    my $ulist = $Dv->list(
      {
        ACTIVATE     => "<=$ADMIN_REPORT{DATE}",
        EXPIRE       => "0000-00-00,>$ADMIN_REPORT{DATE}",
        DV_EXPIRE    => "0000-00-00,>$ADMIN_REPORT{DATE}",
        DV_STATUS    => "0",
        LOGIN_STATUS => 0,
        TP_ID        => $tp_info->{id},
        SORT         => 1,
        PAGE_ROWS    => 1000000,
        DELETED      => 0,
        LOGIN        => '_SHOW',
        REDUCTION    => '_SHOW',
        DEPOSIT      => '_SHOW',
        CREDIT       => '_SHOW',
        COMPANY_ID   => '_SHOW',
        COLS_NAME    => 1,
        %USERS_LIST_PARAMS
      }
    );

    foreach my $u (@$ulist) {
      my %user = (
        LOGIN      => $u->{login},
        UID        => $u->{uid},
        REDUCTION  => $u->{reduction},
        ACTIVATE   => $u->{activate},
        DEPOSIT    => $u->{deposit},
        CREDIT     => ($u->{credit} > 0) ? $u->{credit} :  $tp_info->{credit},
        COMPANY_ID => $u->{company_id},
        DV_STATUS  => $u->{dv_status},
        EXT_DEPOSIT=> ($u->{ext_deposit}) ? $u->{ext_deposit} : 0,
      );

      if (!$CHANGED_TPS{ $user{UID} } && ($d == $START_PERIOD_DAY || $user{ACTIVATE} ne '0000-00-00')) {

        if ($user{ACTIVATE} ne '0000-00-00') {
          my ($activate_y, $activate_m, $activate_d) = split(/-/, $user{ACTIVATE}, 3);
          my $active_unixtime = POSIX::mktime(0, 0, 0, $activate_d, $activate_m - 1, $activate_y - 1900, 0, 0, 0);
          if ($date_unixtime - $active_unixtime < 31 * 86400) {
            next;
          }
        }

        $debug_output .= " Login: $user{LOGIN} ($user{UID}) ACTIVATE $user{ACTIVATE} TP_ID: $tp_info->{id} -> $tp_info->{next_tp_id}\n";
        $CHANGED_TPS{ $user{UID} } = 1;
        $Dv->change(
          {
            UID    => $user{UID},
            STATUS => 0,
            TP_ID  => $tp_info->{next_tp_id}
          }
        );
      }
    }
  }

  return $debug_output;
}

#**********************************************************
=head2 dv_monthly_fees($attr) - Monthly fees

=cut
#**********************************************************
sub dv_monthly_fees {
  my ($attr) = @_;

  my $debug = $attr->{DEBUG} || 0;
  my $debug_output = '';
  $debug_output .= "DV: Monthly periodic payments\n" if ($debug > 1);

  $ADMIN_REPORT{DATE} = $DATE if (!$ADMIN_REPORT{DATE});

  $LIST_PARAMS{TP_ID} = $attr->{TP_ID} if ($attr->{TP_ID});

  my %USERS_LIST_PARAMS = ();
  $USERS_LIST_PARAMS{LOGIN} = $attr->{LOGIN} if ($attr->{LOGIN});
  $USERS_LIST_PARAMS{EXT_BILL} = 1 if ($conf{BONUS_EXT_FUNCTIONS});
  $USERS_LIST_PARAMS{REGISTRATION} = "<$ADMIN_REPORT{DATE}";
  $USERS_LIST_PARAMS{GID}   = $attr->{GID} if ($attr->{GID});

  my $START_PERIOD_DAY = ($conf{START_PERIOD_DAY}) ? $conf{START_PERIOD_DAY} : 1;

  #Change TP to next TP
  $debug_output .= dv_monthly_next_tp($attr);
  $DEBUG .= $debug_output;

  my %FEES_METHODS = %{ get_fees_types({ SHORT => 1 }) };

  my $users = Users->new($db, $admin, \%conf);
  $Tariffs->{debug} = 1 if ($debug > 6);
  my $list = $Tariffs->list({%LIST_PARAMS,
                             MODULE         => 'Dv',
                             DOMAIN_ID      => '_SHOW',
                             FIXED_FEES_DAY => '_SHOW',
                             COLS_NAME      => 1,
                             COLS_UPPER     => 1
                           });

  my ($y, $m, $d)      = split(/-/, $ADMIN_REPORT{DATE}, 3);
  my $days_in_month    = days_in_month({ DATE => $ADMIN_REPORT{DATE} });
  my $cure_month_begin = "$y-$m-01";
  my $cure_month_end   = "$y-$m-$days_in_month";
  $m--;
  my $date_unixtime = POSIX::mktime(0, 0, 0, $d, $m, $y - 1900, 0, 0, 0);

  #Get Preview month begin end days
  if ($m == 0) {
    $m = 12;
    $y--;
  }

  $m = sprintf("%02d", $m);
  my $days_in_pre_month = days_in_month({ DATE => "$y-$m-01" });

  my $pre_month_begin = "$y-$m-01";
  my $pre_month_end   = "$y-$m-$days_in_pre_month";

  foreach my $TP_INFO (@$list) {
    my $month_fee           = $TP_INFO->{MONTH_FEE};
    my $activate_date       = "<=$ADMIN_REPORT{DATE}";
    $USERS_LIST_PARAMS{DOMAIN_ID} = $TP_INFO->{DOMAIN_ID};
    my %used_traffic = ();

    #Monthfee & min use
    if ($month_fee > 0 || $TP_INFO->{MIN_USE} > 0) {
      $debug_output .= "TP ID: $TP_INFO->{ID} MF: $TP_INFO->{MONTH_FEE} POSTPAID: $TP_INFO->{POSTPAID_MONTHLY_FEE} REDUCTION: $TP_INFO->{REDUCTION_FEE} EXT_BILL_ID: $TP_INFO->{EXT_BILL_ACCOUNT} CREDIT: $TP_INFO->{CREDIT} MIN_USE: $TP_INFO->{MIN_USE} ABON_DISTR: $TP_INFO->{ABON_DISTRIBUTION}\n" if ($debug > 1);

      #get used  traffic for min use functions
      my %processed_users = ();
      if ($TP_INFO->{MIN_USE} > 0 && $START_PERIOD_DAY && $conf{DV_MIN_USER_FULLPERIOD}) {
        my $interval = "$pre_month_begin/$pre_month_end";
        if ($conf{DV_MIN_USER_FULLPERIOD}) {
          $activate_date = POSIX::strftime("%Y-%m-%d", localtime($date_unixtime - 86400 * 30));
          $interval      = "$activate_date/$ADMIN_REPORT{DATE}";
          $activate_date = "=$activate_date";
        }

        my $report_list = $Sessions->reports(
          {
            INTERVAL => $interval,
            TP_ID    => $TP_INFO->{ID},
            COLS_NAME=> 1
          }
        );
        foreach my $l (@$report_list) {
          $used_traffic{ $l->{uid} } = $l->{sum};
        }
      }
      if ($TP_INFO->{ABON_DISTRIBUTION}) {
        $month_fee = $month_fee / $days_in_month;
      }

      $Dv->{debug} = 1 if ($debug > 5);
      my $ulist = $Dv->list(
        {
          ACTIVATE     => "$activate_date",
          EXPIRE       => "0000-00-00,>$ADMIN_REPORT{DATE}",
          DV_EXPIRE    => "0000-00-00,>$ADMIN_REPORT{DATE}",
          DV_STATUS    => "0;5",
          JOIN_SERVICE => "<2",
          LOGIN_STATUS => 0,
          TP_ID        => $TP_INFO->{ID},
          SORT         => 1,
          PAGE_ROWS    => 1000000,
          TP_CREDIT    => '_SHOW',
          DELETED      => 0,
          LOGIN        => '_SHOW',
          BILL_ID      => '_SHOW',
          REDUCTION    => '_SHOW',
          DEPOSIT      => '_SHOW',
          CREDIT       => '_SHOW',
          COMPANY_ID   => '_SHOW',
          PERSONAL_TP  => '_SHOW',
          COLS_NAME    => 1,
          %USERS_LIST_PARAMS
        }
      );

      foreach my $u (@$ulist) {
        my $EXT_INFO       = '';
        my $ext_deposit_op = $TP_INFO->{EXT_BILL_ACCOUNT};
        my %user           = (
          LOGIN        => $u->{login},
          UID          => $u->{uid},
          BILL_ID      => ($ext_deposit_op > 0) ? $u->{ext_billd_id} : $u->{bill_id},
          MAIN_BILL_ID => ($ext_deposit_op > 0) ? $u->{bill_id} : 0,
          REDUCTION    => $u->{reduction},
          ACTIVATE     => $u->{activate},
          DEPOSIT      => $u->{deposit},
          CREDIT       => ($u->{credit} > 0) ? $u->{credit} : ($conf{user_credit_change}) ? 0 : $TP_INFO->{CREDIT},
          COMPANY_ID   => $u->{company_id},
          DV_STATUS    => $u->{dv_status},
          EXT_DEPOSIT  => ($u->{ext_deposit}) ? $u->{ext_deposit} : 0,
        );

        my %FEES_DSC = (
          MODULE            => 'Internet',
          TP_ID             => $TP_INFO->{ID},
          TP_NAME           => $TP_INFO->{NAME},
          FEES_PERIOD_MONTH => $lang{MONTH_FEE_SHORT},
          FEES_METHOD       => $FEES_METHODS{$TP_INFO->{FEES_METHOD}}
        );

        $debug_output .= " Login: $user{LOGIN} ($user{UID}) TP_ID: $u->{tp_id} Fees: $TP_INFO->{MONTH_FEE} REDUCTION: $user{REDUCTION} DEPOSIT: $user{DEPOSIT} CREDIT $user{CREDIT} ACTIVE: $user{ACTIVATE} TP: $u->{tp_id}\n" if ($debug > 3);

        if (!$user{BILL_ID} && $user{MAIN_BILL_ID}) {
          $user{BILL_ID}      = $user{MAIN_BILL_ID};
          $user{MAIN_BILL_ID} = 0;
          $ext_deposit_op     = 0;
        }

        if (! $user{BILL_ID} && ! defined($user{DEPOSIT})) {
          my $ext = ($ext_deposit_op > 0) ? 'Ext bill' : '';
          print "UID: $user{UID} LOGIN: $user{LOGIN} Don't have $ext money account\n";
          next;
        }

        my %FEES_PARAMS = (
          DATE   => $ADMIN_REPORT{DATE},
          METHOD => ($TP_INFO->{FEES_METHOD}) ? $TP_INFO->{FEES_METHOD} : 1,
        );
        my $sum = 0;

        #***************************************************************
        #Min use Makes only 1 of month
        if ($TP_INFO->{MIN_USE} > 0 && $d != $START_PERIOD_DAY && !$conf{DV_MIN_USER_FULLPERIOD}) {
          #Check activation date
          my $min_use = $TP_INFO->{MIN_USE};

          if ($user{REDUCTION} > 0) {
            $min_use = $min_use * (100 - $user{REDUCTION}) / 100;
          }

          #Min use Alignment
          if (!$conf{DV_MIN_USER_FULLPERIOD} && $user{ACTIVATE} ne '0000-00-00') {
            $days_in_month = days_in_month({ DATE => $user{ACTIVATE} });
            my (undef, $activated_d)=split(/-/, $user{ACTIVATE});
            $min_use = sprintf("%.5f", $min_use / $days_in_month * ($days_in_month - $activated_d + $START_PERIOD_DAY));
          }

          my $used = ($used_traffic{ $user{UID} }) ? $used_traffic{ $user{UID} } : 0;
          $FEES_PARAMS{DESCRIBE} = "$lang{MIN_USE}";

          #summary for all company users with same tarif plan
          if ($user{COMPANY_ID} > 0 && $processed_users{ $user{COMPANY_ID} }) {
            next;
          }

          if ($user{COMPANY_ID} > 0) {
            my $company_users = $Dv->list(
              {
                TP_ID      => $TP_INFO->{ID},
                LOGIN      => '_SHOW',
                COMPANY_ID => $user{COMPANY_ID},
                COLS_NAME  => 1
              }
            );
            my @UIDS = ();
            foreach my $c_user (@$company_users) {
              push @UIDS, $c_user->{login};
              $used += $used_traffic{ $user{UID} } if ($used_traffic{ $user{UID} });
              $processed_users{ $user{COMPANY_ID} }++;
            }

            $min_use = $min_use * $processed_users{ $user{COMPANY_ID} };
            $FEES_PARAMS{DESCRIBE} .= "$lang{COMPANY} $lang{LOGINS}: " . join(', ', @UIDS);
          }

            #Get Fees sum for min_user
          if ($conf{MIN_USE_FEES_CONSIDE}) {
            $Fees->list(
              {
                UID     => $user{UID},
                DATE    => ($user{ACTIVATE} ne '0000-00-00') ? ">=$user{ACTIVATE}" : $DATE,
                METHODS => "$conf{MIN_USE_FEES_CONSIDE}",
              }
            );
            $used += $Fees->{SUM} if ($Fees->{SUM});
          }

          $debug_output .= "  USED: $used\n" if ($debug > 3);

          #Make payments
          next if ($used >= $min_use);

          $sum = $min_use - $used;

          if ($TP_INFO->{REDUCTION_FEE} == 1 && $user{REDUCTION} > 0) {
            if ($user{REDUCTION} >= 100) {
              $debug_output .= "UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION} next\n" if ($debug > 3);
              next;
            }
            $sum = $sum * (100 - $user{REDUCTION}) / 100;
          }

          if ($TP_INFO->{PAYMENT_TYPE} == 1 || $user{DEPOSIT} + $user{CREDIT} > 0 || $TP_INFO->{POSTPAID_MONTHLY_FEE} == 1) {
            if ($d == $START_PERIOD_DAY) {
              if ($debug > 4) {
                $debug_output .= " UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION}\n";
              }
              else {
                $Fees->take(\%user, $sum, {%FEES_PARAMS});

                $debug_output .= " $user{LOGIN} UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION}\n" if ($debug > 0);
                if ($user{ACTIVATE} ne '0000-00-00') {
                  $users->change(
                    $user{UID},
                    {
                      UID      => $user{UID},
                      ACTIVATE => '0000-00-00'
                    }
                  );
                }
              }
            }
          }
        }

        #***************************************************************
        #Month Fee
        if ($month_fee > 0) {
          #Make sum
          $sum =  ($u->{personal_tp} > 0 ) ? $u->{personal_tp} : $month_fee;
          if ($TP_INFO->{REDUCTION_FEE} == 1 && $user{REDUCTION} > 0) {
            $sum = $sum * (100 - $user{REDUCTION}) / 100;
          }

          my ($activate_y, $activate_m, $activate_d);
          my $active_unixtime = 0;
          if ($user{ACTIVATE} ne '0000-00-00') {
            ($activate_y, $activate_m, $activate_d) = split(/-/, $user{ACTIVATE}, 3);
            $active_unixtime = POSIX::mktime(0, 0, 0, $activate_d, $activate_m - 1, $activate_y - 1900, 0, 0, 0);
          }

          #Get 2 time fees from main account and ext account and from main
          if ($conf{BONUS_EXT_FUNCTIONS} && $ext_deposit_op > 0) {

            # Small deposit
            if ($TP_INFO->{SMALL_DEPOSIT_ACTION} && $user{EXT_DEPOSIT} + $user{DEPOSIT} + $user{CREDIT} < $sum) {
              if (($user{ACTIVATE} eq '0000-00-00' and $d == $START_PERIOD_DAY)
                 || $TP_INFO->{ABON_DISTRIBUTION}
                 || ($user{ACTIVATE} ne '0000-00-00' && $date_unixtime - $active_unixtime < 30 * 86400)) {
                goto SMALL_DEPOSIT_LABEL;
              }
            }
            elsif ($sum > $user{EXT_DEPOSIT} && $user{EXT_DEPOSIT} > 0) {
              # Take some sum from ext deposit other from main
              if ((($user{ACTIVATE} eq '0000-00-00' and $d == $START_PERIOD_DAY) || $TP_INFO->{ABON_DISTRIBUTION}) || $user{ACTIVATE} ne '0000-00-00') {
                if ($date_unixtime - $active_unixtime < 30 * 86400) {
                }
                else {
                  my $ext_deposit_sum = $user{EXT_DEPOSIT};

                  $FEES_PARAMS{DESCRIBE} = fees_dsc_former(\%FEES_DSC);

                  $Fees->take(\%user, $ext_deposit_sum, { %FEES_PARAMS });
                  $sum = $sum - $user{EXT_DEPOSIT};
                  $user{BILL_ID} = $user{MAIN_BILL_ID};
                }

                #and after take rest from main DEPOSIT
                #
              }
            }
            elsif ($user{EXT_DEPOSIT} <= 0) {
              $user{BILL_ID} = $user{MAIN_BILL_ID};
            }
            else {
              $user{DEPOSIT} = $user{EXT_DEPOSIT};
            }
          }

          #Prepaid period credit
          if ($conf{DV_PREPAID_PERIOD_CREDIT}
              && ($user{ACTIVATE} eq '0000-00-00' and $d == $START_PERIOD_DAY)
              && $user{CREDIT} == 0
              && ($user{DEPOSIT} < $sum && $user{DEPOSIT} > 0)) {
            my $credit_period = int($user{DEPOSIT} /  ($sum / $days_in_month));
            if ($credit_period > 0) {
              $users->change($user{UID}, {
                                        UID         => $user{UID},
                                        CREDIT_DATE => sprintf("%04d-%02d-%02d", (($m < 12) ? $y : $y+1), (($m < 12) ? $m+1 : 1),  $credit_period),
                                        CREDIT      => $sum
                                      });
              $user{CREDIT}  = $sum;
            }
            $debug_output .= " $user{LOGIN} UID: $user{UID} SUM: $sum change credit\n";
          }


          #If deposit is above-zero or TARIF PALIN is POST PAID or PERIODIC PAYMENTS is POSTPAID
          if ($TP_INFO->{PAYMENT_TYPE} == 1 || $user{DEPOSIT} + $user{CREDIT} > 0 || $TP_INFO->{POSTPAID_MONTHLY_FEE} == 1) {
            #*******************************************
            #Unblock Small deposit status
            if ($TP_INFO->{SMALL_DEPOSIT_ACTION} && $month_fee < $user{DEPOSIT}) {
              if ($user{DV_STATUS} && $TP_INFO->{ABON_DISTRIBUTION} && $conf{DV_FULL_MONTH} && $sum * $days_in_month > $user{DEPOSIT}) {
                next;
              }
              if ($debug < 7) {
                $Dv->change(
                  {
                    UID    => $user{UID},
                    STATUS => 0
                  }
                );
                $user{DV_STATUS} = 0;
              }
            }

            #take fees in first day of month
            $FEES_PARAMS{DESCRIBE} = fees_dsc_former(\%FEES_DSC);
            $FEES_PARAMS{DESCRIBE} .= " - $lang{ABON_DISTRIBUTION}" if ($TP_INFO->{ABON_DISTRIBUTION});

            if ($user{DV_STATUS} == 5 && $TP_INFO->{FINE} > 0) {
              if ($conf{DV_FINE_LIMIT} && $user{DEPOSIT} + $user{CREDIT} < $conf{DV_FINE_LIMIT}) {
                next;
              }
              $FEES_PARAMS{DESCRIBE} = "$lang{FINE}";
              $FEES_PARAMS{METHOD}   = 2;
              $sum                   = $TP_INFO->{FINE};
              $EXT_INFO              = "FINE";
            }
            # If activation set to monthly fees taken throught 30 days
            elsif ($user{ACTIVATE} ne '0000-00-00') {
              #Block small deposit
              if ($TP_INFO->{SMALL_DEPOSIT_ACTION} && $sum > $user{DEPOSIT} + $user{CREDIT}
                 && (($TP_INFO->{FIXED_FEES_DAY} && ($d == $activate_d || ($d == $START_PERIOD_DAY && $activate_d > 28)))
                 || ($date_unixtime - $active_unixtime > 30 * 86400))
                 ) {
                SMALL_DEPOSIT_LABEL:

                if ($TP_INFO->{SMALL_DEPOSIT_ACTION} == -1) {
                  if ($debug < 7) {
                    if ($user{DV_STATUS} != 5) {
                      $Dv->change(
                        {
                          UID    => $user{UID},
                          STATUS => 5
                        }
                      );
                    }
                  }
                }
                else {
                  if ($debug < 7) {
                    $Dv->change(
                      {
                        UID   => $user{UID},
                        TP_ID => $TP_INFO->{SMALL_DEPOSIT_ACTION}
                      }
                    );
                  }
                }

                #Change activation to cure date
                # !!! We need change activation only if payments add
                #                 $users->change($user{UID}, {
                #                                UID      => $user{UID},
                #                                ACTIVATE => $ADMIN_REPORT{DATE} });

                $debug_output .= " SMALL_DEPOSIT_BLOCK." if ($debug > 3);
                next;
              }
              #Static day
              if( ($TP_INFO->{FIXED_FEES_DAY} && ($d == $activate_d || ($d == $START_PERIOD_DAY && $activate_d > 28)))
                 || ($date_unixtime - $active_unixtime > 30 * 86400) ) {

                if ($debug > 4) {
                  $debug_output .= " $user{LOGIN} UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION}\n";
                }
                else {
                  $FEES_PARAMS{DESCRIBE} .= " ($ADMIN_REPORT{DATE}-" . (POSIX::strftime("%Y-%m-%d", localtime($date_unixtime + 86400 * 30))) . ')' if (!$TP_INFO->{ABON_DISTRIBUTION});

                  $Fees->take(\%user, $sum, \%FEES_PARAMS);
                  $debug_output .= " $user{LOGIN} UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION} CHANGE ACTIVATE\n" if ($debug > 0);
                  if ($Fees->{errno}) {
                    print "Dv Error: [ $user{UID} ] $user{LOGIN} SUM: $sum [$Fees->{errno}] $Fees->{errstr} ";
                    if ($Fees->{errno} == 14) {
                      print "UID: $user{UID} LOGIN: $user{LOGIN} - Don't have money account";
                    }
                    print "\n";
                  }
                  else {
                    $users->change(
                      $user{UID},
                      {
                        UID      => $user{UID},
                        ACTIVATE => $ADMIN_REPORT{DATE}
                      }
                    );
                  }
                  next;
                }
              }
              elsif ($TP_INFO->{ABON_DISTRIBUTION}) {
                $EXT_INFO .= "CHANGE ACTIVATE\n" if ($debug > 0);
              }
              else {
                next;
              }
            }
            elsif (($user{ACTIVATE} eq '0000-00-00' and $d == $START_PERIOD_DAY) || $TP_INFO->{ABON_DISTRIBUTION}) {
              #Block small deposit
              if ($TP_INFO->{SMALL_DEPOSIT_ACTION} && $sum > $user{DEPOSIT} + $user{CREDIT}) {
                if ($TP_INFO->{SMALL_DEPOSIT_ACTION} == -1) {
                  if($debug < 7) {
                    $Dv->change(
                      {
                        UID    => $user{UID},
                         STATUS => 5
                      }
                    );
                  }
                }
                else {
                  if($debug < 7) {
                    $Dv->change(
                      {
                        UID   => $user{UID},
                        TP_ID => $TP_INFO->{SMALL_DEPOSIT_ACTION}
                      });
                  }
                }
                $debug_output .= " SMALL_DEPOSIT_BLOCK." if ($debug > 3);
                next;
              }
              #Skip fees for small deposit actions
              elsif ($user{DV_STATUS} == 5) {
                $debug_output .= " UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION}\n" if ($debug > 2);
                next;
              }
            }
            else {
              next;
            }

            # get fees
            if ($debug > 4) {
              $debug_output .= " UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION}\n";
            }
            else {
              $FEES_PARAMS{DESCRIBE} .= " ($cure_month_begin-$cure_month_end)" if (!$TP_INFO->{ABON_DISTRIBUTION});
              $Fees->take(\%user, $sum, {%FEES_PARAMS});
              $debug_output .= " $user{LOGIN}  UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION} $EXT_INFO\n" if ($debug > 0);
            }
          }
          else {
            # Get Fine
            if ($TP_INFO->{FINE} > 0) {
                if ($conf{DV_FINE_LIMIT} && $user{DEPOSIT} + $user{CREDIT} < $conf{DV_FINE_LIMIT}) {
                  next;
                }
                %FEES_PARAMS = (
                  DESCRIBE => "$lang{FINE}",
                  METHOD   => 1,
                  DATE     => $ADMIN_REPORT{DATE},
                );

                $sum      = $TP_INFO->{FINE};
                $EXT_INFO = "FINE";
                $Fees->take(\%user, $sum, {%FEES_PARAMS});
                $debug_output .= " $user{LOGIN}  UID: $user{UID} SUM: $sum REDUCTION: $user{REDUCTION} FINE\n" if ($debug > 0);
            }

            #Block small deposit
            if ($user{DV_STATUS} == 0 && $TP_INFO->{SMALL_DEPOSIT_ACTION} &&
               (($user{ACTIVATE} ne '0000-00-00' && $date_unixtime - $active_unixtime > 30 * 86400)
                 ||
                 ($user{ACTIVATE} eq '0000-00-00' && ($d == $START_PERIOD_DAY || $TP_INFO->{ABON_DISTRIBUTION}))
                 )
               ) {
              if ($TP_INFO->{SMALL_DEPOSIT_ACTION} == -1) {
                if ($debug < 7){
                  if ($user{DV_STATUS} != 5) {
                    $Dv->change(
                      {
                        UID    => $user{UID},
                        STATUS => 5
                      }
                    );
                  }
                }
              }
              else {
                if ($debug < 7) {
                  $Dv->change(
                    {
                      UID   => $user{UID},
                      TP_ID => $TP_INFO->{SMALL_DEPOSIT_ACTION}
                    }
                  );
                }
              }
              $debug_output .= " SMALL_DEPOSIT_BLOCK" if ($debug > 3);
              next;
            }
          }
        }
      }
    }
  }

  #=====================================

  #Make traffic recalculation for expration
  if ($d == 1) {
    $list = $Tariffs->list({%LIST_PARAMS, MODULE => 'Dv' });
    $debug_output .= "Total month price\n";
    require Billing;
    Billing->import();
    my $Billing = Billing->new($db, \%conf);

    foreach my $tp_line (@$list) {
      my $ti_list = $Tariffs->ti_list({ TP_ID => $tp_line->[18] });
      next if ($Tariffs->{TOTAL} != 1);

      foreach my $ti (@$ti_list) {

        my $tt_list = $Tariffs->tt_list({ TI_ID => $ti->[0], COLS_NAME => 1 });
        next if ($Tariffs->{TOTAL} != 1);

        my %expr_hash = ();
        foreach my $tt (@$tt_list) {
          my $expression = $tt->{expression};
          next if ($expression !~ /MONTH_TRAFFIC_/);

          $expression =~ s/MONTH_TRAFFIC/TRAFFIC/g;

          $debug_output .= "TP: $tp_line->[0] TI: $ti->[0] TT: $tt->{id}\n";
          $debug_output .= "  Expr: $expression\n" if ($debug > 3);

          $expr_hash{ $tt->{id} } = $expression;
        }

        next if (!defined($expr_hash{0}));

        my $ulist = $Dv->list(
          {
            ACTIVATE     => "<=$ADMIN_REPORT{DATE}",
            EXPIRE       => "0000-00-00,>$ADMIN_REPORT{DATE}",
            DV_EXPIRE    => "0000-00-00,>$ADMIN_REPORT{DATE}",
            DV_STATUS    => 0,
            LOGIN_STATUS => 0,
            TP_ID        => $tp_line->[0],
            SORT         => 1,
            PAGE_ROWS    => 1000000,
            TP_CREDIT    => '_SHOW',
            COMPANY_ID   => '_SHOW',
            LOGIN        => '_SHOW',
            BILL_ID      => '_SHOW',
            REDUCTION    => '_SHOW',
            DEPOSIT      => '_SHOW',
            CREDIT       => '_SHOW',
            COLS_NAME    => 1,
            %USERS_LIST_PARAMS
          }
        );

        foreach my $u (@$ulist) {
          my %user = (
            LOGIN      => $u->{login},
            UID        => $u->{uid},
            BILL_ID    => ($tp_line->[14] > 0) ? $u->{ext_bill_id} : $u->{bill_id},
            REDUCTION  => $u->{reduction},
            ACTIVATE   => $u->{activate},
            DEPOSIT    => $u->{deposit},
            CREDIT     => ($u->{credit} > 0) ? $u->{credit} : $tp_line->[15],
            COMPANY_ID => $u->{company_id}
          );

          $debug_output .= " Login: $u->{login} ($u->{uid}) TP_ID: $u->{tp_id} Fees: - REDUCTION: $u->{reduction} $u->{deposit} $u->{credit} - $user{ACTIVATE}\n" if ($debug > 3);

          #Summary for company users
          #         my @UIDS  = ();
          #         if ($$processed_users{$user{COMPANY_ID}}) {
          #            next;
          #          }
          #
          #         if ($user{COMPANY_ID}) {
          #           my $company_users = $ulist = $Dv->list({ TP_ID      => $tp_line->[0],
          #                                                    COMPANY_ID => $user{COMPANY_ID}
          #                                                   });
          #           $$processed_users{$user{COMPANY_ID}}=1;
          #
          #           foreach my $c_user ( @$company_users ) {
          #               push @UIDS, $c_user->[7];
          #            }
          #
          #           print "$user{LOGIN} hello $user{COMPANY_ID} // ";
          #           print @UIDS ,"\n";
          #          }

          $Billing->{PERIOD_TRAFFIC} = undef;
          my $RESULT = $Billing->expression(
            $user{UID},
            \%expr_hash,
            {
              START_PERIOD => $user{ACTIVATE},
              debug        => 0,
              #UIDS         => ($#UIDS > -1) ? join(',', @UIDS) : '',
              #ACCOUNTS_SUMMARY => $#UIDS+1
            }
          );

          #my $message = '';
          my $sum     = 0;

          my %FEES_PARAMS = (
            DATE   => $ADMIN_REPORT{DATE},
            METHOD => 0,
          );

          if ($RESULT->{TRAFFIC_IN}) {
            $FEES_PARAMS{DESCRIBE} = "$lang{USED}\n $lang{TRAFFIC}: $RESULT->{TRAFFIC_IN}\n SUM: $RESULT->{PRICE_IN}";
            $sum = $RESULT->{TRAFFIC_IN} * $RESULT->{PRICE_IN};
          }

          if ($RESULT->{TRAFFIC_OUT}) {
            $FEES_PARAMS{DESCRIBE} = "$lang{USED} $lang{TRAFFIC}: $RESULT->{TRAFFIC_OUT} SUM: $RESULT->{PRICE_OUT}";
            $sum = $RESULT->{TRAFFIC_OUT} * $RESULT->{PRICE_OUT};
          }
          elsif ($RESULT->{TRAFFIC_SUM}) {
            $FEES_PARAMS{DESCRIBE} = "$lang{USED} $lang{TRAFFIC}: $RESULT->{TRAFFIC_SUM} SUM: $RESULT->{PRICE}";
            $sum = $RESULT->{TRAFFIC_SUM} * $RESULT->{PRICE};
          }

          $Fees->take(\%user, $sum, {%FEES_PARAMS});
        }

      }
    }
  }

  $DEBUG .= $debug_output;
  return $debug_output;
}

#**********************************************************
=head2 dv_users_warning_messages($attr)

=cut
#**********************************************************
sub dv_users_warning_messages {
  my ($attr) = @_;

  $ADMIN_REPORT{USERS_WARNINGS} = sprintf("%-14s| %4s|%-20s| %9s| %8s|\n", $lang{LOGIN}, 'TP', $lang{TARIF_PLAN}, $lang{DEPOSIT}, $lang{CREDIT}) . "---------------------------------------------------------------\n";
  if ($ADMIN_REPORT{NO_USERS_WARNINGS}) {
    return 0;
  }

  my $debug = $attr->{DEBUG} || 0;
  my $debug_output = '';
  $debug_output .= "DV: Daily warning messages\n" if ($debug > 1);

  my %LIST_PARAMS     = (USERS_WARNINGS => 1);
  $LIST_PARAMS{ALERT_PERIOD}=$conf{DV_ALERT_REDIRECT_DAYS} if ($conf{DV_ALERT_REDIRECT_DAYS});
  $LIST_PARAMS{LOGIN} = $attr->{LOGIN} if ($attr->{LOGIN});
  $Dv->{debug}=1 if($debug > 5);
  my $dv_list         = $Dv->list({ %LIST_PARAMS,
                                    LOGIN      => '_SHOW',
                                    TP_ID      => '_SHOW',
                                    TP_NAME    => '_SHOW',
                                    DEPOSIT    => '_SHOW',
                                    CREDIT     => '_SHOW',
                                    EMAIL      => '_SHOW',
                                    COLS_NAME  => 1,
                                    COLS_UPPER => 1 });

  if ($Dv->{TOTAL} < 1) {
    $DEBUG .= $debug_output;
    return $debug_output;
  }

  my @allert_redirect_days = split(/,\s?/, $conf{DV_ALERT_REDIRECT_DAYS} || '');

  foreach my $u (@$dv_list) {
    my $type='email';
    my $email = ((!defined($u->{EMAIL})) || $u->{EMAIL} eq '') ? (($conf{USERS_MAIL_DOMAIN}) ? "$u->{LOGIN}\@$conf{USERS_MAIL_DOMAIN}" : '') : "$u->{EMAIL}";

    if($conf{DV_ALERT_REDIRECT_FILTER} && in_array($u->{to_next_period}, \@allert_redirect_days)) {
      $type='redirect';
      $Dv->change({ UID       => $u->{uid},
                    FILTER_ID => $conf{DV_ALERT_REDIRECT_FILTER}
                  });
    }

    if ($email eq '') { next; }
    my $info = sprintf("%-14s| %4d|%-20s| %9.4f| %8.2f| %6s|\n", $u->{login},
       $u->{tp_num},
       $u->{tp_name},
       $u->{deposit},
       $u->{credit},
       $type);

    $ADMIN_REPORT{USERS_WARNINGS} .= $info;
    $debug_output .= $info if ($debug > 3);

    if ($debug < 5) {
      my $message = $html->tpl_show(_include('dv_users_warning_messages', 'Dv'),
        { %$u, DATE => $DATE, TIME => $TIME },
        { OUTPUT2RETURN => 1 });

      sendmail("$conf{ADMIN_MAIL}", "$email", "$lang{BILL_INFO}", "$message",
          "$conf{MAIL_CHARSET}", "2 (High)", { TEST => (($debug>6)?1:0) });
    }
  }

  $ADMIN_REPORT{USERS_WARNINGS} .= "---------------------------------------------------------------
$lang{TOTAL}: $Dv->{TOTAL}\n";

  if ($debug > 5) {
    $debug_output .= $ADMIN_REPORT{USERS_WARNINGS};
  }

  $DEBUG .= $debug_output;
  return $debug_output;
}

#**********************************************************
=head2 dv_change_shaper($attr)

=cut
#**********************************************************
sub dv_change_shaper {
  my ($attr) = @_;

  if ($conf{SHAPER_RESTART_CMD}) {
    my $res = cmd($conf{SHAPER_RESTART_CMD},
                 { PARAMS => { %FORM, %$attr, },
                   SET_ENV=> 1
                  });

    return $res;
  }

  return 0;
}

#**********************************************************
=head2 dv_traf_tarifs($attr)

=cut
#**********************************************************
sub dv_traf_tarifs {
  my ($attr) = @_;

  my Tariffs $tarif_plan;

  if (defined($FORM{tt})) {
    $tarif_plan = $attr->{TP};
    $tarif_plan->tt_defaults();
    $tarif_plan->{TI_ID} = $FORM{tt};

    if ($FORM{add}) {
      $tarif_plan->tt_add({%FORM});
      if (!$tarif_plan->{errno}) {
        $html->message('info', $lang{INFO}, "$lang{ADDED}");
        dv_change_shaper($tarif_plan);
      }
    }
    elsif ($FORM{change}) {
      $FORM{TI_ID} = $FORM{tt};
      $tarif_plan->tt_change({%FORM});

      if (!$tarif_plan->{errno}) {
        $html->message('info', $lang{INFO}, "$lang{CHANGED}");
        dv_change_shaper($tarif_plan);
      }
    }
    elsif (defined($FORM{chg})) {
      $tarif_plan->tt_info({ TI_ID => $FORM{tt}, TT_ID => $FORM{chg} });
      if (!$tarif_plan->{errno}) {
        $html->message('info', $lang{INFO}, "$lang{CHANGING}");
      }

      $tarif_plan->{ACTION}     = 'change';
      $tarif_plan->{LNG_ACTION} = $lang{CHANGE};
    }
    elsif (defined($FORM{del}) && $FORM{COMMENTS}) {
      $tarif_plan->tt_del({ TI_ID => $FORM{INTERVAL_ID} || $FORM{tt}, TT_ID => $FORM{del} });
      if (!$tarif_plan->{errno}) {
        $html->message('info', $lang{INFO}, "$lang{DELETED}");
      }
    }

    _error_show($tarif_plan);

    $tarif_plan->tt_list({ TI_ID => $FORM{tt}, form => 1 });
    $tarif_plan->{TT_ID} = $tarif_plan->{TOTAL} if (!defined($FORM{chg}));
  }
  elsif ($attr->{TP}) {
    $tarif_plan = $attr->{TP};
    $tarif_plan->tt_defaults();

    if ($FORM{change}) {
      $tarif_plan->tt_change({ %FORM  });

      if (! _error_show($tarif_plan)) {
        $html->message('info', $lang{INFO}, "$lang{INTERVALS}");
      }
    }

    $tarif_plan->tt_list($FORM{ti});
  }

  return 1;
}

#***********************************************************
=head2 dv_Sheduler($type, $action, $uid, $attr)

=cut
#***********************************************************
sub dv_sheduler {
  my ($type, $action, $uid, $attr) = @_;

  my $debug = $attr->{DEBUG} || 0;

  my $user = $Dv->info($uid);
  if ($type eq 'tp') {
    $Dv->change(
      {
        UID   => $uid,
        TP_ID => $action
      }
    );

    if ($attr->{GET_ABON} && $attr->{GET_ABON} eq '-1' && $attr->{RECALCULATE} && $attr->{GET_ABON} eq '-1') {
      print "Skip: GET_ABON, RECALCULATE\n" if ($debug > 1);
      return 0;
    }

    my $d  = (split(/-/, $ADMIN_REPORT{DATE}, 3))[2];
    my $START_PERIOD_DAY = $conf{START_PERIOD_DAY} || 1;
    $FORM{RECALCULATE}= 0;

    if ($Dv->{errno}) {
      return $Dv->{errno};
    }
    else {
      if ($Dv->{TP_INFO}->{ABON_DISTRIBUTION} || $d == $START_PERIOD_DAY) {
        $Dv->{TP_INFO}->{MONTH_FEE} = 0;
      }

      $FORM{RECALCULATE} = 1;
      service_get_month_fee($Dv, { QUITE    => 1,
                                   SHEDULER => 1,
                                   DATE     => $attr->{DATE}  });
    }
  }
  elsif ($type eq 'status') {
    $Dv->change(
      {
        UID    => $uid,
        STATUS => $action
      }
    );

    #Get fee for holdup service
    if ($action == 3) {
      my $active_fees = 0;
      if ($conf{DV_USER_SERVICE_HOLDUP}) {
        $active_fees =  (split(/:/, $conf{DV_USER_SERVICE_HOLDUP}))[5];
      }

      if ($active_fees && $active_fees > 0) {
        $user = $users->info($uid);
        $Fees->take(
          $user,
          $active_fees,
          {
            DESCRIBE => "$lang{HOLD_UP}",
            DATE     => "$ADMIN_REPORT{DATE} $TIME",
          }
        );
        if ($Fees->{errno}) {
          print "Error: Holdup fees: $Fees->{errno} $Fees->{errstr}\n";
        }
      }
    }
    elsif ($action == 3) {
      service_get_month_fee($Dv, { QUITE => 1, SHEDULER => 1, DATE => $attr->{DATE} });
    }

    if ($Dv->{errno} && $Dv->{errno} == 15) {
      return $Dv->{errno};
    }
  }

  return 1;
}

#***********************************************************
=head2 dv_report($type, $attr) - Email admin reports

  Arguments:
    $type  - Type of report
               daily
               monthly
    $attr  -
       LIST_PARAMS
       DATE
       DEBUG

  Results:

=cut
#***********************************************************
sub dv_report {
  my ($type, $attr) = @_;
  my $REPORT = "Module: DV ($type)\n";

  %LIST_PARAMS = %{ $attr->{LIST_PARAMS} } if (defined($attr->{LIST_PARAMS}));

  my $debug = $attr->{DEBUG} || 0;
  if ($debug > 6) {
    $Sessions->{debug}=1;
  }

  if ($type eq 'daily') {
    $REPORT .= sprintf("%-14s| %5s| %9s| %9s| %10s| %9s|\n", $lang{LOGIN}, $lang{SESSIONS}, $lang{TRAFFIC}, "$lang{TRAFFIC} 2", $lang{DURATION}, $lang{SUM});
    $REPORT .= "---------------------------------------------------------\n";
    my $list = $Sessions->reports2({
       %LIST_PARAMS,
       #USERS         => '_SHOW',
       SESSIONS      => '_SHOW',
       TRAFFIC_SUM   => '_SHOW',
       TRAFFIC_2_SUM => '_SHOW',
       DURATION_SEC  => '_SHOW',
       SUM           => '_SHOW',
       COLS_NAME     => 1
    });

    if($Sessions->{errno}) {
      $REPORT = "[$Sessions->{errno}] $Sessions->{errstr}\n";
      return $REPORT;
    }

    foreach my $line (@$list) {
      $REPORT .= sprintf("%-14s| %5d| %9s| %9s| %8s| %9.4f|\n",
        $line->{login},
        $line->{sessions},
        int2byte($line->{traffic_sum}),
        int2byte($line->{traffic_2_sum}),
        sec2time($line->{duration_sec}, { str => 1 }),
        $line->{sum}
      );
    }

    $REPORT .= "---------------------------------------------------------\n";
    $REPORT .= sprintf(
      "%-30s| %20s|\n%-30s| %20s|\n%-30s| %20s|\n%-30s| %20s|\n%-30s| %20s|\n%-30s| %20s|\n",
      $lang{USERS}, $Sessions->{USERS},
      $lang{SESSIONS}, $Sessions->{SESSIONS},
      $lang{TRAFFIC}, int2byte($Sessions->{TRAFFIC}),
      "$lang{TRAFFIC} 2", int2byte($Sessions->{TRAFFIC_2}),
      $lang{DURATION}, $Sessions->{DURATION},
      $lang{SUM}, $Sessions->{SUM}
    );

  }
  elsif ($type eq 'monthly') {
    $REPORT .= sprintf(" %12s| %5s| %5s| %10s| %10s| %12s| %9s|\n", $lang{DATE}, $lang{USERS}, $lang{SESSIONS}, $lang{TRAFFIC}, "$lang{TRAFFIC} 2", $lang{DURATION}, $lang{SUM});
    $REPORT .= "---------------------------------------------------------\n";

    my $list = $Sessions->reports2({%LIST_PARAMS,
       USERS_COUNT   => '_SHOW',
       SESSIONS      => '_SHOW',
       TRAFFIC_SUM   => '_SHOW',
       TRAFFIC_2_SUM => '_SHOW',
       DURATION_SEC  => '_SHOW',
       SUM           => '_SHOW',
       COLS_NAME     => 1
    });

    if($Sessions->{errno}) {
      $REPORT = "[$Sessions->{errno}] $Sessions->{errstr}\n";
      return $REPORT;
    }

    foreach my $line (@$list) {
      #   u.id, count(l.id), sum(l.sent + l.recv), sum(l.sent2 + l.recv2), sec_to_time(sum(l.duration)), sum(l.sum), l.id
      $REPORT .= sprintf(" %12s| %5s| %5s| %10s| %10s| %12s| %9.4f|\n",
        $line->{date},
        $line->{users_count},
        $line->{sessions},
        int2byte($line->{traffic_sum}),
        int2byte($line->{traffic_2_sum}),
        sec2time($line->{duration_sec}, { str => 1 }),
        $line->{sum}
      );
    }

    $REPORT .= "---------------------------------------------------------\n";
    $REPORT .= sprintf(
      "%-30s| %20s|\n%-30s| %20s|\n%-30s| %20s|\n%-30s| %20s|\n%-30s| %20s|\n%-30s| %20s|\n",
      $lang{USERS}, $Sessions->{USERS},
      $lang{SESSIONS}, $Sessions->{SESSIONS},
      $lang{TRAFFIC}, int2byte($Sessions->{TRAFFIC}),
      "$lang{TRAFFIC} 2", int2byte($Sessions->{TRAFFIC_2}),
      $lang{DURATION}, $Sessions->{DURATION}, $lang{SUM}, $Sessions->{SUM}
    );
  }

  return $REPORT;
}

#**********************************************************
=head2 dv_cards() Make cards

=cut
#**********************************************************
sub dv_cards {

  if ($admin->{MODULES} && !$admin->{MODULES}{Cards}) {
    $html->message('err', $lang{ERROR}, "$lang{ERR_ACCESS_DENY}");
    return 0;
  }

  load_module('Cards', $html);

  $FORM{CARDS_FORM} = 1;

  my $expire = $FORM{EXPIRE};
  my $dv_tpl ;

  if (! $FORM{create}) {
    $dv_tpl = dv_wizard_user(
      {
        OUTPUT2RETURN => 1,
        NO_EXTRADATA  => 1,
        TPLS          => {
          '2:' => '',
          '3:' => ''
        }
      }
    );
  }

  $FORM{EXPIRE} = $expire;
  my $cards_hash = cards_users_add({ EXTRA_TPL => $dv_tpl });

  $FORM{add} = 1;
  if (scalar keys %FORM_BASE < 1) {
    %FORM_BASE = %FORM;
  }

  my $added_count = 0;

  my $table = $html->table(
    {
      width      => '100%',
      caption    => "$lang{USERS}",
      title      => [ "$lang{LOGIN}", "ID", "$lang{INFO}" ],
      cols_align => [ 'left', 'right', 'right' ],
      ID         => 'ADDED_USERS'
    }
  );

  if (ref($cards_hash) eq 'ARRAY') {
    foreach my $line (@$cards_hash) {
      %FORM = ();
      %FORM = %FORM_BASE;
      while (my ($k, $v) = each %$line) {
        $FORM{$k} = clearquotes($v);
      }

      $FORM{'1.LOGIN'}       = $line->{LOGIN};

      $FORM{'1.PASSWORD'}    = $line->{PASSWORD};
      $FORM{'1.CREATE_BILL'} = 1;
      $line->{UID} = dv_wizard_user({ SHORT_REPORT => 1 });

      if ($line->{UID} < 1) {
        $html->message('err', "Cards:$lang{ERROR}", "$lang{LOGIN}: '$line->{LOGIN}' $line->{UID}");
        exit;
        last if (!$line->{SKIP_ERRORS});
      }
      else {
        #Confim card creation
        $added_count++;
        $table->addrow($html->button($line->{LOGIN}, "index=11&UID=$line->{UID}"), $line->{UID}, $FORM{ex_message});
        if (cards_users_gen_confim({ %$line, SUM => ($FORM{'5.SUM'}) ? $FORM{'5.SUM'} : 0 }) == 0) {
          return 0;
        }
      }
    }
  }

  if ($added_count > 0) {
    print $table->show();
  }

  return 1;
}

#**********************************************************
=head2 dv_wizard_user($attr) - Create user and services

=cut
#**********************************************************
sub dv_wizard_user {
  my ($attr) = @_;

  my $service_status = sel_status({ HASH_RESULT => 1 });

  $Fees = Finance->fees($db, $admin, \%conf);
  my $Finance = Finance->new($db, $admin, \%conf);
  $FORM{DV_WIZARD} = 1;

  if ($FORM{print}) {
    load_module('Docs');
    if ($FORM{PRINT_CONTRACT}) {
      docs_contract({%$Dv});
    }
    else {
      docs_invoice();
    }
    return 0;
  }

  my %add_values = ();
  my $uid = 0;

  if ($FORM{add}) {
    foreach my $k (sort keys %FORM) {
      if ($k =~ m/^[0-9]+\.[_a-zA-Z0-9]+$/) {
        $k =~ s/%22//g;
        my ($id, $main_key) = split(/\./, $k, 2);
        $add_values{$id}{$main_key} = $FORM{$k};
      }
    }

    # Password
    $add_values{1}{GID} = $admin->{GID} if ($admin->{GID});

    if ($permissions{0}{13}) {
      $add_values{1}{DISABLE}=2;
    }
    my $login = $add_values{1}{LOGIN} || q{};

    my Users $user = $users->add({ %{ $add_values{1} }, CREATE_EXT_BILL => ((defined($FORM{'5.EXT_BILL_DEPOSIT'}) || $FORM{'1.CREATE_EXT_BILL'}) ? 1 : 0) });
    my $message = '';
    if (!$user->{errno}) {
      $uid  = $user->{UID};
      $user = $user->info($uid);

      #2
      if (defined($FORM{'2.newpassword'}) && $FORM{'2.newpassword'} ne '') {
        if (length($FORM{'2.newpassword'}) < $conf{PASSWD_LENGTH}) {
          $html->message('err', "$lang{PASSWD} : $lang{ERROR}", "$err_strs{6}");
        }
        elsif ($FORM{'2.newpassword'} eq $FORM{'2.confirm'}) {
          $add_values{2}{PASSWORD} = $FORM{'2.newpassword'};
          $add_values{2}{UID}      = $uid;
          $add_values{2}{DISABLE}  = $FORM{'1.DISABLE'};
        }
        elsif ($FORM{'2.newpassword'} ne $FORM{'2.confirm'}) {
          $html->message('err', "$lang{PASSWD} : $lang{ERROR}", "$err_strs{5}");
        }

        $user->change($uid, { %{ $add_values{2} } });

        if ($conf{external_useradd}) {
          if (!_external($conf{external_useradd}, { LOGIN => $login, %{ $add_values{2} } })) {
            return 0;
          }
        }
      }

      #3 personal info
      $user->pi_add({ UID => $uid, %{ (defined($add_values{3})) ? $add_values{3} : {}  } });
      #5 Payments section
      if ($FORM{'5.SUM'}) {
        if ($FORM{'5.SUM'} > 0) {
          my $er = ($FORM{'5.ER'}) ? $Finance->exchange_info($FORM{'5.ER'}) : { ER_RATE => 1 };
          $Payments->add($user, { %{ $add_values{5} }, ER => $er->{ER_RATE} });

          if ($Payments->{errno}) {
            _error_show($Payments, { MODULE_NAME=> $lang{PAYMENTS} });
            return 0;
          }
          else {
            $message = "$lang{PAYMENTS} $lang{SUM}: ". ($FORM{'5.SUM'} || 0) .' '. ($er->{ER_SHORT_NAME} || '') ."\n";
          }
        }
        elsif ($FORM{'5.SUM'} < 0) {
          my $er = ($FORM{'5.ER'}) ? $Finance->exchange_info($FORM{'5.ER'}) : { ER_RATE => 1 };
          $Fees->take($user, abs($FORM{'5.SUM'}), { DESCRIBE => 'MIGRATION', ER => $er->{ER_RATE} });

          if ($Fees->{errno}) {
            _error_show($Fees, { MODULE_NAME => $lang{FEES} });
            return 0;
          }
          else {
            $message = "$lang{FEES} $lang{SUM}: $FORM{'5.SUM'} $er->{ER_SHORT_NAME}\n";
          }
        }
      }

      # Ext bill add
      if ($FORM{'5.EXT_BILL_DEPOSIT'}) {
        $add_values{5}{SUM} = $FORM{'5.EXT_BILL_DEPOSIT'};
        # if Bonus $conf{BONUS_EXT_FUNCTIONS}
        if (in_array('Bonus', \@MODULES) && $conf{BONUS_EXT_FUNCTIONS}) {
          load_module('Bonus', $html);
          my $sum = $FORM{'5.EXT_BILL_DEPOSIT'};
          %FORM      = %{ $add_values{8} };
          $FORM{UID} = $uid;
          $FORM{SUM} = $sum;
          $FORM{add} = $uid;
          if ($FORM{SUM} < 0) {
            $FORM{ACTION_TYPE} = 1;
            $FORM{SUM}         = abs($FORM{SUM});
          }

          $FORM{SHORT_REPORT} = 1;
          bonus_user_log({ USER_INFO => $user });
        }
        else {
          if ($FORM{'5.EXT_BILL_DEPOSIT'} + 0 > 0) {
            my $er = ($FORM{'5.ER'}) ? $Finance->exchange_info($FORM{'5.ER'}) : { ER_RATE => 1 };
            $Payments->add(
              $user,
              {
                %{ $add_values{5} },
                BILL_ID => $user->{EXT_BILL_ID},
                ER      => $er->{ER_RATE}
              }
            );

            if (_error_show($Payments, { MODULE_NAME => $lang{PAYMENTS} })) {
              return 0;
            }
            else {
              $message = "$lang{SUM}: $FORM{'5.SUM'} $er->{ER_SHORT_NAME}\n";
            }
          }
          elsif ($FORM{'5.EXT_BILL_DEPOSIT'} + 0 < 0) {
            my $er = ($FORM{'5.ER'}) ? $Finance->exchange_info($FORM{'5.ER'}) : { ER_RATE => 1 };
            $Fees->take(
              $user,
              abs($FORM{'5.EXT_BILL_DEPOSIT'}),
              {
                BILL_ID  => $user->{EXT_BILL_ID},
                DESCRIBE => 'MIGRATION',
                ER       => $er->{ER_RATE}
              }
            );

            if (_error_show($Fees, { MODULE_NAME => $lang{FEES} })) {
              return 0;
            }
            else {
              $message = "$lang{SUM}: $FORM{'5.EXT_BILL_DEPOSIT'} $er->{ER_SHORT_NAME}\n";
            }
          }
        }
      }

      #4 Dv
      # Make Dv service only with TP
      if ($add_values{4}{TP_ID}) {
        if ($add_values{4}{IP} && $add_values{4}{IP} =~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/ && $add_values{4}{IP} ne '0.0.0.0') {
          my $list = $Dv->list({ IP        => $add_values{4}{IP},
                                 LOGIN     => '_SHOW',
                                 COLS_NAME => 1,
                                 UID       => "!$uid"
                               });

          if ($Dv->{TOTAL} > 0) {
            $html->message('err', $lang{ERROR}, "IP: $add_values{4}{IP} $lang{EXIST}.\n $lang{LOGIN}: " . $html->button($list->[0]{login}, "index=15&UID=" . $list->[0]{uid}));
            return 0;
          }
        }

        my $user_fees;
        $Dv->add({ UID => $uid, %{ $add_values{4} } });
        if (_error_show($Dv, { MODULE_NAME => 'Internet', MESSAGE => "UID: $uid" })) {
          return ($Dv->{errno} == 7) ? $uid : 0;
        }
        elsif (!$FORM{SERIAL}) {
          if (!$add_values{4}{STATUS} && $Dv->{TP_INFO}->{MONTH_FEE} > 0 && ! $add_values{4}{DV_SKIP_FEE}) {
            $Dv->{UID}              = $uid;
            $Dv->{ACCOUNT_ACTIVATE} = $add_values{1}{ACTIVATE};
            $user_fees              = service_get_month_fee($Dv);
          }
        }
      }

      # Add E-Mail account
      my $Mail;
      if (in_array('Mail', \@MODULES) && $FORM{'6.USERNAME'}) {
        load_module('Mail', $html);

        $Mail = Mail->new($db, $admin, \%conf);

        $FORM{'6.newpassword'} = $FORM{'6.PASSWORD'} if ($FORM{'6.PASSWORD'});

        $Mail->mbox_add(
          {
            UID      => $uid,
            %{ $add_values{6} },
            PASSWORD => $FORM{'6.newpassword'},
          }
        );
        $Mail->{PASSWORD} = $FORM{'6.newpassword'};

        if (! _error_show($Mail, { MESSAGE => 'E-mail' })) {
          if ($FORM{'6.SEND_MAIL'}) {
            $message = $html->tpl_show(_include('mail_test_msg', 'Mail'), $Mail, { OUTPUT2RETURN => 1 });
            sendmail("$conf{ADMIN_MAIL}", "$Mail->{USER_EMAIL}", "Test mail", "$message", "$conf{MAIL_CHARSET}", "");
          }
        }

        $Mail = $Mail->mbox_info({ MBOX_ID => $Mail->{MBOX_ID} });
        $Mail->{EMAIL_ADDR} = $Mail->{USERNAME} . '@' . $Mail->{DOMAIN};
      }

      # Msgs
      if (in_array('Msgs', \@MODULES) && $add_values{7} && $FORM{'7.SUBJECT'}) {
        load_modules('Msgs', $html);

        $FORM{INNER_MSG} = 1;
        Msgs->new($db, $admin, \%conf);

        %FORM      = %{ $add_values{7} };
        $FORM{UID} = $uid;
        $FORM{add} = $uid;
        msgs_admin_add({ SEND_ONLY => 1 });
      }

      # Abon
      if (in_array('Abon', \@MODULES) && $add_values{9}) {
        load_module('Abon', $html);
        %FORM         = %{ $add_values{9} };
        $FORM{UID}    = $uid;
        $FORM{change} = $uid;
        abon_user({ QUITE => 1 });
      }

      #Fees wizard form
      if (scalar keys %{ $add_values{10}} > 0) {
        %FORM      = %{ $add_values{10} };

        $FORM{UID} = $uid;
        $FORM{add} = $uid;

        if (defined(&form_fees_wizard)) {
          form_fees_wizard({ USER_INFO => $user });
        }
      }

      #Dhcphosts wizards
      if (in_array('Dhcphosts', \@MODULES) &&  $add_values{11}) {
        load_module('Dhcphosts', $html);

        %FORM      = %{ $add_values{11} };
        $FORM{UID} = $uid;
        $FORM{add} = $uid;

        $FORM{'NAS_MAC'} = _mac_former($FORM{'NAS_MAC'});

        if ($FORM{'NAS_MAC'} && ! $FORM{NAS_ID}) {
          my $list = $Nas->list({ MAC => $FORM{NAS_MAC}, COLS_NAME => 1 });
          $FORM{NAS_ID} = $list->[0]->{nas_id};
        }

        dhcphosts_user({ USER_INFO    => $user,
                         REGISTRATION => 1,
                         QUITE        => 1 });
      }

      # Info
      my $dv = $Dv->info($uid);
      my $pi = $user->pi({ UID => $uid });
      $user  = $user->info($uid, { SHOW_PASSWORD => 1 });

      if (!$attr->{SHORT_REPORT}) {
        $FORM{ex_message} = $message;
        if (in_array('Docs', \@MODULES)) {
          $message .= $lang{CONTRACT} .': '. $pi->{CONTRACT_SUFIX} . $pi->{CONTRACT_ID} . $html->button($lang{PRINT} .' '.$lang{CONTRACT}, "qindex=$index&UID=$uid&PRINT_CONTRACT=$uid&print=1" . (($conf{DOCS_PDF_PRINT}) ? '&pdf=1' : ''), { ex_params => 'target=_new', class => 'print' });
        }

        $html->message('info', $lang{ADDED}, "LOGIN: $login\nUID: $uid\n$message");
        $html->tpl_show(templates('form_user_info'), { %$user, %$pi, DATE => $DATE, TIME => $TIME });
        $dv->{STATUS} = $service_status->{ $dv->{STATUS} } if ($dv->{STATUS});
        $html->tpl_show(_include('dv_user_info', 'Dv'), $dv);
        $html->tpl_show(_include('mail_user_info', 'Mail'), $Mail) if ($Mail);

        #If docs module enable make account
        if (in_array('Docs', \@MODULES) && $FORM{'4.NO_ACCOUNT'}) {
          $LIST_PARAMS{UID} = $uid;

          if ($dv->{MONTH_FEE} + $dv->{ACTIVATE} > 0) {
            load_module('Docs', $html);

            $FORM{DATE}     = $DATE;
            $FORM{CUSTOMER} = $pi->{FIO} || '-';
            $FORM{PHONE}    = $pi->{PHONE};
            $FORM{UID}      = $uid;

            $FORM{'IDS'}     = '1, 2';
            $FORM{'ORDER_1'} = "$lang{DV}";
            $FORM{'COUNT_1'} = 1;
            $FORM{'UNIT_1'}  = 0;
            $FORM{'SUM_1'}   = $dv->{MONTH_FEE};

            if ($Tariffs->{ACTIV_PRICE}) {
              $FORM{'ORDER_2'} = "$lang{ACTIVATE}";
              $FORM{'COUNT_2'} = 1;
              $FORM{'UNIT_2'}  = 0;
              $FORM{'SUM_2'}   = $dv->{MONTH_FEE};
            }

            $FORM{'create'} = 1;
            docs_invoice();
          }
        }
      }

      return $uid;
    }
    else {
      if ($users->{errno} == 7) {
        if ( ! $attr->{SHOW_USER} ) {
          $html->message('err', "$lang{ERROR}", "$login: '". $html->button($login, "index=7&LOGIN=$login&search=1&type=11") ."' $lang{USER_EXIST}");
        }
        my $list = $users->list({ LOGIN => $login, COLS_NAME => 1 });
        $uid = $list->[0]->{uid};
      }
      elsif ($users->{errno} == 10) {
        $html->message('err', $lang{ERROR}, "'$login' $lang{ERR_WRONG_NAME}");
      }
      else {
        _error_show($users, { MESSAGE => "$lang{LOGIN}: '$login'" });
      }
      return $uid if ($attr->{SHORT_REPORT});
    }
  }

  foreach my $k (keys %FORM) {
    next if ($k eq '__BUFFER');
    my $val = $FORM{$k};
    if ($k =~ /\d+\.([A-Z0-9\_]+)/ig) {
      my $key = $1;
      $FORM{"$key"} = $val;
    }
  }

  my $users_defaults;
  $users_defaults->{DISABLE} = ($users_defaults->{DISABLE} && $users_defaults->{DISABLE} == 1) ? ' checked' : '';

  #Info fields
  if (!$attr->{NO_EXTRADATA}) {
    $users_defaults->{EXDATA} .= $html->tpl_show(templates('form_user_exdata_add'),
       { CREATE_BILL => ' checked',
         GID         => sel_groups({ SKIP_MUULTISEL => 1 })
       },
       { OUTPUT2RETURN => 1 });
    $users_defaults->{EXDATA} .= $html->tpl_show(templates('form_ext_bill_add'), { CREATE_EXT_BILL => ' checked' }, { OUTPUT2RETURN => 1 }) if ($conf{EXT_BILL_ACCOUNT});
  }

  my $dv_defaults = $Dv->defaults();
  $dv_defaults->{STATUS_SEL} = sel_status({ STATUS => $FORM{STATUS} });

  $dv_defaults->{TP_ID} = $html->form_select(
    'TP_ID',
    {
      SELECTED => $FORM{TP_ID},
      SEL_LIST => $Tariffs->list({ MODULE      => 'Dv',
                                   DOMAIN_ID   => $admin->{DOMAIN_ID} || 0,
                                   NEW_MODEL_TP=> 1,
                                   COLS_NAME   => 1
                                 }),
    }
  );

  delete($FORM{TP_ID});
  $dv_defaults->{CALLBACK} = '';

  my $password_form;
  $password_form->{GEN_PASSWORD} = mk_unique_value(8);
  $password_form->{PW_CHARS}     = $conf{PASSWD_SYMBOLS} || "abcdefhjmnpqrstuvwxyz23456789ABCDEFGHJKLMNPQRSTUVWYXZ";
  $password_form->{PW_LENGTH}    = $conf{PASSWD_LENGTH} || 6;

  #Info fields
  my %pi_form = ( INFO_FIELDS => form_info_field_tpl() );

  if ($conf{DOCS_CONTRACT_TYPES}) {
    #PREFIX:SUFIX:NAME;
    $conf{DOCS_CONTRACT_TYPES} =~ s/\n//g;
    my (@contract_types_list) = split(/;/, $conf{DOCS_CONTRACT_TYPES});

    my %CONTRACTS_LIST_HASH = ();
    foreach my $line (@contract_types_list) {
      my ($prefix, $sufix, $name) = split(/:/, $line);
      $prefix =~ s/ //g;
      $CONTRACTS_LIST_HASH{"$prefix|$sufix"} = $name;
    }

    $pi_form{CONTRACT_TYPE} = " $lang{TYPE}: "
    . $html->form_select(
      'CONTRACT_TYPE',
      {
        SELECTED => '',
        SEL_HASH => { '' => '', %CONTRACTS_LIST_HASH },
        NO_ID    => 1
      }
    );
  }

  if ($conf{ADDRESS_REGISTER}) {
    $users->{FLAT_CHECK_FREE} = 1;
    $pi_form{ADDRESS_TPL} = $html->tpl_show(templates('form_address_sel'), $users, { OUTPUT2RETURN => 1 });
  }
  else {
    $pi_form{ADDRESS_TPL} = $html->tpl_show(templates('form_address'), undef, { OUTPUT2RETURN => 1 });
  }

  $dv_defaults->{JOIN_SERVICE} = '';
  my $list = $Nas->ip_pools_list({ STATIC => 1, COLS_NAME => 1 });

  $dv_defaults->{STATIC_IP_POOL} = $html->form_select(
    'STATIC_IP_POOL',
    {
      SELECTED    => $FORM{STATIC_POOL},
      SEL_LIST    => $list,
      NO_ID       => 1,
      SEL_OPTIONS => { '' => '' },
    }
  );

  if ($conf{DV_LOGIN}) {
    $dv_defaults->{LOGIN_FORM} = $html->tpl_show(templates('form_row'), { ID => 'DV_LOGIN',
         NAME  => "Internet ". $lang{LOGIN},
         VALUE => $html->form_input('DV_LOGIN', $FORM{DV_LOGIN}, { ID => 'DV_LOGIN' })
         }, { OUTPUT2RETURN => 1 });
  }

  my %tpls = (
    "01:".$lang{LOGIN}."::"  => $html->tpl_show(templates('form_user'),     { %$users_defaults, %FORM }, { OUTPUT2RETURN => 1, ID => 'FORM_USER' }),
    "02:".$lang{PASSWD}."::" => $html->tpl_show(templates('form_password'), { %$password_form,  %FORM }, { OUTPUT2RETURN => 1, ID => 'FORM_PASSWORD' }),
    "03:".$lang{INFO}."::"   => $html->tpl_show(templates('form_pi'),       { %pi_form,         %FORM }, { OUTPUT2RETURN => 1, ID => 'FORM_PI' }),
    "04:Internet::" => $html->tpl_show(_include('dv_user', 'Dv'),  { %$dv_defaults, %FORM }, { OUTPUT2RETURN => 1, ID => 'DV_USER' }),
  );

  #Payments
  if ($permissions{1} && $permissions{1}{1}) {
    $Payments->{SEL_METHOD} = $html->form_select(
      'METHOD',
      {
        SELECTED     => (defined($FORM{METHOD}) && $FORM{METHOD} ne '') ? $FORM{METHOD} : '',
        SEL_HASH     => get_payment_methods(),
        SORT_KEY_NUM => 1,
        NO_ID        => 1,
        SEL_OPTIONS  => { '' => $lang{ALL} }
      }
    );

    $Payments->{SUM}    = '0.00';
    $FORM{SUM}          = '0.00';

    $Payments->{SEL_ER} = $html->form_select(
      'ER',
      {
        SELECTED    => undef,
        SEL_LIST    => $Finance->exchange_list({ COLS_NAME => 1 }),
        SEL_KEY     => 'id',
        SEL_VALUE   => 'short_name,rate',
        SEL_OPTIONS => { '' => '-N/S-' },
        NO_ID       => 1
      }
    );

    $tpls{"05:". $lang{PAYMENTS} ."::"} = $html->tpl_show(templates('form_payments'), $Payments, { OUTPUT2RETURN => 1, ID => 'FORM_PAYMENTS' });
  }

  #If mail module added
  if (in_array('Mail', \@MODULES)) {
    load_module('Mail', $html);
    my $Mail = Mail->new($db, $admin, \%conf);

    $Mail->{PASSWORD} =   $Mail->{PASSWORD} = $html->tpl_show(_include('mail_password', 'Mail'), {
                                                                        PW_CHARS  => "abcdefhjmnpqrstuvwxyz23456789ABCDEFGHJKLMNPQRSTUVWYXZ",
                                                                        PW_LENGTH => 8,
                                                                        },
                                                                        { OUTPUT2RETURN => 1  });

    $Mail->{SEND_MAIL} = 'checked';

    $Mail->{DOMAINS_SEL} = $html->form_select(
      'DOMAIN_ID',
      {
        SELECTED    => $Mail->{DOMAIN_ID},
        SEL_LIST    => $Mail->domain_list({ COLS_NAME => 1 }),
        SEL_VALUE   => 'domain',
        SEL_OPTIONS => { 0 => '-N/S-' },
        NO_ID       => 1
      }
    );

    $tpls{"06:E-Mail::"} = $html->tpl_show(_include('mail_box', 'Mail'), $Mail, { OUTPUT2RETURN => 1, ID => 'MAIL_BOX' });
  }

  #If msgs module added
  if (in_array('Msgs', \@MODULES) && !defined($FORM{CARDS_FORM})) {
    load_module('Msgs', $html);
    Msgs->new($db, $admin, \%conf);
    $FORM{UID} = -1;
    delete($FORM{add});
    $tpls{"07:". $lang{MESSAGE} ."::"} = msgs_admin_add({ OUTPUT2RETURN => 1 });
  }

  $tpls{"10:". $lang{FEES} ."::"} = form_fees_wizard({ OUTPUT2RETURN => 1 });

  if ($attr->{TPLS}) {
    while (my ($k, $v) = each %{ $attr->{TPLS} }) {
      $tpls{$k} = $v;
    }
  }

  my $wizard;

  my $template         = '';
  my @sorted_templates = sort keys %tpls;

  foreach my $key (@sorted_templates) {
    my ($n, $descr) = split(/:/, $key, 4);
    $n = int($n);
    my $sub_tpl .= $html->tpl_show($tpls{"$key"}, $wizard, { OUTPUT2RETURN => 1, ID => "$descr" });
    $sub_tpl =~ s/(<input .*?UID.*?>)//gi;
    $sub_tpl =~ s/(<input .*?index.*?>)//gi;
    $sub_tpl =~ s/name=[\'\"]?([A-Z_0-9]+)[\'\"]? /name=$n.$1 /ig;
    $template .= $sub_tpl;
  }

  $template =~ s/(<form .*?>)//gi;
  $template =~ s/<\/form>//ig;
  $template =~ s/(<input .*?type=submit.*?>)//gi;
  $template =~ s/<hr>//gi;

  if ($attr->{OUTPUT2RETURN}) {
    return $template;
  }

  print $html->form_main(
    {
      CONTENT => $template,
      HIDDEN  => { index => "$index" },
      SUBMIT  => { add => "$lang{ADD}" },
      NAME    => 'user_form',
      ENCTYPE => 'multipart/form-data',
      class   => 'form-horizontal'
    }
  );

  return 1;
}

#**********************************************************
=head2 dv_registration($attr)

=cut
#**********************************************************
sub dv_registration {
  my ($attr) = @_;
  print "Content-Type: text/html\n\n";
  if ($FORM{reg}) {
    if ($attr->{CAPTCHA} && $attr->{CAPTCHA_OBJ}->check_code("$FORM{CCODE}", "$FORM{C}") != 1) {
      $Dv->{MESSAGE} = $html->message('err', $lang{ERROR}, "$lang{ERR_WRONG_CAPTCHA}", { ID => 991 });
    }
    elsif ($attr->{SKIP_EMAIL_CHECK} && $FORM{EMAIL} !~ /^(([^<>()[\]\\.,;:\s\@\"]+(\.[^<>()[\]\\.,;:\s\@\"]+)*)|(\".+\"))\@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/) {
      $Dv->{MESSAGE} = $html->message('err', $lang{ERROR}, "$lang{WRONG_EMAIL}");
    }
    elsif ($conf{REGISTRATION_CHECK_PHONE} && ! $FORM{PHONE}) {
      $Dv->{MESSAGE} = $html->message('err', $lang{ERROR}, $lang{ERR_WRONG_PHONE});
    }
    elsif (! $FORM{ACCEPT_RULES}) {
      $html->message('err', $lang{ERROR}, "$lang{ERR_ACCEPT_RULES} -");
    }
    else {
      my $password = mk_unique_value($conf{PASSWD_LENGTH} || 8);

      $users->add(
        {
          LOGIN       => $FORM{LOGIN},
          CREATE_BILL => 1,
          PASSWORD    => $password,
          GID         => $conf{REGISTRATION_GID},
          PREFIX      => $conf{REGISTRATION_PREFIX},
        }
      );

      #my $message = '';
      if (!$users->{errno}) {
        my $uid = $users->{UID};
        $users->info($uid);

        #3 personal info
        $users->pi_add(
          {
            %FORM,
            UID   => $uid,
            FIO   => $FORM{FIO},
            EMAIL => $FORM{EMAIL}
          }
        );

        if ($users->{errno}) {
          $Dv->{MESSAGE} = $html->message('err', $lang{ERROR}, "[$users->{errno}] $err_strs{$users->{errno}}");
          goto REG_FORM;
        }

        #4 Dv
        $conf{REGISTRATION_DEFAULT_TP} = 0 if (!$conf{REGISTRATION_DEFAULT_TP});
        $Dv->add(
          {
            UID   => $uid,
            TP_ID => $FORM{TP_ID} || $conf{REGISTRATION_DEFAULT_TP},
            STATUS=> $FORM{STATUS}
          }
        );

        if (!$Dv->{errno}) {
          if ($conf{REGISTRATION_SHOW_PASSWD}) {
            $Dv->{PASSWD} = $password;
          }
          else {
            $Dv->{PASSWD} = "E-mail $lang{SENDED}";
          }

          $Dv->info($uid);
          if ($attr->{ACTIVATE_PAYMENT}) {
            $Payments->add(
              $users,
              {
                METHOD   => $attr->{PAYMENT_METHOD} || '2',
                SUM      => $Dv->{TP_ACTIVATE_PRICE},
              }
            );

            if ($FORM{STATUS}) {
              $Dv->change({ UID    => $uid,
                            STATUS => 0
                          });

              service_get_month_fee($Dv, { QUITE => 1 });
            }
          }

          #show complete when user added
          if ($attr->{SHOW_SMS}) {
            $html->tpl_show(_include('dv_reg_complete_sms', 'Dv'), { %$Dv, %FORM, %{ ($users) ? $users : {} }, PASSWORD => "$password" });
          }
          elsif (! $attr->{QUITE}) {
            $html->tpl_show(_include('dv_reg_complete', 'Dv'), { %$Dv, %FORM, %{ ($users) ? $users : {} } });
          }

          #Sendsms
          if ($FORM{PHONE} && in_array('Sms', \@MODULES) && $conf{DV_REGISTRATION_SEND_SMS} && ! $FORM{REGISTRATION_SKIP_SEND_SMS}) {
            load_module('Sms', $html);

            my $message = $html->tpl_show(_include('dv_reg_complete_sms', 'Dv'), { %FORM }, { OUTPUT2RETURN => 1  });;
                sms_send({
                  NUMBER  => $FORM{PHONE},
                  MESSAGE => $message,
                  UID     => $uid,
                });
          }
          #Send mail
          if ($FORM{EMAIL}) {
            my $message = $html->tpl_show(_include('dv_reg_complete_mail', 'Dv'), { %$Dv, %FORM, PASSWORD => "$password" }, { OUTPUT2RETURN => 1 });
            sendmail("$conf{ADMIN_MAIL}", "$FORM{EMAIL}", "$lang{REGISTRATION}", "$message", "$conf{MAIL_CHARSET}", '');
          }

          return $uid;
        }
        else {
          _error_show($Dv);
        }
      }
      else {
        _error_show($users);
        goto REG_FORM;
      }
    }
  }

  REG_FORM:

  if ($conf{DV_REGISTRATION_TP_GIDS}) {
    $LIST_PARAMS{TP_GID} = $conf{DV_REGISTRATION_TP_GIDS};
  }
  else {
    $LIST_PARAMS{TP_GID} = '>0';
  }

  $Dv->{TP_SEL} = $html->form_select(
    'TP_ID',
    {
      SELECTED => $FORM{TP_ID},
      SEL_LIST => $Tariffs->list({ %LIST_PARAMS,
                                   MODULE       => 'Dv',
                                   NEW_MODEL_TP => 1,
                                   COLS_NAME    => 1 }),
    }
  );

  if ($conf{DV_REGISTRATION_ADDRESS}) {
    $Dv->{ADDRESS_TPL} = $html->tpl_show(templates('form_address_search'), { %FORM, %$attr },
       { OUTPUT2RETURN => 1, ID => 'form_address_sel' });
  }

  $html->tpl_show(_include('dv_registration', 'Dv'), { %$Dv, %$attr, %FORM }, { ID => 'DV_REGISTRATION' });

  return 0;
}

#**********************************************************
=head2 dv_dhcp_get_mac_add($ip, $DHCP_INFO, $attr) - Add discovery mac to Dhcphosts

  Arguments:
    $ip
    $DHCP_INFO
    $attr

  Returns:

=cut
#**********************************************************
sub dv_dhcp_get_mac_add {
  my ($ip, $DHCP_INFO) = @_;

  require Dhcphosts;
  Dhcphosts->import();
  my $Dhcphosts         = Dhcphosts->new($db, $admin, \%conf);

  $conf{DV_IP_DISCOVERY}=~s/[\r\n ]//g;
  my @dhcp_nets         = split(/;/, $conf{DV_IP_DISCOVERY});
  my $default_params    = "IP,MAC";
  load_module('Dhcphosts');

  foreach my $nets (@dhcp_nets) {
    my %PARAMS_HASH = ();

    my ($net_id, $net_ips, $params) = split(/:/, $nets);
    $params                 = $default_params if (!$params);
    my @params_arr          = split(/,/, $params);

    foreach my $param (@params_arr) {
      $PARAMS_HASH{$param} = $DHCP_INFO->{$param};
    }

    my $start_ip           = '0.0.0.0';
    my $bit_mask           = 0;
    ($start_ip, $bit_mask) = split(/\//, $net_ips) if ($net_ips);
    my $mask               = 0b0000000000000000000000000000001;
    my $address_count      = sprintf("%d", $mask << (32 - $bit_mask));

    if (ip2int($ip) >= ip2int($start_ip) && ip2int($ip) <= ip2int($start_ip) + $address_count) {
      $PARAMS_HASH{IP} = dhcphosts_get_static_ip($net_id);

      if($PARAMS_HASH{IP} == -1) {
        return 0;
      }
      elsif ($PARAMS_HASH{IP} == 0) {
        $PARAMS_HASH{IP}='0.0.0.0';
      }

      my $list = $Dhcphosts->hosts_list({
         NAS_ID    => $PARAMS_HASH{NAS_ID},
         UID       => $user->{UID},
         PORTS     => $PARAMS_HASH{PORTS},
         COLS_NAME => 1,
         PAGE_ROWS => 1
         });

      if ($Dhcphosts->{TOTAL} > 0) {
        $Dhcphosts->host_change(
          {
            ID     => $list->[0]->{id},
            MAC    => $PARAMS_HASH{MAC}
          }
        );
      }
      else {
        $Dhcphosts->host_add(
          {
            NETWORK     => $net_id,
            HOSTNAME    => "$user->{LOGIN}_$net_id",
            UID         => $user->{UID},
            IPN_ACTIVATE=> 1,
            %PARAMS_HASH
          }
        );
      }

      if ($Dhcphosts->{errno}) {
        if ($Dhcphosts->{errno} == 7) {
          $html->message('err', $lang{ERROR} . ' ' . $lang{ACTIVATE}, $html->b("$lang{ERR_HOST_REGISTRED}") . "\n $lang{RENEW_IP}\n\n MAC: '$DHCP_INFO->{MAC}'\n IP: '$DHCP_INFO->{IP}'\n HOST: '$user->{LOGIN}_$net_id'", { ID => 118 });
        }
        else {
          $html->message('err', $lang{ACTIVATE}, "$lang{ERROR}: DHCP add hosts error", { ID => 119 });
        }
      }
      else {
        dhcphosts_config(
          {
            NETWORKS => $net_id,
            reconfig => 1,
            QUITE    => 1,
            %PARAMS_HASH
          }
        );
        $Dv->{NEW_IP} = $PARAMS_HASH{IP};

        return 1;
      }

      return 0;
    }
  }

  $html->message('err', $lang{ACTIVATE}, "$lang{ERROR}: Can't find assign network IP: '$ip' ", { ID => 120 });

  return 0;
}

#**********************************************************
=head2 dv_dhcp_get_mac($ip, $attr) - Get MAC from dhcp leaseds

IP discovery function

  Arguments:
    $ip     - User IP
    $attr   - Extra attributes
      CHECK_STATIC - Check static IP in dhcphosts

  Returns:
    Hash_ref
      IP
      MAC
      NAS_ID
      PORTS
      VLAN

=cut
#**********************************************************
sub dv_dhcp_get_mac {
  my ($ip, $attr) = @_;

  require Dhcphosts;
  Dhcphosts->import();
  my $Dhcphosts = Dhcphosts->new($db, $admin, \%conf);

  $Dhcphosts->host_info(0, { IP => $ip });
  #my $MAC    = '';
  my %PARAMS = ();

  if ($Dhcphosts->{TOTAL} > 0) {
    %PARAMS = (
      IP     => $Dhcphosts->{IP},
      MAC    => $Dhcphosts->{MAC},
      NAS_ID => $Dhcphosts->{NAS_ID},
      PORTS  => $Dhcphosts->{PORTS},
      VLAN   => $Dhcphosts->{VLAN}
    );

    if ($attr->{CHECK_STATIC}) {
      $PARAMS{STATIC} = 1;
    }
    if ($PARAMS{MAC} ne '00:00:00:00:00:00') {
      return \%PARAMS;
    }
  }

  #Get mac from DB
  if ($conf{DHCPHOSTS_LEASES} eq 'db') {
    my $list = $Dhcphosts->leases_list({ IP        => $ip,
                                         STATE     => 2,
                                         COLS_NAME => 1,
                                         COLS_UPPER=> 1 });

    if ($Dhcphosts->{TOTAL} > 0) {
      %PARAMS        = %{ $list->[0] };
      $PARAMS{MAC}   = $list->[0]->{HARDWARE};
      $PARAMS{PORTS} = $list->[0]->{PORT};
      $PARAMS{VID}   = $list->[0]->{VLAN};
    }

    load_module('Dhcphosts');

    if (defined($PARAMS{NAS_ID}) && $PARAMS{NAS_ID} == 0 && $PARAMS{CIRCUIT_ID} ) {
      ($PARAMS{NAS_ID}, $PARAMS{PORTS}, $PARAMS{VLAN}, $PARAMS{NAS_MAC})=dhcphosts_o82_info({ %PARAMS });
    }

    return \%PARAMS;
  }

  #Get mac from leases file
  else {
    my $logfile = $conf{DHCPHOSTS_LEASES} || '/var/db/dhcpd/dhcpd.leases';
    my %list    = ();
    my $l_ip    = '';

    open(my $fh, '<', $logfile) or $html->message('err', $lang{ERROR}, "Can't read file '$logfile' $!");
      while (<$fh>) {
        next if /^#|^$/;

        if (/^lease (\d+\.\d+\.\d+\.\d+)/) {
          $l_ip = $1;
          $list{$ip}{ip} = sprintf("%-17s", $ip);
        }
        elsif (/^\s*hardware ethernet (.*);/) {
          my $mac = $1;
          if ($ip eq $l_ip) {
            $list{$ip}{hardware} = sprintf("%s", $mac);
            return $list{$ip}{hardware} if ($list{$ip}{active});
          }
        }
        elsif (/^\s+binding state active/) {
          $list{$ip}{active} = 1;
        }
      }
    close($fh);
    $PARAMS{MAC} = ($list{$ip}{hardware}) ? $list{$ip}{hardware} : '';
  }

  return \%PARAMS;
}

#**********************************************************
=head2 dv_compensation($attr)

=cut
#**********************************************************
sub dv_compensation {
  my ($attr) = @_;

  if ($FORM{add} && $FORM{FROM_DATE}) {
    my ($FROM_Y, $FROM_M, $FROM_D) = split(/-/, $FORM{FROM_DATE}, 3);
    #my $from_date = POSIX::mktime(0, 0, 0, $FROM_D, ($FROM_M - 1), ($FROM_Y - 1900), 0, 0, 0);

    my ($TO_Y, $TO_M, $TO_D) = split(/-/, $FORM{TO_DATE}, 3);

    #my $to_date = POSIX::mktime(0, 0, 0, $TO_D, ($TO_M - 1), ($TO_Y - 1900), 0, 0, 0);
    my $sum     = 0.00;
    my $days    = 0;
    my $days_in_month = 31;

    $Dv->info($FORM{UID});

    my $table = $html->table(
      {
        width       => '400',
        caption     => "$lang{COMPENSATION} $lang{FROM}: $FORM{FROM_DATE} $lang{TO}: $FORM{TO_DATE}",
        title_plain => [ "$lang{MONTH}", "$lang{DAYS}", "$lang{SUM}" ],
        cols_align  => [ 'right', 'right', 'right', ],
        ID          => 'DV_COMPENSATION_DESCRIBE'
      }
    );

    if ($users->{ACTIVATE} && $users->{ACTIVATE} ne '0000-00-00') {
      $days = date_diff($FORM{FROM_DATE}, $FORM{TO_DATE});
      $sum = $days * ($Dv->{MONTH_ABON} / 30);
      if ($Dv->{DAY_ABON} > 0 && ! $attr->{HOLD_UP}) {
        $sum += $days * $Dv->{DAY_ABON};
      }
    }
    else {
      if ("$FROM_Y-$FROM_M" eq "$TO_Y-$TO_M") {
        $days          = $TO_D - $FROM_D;
        $days_in_month = days_in_month({ DATE => "$FROM_Y-$FROM_M-01" });
        $sum           = sprintf("%.2f", $days * $Dv->{DAY_ABON} + $days * ($Dv->{MONTH_ABON} / $days_in_month));
        $table->addrow("$FROM_Y-$FROM_M", $days, $sum);
      }
      elsif ("$FROM_Y-$FROM_M" ne "$TO_Y-$TO_M") {
        $FROM_D--;
        do {
          $days_in_month = days_in_month({ DATE => "$FROM_Y-$FROM_M-01" });
          my $month_days = ($FROM_M == $TO_M) ? $TO_D : $days_in_month - $FROM_D;
          $FROM_D = 0;
          my $month_sum = sprintf("%.2f", $month_days * $Dv->{DAY_ABON} + $month_days * ($Dv->{MONTH_ABON} / $days_in_month));
          $sum  += $month_sum;
          $days += $month_days;
          $table->addrow("$FROM_Y-$FROM_M", $month_days, $month_sum);

          if ($FROM_M < 12) {
            $FROM_M = sprintf("%02d", $FROM_M + 1);
          }
          else {
            $FROM_M = sprintf("%02d", 1);
            $FROM_Y += 1;
          }

          if($attr->{HOLD_UP}) {
            return 1;
          }
        } while (($FROM_Y < $TO_Y) || ($FROM_M <= $TO_M && $FROM_Y == $TO_Y));
      }
    }

    if ($users->{REDUCTION}) {
      $sum = $sum - (($sum / 100) *  $users->{REDUCTION});
    }

    $table->{color} = $_COLORS[3];

    $table->addrow($html->b("$lang{TOTAL}:"), $html->b("$days"), $html->b("$sum"));
    $Payments->add(
      {
        BILL_ID => $users->{BILL_ID} || $user->{BILL_ID},
        UID     => $users->{UID} || $user->{UID}
      },
      {
        SUM            => $sum,
        METHOD         => 6,
        DESCRIBE       => "$lang{COMPENSATION}. $lang{DAYS}: $FORM{FROM_DATE}/$FORM{TO_DATE} ($days)" . (($FORM{DESCRIBE}) ? ". $FORM{DESCRIBE}" : ''),
        INNER_DESCRIBE => $FORM{INNER_DESCRIBE}
      }
    );

    if (! _error_show($Payments)) {
      $html->message('info', "$lang{COMPENSATION}", "$lang{COMPENSATION} $lang{SUM}: $sum");
      print $table->show();
    }

    if ($attr->{QUITE}) {
      return 0;
    }
  }

  $html->tpl_show(_include('dv_compensation', 'Dv'), { %FORM, %$Dv });

  return 1;
}

#**********************************************************
=head2 dv_form_shedule() - Shedule form for Dv modules

=cut
#**********************************************************
sub dv_form_shedule {

  my $Shedule = Shedule->new($db, $admin, \%conf);

  if ($FORM{add}) {
    my ($Y, $M, $D) = split(/-/, ($FORM{DATE} || $DATE), 3);

    $Shedule->add(
      {
        UID    => $FORM{UID},
        TYPE   => $FORM{Shedule} || q{},
        ACTION => $FORM{ACTION},
        D      => $D,
        M      => $M,
        Y      => $Y,
        MODULE => 'Dv'
      }
    );

    if (! _error_show($Shedule, { ID => 971 })) {
      $html->message('info', $lang{CHANGED}, "$lang{SHEDULE} $lang{ADDED}");
    }
  }
  elsif ($FORM{del} && $FORM{COMMENTS}) {
    $Shedule->del({ ID => $FORM{del} });
    if (! _error_show($Shedule->{errno})) {
      $html->message('info', $lang{DELETED}, "$lang{DELETED} [$FORM{del}]");
    }
  }

  my $service_status = sel_status({ HASH_RESULT => 1 });

  if ($FORM{Shedule} && $FORM{Shedule} eq 'status') {
    my @rows = (
                " $lang{FROM}: ",
                $html->date_fld2('DATE', {
                    NEXT_DAY  => 1,
                    FORM_NAME => 'Shedule',
                    MONTHES   => \@MONTHES,
                    FORM_NAME => 'Shedule',
                    WEEK_DAYS => \@WEEKDAYS }),
                " $lang{STATUS}: ",
                $html->form_select('ACTION', {
                    SELECTED   => $FORM{ACTION},
                    SEL_HASH   => $service_status,
                    USE_COLORS => 1,
                    NO_ID      => 1
                  }
                ),
                $html->form_input('add', $lang{ADD}, { TYPE => 'submit' })
                );

    my $info = '';
    foreach my $val ( @rows ) {
      $info .= $html->element('div', $val, { class => 'form-group' });
    }

    print $html->form_main(
      {
        CONTENT => $html->element('div', $info, { class => 'well well-sm' }),
        HIDDEN  => {
          sid     => $sid,
          index   => $index,
          Shedule => "status",
          UID     => $FORM{UID},
        },
        NAME  => 'Shedule',
        ID    => 'Shedule',
        class => 'form-inline'
      }
    );
  }

  #my $service_status_colors = sel_status({ COLORS => 1 });
  my $list = $Shedule->list(
    {
      UID    => $FORM{UID},
      MODULE => 'Dv'
    }
  );

  my $table = $html->table(
    {
      width      => '100%',
      title      => [ "$lang{HOURS}", "$lang{DAY}", "$lang{MONTH}", "$lang{YEAR}", "$lang{COUNT}", "$lang{USER}", "$lang{TYPE}", "$lang{VALUE}", "$lang{MODULES}", "$lang{ADMINS}", "$lang{CREATED}", "-" ],
      cols_align => [ 'right', 'right', 'right', 'right', 'right', 'left', 'right', 'right', 'right', 'left', 'right', 'center' ],
      qs         => $pages_qs,
      pages      => $Shedule->{TOTAL},
      ID         => 'DV_SHEDULE'
    }
  );

  foreach my $line (@$list) {
    my $delete = ($permissions{0}{4}) ? $html->button($lang{DEL}, "index=$index&del=$line->[14]&UID=$line->[13]", { MESSAGE => "$lang{DEL} [$line->[13]]?", class => 'del', TEXT => $lang{DEL} }) : '-';

    $table->addrow(
      $html->b($line->[0]),
      $line->[1],
      $line->[2],
      $line->[3],
      $line->[4],
      $html->button($line->[5], "index=15&UID=$line->[13]"),
      $line->[6],
      ($line->[6] eq 'status') ? $html->color_mark($service_status->{ $line->[7] }) : $line->[7],
      $line->[8],
      $line->[9],
      $line->[10],
      $delete
    );
  }

  print $table->show();

  $table = $html->table(
    {
      width      => '100%',
      cols_align => [ 'right', 'right', 'right', 'right' ],
      rows => [ [ "$lang{TOTAL}:", $html->b($Shedule->{TOTAL}) ] ]
    }
  );
  print $table->show();

  return 1;
}

#**********************************************************
=head2 dv_traffic_classes()

=cut
#**********************************************************
sub dv_traffic_classes {
  #my ($attr) = @_;

  $Tariffs->{ACTION}     = 'add';
  $Tariffs->{LNG_ACTION} = $lang{ADD};

  if ($FORM{add}) {
    $Tariffs->traffic_class_add({%FORM});
    if (!$Tariffs->{errno}) {
      $html->message('info', $lang{INFO}, "$lang{ADDED}");
    }
  }
  elsif ($FORM{change}) {
    $Tariffs->traffic_class_change({ %FORM, CHANGED => "$DATE $TIME" });

    if (!$Tariffs->{errno}) {
      $html->message('info', $lang{INFO}, "$lang{CHANGED}");
    }
  }
  elsif ($FORM{chg}) {
    $Tariffs->traffic_class_info($FORM{chg});
    $Tariffs->{ACTION}     = 'change';
    $Tariffs->{LNG_ACTION} = $lang{CHANGE};
    if (!$Tariffs->{errno}) {
      $html->message('info', $lang{INFO}, "$lang{CHANGED}");
    }
  }
  elsif ($FORM{del} && $FORM{COMMENTS}) {
    $Tariffs->traffic_class_del({ ID => $FORM{del} });
    if (!$Tariffs->{errno}) {
      $html->message('info', $lang{INFO}, "$lang{DELETED}");
    }
  }

  _error_show($Tariffs);

  $html->tpl_show(_include('dv_traffic_class', 'Dv'), $Tariffs);

  my $list  = $Tariffs->traffic_class_list({%LIST_PARAMS});
  my $table = $html->table(
    {
      width      => '100%',
      caption    => "$lang{TRAFFIC_CLASS}",
      title      => [ '#', "$lang{NAME}", 'NETS', "$lang{COMMENTS}", "$lang{CHANGED}", '-', '-' ],
      cols_align => [ 'right', 'left', 'left', 'center:noprint', 'center:noprint' ],
      qs         => $pages_qs,
      pages      => $Dv->{TOTAL},
      ID         => 'DV_TRAFFIC_CLASSES'
    }
  );

  my $br = $html->br();
  foreach my $line (@$list) {
    $line->[2] =~ s/\n/$br/g;
    $table->addrow("$line->[0]",
      $line->[1],
      $line->[2],
      $line->[3],
      $line->[4],
      $html->button("$lang{CHANGE}", "index=$index&chg=$line->[0]", { class => 'change' }),
      $html->button("$lang{DEL}", "index=$index&del=$line->[0]", { MESSAGE => "$lang{DEL} $line->[0]?", class => 'del' }));
  }
  print $table->show();

  return 1;
}

#**********************************************************
=head2 dv_payments_maked($attr) - Cross module payment maked

=cut
#**********************************************************
sub dv_payments_maked {
  my ($attr) = @_;

  $user=$attr->{USER_INFO} if ($attr->{USER_INFO});
  return '' if ($FORM{DISABLE});

  $Dv->info($attr->{USER_INFO}->{UID});

  if ($Dv->{TOTAL} < 1) {
    return 0;
  }
  #User without TP
  elsif(! $Dv->{TP_NUM}) {
    return 0;
  }

  my $deposit = $attr->{USER_INFO}->{DEPOSIT} + (($attr->{USER_INFO}->{CREDIT} > 0) ? $attr->{USER_INFO}->{CREDIT} : $Dv->{TP_CREDIT} );
  # + (( $attr->{SUM})? $attr->{SUM} : 0 );

  my $abon_fees = ($attr->{USER_INFO}->{REDUCTION}==0) ? $Dv->{MONTH_ABON} + $Dv->{DAY_ABON} : ($Dv->{MONTH_ABON} + $Dv->{DAY_ABON}) * (100 - $attr->{USER_INFO}->{REDUCTION}) / 100;

  if($conf{DV_FULL_MONTH}) {
    $abon_fees = ($attr->{USER_INFO}->{REDUCTION}==0) ? $Dv->{MONTH_ABON} + $Dv->{DAY_ABON}*30 : ($Dv->{MONTH_ABON} + $Dv->{DAY_ABON}*30) * (100 - $attr->{USER_INFO}->{REDUCTION}) / 100;
  }

  if ($Dv->{STATUS} > 3 && ($deposit > $abon_fees || (! $conf{DV_FULL_MONTH} && $Dv->{ABON_DISTRIBUTION}) )) {
    $Dv->change(
      {
        UID    => $attr->{USER_INFO}->{UID},
        STATUS => 0
      }
    );
    $Dv->{ACCOUNT_ACTIVATE} = $attr->{USER_INFO}->{ACTIVATE} || '0000-00-00';
    service_get_month_fee($Dv, $attr);
  }

  return 1;
}

#**********************************************************
=head2 dv_pay_to($attr) - Pay to function

=cut
#**********************************************************
sub dv_pay_to {
  my ($attr) = @_;

  my $Dv_ = $attr->{Dv};

  if ($FORM{DATE}) {
    my ($from_year, $from_month, $from_day) = split(/-/, $DATE,       3);
    my ($to_year,   $to_month,   $to_day)   = split(/-/, $FORM{DATE}, 3);
    $Dv_->{ACTION_LNG} = "$lang{PAYMENTS}";
    $Dv_->{DATE}       = "$DATE - $FORM{DATE}";
    $Dv_->{SUM}        = 0.00;
    $Dv_->{DAYS}       = 0;

    if ($Dv_->{MONTH_ABON} && $Dv_->{ABON_DISTRIBUTION} || $Dv_->{DAY_ABON}) {
      if ($from_year . '-' . $from_month eq $to_year . '-' . $to_month) {
        $Dv_->{DAYS} = $to_day - $from_day + 1;
        my $days_in_month = days_in_month({ DATE => "$from_year-$from_month-01" });
        $Dv_->{SUM} = sprintf("%.2f", ($Dv_->{MONTH_ABON} / $days_in_month) * $Dv_->{DAYS});
      }
      elsif ("$from_year-$from_month" ne "$to_year-$to_month") {
        $from_day--;
        do {
          my $days_in_month = days_in_month({ DATE => "$from_year-$from_month-01" });
          my $month_days = ($from_month == $to_month) ? $to_day : $days_in_month - $from_day;
          $from_day      = 0;
          my $month_sum  = sprintf("%.2f", ($Dv_->{MONTH_ABON} / $days_in_month) * $month_days);

          $Dv_->{SUM}  += $month_sum;
          $Dv_->{DAYS} += $month_days;

          if ($from_month < 12) {
            $from_month = sprintf("%02d", $from_month + 1);
          }
          else {
            $from_month = sprintf("%02d", 1);
            $from_year += 1;
          }
        } while (($from_year < $to_year) || ($from_month <= $to_month && $from_year <= $to_year));
      }
    }
    elsif ($Dv_->{MONTH_ABON}) {
      $Dv_->{SUM} = $Dv_->{MONTH_ABON};
    }
    else {
      $Dv_->{SUM} = 0;
    }
    $index = 2;
  }
  else {
    $Dv_->{ACTION_LNG} = "$lang{RECALCULATE}";
  }

  $html->tpl_show(_include('dv_pay_to', 'Dv'), $Dv_);

  return 1;
}

#**********************************************************
=head2 dv_docs($attr) - get services for invoice

=cut
#**********************************************************
sub dv_docs {
  my ($attr) = @_;

  my $uid      = $attr->{UID} || $FORM{UID};
  my @services = ();
  my %info     = ();

  $Dv->info($uid);

  if ($attr->{FEES_INFO}) {
    $info{day}   = $Dv->{DAY_ABON};
    $info{month} = $Dv->{MONTH_ABON};
    $info{abon_distribution} = $Dv->{ABON_DISTRIBUTION};
    return \%info;
  }

  if ($Dv->{TOTAL}==0 || ! $Dv->{DAY_ABON} || ($Dv->{STATUS} && $Dv->{STATUS} != 5)
    #|| ($attr->{PAYMENT_TYPE} && ($Dv->{POSTPAID_ABON} || $Dv->{PAYMENT_TYPE}))
    ) {
    return \@services;
  }

  if ($Dv->{MONTH_ABON} > 0) {
    my %FEES_DSC = (
              MODULE          => 'Internet',
              TP_ID           => $Dv->{TP_ID},
              TP_NAME         => $Dv->{TP_NAME},
              FEES_PERIOD_DAY => $lang{MONTH_FEE_SHORT},
              FEES_METHOD     => $Dv->{FEES_METHOD} ? $FEES_METHODS{$Dv->{FEES_METHOD}} : undef,
            );

    push @services, fees_dsc_former(\%FEES_DSC)."||$Dv->{MONTH_ABON}||$Dv->{TP_NAME}";
  }

  if ($Dv->{DAY_ABON} > 0) {
    my $days_in_month =  days_in_month({ DATE => next_month({ DATE => $DATE }) });
    #Describe| days | sum
    push @services, "Internet: $lang{MONTH_FEE_SHORT}: $Dv->{TP_NAME} ($Dv->{TP_ID})|$days_in_month $lang{DAY}|" . sprintf("%.2f", ($Dv->{DAY_ABON} * $days_in_month)) . "||$Dv->{TP_NAME}";
  }

  return \@services;
}


#**********************************************************
=head2 dv_report_debetors($attr)

=cut
#**********************************************************
sub dv_report_debetors {

  result_former({
     INPUT_DATA      => $Dv,
     FUNCTION        => 'report_debetors',
     BASE_FIELDS     => 0,
     DEFAULT_FIELDS  => 'LOGIN,FIO,PHONE,TP_NAME,DEPOSIT,CREDIT,DV_STATUS',
     FUNCTION_FIELDS => '',
     EXT_TITLES      => {
       'ip'          => 'IP',
       'netmask'     => 'NETMASK',
       'speed'       => $lang{SPEED},
       'port'        => $lang{PORT},
       'cid'         => 'CID',
       'filter_id'   => 'Filter ID',
       'tp_name'     => "$lang{TARIF_PLAN}",
       'dv_status'   => "Internet $lang{STATUS}",
       'dv_status_date' => "$lang{STATUS} $lang{DATE}",
       'online'      => 'Online',
       'dv_expire'   => "Internet $lang{EXPIRE}",
       'dv_login'    => "$lang{SERVICE} $lang{LOGIN}",
       'dv_password' => "$lang{SERVICE} $lang{PASSWD}"
     },
     TABLE           => {
       width      => '100%',
       caption    => "$lang{DEBETORS}",
       qs         => $pages_qs,
       ID         => 'REPORT_DEBETORS',
       EXPORT     => 1,
     },
     MAKE_ROWS    => 1,
     MODULE       => 'Dv',
     TOTAL        => "TOTAL:$lang{TOTAL};TOTAL_DEBETORS_SUM:$lang{SUM}"
  });

  return 1;
}

#**********************************************************
=head2 dv_report_tp()

=cut
#**********************************************************
sub dv_report_tp {

  my $list = $Dv->report_tp({ %LIST_PARAMS,
                              COLS_NAME => 1 });

my $table = $html->table(
  {
    caption     => $lang{TARIF_PLANS},
    width       => '100%',
    title       => [ "#", "$lang{NAME}", "$lang{TOTAL}", "$lang{ACTIV}", "$lang{DISABLE}",
      "$lang{DEBETORS}", "ARPPU $lang{ARPPU}", "ARPU $lang{ARPU}" ],
    cols_align  => [ 'left', 'right', 'right', 'right', 'right', 'right' ],
    ID          => 'REPORTS_TARIF_PLANS'
  }
);

my $dv_users_list_index = get_function_index('dv_users_list') || 0;

my ($total_users, $totals_active, $total_disabled, $total_debetors)=(0,0,0,0);
foreach my $line (@$list) {
  $line->{id} = 0 if (! defined($line->{id}));
  $table->addrow(
    $line->{id},
    $html->button($line->{name}, "index=$dv_users_list_index&TP_NUM=$line->{id}"),
    $html->button($line->{counts}, "index=$dv_users_list_index&TP_NUM=$line->{id}"),
    $html->button($line->{active}, "index=$dv_users_list_index&TP_NUM=$line->{id}&DV_STATUS=0"),
    $html->button($line->{disabled}, "index=$dv_users_list_index&TP_NUM=$line->{id}&DV_STATUS=1"),
    $html->button($line->{debetors}, "index=$dv_users_list_index&TP_NUM=$line->{id}&DEPOSIT=<0&search=1"),
    $line->{arppu},
    $line->{arpu}
  );

  $total_users    += $line->{counts};
  $totals_active  += $line->{active};
  $total_disabled += $line->{disabled};
  $total_debetors += $line->{debetors};
}

  $table->addrow(
    '',
    $lang{TOTAL},
    $total_users,
    $totals_active,
    $total_disabled,
    $total_debetors
  );

  print $table->show();

  return 1;
}


#***************************************************************
=head2 dv_start_page($attr) - Start page summary

=cut
#***************************************************************
sub dv_start_page {

  my %START_PAGE_F = (
    'dv_sp_online' => "Online",
    'dv_sp_errors' => "$lang{ERROR}",
  );

  return \%START_PAGE_F;
}

#***************************************************************
=head2 dv_sp_online($attr) - Online summary

=cut
#***************************************************************
sub dv_sp_online {
#  my ($attr)=@_;

  $Sessions->online({ STATUS_COUNT => 1 });

  my $dv_online_index = get_function_index('dv_online');

  my $table = $html->table(
    {
      width      => '100%',
      caption    => "Internet - Online",
      ID         => 'DV_ONLINE',
      rows       => [
       [$html->button('Online', "index=$dv_online_index"   ),
         $Sessions->{ONLINE_COUNT}  ],
       [$html->button('Reconnect', "STATUS=6&index=$dv_online_index"),
         $Sessions->{RECONNECT_COUNT} ],
       [$html->button('Recovery',    "STATUS=9&index=$dv_online_index"),
         $Sessions->{RECOVER_COUNT}  ],
       [$html->button('Zaped',    "ZAPED=2&index=$dv_online_index"),
         $Sessions->{ZAPPED_COUNT}  ]
       ],
    }
  );

  my $reports = $table->show();

  return $reports;
}


#***************************************************************
=head2 dv_sp_errors($attr) - Quick menu errors

=cut
#***************************************************************
sub dv_sp_errors {
  #my ($attr)=@_;

  my $list = $Log->log_reports({ RETRIES   => 10,
                                 COLS_NAME => 1
                                });

  my $table = $html->table(
    {
      width      => '100%',
      caption    => "DV $lang{ERROR}",
      ID         => 'DV_ERRORS',
      title_plain=> [ "$lang{USER}", "$lang{COUNT}" ],
    }
  );

  foreach my $line (@$list) {
    $table->addrow(
       $html->button($line->{user}, "index=". get_function_index('dv_error') ."&LOGIN=$line->{user}&search=1"),
       $line->{count},
    );
  }

  my $reports = $table->show();

  return $reports;
}

#***************************************************************
=head2 dv_warning($attr) - Show warning message and tips

  Arguments:
    $attr
      DV    - Dv object
      USER  - User object

=cut
#***************************************************************
sub dv_warning {
  my ($attr) = @_;
  my $warning = '';

  my $users_ = $attr->{USER};
  my $Dv_    = $attr->{DV};

  $users_->{DEPOSIT} = 0 if ($users_->{DEPOSIT} !~ /\d+/);

  #use dv warning expr
  if ($conf{DV_WARNING_EXPR}) {
    if ($conf{DV_WARNING_EXPR}=~/CMD:(.+)/) {
      $warning = cmd($1, {
           PARAMS => {
               language => $html->{language},
               %{ $attr->{USER} },
               %{ $attr->{DV} } }
         });
    }
  }
  # Get next payment period
  elsif (
      !$Dv_->{STATUS}
      && !$users_->{DISABLE}
      && ( $users_->{DEPOSIT} + (($users_->{CREDIT} > 0) ? $users_->{CREDIT} : ($Dv_->{TP_CREDIT} || 0)) > 0
        || $Dv_->{POSTPAID_ABON}
        || ($Dv_->{PAYMENT_TYPE} && $Dv_->{PAYMENT_TYPE} == 1) )
  ){
    my $days_to_fees = 0 ;
    my ($from_year, $from_month, $from_day) = split(/-/, $DATE, 3);
    $users_->{REDUCTION} = 0 if (! $Dv_->{REDUCTION_FEE});

    if ($Dv_->{REDUCTION_FEE} && $users_->{REDUCTION} == 100) {
      $warning = "$lang{NEXT_FEES}: -- $lang{REDUCTION}: 100%";
    }
    elsif ($Dv_->{MONTH_ABON} && $Dv_->{MONTH_ABON} > 0) {
      if ($Dv_->{ABON_DISTRIBUTION} && $Dv_->{MONTH_ABON} > 0) {
        my $days_in_month = 30;

        if ($users_->{ACTIVATE} eq '0000-00-00') {
          my ($y, $m, $d)=split(/-/, $DATE);
          my $rest_days    = 0;
          my $rest_day_sum = 0;
          my $deposit      = $users_->{DEPOSIT} + $users_->{CREDIT};

          while($rest_day_sum < $deposit) {
            $days_in_month   = ($m != 2 ? (($m % 2) ^ ($m > 7)) + 30 : (!($y % 400) || !($y % 4) && ($y % 25) ? 29 : 28));
            my $month_day_fee= $Dv_->{MONTH_ABON} * ((100 - $users_->{REDUCTION}) / 100) / $days_in_month;
            $rest_days    = $days_in_month - $d;
            $rest_day_sum    = $rest_days * $month_day_fee;

            if ($rest_day_sum > $deposit) {
              $days_to_fees += int($deposit / $month_day_fee);
            }
            else {
              $deposit = $deposit - $month_day_fee * $rest_days;
              $days_to_fees += $rest_days;
              $rest_day_sum = 0;
              $d = 1;
              $m++;
              if ($m > 12) {
                $m = 1;
                $y++;
              }
            }
          }
        }
        else {
          $days_to_fees = int(($users_->{DEPOSIT} + $users_->{CREDIT}) * (100 / (100 - $users_->{REDUCTION}))  / ($Dv_->{MONTH_ABON} /  $days_in_month));
        }
        $warning = $lang{SERVICE_ENDED} || q{};
        $warning =~ s/\%DAYS\%/$days_to_fees/g;
      }
      else {
        #$warning = "$lang{NEXT_FEES}: ";
        if ($users_->{ACTIVATE} ne '0000-00-00') {
          my ($Y, $M, $D) = split(/-/, $users_->{ACTIVATE}, 3);
          if($Dv_->{FIXED_FEES_DAY}) {
            if ($M == 12) {
              $M = 0;
              $Y++;
            }

            $Dv_->{ABON_DATE} = POSIX::strftime("%Y-%m-%d", localtime(POSIX::mktime(0, 0, 0, $D, $M, ($Y - 1900), 0, 0, 0)));
          }
          else {
            $M--;
            $Dv_->{ABON_DATE} = POSIX::strftime("%Y-%m-%d", localtime((POSIX::mktime(0, 0, 0, $D, $M, ($Y - 1900), 0, 0, 0) + 31 * 86400)));
          }
        }
        else {
          my ($Y, $M, $D) = split(/-/, $DATE, 3);
          if ($conf{START_PERIOD_DAY} && $conf{START_PERIOD_DAY} > $D) {
          }
          else {
            $M++;
          }

          if ($M == 13) {
            $M = 1;
            $Y++;
          }
          if ($conf{START_PERIOD_DAY}) {
            $D = $conf{START_PERIOD_DAY};
          }
          else {
            $D = '01';
          }
          $Dv_->{ABON_DATE} = sprintf("%d-%02d-%02d", $Y, $M, $D);
        }

        $days_to_fees = date_diff($DATE, $Dv_->{ABON_DATE});
        if ($days_to_fees > 0) {
          $warning = "$lang{NEXT_FEES_THROUGHT} ($Dv_->{ABON_DATE})";
          $warning =~ s/\%DAYS\%/$days_to_fees/g;
        }
      }
    }
    elsif ($Dv_->{DAY_ABON} && $Dv_->{DAY_ABON} > 0) {
      $days_to_fees = int(($users_->{DEPOSIT} + $users_->{CREDIT} > 0) ?  ($users_->{DEPOSIT} + $users_->{CREDIT}) * (100 / (100 - $users_->{REDUCTION}) / $Dv_->{DAY_ABON}) : 0);
      $warning = $lang{SERVICE_ENDED};
      $warning =~ s/\%DAYS\%/$days_to_fees/g;
    }

    if ($days_to_fees && $days_to_fees < 5) {
      $warning = $html->color_mark($warning, 'bg-danger');
    }

    if ($days_to_fees > 0) {
      #Calculate days from net day
      my $expire_date = POSIX::strftime("%Y-%m-%d", localtime(POSIX::mktime(0, 0, 0, $from_day, ($from_month - 1), ($from_year - 1900))
            + 86400 * $days_to_fees + 86400));
      $warning .= " ($expire_date)";
    }
    elsif ($Dv_->{DV_EXPIRE} && $Dv_->{DV_EXPIRE} ne '0000-00-00') {
      $Dv_->{SERVICE_EXPIRE_DATE}=$Dv_->{DV_EXPIRE} if ($FORM{xml});
    }
  }

  return $warning;
}


#**********************************************************
=head2 dv_terminate_causes() - Session terminate cause

  Arguments:
    $attr
      REVERSE - Show reverse hash id => name

  Returns:
    Hash_refs

=cut
#**********************************************************
sub dv_terminate_causes {
  my ($attr) = @_;

  my %ACCT_TERMINATE_CAUSES = (
    'Unknown'                      => 0,
    'User-Request'                 => 1,
    'Lost-Carrier'                 => 2,
    'Lost-Service'                 => 3,
    'Idle-Timeout'                 => 4,
    'Session-Timeout'              => 5,
    'Admin-Reset'                  => 6,
    'Admin-Reboot'                 => 7,
    'Port-Error'                   => 8,
    'NAS-Error'                    => 9,
    'NAS-Request'                  => 10,
    'NAS-Reboot'                   => 11,
    'Port-Unneeded'                => 12,
    'Port-Preempted'               => 13,
    'Port-Suspended'               => 14,
    'Service-Unavailable'          => 15,
    'Callback'                     => 16,
    'User-Error'                   => 17,
    'Host-Request'                 => 18,
    'Supplicant-Restart'           => 19,
    'Reauthentication-Failure'     => 20,
    'Port-Reinit'                  => 21,
    'Port-Disabled'                => 22,
    'Lost-Alive/Billd Calculation' => 23
  );

  if (ref $attr eq 'SCALAR') {
    return $ACCT_TERMINATE_CAUSES{$attr};
  }

  return ($attr->{REVERSE}) ? { reverse %ACCT_TERMINATE_CAUSES } : \%ACCT_TERMINATE_CAUSES;
}

#**********************************************************
=head dv_quick_info($attr) - Quick information

  Arguments:
    $attr

=cut
#**********************************************************
sub dv_quick_info {
  my ($attr) = @_;
  my $result;

  if ($attr->{UID}) {
    $result = $Dv->info($attr->{UID});
    my $service_status = sel_status({ HASH_RESULT => 1 });
    $Dv->{STATUS} = (defined($Dv->{STATUS})) ? $service_status->{ $Dv->{STATUS} } : '';
  }
  elsif($attr->{GET_PARAMS}) {
    $result = {
      HEADER => $lang{DV},
      FIELDS => {
        TP_NAME => $lang{TARIF_PLAN},
        IP      => 'IP',
        STATUS  => $lang{STATUS}
      }
    }
  }

  return $result;
}

#**********************************************************
=head2 dv_stats_periods() Summary stats

=cut
#**********************************************************
sub dv_stats_periods {
#  my ($attr) = @_;

  $Sessions->periods_totals({ %LIST_PARAMS });
  my $table  = $html->table(
    {
      caption     => "$lang{PERIOD}",
      width       => '100%',
      title_plain => [ "$lang{PERIOD}", "$lang{DURATION}", "$lang{RECV}", "$lang{SEND}", "$lang{SUM}" ],
      cols_align  => [ 'left', 'right', 'right', 'right', 'right' ],
      ID          => 'DV_STATS_PERIOD'
    }
  );

  for (my $i = 0 ; $i < 5 ; $i++) {
    $table->addrow(
      $html->button("$PERIODS[$i]", "index=$index&PERIOD=$i$pages_qs"),
      sec2time_str($Sessions->{ 'duration_' . $i }),
      int2byte($Sessions->{ 'sent_' . $i }),
      int2byte($Sessions->{ 'recv_' . $i }),
      int2byte($Sessions->{ 'sum_' . $i })
    );
  }

  return $table->show({ OUTPUT2RETURN => 1 });
}

#**********************************************************
=head2 dv_period_select() - period select

=cut
#**********************************************************
sub dv_period_select {
  my ($attr) = @_;

  my @rows = (
    "$lang{FROM}: ",
    $html->date_fld2('FROM_DATE', { MONTHES => \@MONTHES, FORM_NAME => 'stats', WEEK_DAYS => \@WEEKDAYS }),
    "$lang{TO}: ",
    $html->date_fld2('TO_DATE', { MONTHES => \@MONTHES, FORM_NAME => 'stats', WEEK_DAYS => \@WEEKDAYS }),
    $html->form_select(
      'DIMENSION',
      {
        SELECTED => $FORM{DIMENSION},
        SEL_HASH => {
          '' => 'Auto',
          'Kb' => 'Kb',
          'Mb' => 'Mb',
          'Gb' => 'Gb'
        },
        NO_ID => 1
      },
    ),
    "$lang{ROWS}: ",
    $html->form_input('rows', int($conf{list_max_recs}), { SIZE => 4, OUTPUT2RETURN => 1 }),
    $html->form_input('show', $lang{SHOW}, { TYPE => 'submit', OUTPUT2RETURN => 1 })
  );

  my $info = '';
  foreach my $val (@rows) {
    $info .= $html->element('div', $val . ' ', { class => 'form-group', OUTPUT2RETURN => 1 });
  }

  return $html->form_main(
    {
      CONTENT => $html->element('div', $info, { class => 'well well-sm', OUTPUT2RETURN => 1 }),
      HIDDEN => {
        sid   => $sid,
        index => $index,
        UID   => $attr->{UID} || '',
      },
      NAME  => 'stats',
      ID    => 'stats',
      class => 'form-inline',
      OUTPUT2RETURN => 1
    }
  );
}

#**********************************************************
=head2 dv_get_chart_iframe()  - make an iframe with a chart

=cut
#**********************************************************
sub dv_get_chart_iframe {
  my ($query, $periods) = @_;

  my $frameopts = "width='100%' height='" . $chart_height * 1.4 . "px' frameborder='0' seamless='seamless' scrolling='false'";
  my $chart_query  = dv_get_chart_query($query, $periods);

  if ($FORM{xml}){return 1};

  return "<iframe src='$chart_query' $frameopts></iframe>"
}

#**********************************************************
=head2 dv_get_chart_query() - form query to charts.cgi from given params

=cut
#**********************************************************
sub dv_get_chart_query {
  my ($query, $periods, $width, $height) = @_;

  my $chart_dimensions ='';
  $chart_dimensions.= ($height) ? "&height=$height" : "&height=$chart_height";
  $chart_dimensions.= "px";
  $chart_dimensions.= ($width) ? "&width=$width" : "&width=$chart_embedded_width";
  $chart_dimensions.= "px";

  return "/charts.cgi?$query&periods=$periods&SHOW_GRAPH=1$chart_dimensions";
}


#**********************************************************
=head2 _color_hex_to_rgb($hex_color_string)

 Returns:
   arr ref of RGB

=cut
#**********************************************************
sub _color_hex_to_rgb {
  my ($hex_color_string) = @_;

  return [] unless ($hex_color_string);

  my @symbols = split('', lc $hex_color_string);
  return [] unless ($symbols[0] eq '#');

  # Speed hack
  my %digits = (
    0 => 0,
    1 => 1,
    2 => 2,
    3 => 3,
    4 => 4,
    5 => 5,
    6 => 6,
    7 => 7,
    8 => 8,
    9 => 9,
    a => 10,
    b => 11,
    c => 12,
    d => 13,
    e => 14,
    f => 15
  );

  my @decimals = ();
  for (my $i = 1; $i < scalar @symbols; $i+=2){
    my $res = 0;
    $res = ($symbols[$i]) ? $digits{$symbols[$i]} * 16 : 0;
    $res += ($symbols[$i+1]) ? $digits{$symbols[$i+1]} : 0;

    push (@decimals, $res);
  }

  return \@decimals;
}

#**********************************************************
=head2 _rgb_to_hex($rgb_ref) - get hex string from RGB

=cut
#**********************************************************
sub _rgb_to_hex {
  my ($rgb_ref) = @_;
  # Speed hack
  my @hex = qw/ 0 1 2 3 4 5 6 7 8 9 a b c d e f /;

  my $hex_string = '#';

  foreach my $color (@$rgb_ref){
    my $low = $color % 16;
    my $high = ($color - $low) / 16;

    $hex_string .= "$hex[$high]" . "$hex[$low]";
  }

  return $hex_string;
}

#**********************************************************
=head2 _darken_hex($hex_color_string, $increment_by) - darkens given color

  Returns:
    incremented hex_color_string

=cut
#**********************************************************
sub _darken_hex {
  my ($hex_color_string, $increment_by) = @_;
  my $rgb_ref = _color_hex_to_rgb($hex_color_string);


  my @darkened_rgb = map {my $num = int($_ * $increment_by); ($num > 255) ? 255 : $num } @$rgb_ref;

  return _rgb_to_hex(\@darkened_rgb);
}

1

