#!perl

=head1 NAME

  Cams - RTSP flows management

=head1 ERRORS

  ID => 40xx

=cut

use strict;
use Abills::Base qw(sendmail days_in_month _bp in_array);
use Cams;
use Address;
use Tariffs;
use Abills::Experimental;
our ($db, $admin, %conf, $html, %lang, %ADMIN_REPORT);

require Cams::Services;
require Cams::Configure;
require Cams::Users;
require Cams::User_portal;
require Abills::Misc;

my $Cams = Cams->new($db, $admin, \%conf);
my $Address = Address->new($db, $admin, \%conf);
my $Tariffs = Tariffs->new($db, \%conf, $admin);
my $Users = Users->new($db, $admin, \%conf);

my $Cams_service;

#**********************************************************
=head2 cams_main($attr)

=cut
#**********************************************************
sub cams_main {
  my ($change_button, $delete_button) = "";
  my $show_add_form = 1;
  my $correct_name = 1;
  my $camera = ();
  my $service_id = '';
  my $user_list;

  if ($FORM{add_cam}) {
    if ($FORM{OWNER}) {
      $user_list = $users->list({
        LOGIN     => $FORM{OWNER},
        UID       => '_SHOW',
        COLS_NAME => 1,
      });

      if ($users->{TOTAL}) {
        $FORM{UID} = $user_list->[0]{uid};
      }
      else {
        $html->message("err", $lang{INFO}, "User not exist");
      }
    }

    $FORM{HOST} = _cams_correct_host($FORM{HOST});
    if ($FORM{NAME} =~ /^[aA-zZ\d_-]+$/mg && $FORM{HOST}) {
      $correct_name = _cams_group_correct({
        GROUP_ID     => $FORM{GROUP_ID},
        CHECK_GROUPS => 1,
      });
      if ($correct_name) {
        my $group = $Cams->group_info($FORM{GROUP_ID});
        if ($Cams->{TOTAL}) {
          $FORM{SERVICE_ID} = $group->{SERVICE_ID};
          $FORM{GROUP_NAME} = $group->{NAME};
        }
        if (in_array('Maps', \@MODULES)) {
          load_module('Maps');
          $FORM{POINT_ID} = maps_add_external_object(33, \%FORM);
        }

        $Cams->stream_add(\%FORM);
        if (!_error_show($Cams)) {
          $FORM{CAM_ID} = $Cams->{INSERT_ID};
          show_result($Cams, $lang{ADDED});
        }
      }
    }
    else {
      $html->message("err", "$lang{ERROR}", "$lang{ONLY_LATIN_LETTER}") if $FORM{HOST};
      $correct_name = 0;
    }
  }
  elsif ($FORM{chg_cam}) {
    $camera = $Cams->stream_info($FORM{chg_cam});
    $camera->{OWNER} = $camera->{USER_LOGIN};
  }
  elsif ($FORM{change_cam}) {
    if ($FORM{OWNER}) {
      $user_list = $users->list({
        LOGIN     => $FORM{OWNER},
        UID       => '_SHOW',
        COLS_NAME => 1,
      });

      if ($users->{TOTAL}) {
        $FORM{UID} = $user_list->[0]{uid};
      }
      else {
        $html->message("err", $lang{INFO}, "User not exist");
      }
    }

    $FORM{HOST} = _cams_correct_host($FORM{HOST});
    if ($FORM{NAME} =~ /^[aA-zZ\d_-]+$/mg && $FORM{HOST}) {
      $Cams->stream_change(\%FORM);
      if (!_error_show($Cams)) {
        show_result($Cams, $lang{CHANGED});
        $show_add_form = 0;
      }
    }
    else {
      $html->message("err", "$lang{ERROR}", "$lang{ONLY_LATIN_LETTER}") if $FORM{HOST};
      $correct_name = 0;
    }
  }
  elsif ($FORM{del_cam} && $FORM{COMMENTS}) {
    my $cam = $Cams->stream_info($FORM{del_cam});
    $FORM{CAM_NAME} = $cam->{NAME} || "";
    $FORM{SERVICE_ID} = $cam->{SERVICE_ID} || "";
    $Cams->stream_del({ ID => $FORM{del_cam} });
    show_result($Cams, $lang{DELETED});
    $show_add_form = 0;
  }

  $service_id = $FORM{SERVICE_ID} || $camera->{SERVICE_ID};

  if ($service_id && $correct_name) {
    $FORM{SERVICE_ID} = $service_id;
    $Cams_service = cams_user_services(\%FORM);
  }

  if ($show_add_form) {
    $camera->{GROUPS_SELECT} = $html->form_select('GROUP_ID', {
      SELECTED  => $camera->{GROUP_ID} || q{},
      SEL_LIST  => $Cams->group_list({
        NAME         => "_SHOW",
        SERVICE_NAME => "_SHOW",
        COLS_NAME    => 1,
      }),
      SEL_VALUE => 'service_name,name',
      SEL_KEY   => 'id',
      NO_ID     => 1,
      EX_PARAMS => 'required="required"',
    });

    $camera->{ORIENTATION_SELECT} = _cams_orientation_select({ SELECTED => ($camera->{ORIENTATION} || 0) });
    $camera->{ARCHIVE_SELECT} = _cams_archive_select({ SELECTED => $camera->{ARCHIVE} });
    $camera->{TYPE_SELECT} = _cams_type_select({ SELECTED => ($camera->{TYPE} || 0) });
    $camera->{TRANS_SELECT} = _cams_transport_select({ SELECTED => ($camera->{TRANSPORT} || 0) });
    $camera->{SOUND_SELECT} = $html->form_select('SOUND', {
      SELECTED => $camera->{SOUND} || q{},
      SEL_LIST => [
        { id => 1, name => "PCMA/PCMU" },
        { id => 2, name => "AAC" },
      ],
      NO_ID    => 1
    });

    $html->tpl_show(_include('cams_stream_add', 'Cams'), {
      %$camera,
      DISABLED_CHECKED   => $camera->{DISABLED} ? 'checked' : '',
      LIMIT_ARCHIVE      => $camera->{LIMIT_ARCHIVE} ? 'checked' : '',
      PRE_IMAGE          => $camera->{PRE_IMAGE} ? 'checked' : '',
      CONSTANTLY_WORKING => $camera->{CONSTANTLY_WORKING} ? 'checked' : '',
      ONLY_VIDEO         => $camera->{ONLY_VIDEO} ? 'checked' : '',
      SUBMIT_BTN_ACTION  => ($FORM{chg_cam}) ? 'change_cam' : 'add_cam',
      SUBMIT_BTN_NAME    => ($FORM{chg_cam}) ? $lang{CHANGE} : $lang{ADD},
    });
  }

  my $cameras_table = $html->table({
    width      => '100%',
    caption    => $lang{CAMERAS},
    title      => [ "#", $lang{SERVICE}, $lang{OWNER}, $lang{GROUP}, $lang{NAME}, $lang{CAM_TITLE},
      "Host", "RTSP Path", "RTSP Port", "$lang{LOCATION}", "", "" ],
    ID         => 'CAMERAS_ITEMS',
    DATA_TABLE => 1,
    MENU       => "$lang{ADD}:index=$index&add_form=1:add",
  });

  my $cameras = $Cams->streams_list({ SHOW_ALL_COLUMNS => 1 });

  foreach my $one_camera (@$cameras) {
    if ($one_camera->{USER_LOGIN} && $one_camera->{UID}) {
      $one_camera->{USER_LOGIN} = $html->button($one_camera->{USER_LOGIN}, "index=15&LOGIN=$one_camera->{USER_LOGIN}", {
        ex_params => "target='_blank'",
      });
    }

    my $maps_btn = "";
    if (in_array('Maps', \@MODULES)) {
      $maps_btn = _cams_result_former_point_id_filter($one_camera->{point_id});
    }

    $change_button = $html->button('', "index=$index&chg_cam=$one_camera->{ID}", { class => 'change' });
    $delete_button = $html->button('', "index=$index&del_cam=$one_camera->{ID}", { MESSAGE => "$lang{DEL} $one_camera->{NAME}?", class => 'del' });
    $cameras_table->addrow($one_camera->{ID}, $one_camera->{SERVICE_NAME}, $one_camera->{USER_LOGIN}, $one_camera->{GROUP_NAME}, $one_camera->{NAME},
      $one_camera->{TITLE}, $one_camera->{HOST}, $one_camera->{RTSP_PATH}, $one_camera->{RTSP_PORT}, $maps_btn, $change_button, $delete_button);
  }

  print $cameras_table->show();

  return 1;
}

#**********************************************************
=head2 _cams_orientation_select()

=cut
#**********************************************************
sub _cams_orientation_select {
  my $attr = shift || {};

  my @orientations = (
    { id => 1, name => $lang{NORMAL} },
    { id => 2, name => "$lang{ROTATE} $lang{RIGHT}" },
    { id => 3, name => $lang{INVERTED} },
    { id => 4, name => "$lang{ROTATE} $lang{LEFT}" },
    { id => 5, name => "$lang{FLIPPED} $lang{HORIZONTALLY}" },
    { id => 6, name => "$lang{FLIPPED} $lang{VERTICALLY}" },
  );

  return $html->form_select('ORIENTATION', {
    SELECTED => $attr->{SELECTED} || $FORM{ORIENTATION} || q{},
    SEL_LIST => \@orientations,
    NO_ID    => 1
  });
}

#**********************************************************
=head2 _cams_archive_select()

=cut
#**********************************************************
sub _cams_archive_select {
  my $attr = shift || {};

  my @periods = (
    { id => 1, name => "1 день" },
    { id => 2, name => "2 дня" },
    { id => 3, name => "3 дня" },
    { id => 4, name => "4 дня" },
    { id => 5, name => "5 дней" },
    { id => 6, name => "6 дней" },
    { id => 7, name => "1 неделя" },
    { id => 10, name => "10 дней" },
    { id => 40, name => "40 дней" },
    { id => 14, name => "2 недели" },
    { id => 30, name => "1 месяц" },
    { id => 60, name => "2 месяца" },
    { id => 90, name => "3 месяца" },
    { id => 183, name => "6 месяцев" },
    { id => 365, name => "1 год" },
  );

  return $html->form_select('ARCHIVE', {
    SELECTED => $attr->{SELECTED} || $FORM{ARCHIVE} || q{},
    SEL_LIST => \@periods,
    NO_ID    => 1
  });
}

#**********************************************************
=head2 _cams_type_select()

=cut
#**********************************************************
sub _cams_type_select {
  my $attr = shift || {};

  my @orientations = (
    { id => 1, name => $lang{PUBLIC_CAM} },
    { id => 2, name => $lang{PRIVATE_CAM} },
  );

  return $html->form_select('TYPE', {
    SELECTED  => $attr->{SELECTED} || $FORM{TYPE} || q{},
    SEL_LIST  => \@orientations,
    NO_ID     => 1,
    SEL_KEY   => 'id',
    SEL_VALUE => 'name',
  });
}

#**********************************************************
=head2 _cams_type_select()

=cut
#**********************************************************
sub _cams_transport_select {
  my $attr = shift || {};

  my @transport = (
    { id => 1, name => "TCP" },
    { id => 2, name => "UDP" },
  );

  return $html->form_select('TRANSPORT', {
    SELECTED => $attr->{SELECTED} || $FORM{TRANSPORT} || q{},
    SEL_LIST => \@transport,
    NO_ID    => 1
  });
}

#**********************************************************
=head2 _cams_groups_select()

=cut
#**********************************************************
sub _cams_groups_select {
  my ($attr) = @_;

  my $user_groups = '';
  my @active_groups = ();
  my $current_user_group = $Cams->user_groups_list({
    TP_ID     => $attr->{TP_ID},
    ID        => $attr->{ID},
    PAGE_ROWS => 10000,
    COLS_NAME => 1
  });

  foreach my $group (@$current_user_group) {
    push @active_groups, $group->{group_id};
  }

  if ($attr->{UID} && $attr->{SERVICE_ID}) {
    $user = $Users->pi({ UID => $attr->{UID} });
    if ($Users->{TOTAL}) {
      my $user_address = $Address->address_info($user->{LOCATION_ID});
      $user_groups = $Cams->access_group_list({
        NAME        => "_SHOW",
        STREET_ID   => $user_address->{STREET_ID} || 0,
        DISTRICT_ID => $user_address->{DISTRICT_ID} || 0,
        LOCATION_ID => $user->{LOCATION_ID} || 0,
        SERVICE_ID  => $attr->{SERVICE_ID},
        COMMENT     => "_SHOW",
        COLS_NAME   => 1,
      });

      return $html->form_select('GROUP_ID', {
        SELECTED => $attr->{SELECTED} || $FORM{SELECTED} || 0,
        SEL_LIST => $user_groups,
        NO_ID    => 1
      });
    }
  }

  return $user_groups;
}

#**********************************************************
=head2 cams_groups($attr)

=cut
#**********************************************************
sub cams_groups {

  my %TEMPLATE_CAMS_TP = ();
  my $show_add_form = $FORM{add_form} || 0;
  my $service_id = '';
  my $errors = 0;

  if ($FORM{add_group}) {
    if (!$FORM{NAME} && !$FORM{DISTRICT_ID} && !$FORM{STREET_ID} && !$FORM{BUILD_ID}) {
      $errors = 1;
      $html->message("err", "$lang{ERROR}", "Укажыте название группы или адрес");
    }
    else {
      $FORM{NAME} = $FORM{NAME} ? $FORM{NAME} : _cams_show_location('', \%FORM);
      $Cams->group_add({ %FORM });
      $FORM{GROUP_ID} = $Cams->{INSERT_ID} || 0;
      $show_add_form = !show_result($Cams, $lang{ADDED});
    }
  }
  elsif ($FORM{change_group}) {
    $Cams->group_change({ %FORM });
    show_result($Cams, $lang{CHANGED});
    $show_add_form = 1;
  }
  elsif ($FORM{chg}) {
    $FORM{chg_group} = $FORM{chg};
    delete $FORM{chg};
    my $group_info = $Cams->group_info($FORM{chg_group});
    if (!_error_show($Cams)) {
      %TEMPLATE_CAMS_TP = %{$group_info ? $group_info : {}};
      delete $TEMPLATE_CAMS_TP{admin};
      delete $TEMPLATE_CAMS_TP{conf};
      delete $TEMPLATE_CAMS_TP{db};
      $show_add_form = 1;
    }
  }
  elsif ($FORM{del}) {
    $FORM{del_group} = $FORM{del};
    delete $FORM{del};

    my $group = $Cams->group_info($FORM{del_group});
    $FORM{SERVICE_ID} = $group->{SERVICE_ID} || "";
    $FORM{GROUP_ID} = $group->{ID} || "";

    $Cams->group_del($FORM{del_group});
    show_result($Cams, $lang{DELETED});
  }

  $service_id = $TEMPLATE_CAMS_TP{SERVICE_ID} || $FORM{SERVICE_ID};

  if ($service_id && !$errors) {
    $FORM{SERVICE_ID} = $service_id;
    $Cams_service = cams_user_services(\%FORM, \%TEMPLATE_CAMS_TP);
  }

  if ($show_add_form) {
    $TEMPLATE_CAMS_TP{SERVICES_SELECT} = $html->form_select('SERVICE_ID', {
      SELECTED  => $TEMPLATE_CAMS_TP{SERVICE_ID} || q{},
      SEL_LIST  => $Cams->services_list({
        NAME      => "_SHOW",
        COLS_NAME => 1,
      }),
      SEL_NAME  => 'name',
      SEL_KEY   => 'id',
      NO_ID     => 1,
      EX_PARAMS => 'required="required"',
    });

    $TEMPLATE_CAMS_TP{ADDRESS} = form_address_select2({
      HIDE_FLAT             => 1,
      HIDE_ADD_BUILD_BUTTON => 1,
      LOCATION_ID           => $TEMPLATE_CAMS_TP{LOCATION_ID} || 0,
      DISTRICT_ID           => $TEMPLATE_CAMS_TP{DISTRICT_ID} || 0,
      STREET_ID             => $TEMPLATE_CAMS_TP{STREET_ID} || 0,
    });

    $html->tpl_show(
      _include('cams_groups', 'Cams'),
      {
        %TEMPLATE_CAMS_TP,
        BTN_ACTION => ($FORM{chg_group}) ? 'change_group' : 'add_group',
        BTN_LNG    => ($FORM{chg_group}) ? $lang{CHANGE} : $lang{ADD},
      }
    );
  }

  result_former({
    INPUT_DATA      => $Cams,
    FUNCTION        => 'group_list',
    BASE_FIELDS     => 0,
    DEFAULT_FIELDS  => 'ID,NAME,LOCATION_ID,COMMENT,MAX_USERS,MAX_CAMERAS,SERVICE_NAME',
    HIDDEN_FIELDS   => 'DISTRICT_ID,STREET_ID,BUILD_ID',
    FUNCTION_FIELDS => 'change, del',
    SKIP_USER_TITLE => 1,
    EXT_TITLES      => {
      'id'           => "#",
      'name'         => $lang{NAME},
      'location_id'  => $lang{LOCATION_CAMS},
      'comment'      => $lang{COMMENTS},
      'max_users'    => "Max. " . $lang{USERS},
      'max_cameras'  => "Max. " . $lang{CAMERAS},
      'service_name' => $lang{SERVICE},
    },
    FILTER_COLS     => {
      location_id => '_cams_show_location::LOCATION_ID,DISTRICT_ID,STREET_ID,BUILD_ID',
    },
    TABLE           => {
      width   => '100%',
      caption => $lang{CAMERAS} . ": " . $lang{GROUPS},
      qs      => $pages_qs,
      ID      => 'CAMS_GROUPS',
      header  => '',
      EXPORT  => 1,
      MENU    => "$lang{ADD}:index=$index&add_form=1" . ':add',
    },
    MAKE_ROWS       => 1,
    TOTAL           => 1
  });
}

#**********************************************************
=head2 _cams_show_location($attr)

=cut
#**********************************************************
sub _cams_show_location {
  my (undef, $attr) = @_;

  $attr->{VALUES} = $attr if $attr->{district_id} || $attr->{DISTRICT_ID};
  $attr->{DISTRICT_ID} = $attr->{district_id} || $attr->{DISTRICT_ID} || 0;
  $attr->{BUILD_ID} = $attr->{build_id} || $attr->{BUILD_ID} || 0;
  $attr->{STREET_ID} = $attr->{street_id} || $attr->{STREET_ID} || 0;

  my $address_params = $attr->{VALUES} || "";
  return "" if !$address_params || !$address_params->{DISTRICT_ID};

  my $address_info = "";
  if ($address_params->{BUILD_ID}) {
    $address_info = $Address->address_info($address_params->{BUILD_ID});

    if ($Address->{TOTAL}) {
      return ($address_info->{ADDRESS_DISTRICT} || "") . ", " . ($address_info->{ADDRESS_STREET} || "")
        . ", " . ($address_info->{ADDRESS_BUILD} || "");
    }
  }
  elsif ($address_params->{STREET_ID}) {
    my $street_info = $Address->street_info({ ID => $address_params->{STREET_ID} });
    if ($Address->{TOTAL}) {
      my $street_name = $street_info->{NAME} || "";
      $address_info = $Address->district_info({ ID => $street_info->{DISTRICT_ID} });
      return ($address_info->{NAME} || "") . ", " . $street_name if $Address->{TOTAL};
    }
  }

  $address_info = $Address->district_info({ ID => $address_params->{DISTRICT_ID} });
  return($address_info->{NAME} || "") if $Address->{TOTAL};

  return "";
}

#**********************************************************
=head2 cams_user_groups$attr)

  Arguments:
    $attr
      SERVICE_INFO
      SHOW_ONLY     - Show only info
      UID


  Results:

=cut
#**********************************************************
sub cams_user_groups {
  my ($attr) = @_;

  my $user = '';
  my $user_groups = '';
  my $current_user_group = '';
  my @active_groups = ();
  my $groups_table = $html->table({
    width   => '100%',
    caption => $lang{GROUPS},
    title   => [ "#", $lang{NAME}, $lang{LOCATION}, $lang{COMMENTS} ],
    ID      => 'CAMERAS_GROUPS_ID',
  });

  if ($attr->{SERVICE_INFO}) {
    $Cams = $attr->{SERVICE_INFO};
  }

  if ($FORM{change_now}) {
    $Cams->user_groups(\%FORM);
  }

  $current_user_group = $Cams->user_groups_list({
    TP_ID     => $Cams->{TP_ID},
    ID        => $FORM{ID} || $FORM{chg},
    PAGE_ROWS => 10000,
    COLS_NAME => 1
  });

  foreach my $group (@$current_user_group) {
    push @active_groups, $group->{group_id};
  }

  if ($attr->{UID} && $attr->{SERVICE_ID}) {
    $user = $Users->pi({ UID => $attr->{UID} });
    if ($Users->{TOTAL}) {
      my $user_address = $Address->address_info($user->{LOCATION_ID});
      $user_groups = $Cams->access_group_list({
        NAME        => "_SHOW",
        STREET_ID   => $user_address->{STREET_ID} || 0,
        DISTRICT_ID => $user_address->{DISTRICT_ID} || 0,
        LOCATION_ID => $user->{LOCATION_ID} || 0,
        SERVICE_ID  => $attr->{SERVICE_ID},
        COMMENT     => "_SHOW",
        COLS_NAME   => 1,
      });

      foreach my $group (@$user_groups) {
        my $location = _cams_show_location('', $group);
        my $checkbox = $html->form_input('IDS', $group->{id}, {
          TYPE          => 'checkbox',
          STATE         => (in_array($group->{id}, \@active_groups) ? 1 : undef),
          OUTPUT2RETURN => 1,
        });
        $groups_table->addrow($checkbox, $group->{name}, $location, $group->{comment});
      }
    }
  }

  my %submit_h = ();
  $submit_h{change_now} = "$lang{CHANGE}";

  return $html->form_main({
    CONTENT => $groups_table->show({ OUTPUT2RETURN => 1 }),
    HIDDEN  => {
      UID   => $FORM{UID},
      ID    => $FORM{chg} || $FORM{ID},
      TP_ID => $Cams->{TP_ID},
      index => $index,
      chg   => $FORM{chg},
    },
    METHOD  => 'get',
    SUBMIT  => \%submit_h
  });

  return $groups_table->show();
}

#**********************************************************
=head2 cams_monthly_fees($attr) -  Monthly periodic

  Arguments:
    $attr

=cut
#**********************************************************
sub cams_monthly_fees {
  my ($attr) = @_;

  my $debug = $attr->{DEBUG} || 0;

  my $debug_output = '';
  $debug_output .= "Cams - Monthly periodic fees\n" if ($debug > 1);

  $LIST_PARAMS{TP_ID} = $attr->{TP_ID} if ($attr->{TP_ID});
  my %USERS_LIST_PARAMS = (
    ACTIVATE  => "<=$ADMIN_REPORT{DATE}",
    EXPIRE    => "0000-00-00,>$ADMIN_REPORT{DATE}",
    PAGE_ROWS => 1000000,
  );
  $USERS_LIST_PARAMS{LOGIN} = $attr->{LOGIN} if ($attr->{LOGIN});

  my %tp_id2id = ();
  my $tp_list = $Tariffs->list({
    MODULE       => 'Cams',
    NEW_MODEL_TP => 1,
    COLS_NAME    => 1
  });

  foreach my $tp (@{$tp_list}) {
    $tp_id2id{ $tp->{tp_id} } = $tp->{id};
  }

  my %FEES_METHODS = %{get_fees_types({ SHORT => 1 })};
  $Tariffs->{debug} = 1 if ($debug > 6);
  my $list = $Tariffs->list({
    %LIST_PARAMS,
    MODULE               => 'Cams',
    MONTH_FEE            => '_SHOW',
    MIN_USE              => '_SHOW',
    PAYMENT_TYPE         => '_SHOW',
    POSTPAID_MONTH_FEE   => '_SHOW',
    REDUCTION_FEE        => '_SHOW',
    FEES_METHOD          => '_SHOW',
    EXT_BILL_ACCOUNT     => '_SHOW',
    FILTER_ID            => '_SHOW',
    ABON_DISTRIBUTION    => '_SHOW',
    SMALL_DEPOSIT_ACTION => '_SHOW',
    CREDIT               => '_SHOW',
    COLS_NAME            => 1,
    NEW_MODEL_TP         => 1
  });

  $ADMIN_REPORT{DATE} = $DATE if (!$ADMIN_REPORT{DATE});
  my ($y, $m, undef) = split(/-/, $ADMIN_REPORT{DATE}, 3);
  $m--;

  #Get Preview month begin end
  if ($m == 0) {
    $m = 12;
    $y--;
  }

  $m = sprintf("%02.d", $m);

  foreach my $tp (@{$list}) {
    my $TP_ID = $tp->{tp_id};
    my $min_use = $tp->{min_use};
    my $postpaid = $tp->{payment_type};
    my $month_fee = $tp->{month_fee};
    my $TP_NUM = $tp->{id};

    if ($debug > 1) {
      $debug_output .= "TP ID: $TP_NUM MF: $month_fee POSTPAID: $postpaid REDUCTION: $tp->{reduction_fee} "
        . "EXT_BILL_ID: $tp->{ext_bill_account} CREDIT: $tp->{credit} MIN_USE: $min_use\n";
      $Cams->{debug} = 1 if ($debug > 6);
    }

    my %users_services = ();

    my $users_main = $Cams->_list({
      LOGIN          => '_SHOW',
      ID             => '_SHOW',
      STATUS         => '_SHOW',
      SERVICE_STATUS => "0;5",
      TP_ID          => $TP_ID,
      SORT           => 1,
      PAGE_ROWS      => 1000000,
      COLS_NAME      => 1,
      %USERS_LIST_PARAMS
    });

    foreach my $some_user (@{$users_main}) {
      my $user_info = $Users->info($some_user->{uid});
      next if !$Users->{TOTAL};

      $debug_output .= " Login: $user_info->{LOGIN} ($some_user->{uid})  TP_ID: $some_user->{tp_id} " .
        "Fees: $tp->{month_fee} REDUCTION: $user_info->{REDUCTION}  $user_info->{DEPOSIT} $user_info->{CREDIT}\n" if ($debug > 3);
      my %user = (
        ID          => $some_user->{id},
        LOGIN       => $user_info->{LOGIN},
        UID         => $some_user->{uid},
        BILL_ID     => ($tp->{ext_bill_account} > 0) ? $user_info->{EXT_BILL_ID} : $user_info->{BILL_ID},
        REDUCTION   => ($tp->{reduction_fee}) ? $user_info->{REDUCTION} : 0,
        ACTIVATE    => $user_info->{ACTIVATE},
        DEPOSIT     => $user_info->{DEPOSIT},
        CREDIT      => ($user_info->{CREDIT} > 0) ? $user_info->{CREDIT} : $tp->{credit},
        CAMS_STATUS => $some_user->{status},
      );

      my $total_sum = 0;
      if ($month_fee > 0 || $min_use > 0) {
        my %FEES_DSC = (
          MODULE            => "Cams",
          SERVICE_NAME      => $lang{CAMERAS},
          TP_ID             => $tp->{id},
          TP_NAME           => $tp->{name},
          FEES_PERIOD_MONTH => $lang{MONTH_FEE_SHORT},
          FEES_METHOD       => $FEES_METHODS{ $tp->{fees_method} }
        );

        #Check bill ID and deposit
        if (!$user{BILL_ID} && !defined($user{DEPOSIT})) {
          print "[ $user{UID} ] $user{LOGIN} - Don't have money account\n";
          next;
        }

        #Month Fee ====
        delete $users_services{ $some_user->{uid} };
        push @{$users_services{ $some_user->{uid} }},
          {
            SUM      => $month_fee,
            DESCRIBE => fees_dsc_former(\%FEES_DSC),
            ID       => $user{ID}
          };
      }

      #Get fees
      my $ret = get_service_fee(\%user, \%users_services, {
        DATE   => $ADMIN_REPORT{DATE},
        METHOD => 1,
        DEBUG  => $debug
      });

      if ($ret) {
        if ($debug > 0) {
          $debug_output .= " $user{LOGIN} UID: $user{UID} SUM: $total_sum REDUCTION: $user{REDUCTION} CHANGE ACTIVATE\n";
        }
      }
    }
  }

  return $debug_output;
}

#**********************************************************
=head2 _cams_correct_host($attr) -  check video host

  Arguments:
    $host

  Return:
    host - if correct and 0 - not correct

=cut
#**********************************************************
sub _cams_correct_host {
  my $host = shift;

  if ($host =~ /^(rtsp:\/\/)(\b(?:\d{1,3}\.){3}\d{1,3})\b$/mg) {
    return $2;
  }
  elsif ($host =~ /^\b(?:\d{1,3}\.){3}\d{1,3}\b$/mg) {
    return $host;
  }

  $html->message("err", "$lang{ERROR}", "$lang{NOT_CORRECT_HOST}");

  return 0;
}

#**********************************************************
=head2 _cams_correct_host($attr

  Arguments:

  Return:

=cut
#**********************************************************
sub _cams_group_correct {
  my ($attr) = @_;

  if ($attr->{GROUP_ID}) {
    my $group = $Cams->group_info($FORM{GROUP_ID});
    $Cams->streams_list({
      GROUP_ID => $FORM{GROUP_ID},
    });

    if ($group->{MAX_CAMERAS} <= $Cams->{TOTAL} && $attr->{CHECK_GROUPS} && $group->{MAX_CAMERAS}) {
      $html->message("err", "$lang{ERROR}", $lang{NUMBER_OF_GROUPS});
      return 0;
    }
    elsif ($attr->{CHECK_GROUPS}) {
      return 1;
    }

    my $current_users = $Cams->users_group_count({
      GROUP_ID => $FORM{GROUP_ID},
    });
    if ($group->{MAX_USERS} <= $current_users && $attr->{CHECK_USERS} && $group->{MAX_USERS}) {
      $html->message("err", "$lang{ERROR}", "$lang{NUMBER_OF_USERS}");
      return 0;
    }
    elsif ($attr->{CHECK_USERS}) {
      return 1;
    }
  }

  return 1;
}

#**********************************************************
=head2 cams_maps_layers()

=cut
#**********************************************************
sub cams_maps_layers {
  return {
    LAYERS      => [ {
      id         => 33,
      name       => 'CAMS',
      lang_name  => $lang{CAMERAS},
      module     => 'Cams',
      structure  => 'MARKER',
      clustering => 1,
      add_func   => 'cams_main',
    } ],
    EXPORT_FUNC => {
      "33" => 'cams_cams_maps',
    }
  }
}
#
#**********************************************************
=head2 cams_cams_maps()

=cut
#**********************************************************
sub cams_cams_maps {
  my $cameras = $Cams->streams_list({
    POINT_ID     => $FORM{OBJECT_ID} || $FORM{POINT_ID} || '!',
    NAME         => '_SHOW',
    TITLE        => '_SHOW',
    GROUP_NAME   => '_SHOW',
    SERVICE_NAME => '_SHOW',
    HOST         => '_SHOW',
    PAGE_ROWS    => 10000
  });

  require Maps;
  Maps->import();
  my $Maps = Maps->new($db, $admin, \%conf);

  my @object_ids = map {+$_->{point_id}} @{$cameras};

  my $point_ids = join(';', @object_ids);

  my $points_list = $Maps->points_list({ ID => $point_ids, SHOW_ALL_COLUMNS => 1, EXTERNAL => 1, PAGE_ROWS => 10000 });

  my %point_id_to_id = ();
  foreach my $camera (@{$cameras}) {
    $point_id_to_id{$camera->{point_id}} = $camera;
  }

  my @export_arr = ();
  foreach my $point (@{$points_list}) {
    next if (!$point->{coordy} || !$point->{coordx});

    my $index = get_function_index("cams_main");
    my $link = "$lang{CAM}:<a href='index.cgi?index=$index&chg_cam=$point_id_to_id{$point->{id}}{id}' target='_blank'> $point->{name}</a>";
    my $tb = "<div class='panel panel-info'>" .
      "<div class='panel-heading'><h3 class='panel-title'>$link</h3></div>" .
      "<ul class='list-group'>" .
      "<li class='list-group-item'>$lang{NAME}: $point_id_to_id{$point->{id}}{name}</li>" .
      "<li class='list-group-item'>$lang{CAM_TITLE}: $point_id_to_id{$point->{id}}{title}</li>" .
      "<li class='list-group-item'>$lang{SERVICE}: $point_id_to_id{$point->{id}}{service_name}</li>" .
      "<li class='list-group-item'>$lang{CAMS_GROUP}: $point_id_to_id{$point->{id}}{group_name}</li>" .
      "<li class='list-group-item'>Host: $point_id_to_id{$point->{id}}{host}</li>" .
      #      "<li class='list-group-item'>$lang{PORTS}: $ports</li>" .
      "</ul>" .
      "</div>";
    my $info = "<div class='panel-group'>$tb</div>";

    my $tpl = qq{
              {
               "MARKER": {
                    "ID"       : $point->{id},
                    "COORDX"   : $point->{coordx},
                    "COORDY"   : $point->{coordy},
                    "INFO"     : "$info",
                    "TYPE"     : "cams_main"
                  },
               "LAYER_ID" : 33
              }
      };

    push @export_arr, $tpl;
  }
  if ($FORM{EXPORT_LIST}) {
    return join(", ", @export_arr);
  }

  return join(";", map {"ObjectsArray[ObjectsArray.length] = $_ ;"} @export_arr);
}

#**********************************************************
=head2 _cams_result_former_point_id_filter()

  Arguments:
    $point_id - Maps object id
    $attr     - hash ref
      PARAMS - arr ref
        0  - layer_id

=cut
#**********************************************************
sub _cams_result_former_point_id_filter {
  my ($point_id) = @_;

  require Maps;
  Maps->import();
  my $Maps = Maps->new($db, $admin, \%conf);

  my $map_points_by_id;
  if (!defined $map_points_by_id) {
    my $points_list = $Maps->points_list({
      COORDX    => '_SHOW',
      COORDY    => '_SHOW',
      EXTERNAL  => 1,
      PAGE_ROWS => 10000
    });
    $map_points_by_id = sort_array_to_hash($points_list);
  }
  my $map_index = undef;
  if (!$map_index) {
    $map_index = get_function_index('maps_edit');
  }

  if ($point_id) {
    # If have location, we can show it on map
    if ($map_points_by_id->{$point_id}{coordx} && $map_points_by_id->{$point_id}{coordy}) {
      return $html->button('', "index=$map_index&show_layer=33&OBJECT_ID=$point_id&BY_POINT_ID=$point_id&SINGLE=1&LAYER_ID=33&POINT_ID=$point_id",
        { ICON => 'glyphicon glyphicon-globe' })
    }
    # Else should change existing object
    else {
      return $html->button('', "index=$map_index&add=CUSTOM_POINT&OBJECT_ID=$point_id",
        { ICON => 'glyphicon glyphicon-map-marker' })
    }
  }
  # If no object defined, propose to add it
  else {
    return '';
  }

}

1;